/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*****************************************************************************
 *
 * Filename:
 * ---------
 *  PlstSrvsql.c
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *  palyer list service
 *
 * Author:
 * -------
 * -------
 *                      
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#ifdef __MTK_TARGET__
//#define __MAUI_SOFTWARE_LA__
#endif

#include "mmi_include.h"
#include "FileMgrSrvGProt.h"
#ifdef __PLST_SERVICE_DB_SUPPORT__
#include "sqlite3.h"
#include "sqlite3ex.h"
#include "sqlite3kal.h"
#include "meta_tag_api.h"
#include "Che_api.h"
#include "PlstsrvGprot.h"
#include "PlstSrv.h"
#include "PlstSrvpls.h"
#include "PlstSrvResdef.h"
#include "mmi_rp_srv_plst_def.h"

#include "APP_datetime.h"
#include "Gsm7BitNationalLang.h" //for mmi_7bit_check_gsm_ext_character_default()
#define SRV_PLST_SQL_MAX_LENGTH   700
#define SRV_PLST_SQL_OP_TIME      2   /* Yaling check more */
#define SRV_PLST_SQL_SHUFFLE_LIMIT   20   /* use offset to select while list number < SRV_PLST_SQL_SHUFFLE_LIMIT */

#ifdef __MAUI_SOFTWARE_LA__
#include "SST_sla.h"
#endif

//#define __PERFORMANCE_TEST_GEN_DB__
#ifdef __PERFORMANCE_TEST_GEN_DB__
static kal_uint32 start_tick1 = 0;
static kal_uint32 end_tick1 = 0;
static kal_uint32 start_tick2 = 0;
static kal_uint32 end_tick2 = 0;
static kal_uint32 total_tick1 = 0;
static kal_uint32 total_tick2 = 0;

static kal_uint32 start_tick3 = 0;
static kal_uint32 end_tick3 = 0;
static kal_uint32 total_tick3 = 0;

#define PTGB_TOTAL_START() total_tick1 = 0; total_tick2 = 0
#define PTGB_START_1() kal_get_time(&start_tick1)
#define PTGB_START_2() kal_get_time(&start_tick2)
#define PTGB_END_1() kal_get_time(&end_tick1); total_tick1 += end_tick1-start_tick1
#define PTGB_END_2() kal_get_time(&end_tick2); total_tick2 += end_tick2-start_tick2

#define PTGB_START_3() kal_get_time(&start_tick3)
#define PTGB_END_3() kal_get_time(&end_tick3); total_tick3 += end_tick3-start_tick3

#define PTGB_ITEM_REPORT() \
                MMI_TRACE(TRACE_GROUP_1, MMI_PLS_PLS_FIND_META_SQL_TOTAL, kal_ticks_to_milli_secs(total_tick3), kal_ticks_to_milli_secs(total_tick1), kal_ticks_to_milli_secs(total_tick2 - total_tick1), kal_ticks_to_milli_secs(total_tick2 + total_tick3))

#else

#define PTGB_START_1()
#define PTGB_START_2()
#define PTGB_END_1()
#define PTGB_END_2()

#define PTGB_START_3()
#define PTGB_END_3()

#define PTGB_ITEM_REPORT()

#endif

static const S8 SqlOmediaidasc[] = " ORDER BY media_id ASC limit ?";
static const S8 SqlOmediaiddesc[] = " ORDER BY media_id DESC limit ?";
static const S8 SqlOartistidasc[] = " ORDER BY artist_id ASC limit ?";
static const S8 SqlOartistiddesc[] = " ORDER BY artist_id DESC limit ?";
static const S8 SqlOalbumidasc[] = " ORDER BY album_id ASC limit ?";
static const S8 SqlOalbumiddesc[] = " ORDER BY album_id DESC limit ?";
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static const S8 SqlOvideoidasc[] = " ORDER BY vdo_id limit ?";
static const S8 SqlOvideoiddesc[] = " ORDER BY vdo_id DESC limit ?";
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
static const S8 SqlOnaidasc[] = " ORDER BY name, media_id limit ?";
static const S8 SqlOnaidascnl[] = " ORDER BY name, media_id ";
static const S8 SqlOnaiddesc[] = " ORDER BY name DESC, media_id DESC limit ?";
static const S8 SqlOpnaidasc[] = " ORDER BY ischar, p_name, media_id limit ?";
static const S8 SqlOpnaidascnl[] = " ORDER BY ischar, p_name, media_id ";
static const S8 SqlOpnaiddesc[] = " ORDER BY ischar DESC, p_name DESC, media_id DESC limit ?";
static const S8 SqlOtracknaidasc[] = " ORDER BY track_num, p_name, media_id limit ?";
static const S8 SqlOtracknaidascnl[] = " ORDER BY track_num, p_name, media_id ";
static const S8 SqlOtracknaiddesc[] = " ORDER BY track_num DESC, p_name DESC, media_id DESC limit ?";
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static const S8 SqlOvideonaidasc[] = " ORDER BY name, vdo_id limit ?"; 
static const S8 SqlOvideonaiddesc[] = " ORDER BY name DESC, vdo_id DESC limit ?";  
static const S8 SqlOvideopnaidasc[] = " ORDER BY p_name, vdo_id limit ?"; 
static const S8 SqlOvideopnaiddesc[] = " ORDER BY p_name DESC, vdo_id DESC limit ?";
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
static const S8 SqlOartistnaidasc[] = " ORDER BY artist_name, artist_id limit ?";
static const S8 SqlOartistnaiddesc[] = " ORDER BY artist_name DESC, artist_id DESC limit ?" ;
static const S8 SqlOartistpnaidasc[] = " ORDER BY ischar, p_name, artist_id limit ?";
static const S8 SqlOartistpnaiddesc[] = " ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ?" ;
static const S8 SqlOalbumnaidasc[] = " ORDER BY album_name, album_id limit ? ";
static const S8 SqlOalbumnaiddesc[] = " ORDER BY album_name DESC, album_id DESC limit ? ";
static const S8 SqlOalbumpnaidasc[] = " ORDER BY ischar, p_name, album_id limit ? ";
static const S8 SqlOalbumpnaiddesc[] = " ORDER BY ischar DESC, p_name DESC, album_id DESC limit ? ";
static const S8 SqlOalbumnaidasc2[] = " ORDER BY album_name, id limit ? ";
static const S8 SqlOalbumnaidasc2nl[] = " ORDER BY album_name, id ";
static const S8 SqlOalbumnaiddesc2[] = " ORDER BY album_name DESC, id DESC limit ? ";
static const S8 SqlOalbumpnaidasc2[] = " ORDER BY p_ischar, pp_name, id limit ? ";
static const S8 SqlOalbumpnaidasc2nl[] = " ORDER BY p_ischar, pp_name, id ";
static const S8 SqlOalbumpnaiddesc2[] = " ORDER BY p_ischar DESC, pp_name DESC, id DESC limit ? ";
static const S8 SqlOgenrenaidasc[] = " ORDER BY genre_name , genre_id limit ?";
static const S8 SqlOgenrenaiddesc[] = " ORDER BY genre_name DESC, genre_id DESC limit ?";
static const S8 SqlOgenrepnaidasc[] = " ORDER BY ischar, p_name, genre_id limit ?";
static const S8 SqlOgenrepnaiddesc[] = " ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ?";
static const S8 SqlOplstnaidasc[] = " ORDER BY plst_name, plst_id limit ?";
static const S8 SqlOplstnaiddesc[] = " ORDER BY plst_name DESC, plst_id DESC limit ?";
static const S8 SqlOplsttimeidasc[] = " ORDER BY create_time DESC, plst_id DESC limit ?";
static const S8 SqlOplsttimeiddesc[] = " ORDER BY create_time ASC, plst_id ASC limit ?";
static const S8 SqlOplstidxidasc[] = "ORDER BY idx, plstitem_id ASC limit ?";
static const S8 SqlOplstidxiddesc[] = "ORDER BY idx DESC, plstitem_id DESC limit ?";
static const S8 Sqlmedialarger[] = " media_id > ?";
static const S8 Sqlmediasmaller[] = " media_id < ?";
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static const S8 Sqlvideolarg[] = " vdo_id > ?";
static const S8 Sqlvideosmal[] = " vdo_id < ?";
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
static const S8 Sqlartistidlarg[] = " artist_id > ?";
static const S8 Sqlartistidsmal[] = " artist_id < ?";
static const S8 Sqlartistid[] = " artist_id = ?";
static const S8 Sqlalbumlarg[] = " album_id > ?";
static const S8 Sqlalbumsmal[] = " album_id < ?";
static const S8 Sqlalbumid[] = " album_id = ?" ;
static const S8 Sqlgenrelarg[] = " genre_id > ?";
static const S8 Sqlgenresmal[] = " genre_id < ?";
static const S8 Sqlgenreid[] = " genre_id = ?";
static const S8 Sqlplstlarg[] = " plst_id > ?";
static const S8 Sqlplstsmal[] = " plst_id < ?";
static const S8 Sqlplstitemlarg[] = " plstitem_id > ?";
static const S8 Sqlplstitemsmal[] = " plstitem_id < ?";
static const S8 Sqlnamelarger[] = " name > ?";
static const S8 Sqlnamesmaller[] = " name < ?";
static const S8 Sqlpnamelarger[] = " p_name > ?";
static const S8 Sqlpnamesmaller[] = " p_name < ?";
static const S8 Sqlpalbumnamelarger[] = " album.p_name > ?";
static const S8 Sqlpalbumnamesmaller[] = " album.p_name < ?";
static const S8 Sqltracklarger[] = " track_num > ?";
static const S8 Sqltracksmaller[] = " track_num < ?";
static const S8 Sqlischarlarger[] = " ischar > ?";
static const S8 Sqlischarsmaller[] = " ischar < ?";
static const S8 Sqlalbumischarlarger[] = " album.ischar > ?";
static const S8 Sqlalbumischarsmaller[] = " album.ischar < ?";
static const S8 Sqlartistnalarg[] = " artist_name > ?";
static const S8 Sqlartistnasmal[] = " artist_name < ?";
static const S8 Sqlalbumnalarg[] = " album_name > ?";
static const S8 Sqlalbumnasmal[] = " album_name < ?";
static const S8 Sqlgenrenalarg[] = " genre_name > ?";
static const S8 Sqlgenrenasmal[] = " genre_name < ?";
static const S8 Sqlplstnalarg[] = " plst_name > ?";
static const S8 Sqlplstnasmal[] = " plst_name < ?";
static const S8 Sqlplsttimelarg[] = " create_time > ?";
static const S8 Sqlplsttimesmal[] = " create_time < ?";
static const S8 Sqlplstidxlarg[] = "idx > ?";
static const S8 Sqlplstidxsmal[] = "idx < ?";
static const S8 Sqlsearchname[] = " name >= ? and name <?";
static const S8 Sqlsearchpname[] = " p_name >= ? and p_name <?";
static const S8 Sqlsearchartistname[] = "artist_name >= ? and artist_name < ?";
static const S8 Sqlsearchalbumname[] = "album_name >= ? and album_name < ?";
static const S8 Sqlsearchgenrename[] = "genre_name >= ? and genre_name < ?";
static const S8 Sqlsearchplstname[] = "plst_name >= ? and plst_name < ?";
static const S8 Sqlsearchname2[] = " name > ? and name <?";
static const S8 Sqlsearchpname2[] = " p_name > ? and p_name <?";
static const S8 Sqlsearchartistname2[] = " artist_name > ? and artist_name < ?";
static const S8 Sqlsearchalbumname2[] = " album_name > ? and album_name < ?";
static const S8 Sqlsearchgenrename2[] = " genre_name > ? and genre_name < ?";
static const S8 Sqlsearchplstname2[] = " plst_name > ? and plst_name < ?";
static const S8 Sqlmainplstitem[] = " main.plst_item";
static const S8 Sqldbplstitem[] = " db2.plst_item";
static const S8 SqlOrecentlistasc[] = " ORDER BY played ASC, plstitem_id ASC limit ?";
static const S8 SqlOrecentlistdesc[] = " ORDER BY played DESC, plstitem_id DESC limit ?";
static const S8 SqlOmostlistasc[] = " ORDER BY played_count ASC, plstitem_id ASC limit ?";
static const S8 SqlOmostlistdesc[] = " ORDER BY played_count DESC, plstitem_id DESC limit ?";
static const S8 Sqlplayedlarg[] = " played > ?";
static const S8 Sqlplayedsmal[] = " played < ?";
static const S8 Sqlplaycountlarg[] = " played_count > ?";
static const S8 sqlplaycountsmal[] = " played_count < ?";
static const S8 SqlOnaidasc2[] = " ORDER BY name, id asc limit ?";
static const S8 SqlOnaiddesc2[] = " ORDER BY name DESC, id desc limit ?";

static const S8 SqlFieldAidAPNameIsChar[] = "album.album_id AS id, album.p_name as pp_name, album.ischar as p_ischar";
static const S8 SqlFieldAidAName[] ="album.album_id AS id, album_name";
static const S8 SqlFieldIdPNameTrack[] = "media_id, p_name, track_num";
static const S8 SqlFieldIdPNameIsChar[] = "media_id, p_name, ischar";
static const S8 SqlFieldIdName[] = "media_id, name";

static const S8 Sqlmaindot[] = "main.";
static const S8 Sqldb2dot[] = "db2.";
static const S8 *Sqldbloc[2] = {Sqlmaindot, Sqldb2dot};

static const S8 SqlCreateTable[] = "CREATE TABLE";
static const S8 SqlCreateIndex[] = "CREATE INDEX";

/* cache statement begin */
typedef enum
{
    PLS_SQL_STMT_NULL = 0,

    /* Get detail item */
    PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_MAIN_AUDIO,
    PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_DB2_AUDIO,
    PLS_SQL_STMT_SELECT_ARTIST_NAME_MAIN_ARTIST,
    PLS_SQL_STMT_SELECT_ARTIST_NAME_DB2_ARTIST,    
    PLS_SQL_STMT_SELECT_ALBUM_NAME_MAIN_ALBUM,
    PLS_SQL_STMT_SELECT_ALBUM_NAME_DB2_ALBUM,
    PLS_SQL_STMT_SELECT_DURATION_MAIN_META,
    PLS_SQL_STMT_SELECT_DURATION_DB2_META,

    /* For scrolling 1 level cache - BEGIN */
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_SAME_MEDIA_ID_MAIN,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_SAME_MEDIA_ID_DB2,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC_PINYIN,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC_UNICODE,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC_PINYIN,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC_UNICODE,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC_SINGLE,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC_SINGLE,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC_SINGLE,
    
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC, // DO NOT change the following 2 item order
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC_SINGLE,

    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_ASC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_DESC_ATTACH,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_ASC_SINGLE,
    PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_DESC_SINGLE,
    /* For scrolling 1 level cache - END */

    /* For RESET database sequence - BEGIN */
    PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_MAIN_AUDIO,
    PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_DB2_AUDIO,
    PLS_SQL_STMT_UPDATE_MAIN_META_SLIM_IS_EXIST_BY_ID,
    PLS_SQL_STMT_UPDATE_DB2_META_SLIM_IS_EXIST_BY_ID,

    PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_MAIN_ARTIST,
    PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_MAIN_ALBUM,
    PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_MAIN_GENRE,
    PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_DB2_ARTIST,
    PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_DB2_ALBUM,
    PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_DB2_GENRE,

    PLS_SQL_STMT_INSERT_MAIN_ARTIST_ALBUM_GENRE, // DO NOT change the following 6 item order
    PLS_SQL_STMT_INSERT_MAIN_ARTIST,
    PLS_SQL_STMT_INSERT_MAIN_ARTIST_PINYIN,
    PLS_SQL_STMT_INSERT_MAIN_ALBUM,
    PLS_SQL_STMT_INSERT_MAIN_ALBUM_PINYIN,
    PLS_SQL_STMT_INSERT_MAIN_GENRE,
    PLS_SQL_STMT_INSERT_MAIN_GENRE_PINYIN,
    PLS_SQL_STMT_INSERT_DB2_ARTIST_ALBUM_GENRE, // DO NOT change the following 6 item order
    PLS_SQL_STMT_INSERT_DB2_ARTIST,
    PLS_SQL_STMT_INSERT_DB2_ARTIST_PINYIN,
    PLS_SQL_STMT_INSERT_DB2_ALBUM,
    PLS_SQL_STMT_INSERT_DB2_ALBUM_PINYIN,
    PLS_SQL_STMT_INSERT_DB2_GENRE,
    PLS_SQL_STMT_INSERT_DB2_GENRE_PINYIN,

    PLS_SQL_STMT_INSERT_MAIN_ALBUM_ARTWORK,
    PLS_SQL_STMT_INSERT_DB2_ALBUM_ARTWORK,

    PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_MAIN_ALBUM_ART,
    PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_DB2_ALBUM_ART,
    PLS_SQL_STMT_UPDATE_MAIN_ALBUM_ART,
    PLS_SQL_STMT_UPDATE_DB2_ALBUM_ART,

    PLS_SQL_STMT_SELECT_MAX_MEDIA_ID_MAIN_AUDIO,
    PLS_SQL_STMT_SELECT_MAX_MEDIA_ID_DB2_AUDIO,

    PLS_SQL_STMT_INSERT_INTO_MAIN_AUDIO, // DO NOT change the following 3 item order
    PLS_SQL_STMT_INSERT_INTO_MAIN_AUDIO_PINYIN,
    PLS_SQL_STMT_INSERT_INTO_DB2_AUDIO,
    PLS_SQL_STMT_INSERT_INTO_DB2_AUDIO_PINYIN,

    PLS_SQL_STMT_INSERT_INTO_MAIN_META,
    PLS_SQL_STMT_INSERT_INTO_DB2_META,
    PLS_SQL_STMT_INSERT_INTO_MAIN_META_SLIM,
    PLS_SQL_STMT_INSERT_INTO_DB2_META_SLIM,
    /* For RESET database sequence - END */
    PLS_SQL_STMT_TOTAL
}pls_sql_stmt_cache_enum;

typedef struct
{
    sqlite3_stmt* stmt;
    U32 stmt_id;
    U32 use_count;
} pls_sql_stmt_cache_struct;


/* 6 statement for 1 level audio scrolling case */
/* 14 statement for reset database */
#define PLS_SQL_STATEMENT_CACHE_NUM 14

pls_sql_stmt_cache_struct sql_stmt_cache[PLS_SQL_STATEMENT_CACHE_NUM];
U32 sql_stmt_cache_max_count; /* Max count for cache query times */
/* cache statement end */

extern srv_plst_control_struct* g_srv_plst_control_ptr;

__align(4) static STCHE che_context;

/* crc */
extern kal_uint32 med_crc_calculate(kal_uint8 const *data, kal_uint32 length);

static S32 pls_sql_delete_video_by_video_id(srv_plst_db_context_struct *db, U32 id);
static S32 pls_sql_delete_media_by_media_id(srv_plst_db_context_struct *db, U32 media_id, U32 *count);
static MMI_BOOL pls_sql_util_check_default_list_exist(srv_plst_db_context_struct *db, srv_plst_default_playlist_enum type);
static S32 pls_sql_util_get_hint_count_as_hint_type(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32* count);
static S32 pls_sql_get_view_count_two_level(srv_plst_db_context_struct * db,S32 index,U32 * count);
S32 pls_sql_get_active_id_by_index(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 index, U32 *id);

/*****************************************************************************
 * FUNCTION
 *  pls_sql_util_rand
 * DESCRIPTION
 *  
 * PARAMETERS
 *  min_value  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static U32 pls_sql_util_rand(U32 min_value, U32 max_value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    return (rand()%(max_value-min_value+1)) + min_value;
}


/*****************************************************************************
 * FUNCTION
 *  pls_db_util_convert_to_spelling
 * DESCRIPTION
 *  This function is used to convert to spelling. (ex. Chinese 'Ò»' can be converted to 'Y', 'i').
 * PARAMETERS
 *  input_mode:         [IN]        Input method mode
 *  input_char:         [IN]        Input character
 *  output_char:        [OUT]       Output characters
 *  out_len:            [IN]        Output buffer length
 * RETURNS
 *  No. of characters converted
 *****************************************************************************/
static U16 pls_db_util_convert_to_spelling(U16 input_mode, U16 input_char, U16 *output_char, U16 out_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_CSTAR__) || defined(__MMI_T9__)
    S32 i = 0;
    U16 char_buffer[SRV_PLST_META_INFO_MAX_LEN + 1];
#endif /* defined(__MMI_CSTAR__) || defined(__MMI_T9__) */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_CSTAR__) || defined(__MMI_T9__)
    if (input_char)
    {
        if ((input_char >= 0x4E00) && (input_char <= 0x9FA5) &&
            mmi_imc_get_char_info(input_char, char_buffer, SRV_PLST_META_INFO_MAX_LEN, (mmi_imm_input_mode_enum)input_mode))
        {
            switch (input_mode)
            {
                case IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO:
                case IMM_INPUT_MODE_QUICK_SEARCH_PINYIN:
                case IMM_INPUT_MODE_QUICK_SEARCH_SM_STROKE:
                case IMM_INPUT_MODE_QUICK_SEARCH_TR_STROKE:
                case IMM_INPUT_MODE_QUICK_SEARCH_HK_STROKE:
                    while ((i < SRV_PLST_MAX_FILE_LEN - 1) && char_buffer[i] && (i < out_len))
                    {
                        *(output_char++) = char_buffer[i++];
                    }
                    break;

                default:
                    break;
            }
            return i;
        }
    }
#endif
    *output_char = input_char;
    return 1;
}


#define UI_IS_UCS2_CHARACTER(c)         ((c != 0) && !mmi_7bit_check_gsm_default(c) && !mmi_7bit_check_gsm_ext_character_default(c))


static MMI_BOOL pls_check_ucs2_character(U16 *buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (*buffer)
    {
        if (UI_IS_UCS2_CHARACTER(*buffer))
        {
            return MMI_TRUE;
        }
        buffer++;
    }

    return MMI_FALSE;
}

//bql:MAUI_02932778
//in chinese char case like (¾Í)
//our orignal design is save the pinyin name as (jiu )
//need to skip punctuation char followed by chinese word
MMI_BOOL pls_db_util_check_punctuation_char(WCHAR code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((code >= 0x0020 && code <= 0x002F) ||
        (code >= 0x003A && code <= 0x0040) ||
        (code >= 0x005B && code <= 0x0060))
    {
        return MMI_TRUE;
    }
    return MMI_FALSE;

}

S32  pls_db_util_convert_to_pingyin(U16 *input_string, U16 *output_string, U16 out_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 len;
    U16 *temp_string = output_string;
    U16 total_len = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
     while (*input_string && out_len)
    {
        len = pls_db_util_convert_to_spelling(IMM_INPUT_MODE_QUICK_SEARCH_PINYIN, *input_string, temp_string, out_len);
        temp_string += len;
        total_len += len;
        out_len -= len;
        if (out_len && (*(temp_string - 1)) != (*input_string) &&
            !pls_db_util_check_punctuation_char(*(input_string+1)) )
        {
           *(temp_string++) = 32;
            out_len--;
        }
       
        input_string++;
    }

    return (U16) (temp_string - output_string);
}


/* parser input search string for searching function while using like */
static void pls_sql_util_parser_search_string(U16 *input_string, U16 *output_string, U16 out_len)
{
    while(*input_string && out_len > 0)
    {
        if(!mmi_ucs2nicmp((PS8)input_string, (PS8) L"\\", 1) ||
            !mmi_ucs2ncmp((PS8)input_string, (PS8)L"%",1) ||
            !mmi_ucs2ncmp((PS8)input_string, (PS8) L"_", 1))
        {
            *output_string = 92;
            out_len --;
            output_string ++;
        }
        *output_string = *input_string;            
        input_string++;
        output_string++;
        out_len --;
    }
    if(out_len)
    {
        *output_string = 37;  /* add % */
        output_string++;
    }
    else
    {
       /* to do */
    }
   // *output_string = 32;
    return;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_init_instance
 * DESCRIPTION
 *   init instance
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_init_instance_int(srv_plst_db_context_struct *db, U32 db_mem_size, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (!db->instance_inited)
    {
        sqlite3_init_instance(&(db->sqlite_instance), db->sqlite_buf, db_mem_size, 0);
        db->instance_inited = MMI_TRUE;
        MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_INIT_INSTANCE, &(db->sqlite_instance), db->sqlite_instance.taskid, db_mem_size, line);
    }
    return SRV_PLST_OK ;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_deinit_instance
 * DESCRIPTION
 *   deinit instance
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_deinit_instance_int(srv_plst_db_context_struct *db, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (db->instance_inited)
    {
        sqlite3_free_instance(&(db->sqlite_instance));
        db->instance_inited = MMI_FALSE;
        MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_DEINIT_INSTANCE, &(db->sqlite_instance), db->sqlite_instance.taskid, line);
    }
    return SRV_PLST_OK ;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_stmt_cache_get_max_count
 * DESCRIPTION
 *
 * PARAMETERS
 *
 * RETURNS
 *
 *****************************************************************************/ 
U32 pls_sql_stmt_cache_get_max_count(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    /* Clear cache count if reach maximum number */
    if(sql_stmt_cache_max_count == 0xFFFFFFFF)
    {
        sql_stmt_cache_max_count = 0;
        for (i = 0; i < PLS_SQL_STATEMENT_CACHE_NUM ; i++)
        {
            sql_stmt_cache[i].use_count = 0;
        }
    }

    return ++sql_stmt_cache_max_count;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_stmt_cache_get_command
 * DESCRIPTION
 *
 * PARAMETERS
 * 
 * RETURNS
 *
 *****************************************************************************/ 
CHAR* pls_sql_stmt_cache_get_command(U32 stmt_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    switch(stmt_id)
    {
        case PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_MAIN_AUDIO:
            return "SELECT media_id FROM main.meta_slim Where path = ? limit 1";

        case PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_DB2_AUDIO:
            return "SELECT media_id FROM db2.meta_slim Where path = ? limit 1";

        case PLS_SQL_STMT_UPDATE_MAIN_META_SLIM_IS_EXIST_BY_ID:
            return "UPDATE main.meta_slim SET is_exist = ? WHERE media_id = ?";

        case PLS_SQL_STMT_UPDATE_DB2_META_SLIM_IS_EXIST_BY_ID:
            return "UPDATE db2.meta_slim SET is_exist = ? WHERE media_id = ?";

        case PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_MAIN_ARTIST:
            return "SELECT artist_name FROM main.artist WHERE artist_id = ? limit 1";

        case PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_MAIN_ALBUM:
            return "SELECT album_name FROM main.album WHERE album_id = ? limit 1";

    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        case PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_MAIN_GENRE:
            return "SELECT genre_name FROM main.genre WHERE genre_id = ? limit 1";
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

        case PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_DB2_ARTIST:
            return "SELECT artist_name FROM db2.artist WHERE artist_id = ? limit 1";

        case PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_DB2_ALBUM:
            return "SELECT album_name FROM db2.album WHERE album_id = ? limit 1";

    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        case PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_DB2_GENRE:
            return "SELECT genre_name FROM db2.genre WHERE genre_id = ? limit 1";
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

        case PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_MAIN_ALBUM_ART:
            return "SELECT artwork_size from main.album_artwork WHERE album_id = ?";

        case PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_DB2_ALBUM_ART:
            return "SELECT artwork_size from db2.album_artwork WHERE album_id = ?";

        default:
            break;
    }
    return NULL;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_stmt_cache_prepare
 * DESCRIPTION
 *
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *
 *****************************************************************************/ 
S32 pls_sql_stmt_cache_prepare(srv_plst_db_context_struct *db, U32 stmt_id, sqlite3_stmt** stmt, CHAR* cmd)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 least_recent_use;
    U16 least_recent_item;
    U16 i;
    S32 ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_STMT_CACHE_PREPARE, stmt_id);

    /* Check if statement already prepared */
    for (i = 0; i < PLS_SQL_STATEMENT_CACHE_NUM ; i++)
    {
        if(sql_stmt_cache[i].stmt_id == stmt_id)
        {
            sql_stmt_cache[i].use_count = pls_sql_stmt_cache_get_max_count();
            *stmt = sql_stmt_cache[i].stmt;
            return SRV_PLST_OK;
        }
    }

    /* Find an empty cache */
    for (i = 0; i < PLS_SQL_STATEMENT_CACHE_NUM ; i++)
    {
        if(sql_stmt_cache[i].stmt_id == PLS_SQL_STMT_NULL)
        {
            break;
        }
    }

    /* If no cache found, clear a least recent use cache */
    if(i == PLS_SQL_STATEMENT_CACHE_NUM)
    {
        //kal_prompt_trace(MOD_MMI_MEDIA_APP,"[PLST SRV]pls_sql_stmt_cache_prepare(), cache miss");
        least_recent_use = sql_stmt_cache[0].use_count;
        least_recent_item = 0;
        
        for (i = 1; i < PLS_SQL_STATEMENT_CACHE_NUM ; i++)
        {
            if(sql_stmt_cache[i].use_count < least_recent_use)
            {
                least_recent_use = sql_stmt_cache[i].use_count;
                least_recent_item = i;
            }
        }

        if(sql_stmt_cache[least_recent_item].stmt_id != PLS_SQL_STMT_NULL)
        {
            pls_sql_finalize(sql_stmt_cache[least_recent_item].stmt);
            sql_stmt_cache[least_recent_item].stmt = NULL;
            sql_stmt_cache[least_recent_item].stmt_id = PLS_SQL_STMT_NULL;
            sql_stmt_cache[least_recent_item].use_count = 0;
        }

        i = least_recent_item;
    }

    /* prepare statement */
    if(cmd == NULL)
    {
        ret = pls_sql_prepare_ex(db, pls_sql_stmt_cache_get_command(stmt_id), &sql_stmt_cache[i].stmt);
    }
    else
    {
        ret = pls_sql_prepare_ex(db, cmd, &sql_stmt_cache[i].stmt);
    }

    if(ret == SRV_PLST_OK)
    {
        sql_stmt_cache[i].stmt_id = stmt_id;
        sql_stmt_cache[i].use_count = pls_sql_stmt_cache_get_max_count();
        *stmt = sql_stmt_cache[i].stmt;
    }

    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_stmt_cache_finalize_all
 * DESCRIPTION
 *
 * PARAMETERS
 *
 * RETURNS
 *
 *****************************************************************************/ 
void pls_sql_stmt_cache_finalize_all(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 cache_count = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < PLS_SQL_STATEMENT_CACHE_NUM ; i++)
    {
        if(sql_stmt_cache[i].stmt_id != PLS_SQL_STMT_NULL)
        {
            pls_sql_finalize(sql_stmt_cache[i].stmt);
            sql_stmt_cache[i].stmt = NULL;
            sql_stmt_cache[i].stmt_id = PLS_SQL_STMT_NULL;
            sql_stmt_cache[i].use_count = 0;
            cache_count++;
        }
    }

    MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_STMT_CACHE_PREPARE, cache_count);
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_prepare_ex
 * DESCRIPTION
 *   sqlite prepare
 * PARAMETERS
 *  db           :         [IN]   
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_prepare_ex_int(srv_plst_db_context_struct *db, CHAR* cmd, sqlite3_stmt** stmt, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret ;
    //sqlite3_instance* instance;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
#ifdef __MAUI_SOFTWARE_LA__
    kal_prompt_trace(MOD_MMI_MEDIA_APP, "[PLST SRV] pls_sql_prepare() : %s", cmd);
    SLA_CustomLogging("SQ2", SA_start);
#endif
    ret = sqlite3_prepare_v2(db->db, cmd, -1, stmt, NULL);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ2", SA_stop);
#endif
    if(ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        db->err_code = ret;        
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_SQLITE_PREPARE, ret);
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_SQLITE_PREPARE, (U32)sqlite3_memory_used());
        ret = SRV_PLST_RET_ERR_SQLITE_ERR;
    }
    else
    {
        ret = SRV_PLST_OK;   
    }    
    return ret;    
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_step_ex
 * DESCRIPTION
 *   sqlite prepare
 * PARAMETERS
 *  db           :         [IN]   
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_step_ex(srv_plst_db_context_struct *db, sqlite3_stmt* stmt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret ;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ3", SA_start);
#endif
    ret = sqlite3_step(stmt);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ3", SA_stop);
#endif

    if(ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        db->err_code = ret;
        MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_SQLITE_STEP, ret);
        MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_SQLITE_STEP, (U32)sqlite3_memory_used());
        ret = SRV_PLST_RET_ERR_SQLITE_ERR;
    }
    else if(ret == SQLITE_ROW)
    {
        ret = SRV_PLST_RET_ITEM_EXIST;
    }
    else
    {
        ret = SRV_PLST_OK;
    }
    return ret;  
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_finalize_int
 * DESCRIPTION
 *
 * PARAMETERS
 *
 * RETURNS
 *
 *****************************************************************************/ 
S32 pls_sql_finalize_int(sqlite3_stmt* stmt, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ4", SA_start);
#endif
    //MAUI_02661984 
    //in order to prevent statement finalize leak
    sqlite3_reset(stmt);
    ret = sqlite3_finalize(stmt);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ4", SA_stop);
#endif

    if (ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_FINALIZE, ret, __LINE__);
    }
    return SRV_PLST_OK;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_clear_binding_int
 * DESCRIPTION
 *
 * PARAMETERS
 *
 * RETURNS
 *
 *****************************************************************************/ 
S32 pls_sql_clear_binding_int(sqlite3_stmt* stmt, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ5", SA_start);
#endif
    sqlite3_reset(stmt);
    ret = sqlite3_clear_bindings(stmt);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ5", SA_stop);
#endif

    if (ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_CLEAR_BINDING, ret, __LINE__);
    }
    return SRV_PLST_OK;

}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_finalize_or_clear_binding_int
 * DESCRIPTION
 *
 * PARAMETERS
 *
 * RETURNS
 *
 *****************************************************************************/ 
S32 pls_sql_finalize_or_clear_binding_int(sqlite3_stmt* stmt, U32 stmt_id, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    if(stmt_id == PLS_SQL_STMT_NULL)
    {
        ret = pls_sql_finalize_int(stmt, line);
    }
    else
    {
        ret = pls_sql_clear_binding_int(stmt, line);
    }
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_enter_instance
 * DESCRIPTION
 *   enter instance
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_enter_instance_int(srv_plst_db_context_struct *db, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (!db->in_transaction)
    {
        sqlite3_enter_instance(&(db->sqlite_instance));
        db->in_transaction = MMI_TRUE;
    }
    return SRV_PLST_OK ;
}



/*****************************************************************************
 * FUNCTION
 *  pls_sql_exit_instance
 * DESCRIPTION
 *   exit instance
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_exit_instance_int(srv_plst_db_context_struct *db, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (db->in_transaction)
    {
        sqlite3_exit_instance(&(db->sqlite_instance));
        db->in_transaction = MMI_FALSE;
        //MMI_TRACE(TRACE_GROUP_1, MMI_PLS_SQL_EXIT_INSTANCE, &(db->sqlite_instance), db->sqlite_instance.taskid, line);
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_open_db
 * DESCRIPTION
 *   open db
 * PARAMETERS
 *  path         :         [IN]   db file path
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_open_db(UI_string_type path, srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (!db->db_opened && db->in_transaction)
    {
        ret = sqlite3_open16(path, &(db->db));
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_OPEN_DB, ret);

        if(ret > SQLITE_OK && ret < SQLITE_ROW)
        {
            sqlite3_close(db->db);
            db->err_code = ret;
            ret = SRV_PLST_RET_ERR_SQLITE_ERR;
        }
        else
        {
            db->db_opened = MMI_TRUE;
            ret = SRV_PLST_OK;
        }
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_attach_db
 * DESCRIPTION
 *   attach db
 * PARAMETERS
 *  path         :         [IN]   db file path
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_attach_db(UI_string_type path, srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt = NULL;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (db->db_opened && db->in_transaction)
    {
        ret = pls_sql_prepare_ex(db,"ATTACH ? AS db2", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, path);
        ret = pls_sql_step_ex(db, stmt);
        db->db_opened = MMI_TRUE;
        pls_sql_finalize(stmt);
    }
    return ret;
}



/*****************************************************************************
 * FUNCTION
 *  pls_sql_detach_db
 * DESCRIPTION
 *   detach db
 * PARAMETERS
 *  path         :         [IN]   db file path
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_detach_db(UI_string_type path, srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt = NULL;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (db->db_opened && db->in_transaction)
    {
        ret = pls_sql_prepare_ex(db,"DETACH ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, path);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_close_db
 * DESCRIPTION
 *   close db
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_close_db(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (db->db_opened && db->in_transaction)
    {
        /* Clear all cache prepare statements */
        pls_sql_stmt_cache_finalize_all();

        /* Close DB */
        ret = sqlite3_close(db->db);
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_CLOSE_DB, ret);

        /* Print maximum memory used */
    #ifdef __MAUI_SOFTWARE_LA__
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_CLOSE_DB, (U32)sqlite3_memory_highwater(0));
    #endif

        db->db_opened = MMI_FALSE;
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_begin_transaction
 * DESCRIPTION
 *   begin transaction
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_begin_transaction(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(db->in_transaction)
    {
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ1", SA_start);
#endif
        sqlite3_exec(db->db, "BEGIN TRANSACTION", 0, 0, 0);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ1", SA_stop);
#endif
        db->enable_flag = MMI_TRUE;
        return SRV_PLST_OK;
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_set_db_parama
 * DESCRIPTION
 *   set param
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_set_db_parama(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(db->in_transaction)
    {
        sqlite3_exec(db->db, "PRAGMA  encoding =\"UTF-16be\"", 0, 0, 0);
        return SRV_PLST_OK;
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_rollback_transaction
 * DESCRIPTION
 *   rollback transaction
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_rollback_transaction_int(srv_plst_db_context_struct *db, U32 line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(db->in_transaction)
    {
        ret = sqlite3_exec(db->db, "ROLLBACK TRANSACTION", 0, 0, 0);
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_ROLLBACK_TRANSACTION, ret, line);
        db->enable_flag = MMI_FALSE;
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_end_transaction
 * DESCRIPTION
 *   end transaction
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_end_transaction(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(db->in_transaction)
    {
        sqlite3_exec(db->db, "END TRANSACTION", 0, 0, 0);
        db->enable_flag = MMI_FALSE;
    }
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_commit_transaction
 * DESCRIPTION
 *   commit transaction
 * PARAMETERS
 *  db           :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_commit_transaction(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(db->in_transaction)
    {
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ5", SA_start);
#endif
        ret = sqlite3_exec(db->db, "COMMIT TRANSACTION", 0, 0, 0);
#ifdef __MAUI_SOFTWARE_LA__
    SLA_CustomLogging("SQ5", SA_stop);
#endif
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_COMMIT_TRANSACTION, ret);
        db->enable_flag = MMI_FALSE;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_prepare_to_create_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_prepare_to_create_plst(srv_plst_db_context_struct *db, U32* id, UI_string_type name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;      
    sqlite3_stmt* stmt;
    const S8* db_loc;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (IS_CARD_EXIST)
    {
        db_loc = Sqldb2dot;
    }
    else
    {
        db_loc = Sqlmaindot;
    }

    kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM %splst WHERE plst_name = ?", db_loc);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if( ret == SRV_PLST_RET_ITEM_EXIST)  
    {
        return ret;
    }

    if( ret == SRV_PLST_OK)
    {
        sprintf(db->sql_cmd, "SELECT MAX(plst_id) FROM  %splst", db_loc);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db,stmt);  

        if(id != NULL)
        {
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                if(*id == 0)
                {
                    if(IS_CARD_EXIST)
                    {
                        *id = 1;
                    }
                    else
                    {
                        *id = 0x8000 + 1;
                    }
                }
                else 
                {
                    *id = *id + 1;        
                }
            }
        }
        pls_sql_finalize(stmt);
    }

    return ret;
}
   

/*****************************************************************************
 * FUNCTION
 *  pls_sql_create_plst
 * DESCRIPTION
 *   create plst
 * PARAMETERS
 *  db            :         [IN]   see srv_plst_db_context_struct
 *  id            :         [IN]   id
 *  name          :         [IN]   playlist name
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_create_plst(srv_plst_db_context_struct *db, U32 id, UI_string_type name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 time_new;
    sqlite3_stmt* stmt;
    applib_time_struct time;
    srv_plst_base_info_struct *base;
    const S8* db_loc;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    applib_dt_get_rtc_time(&time);
    //applib_dt_get_date_time(&time);

    if (id > 0X8000)
    {
        db_loc = Sqlmaindot;
    }
    else
    {
        db_loc = Sqldb2dot;
    }

    time_new = applib_dt_mytime_2_utc_sec(&time, MMI_FALSE);
    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        sprintf(db->sql_cmd, "INSERT INTO %splst(plst_id, plst_name, create_time) VALUES (?,?,?)", db_loc);
    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
        sprintf(db->sql_cmd, "INSERT INTO %splst(plst_id, plst_name) VALUES (?,?)", db_loc);
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    sqlite3_bind_kal_wstr(stmt, 2, name);
    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        sqlite3_bind_kal_uint32(stmt, 3, time_new);
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    return ret;       
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_rename_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_rename_plst(srv_plst_db_context_struct *db, U32 id,  UI_string_type name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;      
    sqlite3_stmt* stmt;
    const S8* db_loc;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (IS_CARD_EXIST)
    {
        db_loc = Sqldb2dot;
    }
    else
    {
        db_loc = Sqlmaindot;
    }

    sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM %splst WHERE plst_name = ? AND plst_id != ?", db_loc);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    sqlite3_bind_kal_uint32(stmt, 2, id);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if( ret == SRV_PLST_RET_ITEM_EXIST)
    {
        return ret;
    }
    if(ret == SRV_PLST_OK)
    {
        if (id > 0X8000)
        {
            db_loc = Sqlmaindot;
        }
        else
        {
            db_loc = Sqldb2dot;
        }

        sprintf(db->sql_cmd, "UPDATE  %splst SET plst_name = ?  WHERE plst_id = ? ", db_loc);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);      
    }   
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_insert_ser_info
 * DESCRIPTION
 *   insert security info to db
 * PARAMETERS
 *  db            :         [IN]   see srv_plst_db_context_struct
 *  sec           :         [IN]   see srv_plst_security
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_insert_ser_info(srv_plst_db_context_struct *db, srv_plst_security *sec)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;    
    sqlite3_stmt* stmt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*
    CREATE TABLE security(
        sec_id            INTEGER     PRIMARY KEY,
        ver           TEXT,
        ver_int       INTEGER,
        completed     INTEGER,
        phone_id      INTEGER,
        card_id       INTEGER,
        config_info   BLOB,                          
        artwork_width  INTEGER)                           
     */
    ret = pls_sql_prepare_ex(db, "INSERT INTO security(sec_id, ver, ver_int, completed, phone_id, card_id, config_info, artwork_width) VALUES (?,?,?,?,?,?,?,?)", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint16(stmt, 1, 1);
    sqlite3_bind_kal_wstr(stmt, 2, sec->ver);
    sqlite3_bind_kal_uint16(stmt, 3, sec->ver_int);
    sqlite3_bind_kal_uint16(stmt, 4, MMI_TRUE);
    sqlite3_bind_kal_uint32(stmt, 5, sec->phone_id);
    sqlite3_bind_kal_uint32(stmt, 6, sec->card_id);   
    sqlite3_bind_blob(stmt, 7, (srv_plst_config_info_struct*)&(sec->config), sizeof(srv_plst_config_info_struct), SQLITE_STATIC);    
    sqlite3_bind_kal_uint32(stmt, 8, sec->artwork_width);   
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_create_table
 * DESCRIPTION
 *   create table
 * PARAMETERS
 *  drv            :         [IN]   drive letter
 *  db             :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_create_table(U8 drv, srv_plst_db_context_struct  *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;   
    srv_plst_base_info_struct *base;
    U32 i = 0;
    PS8 error_msg = NULL;
    MMI_BOOL is_exec;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);  
    for (i = 0; i < SRV_PLST_DB_CREATE_TBL_ENUM_END; i++)
    {
        is_exec = MMI_TRUE;
        switch(i)
        {
            case SRV_PLST_DB_CREATE_TBL_ARTIST:
                 /*
                        CREATE TABLE artist(
                            artist_id       INTEGER     PRIMARY KEY,
                            artist_name     TEXT        NOT NULL)

                        1. CREATE TABLE artist(artist_id INTEGER PRIMARY KEY, artist_name TEXT COLLATE NOCASE, p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1)
                        2. CREATE TABLE artist(artist_id INTEGER PRIMARY KEY, artist_name TEXT COLLATE NOCASE)
                */
                sprintf(db->sql_cmd, "%s artist(artist_id INTEGER PRIMARY KEY, artist_name TEXT COLLATE NOCASE", SqlCreateTable);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1");
                }

                strcat(db->sql_cmd, ")");

                break;
                 
            case SRV_PLST_DB_CREATE_TBL_ALBUM:
                 /*
                        CREATE TABLE album(
                            album_id       INTEGER     PRIMARY KEY,
                            album_name     TEXT        NOT NULL,
                            ischar  REAL DEFAULT 1)

                        1. CREATE TABLE album(album_id INTEGER PRIMARY KEY, album_name TEXT COLLATE NOCASE, p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1)
                        2. CREATE TABLE album(album_id INTEGER PRIMARY KEY, album_name TEXT COLLATE NOCASE)
                */

                // change feature of MAUI_02455521
                sprintf(db->sql_cmd, "%s album(album_id INTEGER PRIMARY KEY, album_name TEXT COLLATE NOCASE", SqlCreateTable);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1");
                }

                strcat(db->sql_cmd, ")");

                //TODO: check if non-pinyin style also need to store artwork_path TEXT

                break;

            case SRV_PLST_DB_CREATE_TBL_ALBUM_ARTWORK:
                 /*
                CREATE TABLE album_artwork(
                    album_id       INTEGER     PRIMARY KEY,
                    artwork_mid    INTEGER,
                    artwork        BLOB,
                    artwork_size   INTEGER,
                    artwork_parser_path TEXT,   
                    filetype       INTEGER)
                */
                // change feature of MAUI_02455521
                sprintf(db->sql_cmd, 
"%s album_artwork( \
album_id INTEGER PRIMARY KEY, \
artwork_mid INTEGER,\
artwork BLOB, \
artwork_size INTEGER DEFAULT 0, \
artwork_parser_path TEXT DEFAULT NULL,\
filetype INTEGER)", SqlCreateTable);
                 break;                
                 
            case SRV_PLST_DB_CREATE_TBL_GENRE:
                 /*
                        CREATE TABLE genre(
                            genre_id       INTEGER     PRIMARY KEY,
                            genre_name     TEXT        NOT NULL)

                        1. CREATE TABLE genre(genre_id INTEGER PRIMARY KEY, genre_name TEXT COLLATE NOCASE, p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1)
                        2. CREATE TABLE genre(genre_id INTEGER PRIMARY KEY, genre_name TEXT COLLATE NOCASE)

                */
                sprintf(db->sql_cmd, "%s genre(genre_id INTEGER PRIMARY KEY, genre_name TEXT COLLATE NOCASE", SqlCreateTable);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", p_name TEXT COLLATE NOCASE, ischar REAL DEFAULT 1");
                }

                strcat(db->sql_cmd, ")");

                break;            
                 
            case SRV_PLST_DB_CREATE_TBL_AUDIO:
                 /*
                        CREATE TABLE audio(
                            media_id       INTEGER     PRIMARY KEY,
                            artist_id      INTEGER,
                            album_id       INTEGER,
                            genre_id       INTEGER,
                            name           TEXT,
                            play_count     INTEGER    default 0,
                            ordinal        INTEGER    default 0)

                        1. CREATE TABLE audio(media_id INTEGER PRIMARY KEY, artist_id INTEGER, album_id INTEGER, genre_id INTEGER, name TEXT COLLATE NOCASE, p_name TEXT COLLATE NOCASE, play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0, track_num INTEGER, ischar REAL DEFAULT 1)
                        2. CREATE TABLE audio(media_id INTEGER PRIMARY KEY, artist_id INTEGER, album_id INTEGER, genre_id INTEGER, name TEXT COLLATE NOCASE, play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0)

                */

                sprintf(db->sql_cmd, "%s audio(media_id INTEGER PRIMARY KEY, artist_id INTEGER, album_id INTEGER, genre_id INTEGER, name TEXT COLLATE NOCASE", SqlCreateTable);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", p_name TEXT COLLATE NOCASE");
                }

                strcat(db->sql_cmd, ", play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0");

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", track_num INTEGER, ischar REAL DEFAULT 1");
                }

                strcat(db->sql_cmd, ")");

                break;  

            case SRV_PLST_DB_CREATE_TBL_META:
                  /*
                        CREATE TABLE meta(
                            media_id       INTEGER     PRIMARY KEY,
                            is_short       INTEGER,
                            title          TEXT,
                            copyrights     TEXT,
                            description    TEXT,
                            author         TEXT,
                            year           INTEGER,
                            track_num      INTEGER,
                            artwork_type   INTEGER,
                            volume         INTEGER,
                            user_rating    INTEGER,
                            played         REAL DEFAULT 0,  // Played time
                            modified       REAL DEFAULT 0,
                            format         INTEGER,
                            played_count   INTEGER DEFAULT 0, // Played count
                            )
                */
                sprintf(db->sql_cmd, "%s meta(media_id INTEGER PRIMARY KEY, \
title TEXT, copyrights TEXT, description TEXT, author TEXT, year INTEGER, track_num INTEGER, artwork_type TEXT, \
volume TEXT, user_rating INTEGER, played REAL DEFAULT 0, duration INTEGER, modified REAL DEFAULT 0, played_count INTEGER DEFAULT 0, \
bits_rate INTEGER, sample_rate INTEGER, sample_bits INTEGER)", SqlCreateTable);
                 break;

            case SRV_PLST_DB_CREATE_TBL_META_SLIM:
                  /*
                        CREATE TABLE meta_slim(
                            media_id       INTEGER     PRIMARY KEY,
                            path           TEXT        NOT NULL,
                            is_exist       INTEGER)
                */
                sprintf(db->sql_cmd, "%s meta_slim(media_id INTEGER PRIMARY KEY, path TEXT, is_exist INTEGER)", SqlCreateTable);
                 break;
                  
            case SRV_PLST_DB_CREATE_TBL_VIDEO:
                 /*
                        CREATE TABLE video(
                            vdo_id       INTEGER     PRIMARY KEY,
                            path         TEXT        NOT NULL,
                            is_short     INTEGER,
                            format       INTEGER,
                            name         TEXT,
                            play_count   INTEGER,
                            ordinal      INTEGER,
                            is_exist     INTEGER)

                        1. CREATE TABLE video(vdo_id INTEGER PRIMARY KEY, path TEXT, is_short INTEGER, format INTEGER, name TEXT COLLATE NOCASE, p_name TEXT COLLATE NOCASE, play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0, is_exist INTEGER, ischar REAL DEFAULT 1)
                        2. CREATE TABLE video(vdo_id INTEGER PRIMARY KEY, path TEXT, is_short INTEGER, format INTEGER, name TEXT COLLATE NOCASE, play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0, is_exist INTEGER)
                */

                sprintf(db->sql_cmd, "%s video(vdo_id INTEGER PRIMARY KEY, path TEXT, is_short INTEGER, format INTEGER, name TEXT COLLATE NOCASE", SqlCreateTable);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", p_name TEXT COLLATE NOCASE"); 
                }

                strcat(db->sql_cmd, ", play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0, is_exist INTEGER");

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    strcat(db->sql_cmd, ", ischar REAL DEFAULT 1");
                }

                strcat(db->sql_cmd, ")");

                break;
                 
            case SRV_PLST_DB_CREATE_TBL_STREAM:
                 /*
                        CREATE TABLE stream(
                            stream_id       INTEGER     PRIMARY KEY,
                            URL             TEXT,
                            title           TEXT,
                            format          INTEGER)                         
                */
                sprintf(db->sql_cmd, "%s stream(stream_id INTEGER PRIMARY KEY, URL TEXT, title TEXT COLLATE NOCASE, format INTEGER)", SqlCreateTable);
                break;
                
            case SRV_PLST_DB_CREATE_TBL_PLST:
                 /*
                        CREATE TABLE plst(
                            plst_id      INTEGER     PRIMARY KEY,
                            plst_name    TEXT,
                            count        INTEGER)                           

                        1. CREATE TABLE plst(plst_id INTEGER PRIMARY KEY, plst_name TEXT COLLATE NOCASE,count INTEGER, create_time REAL)
                        2. CREATE TABLE plst(plst_id INTEGER PRIMARY KEY, plst_name TEXT COLLATE NOCASE,count INTEGER)
                */
                sprintf(db->sql_cmd, "%s plst(plst_id INTEGER PRIMARY KEY, plst_name TEXT COLLATE NOCASE,count INTEGER", SqlCreateTable);

                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    strcat(db->sql_cmd, ", create_time REAL");
                }

                strcat(db->sql_cmd, ")");

                break;
                
            case SRV_PLST_DB_CREATE_TBL_PLST_ITEM:
                 /*
                        CREATE TABLE plst_item(
                            plstitem_id      INTEGER     PRIMARY KEY,
                            plst_id          INTEGER,
                            media_id         INTEGER,
                            idx              INTEGER,
                            play_count       INTEGER,
                            ordinal          INTEGER)                           
                */
                sprintf(db->sql_cmd, "%s plst_item(plstitem_id INTEGER PRIMARY KEY, plst_id INTEGER, media_id INTEGER, \
idx INTEGER, play_count INTEGER DEFAULT 0, ordinal INTEGER DEFAULT 0)", SqlCreateTable);
                break;
                 
            case SRV_PLST_DB_CREATE_TBL_PLAYING_INFO:
                 /*
                        CREATE TABLE playing_info(
                            unque_id      INTEGER     PRIMARY KEY,
                            plst_id       INTEGER,
                            media_id      INTEGER,
                            playing_type  INTEGER,
                            filtertype    BLOB)                           
                */
                sprintf(db->sql_cmd, "%s playing_info(unque_id INTEGER PRIMARY KEY, plst_id INTEGER, idx INTEGER, \
playing_type INTEGER, filtertype BLOB)", SqlCreateTable);                
                break;
                 
            case SRV_PLST_DB_CREATE_TBL_SECURITY:
                 /*
                        CREATE TABLE security(
                            sec_id            INTEGER     PRIMARY KEY,
                            ver           TEXT,
                            ver_int       INTEGER,
                            completed     INTEGER,
                            phone_id      INTEGER,
                            card_id       INTEGER,
                            config_info   BLOB,                     
                            artwork_width  INTEGER)                           
                */
                sprintf(db->sql_cmd, "%s security(sec_id INTEGER PRIMARY KEY, ver TEXT, ver_int INTEGER, \
completed INTEGER, phone_id INTEGER, card_id INTEGER, config_info BLOB, artwork_width INTEGER)", SqlCreateTable);
                break;

            case SRV_PLST_DB_CREATE_IDX_ARTIST:
                /*
                      CREATE INDEX artist_idx ON artist(artist_name)
                 */ 
                sprintf(db->sql_cmd, "%s artist_idx ON artist", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd, "(p_name)");
                }
                else
                {
                   strcat(db->sql_cmd, "(artist_name)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_ARTIST_SORT:
                /*
                    CREATE INDEX artist_sort_idx ON artist(ischar, p_name, artist_id)
                 */
                sprintf(db->sql_cmd,"%s artist_sort_idx ON artist", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd,"(ischar, p_name, artist_id)");
                }
                else
                {
                   strcat(db->sql_cmd,"(artist_name, artist_id)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_ALBUM:
                /*
                      CREATE INDEX album_idx ON album(album_name)
                 */
                sprintf(db->sql_cmd, "%s album_idx ON album", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd, "(p_name)");
                }
                else
                {
                   strcat(db->sql_cmd, "(album_name)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_ALBUM_SORT:
                /*
                    CREATE INDEX album_sort_idx ON album(name)
                 */
                sprintf(db->sql_cmd,"%s album_sort_idx ON album", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd,"(ischar, p_name, album_id)");
                }
                else
                {
                   strcat(db->sql_cmd,"(album_name, album_id)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_GENRE:
                /*
                     CREATE INDEX genre_idx ON genre(genre_name)  
                 */
                sprintf(db->sql_cmd, "%s genre_idx ON genre", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd, "(p_name)");
                }
                else
                {
                   strcat(db->sql_cmd, "(genre_name)");
                }
                break;
                
            case SRV_PLST_DB_CREATE_IDX_AUDIO_NAME:
                /*
                    CREATE INDEX aud_name_idx ON audio(name)
                 */
                sprintf(db->sql_cmd,"%s aud_name_idx ON audio", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd,"(p_name)");
                }
                else
                {
                   strcat(db->sql_cmd,"(name)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_AUDIO_ARTIST:
                /*
                    CREATE INDEX aud_art_idx ON audio(artist_id)
                 */
                sprintf(db->sql_cmd,"%s aud_art_idx ON audio(artist_id)", SqlCreateIndex);
                break;

            case SRV_PLST_DB_CREATE_IDX_AUDIO_ALBUM:
                /*
                    CREATE INDEX aud_abm_idx ON audio(album_id)
                 */
                sprintf(db->sql_cmd,"%s aud_abm_idx ON audio(album_id)", SqlCreateIndex);
                break;

            case SRV_PLST_DB_CREATE_IDX_AUDIO_SORT:
                /*
                    CREATE INDEX aud_name_idx ON audio(ischar, p_name, media_id)
                 */
                sprintf(db->sql_cmd,"%s aud_sort_idx ON audio", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd,"(ischar, p_name, media_id)");
                }
                else
                {
                   strcat(db->sql_cmd,"(name, media_id)");
                }
                break;

            case SRV_PLST_DB_CREATE_IDX_AUDIO_ALBUM_SORT:
                /*
                    CREATE INDEX aud_name_idx ON audio(ischar, p_name, media_id)
                 */

                // Note : only implement album list track number sotring in PINYIN verstion now
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   sprintf(db->sql_cmd,"%s aud_sort_album_idx ON audio", SqlCreateIndex);
                   strcat(db->sql_cmd,"(track_num, p_name, media_id)");
                }
                else
                {
                    is_exec = MMI_FALSE;
                }
                
                break;

            case SRV_PLST_DB_CREATE_IDX_AUDIO_PLAY_MAX:
                /*
                    CREATE INDEX aud_ply_cnt ON audio(play_count)
                 */
                sprintf(db->sql_cmd,"%s aud_ply_cnt ON audio(play_count)", SqlCreateIndex);
                break;


            case SRV_PLST_DB_CREATE_IDX_META_SLIM_PATH:
                /*
                    CREATE INDEX path_idx ON meta_slim(path)
                 */
                sprintf(db->sql_cmd,"%s path_idx ON meta_slim(path)", SqlCreateIndex);
                break;

            case SRV_PLST_DB_CREATE_IDX_VIDEO:
                /*
                    CREATE INDEX video_idx ON video(name)
                 */
                sprintf(db->sql_cmd, "%s video_idx ON video", SqlCreateIndex);

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                   strcat(db->sql_cmd, "(p_name)");
                }
                else
                {
                   strcat(db->sql_cmd, "(name)");
                }
                break;
                
            case SRV_PLST_DB_CREATE_IDX_PLST:
                /*
                   CREATE INDEX plst_idx ON plst(plst_name)
                 */
                sprintf(db->sql_cmd, "%s plst_idx ON plst(plst_name)", SqlCreateIndex);
                break;

            case SRV_PLST_DB_CREATE_IDX_PLST_ITEM_PLAY_MAX:
                /*
                   CREATE INDEX plst_itm_play_max ON plst_item(play_count)
                 */
                sprintf(db->sql_cmd, "%s plst_itm_play_max ON plst_item(play_count)", SqlCreateIndex);
                break;

            default:
                break;
        }

        if(is_exec)
        {
            ret = sqlite3_exec(db->db, db->sql_cmd, NULL, 0, &error_msg);
            
            if (ret > SQLITE_OK && ret < SQLITE_ROW)
            {
                db->err_code = ret;
                ret = SRV_PLST_RET_ERR_SQLITE_ERR;
                break;
            }
            else
            {
                ret = SRV_PLST_OK;
            }
        }
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    /* set security info */
    if (drv == SRV_FMGR_PUBLIC_DRV || drv == SRV_FMGR_CARD_DRV)
    {
        srv_plst_security sec;

        mmi_ucs2cpy((CHAR*) sec.ver, (CHAR*)SRV_PLST_DB_VERSION_NUM);
        sec.ver_int = med_crc_calculate((kal_uint8* )sec.ver, mmi_ucs2strlen((S8*)sec.ver) * ENCODING_LENGTH);
        pls_db_util_get_security_info(drv,&sec);  
        sec.config.default_list_flag = base->default_plst_config;
        sec.config.list_sort = base->config_sort_list_view;
        sec.config.plst_sort = base->config_plst_view;
        sec.config.view_type = base->config_view_sort_type;
        sec.config.store_play_info = base->config_store_play_info;
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        sec.config.dual_db = MMI_TRUE;
    #else
        sec.config.dual_db = MMI_FALSE;
    #endif
        sec.artwork_width = SRV_PLST_ARTWORK_RESIZED_WIDTH;
        ret = pls_sql_insert_ser_info(db, &sec); 
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
    }

    /* create default playlist */
    if (drv == SRV_FMGR_PUBLIC_DRV ||
        (g_srv_plst_control_ptr->card_state == SRV_PLST_DRIVE_CARD_ONLY && drv == SRV_FMGR_CARD_DRV)) 
    {
        srv_plst_base_info_struct *base;
        U32 flag;
        U8  id = 1;        
        base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info); 
        flag = base->default_plst_config;
        for(i = 1; i < SRV_PLST_DEF_LIST_ENUM_END ; i = i<<1)
        {
            if (i & flag)
            {
                U32 temp_id;
                UI_character_type name[2];
                name[0] = 0;
                switch(i)
                {
                    case SRV_PLST_DEF_MY_FAVOURITE:
                    case SRV_PLST_DEF_RECENTLY_PLST:
                    case SRV_PLST_DEF_MOST_PLST:
                    case SRV_PLST_DEF_ON_THE_FLY:
                        temp_id = id|0X8000;
                        ret = pls_sql_create_plst(db, temp_id, name);
                        id++;
                        break;
                        
                    default :
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                if (ret > SQLITE_OK && ret < SQLITE_ROW)
                {
                    db->err_code = ret;
                    return SRV_PLST_RET_ERR_SQLITE_ERR;
                }
            }
        }
    }
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_create_mark_tbl
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_create_mark_tbl(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;    
    PS8 error_msg = NULL;
    const S8* db_loc;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (IS_CARD_EXIST)
    {
        db_loc = Sqldb2dot;
    }
    else
    {
        db_loc = Sqlmaindot;
    }

    sprintf(db->sql_cmd, "SELECT id FROM %smark", db_loc);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_step_ex(db,stmt);
    pls_sql_finalize(stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_OK)
    {  
        sprintf(db->sql_cmd, "DROP TABLE %smark", db_loc);
        ret = sqlite3_exec(db->db, db->sql_cmd, NULL, 0, &error_msg);
        if(ret > SQLITE_OK && ret < SQLITE_ROW)
        {
            db->err_code = ret;
            return SRV_PLST_RET_ERR_SQLITE_ERR;
        }
    }   

    sprintf(db->sql_cmd, "CREATE TABLE  %smark(id INTEGER PRIMARY KEY, mark_flag INTEGER)", db_loc);
    ret = sqlite3_exec(db->db, db->sql_cmd, NULL, 0, &error_msg);
    if(ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        db->err_code = ret;
        return SRV_PLST_RET_ERR_SQLITE_ERR;
    }
    else
    {
        ret = SRV_PLST_OK;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_mark_tbl
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_delete_mark_tbl(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;    
    PS8 error_msg = NULL;
    const S8* db_loc;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (IS_CARD_EXIST)
    {
        db_loc = Sqldb2dot;
    }
    else
    {
        db_loc = Sqlmaindot;
    }

    sprintf(db->sql_cmd, "DROP TABLE %smark", db_loc);
    ret = sqlite3_exec(db->db, db->sql_cmd, NULL, 0, &error_msg);
    if(ret > SQLITE_OK && ret < SQLITE_ROW)
    {
        db->err_code = ret;
        ret = SRV_PLST_RET_ERR_SQLITE_ERR;
    }
    else
    {
        ret = SRV_PLST_OK;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_reset_exist_flag_for_udpate
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_reset_exist_flag_for_udpate(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;  
    U32 count = 0;
    U32 loc = 0, db_loc_count = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(IS_CARD_EXIST)
    {
        db_loc_count = 2;
    }

    do
    {
        /* reset meta_slim table */
        sprintf(db->sql_cmd, "SELECT MAX(is_exist) FROM %smeta_slim", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count = sqlite3_column_kal_uint32(stmt, 0) + 1;
        }
        else
        {
            count = 0;
        }
        pls_sql_finalize(stmt);
        if(db->Ucount < count)
        {
            db->Ucount = count;
        }

        sprintf(db->sql_cmd, "SELECT MAX(is_exist) FROM %svideo", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count = sqlite3_column_kal_uint32(stmt, 0) + 1;
        }
        else
        {
            count = 0;
        }
        pls_sql_finalize(stmt);
        if(db->Ucount < count)
        {
            db->Ucount = count;
        }    

        loc++;
    } 
    while (loc < db_loc_count);

    return ret;   
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_check_if_need_del_unexist_file
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
MMI_BOOL pls_sql_check_if_need_del_unexist_file(srv_plst_db_context_struct *db)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;    
    U32 loc = 0, db_loc_count = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(IS_CARD_EXIST)
    {
        db_loc_count = 2;
    }

    do
    {
        sprintf(db->sql_cmd, "SELECT media_id FROM %smeta_slim WHERE is_exist != ?", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return MMI_FALSE;
        }
        sqlite3_bind_kal_uint32(stmt, 1, db->Ucount);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            return MMI_TRUE;
        }
    
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        sprintf(db->sql_cmd, "SELECT vdo_id FROM %svideo WHERE is_exist != ?", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return MMI_FALSE;
        }
        sqlite3_bind_kal_uint32(stmt, 1, db->Ucount);
        ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            return MMI_TRUE;
        }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

        loc++;
    }
    while (loc < db_loc_count);

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_del_unexist_file
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_del_unexist_file(srv_plst_db_context_struct *db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;    
    U32 id;
    U8 count = 0;
    srv_plst_gen_lib_context_struct *gen;
    U32 loc = 0, db_loc_count = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    gen = (srv_plst_gen_lib_context_struct*)(((srv_plst_main_context_struct*)(db->srv_hdr))->gen); 

    if(IS_CARD_EXIST)
    {
        db_loc_count = 2;
    }

    do
    {
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        sprintf(db->sql_cmd, "SELECT vdo_id FROM %svideo WHERE is_exist != ?", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, db->Ucount);
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            ret = SRV_PLST_OK;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret_t = pls_sql_delete_video_by_video_id(db, id);
            if(ret_t != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret_t;
            }
            if(gen->cancel_gen)
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_OK;
            }
            count ++;
            if(count >= SRV_PLST_SELECT_SQL_MIN_NUM)
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_CONTINUE;
            }
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

        sprintf(db->sql_cmd, "SELECT media_id FROM %smeta_slim WHERE is_exist != ?", Sqldbloc[loc]);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, db->Ucount);
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            U32 count_t;

            ret = SRV_PLST_OK;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret_t = pls_sql_delete_media_by_media_id(db, id, &count_t);
            if(ret_t != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret_t;
            }
            if(gen->cancel_gen)
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_OK;
            }
            count += count_t;
            if(count >= SRV_PLST_SELECT_SQL_MIN_NUM)
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_CONTINUE;
            }
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);

        loc++;
    } 
    while (loc < db_loc_count);

    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_set_mark
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_set_mark(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32 is_mark)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;  
    S32 ret_value;
    S32 index_o;
    U32 id;
    const S8* loc_ptr;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /*
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST)
    {
        srv_plst_list_context_struct *list_cache;
        list_cache = &(list_view->list_cache[1]);
        id = list_cache->parent_id;

        if(id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? ORDER BY idx, media_id limit 1 OFFSET ?");
        }
        else
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? ORDER BY idx, media_id limit 1 OFFSET ?");
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        sqlite3_bind_kal_uint32(stmt, 2, index);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id = sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);

        if(ret != SRV_PLST_RET_ITEM_EXIST)
        {
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
    }
    else
    */
    {
        ret_value = pls_db_util_check_item_if_in_cache(list_view,index, &index_o);
        list_view->query_index = index;
        if(ret_value)
        {
            ret = pls_sql_get_item_to_fill_cache(db,index,ret_value,&index_o);       
        } 
        if(index_o < 0 || list_view->list_cache[list_view->current_index].cache[index_o].idx_in_list > list_view->total_count)
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        id = list_view->list_cache[list_view->current_index].cache[index_o].id;
    }

    if(IS_CARD_EXIST)
    {
        loc_ptr = Sqldb2dot;
    }
    else
    {
        loc_ptr = Sqlmaindot;
    }

    sprintf(db->sql_cmd, "SELECT * FROM %smark WHERE id = ?", loc_ptr);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        MMI_BOOL temp_mark;
        temp_mark = (MMI_BOOL)sqlite3_column_kal_uint32(stmt, 1);
        if(temp_mark == is_mark)
        {
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            sprintf(db->sql_cmd, "UPDATE %smark SET mark_flag = ? WHERE id = ?", loc_ptr);
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, is_mark);
            sqlite3_bind_kal_uint32(stmt, 2, id);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    pls_sql_finalize(stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    sprintf(db->sql_cmd, "INSERT INTO %smark(id, mark_flag) VALUES (?,?)", loc_ptr);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }    
    sqlite3_bind_kal_uint32(stmt, 1, id);
    sqlite3_bind_kal_uint32(stmt, 2, is_mark);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_mark
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_get_mark(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32* is_mark)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    S32 ret_value;
    S32 index_o;
    U32 id;
    const S8* loc_ptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /*
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST)
    {
        srv_plst_list_context_struct *list_cache;
        list_cache = &(list_view->list_cache[1]);
        id = list_cache->parent_id;

        if(id > 0X8000)
        {
            ptr = Sqlmainplstitem;
        }
        else
        {
            ptr = Sqldbplstitem;
        }
        kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM %s WHERE plst_id = ? ORDER BY idx, media_id limit 1 OFFSET ?", ptr);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        sqlite3_bind_kal_uint32(stmt, 2, index);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id = sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);

        if(ret != SRV_PLST_RET_ITEM_EXIST)
        {
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
    }
    else
    */
    {
        ret_value = pls_db_util_check_item_if_in_cache(list_view,index, &index_o);
        list_view->query_index = index;
        if(ret_value)
        {
            ret = pls_sql_get_item_to_fill_cache(db,index,ret_value,&index_o);       
        } 
        if(index_o < 0 || list_view->list_cache[list_view->current_index].cache[index_o].idx_in_list > list_view->total_count)
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        id = list_view->list_cache[list_view->current_index].cache[index_o].id;
    }

    if(IS_CARD_EXIST)
    {
        loc_ptr = Sqldb2dot;
    }
    else
    {
        loc_ptr = Sqlmaindot;
    }
    sprintf(db->sql_cmd, "SELECT mark_flag FROM %smark WHERE id = ?", loc_ptr);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        *is_mark = sqlite3_column_kal_uint32(stmt, 0);
    }
    else
    {
        if(list_view->is_unmark_all)
        {
            *is_mark = 1;
        }
        else
        {
            *is_mark = 0;
        }
    }
    pls_sql_finalize(stmt);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_read_version
 * DESCRIPTION
 *   read version info
 * PARAMETERS
 *  drv            :         [IN]   drive letter
 *  db             :         [IN]   see srv_plst_db_context_struct
 *  sec            :         [IN]   see srv_plst_security
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_read_version(U8 drv, srv_plst_db_context_struct* db, srv_plst_security* sec)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    S32 ret = SRV_PLST_OK;
    sqlite3_stmt *stmt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/     
#ifndef __MTK_TARGET__
    return SRV_PLST_OK;
#endif 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);  
    /*
        CREATE TABLE security(
            sec_id            INTEGER     PRIMARY KEY,
            ver           TEXT,
            ver_int       INTEGER,
            completed     INTEGER,
            phone_id      INTEGER,
            card_id       INTEGER,
            config_info   BLOB,                           
            artwork_width  INTEGER)                           
   */
    ret = pls_sql_prepare_ex(db, "SELECT sec_id, ver, ver_int, completed, phone_id, card_id, config_info, artwork_width FROM main.security ", &stmt);  
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
        {
            mmi_ucs2ncpy((S8*)sec->ver, (S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_MAX_TEMP_FILE_LENGTH);
        }
        else
        {
            sec->ver[0] = 0;
        }
        sec->ver_int = sqlite3_column_kal_uint32(stmt, 2);
        sec->phone_id = sqlite3_column_kal_uint32(stmt, 4);
        sec->card_id = sqlite3_column_kal_uint32(stmt, 5);
        if(sqlite3_column_blob(stmt, 6) != NULL)
        {
            memcpy((S8*)(&(sec->config)), (const S8*)sqlite3_column_blob(stmt, 6),sizeof(srv_plst_config_info_struct));        
        }   
        sec->artwork_width = sqlite3_column_kal_uint32(stmt, 7);
        
        pls_sql_finalize(stmt);
        ret = SRV_PLST_OK;
    }
    else
    {
        pls_sql_finalize(stmt); // to do check more        
        return ret;
    }

    if(base->default_plst_config != sec->config.default_list_flag ||
        base->config_view_sort_type != sec->config.view_type      ||
        base->config_sort_list_view != sec->config.list_sort      ||
        base->config_plst_view  != sec->config.plst_sort    ||
        base->config_store_play_info != sec->config.store_play_info ||
        SRV_PLST_ARTWORK_RESIZED_WIDTH != sec->artwork_width)
    {
        ret = SRV_PLST_RET_ERR_DB_CRASH;
        MMI_TRACE(TRACE_GROUP_1,MMI_PLS_PLS_CHECK_VERSION, ret, __LINE__);   
        return ret;
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(!sec->config.dual_db)
#else
    if(sec->config.dual_db)
#endif
    {
        ret = SRV_PLST_RET_ERR_DB_CRASH;
        MMI_TRACE(TRACE_GROUP_1,MMI_PLS_PLS_CHECK_VERSION, ret, __LINE__);   
        return ret;
    }
    
    /* check table if OK */
    /* audio */
    /* SELECT media_id, artist_id, album_id, genre_id, name, p_name, play_count, ordinal, ischar from audio where media_id = 1 */
    /* SELECT media_id, artist_id, album_id, genre_id, name, play_count, ordinal from audio where media_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT media_id, artist_id, album_id, genre_id, name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, ", p_name, play_count, ordinal, ischar");
    }
    else        
    {
        strcat(db->sql_cmd, ", play_count, ordinal");
    }
    strcat(db->sql_cmd," from audio where media_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    /* video */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    /* SELECT vdo_id, name, p_name, path, play_count, ordinal, is_exist, ischar from main.video where vdo_id = 1 */
    /* SELECT vdo_id, name, path, play_count, ordinal, is_exist from main.video where vdo_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd,", p_name");
    }
    strcat(db->sql_cmd,", path, play_count, ordinal, is_exist");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd,", ischar");
    }
    strcat(db->sql_cmd," from main.video where vdo_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }  
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

    /* artist */
    /* SELECT artist_id, artist_name, p_name, ischar from main.artist where artist_id = 1 */
    /* SELECT artist_id, artist_name from main.artist where artist_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd,", p_name, ischar");
    }
    strcat(db->sql_cmd," from main.artist where artist_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    
    /* album */
    //MAUI_02976962
    //Side effect of design change for album table splitting.
    //Need to modify version check logic
    /* SELECT album_id, album_name, p_name, ischar from main.album where album_id = 1 */
    /* SELECT album_id, album_name from main.album where album_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd,", p_name, ischar");
    }
    strcat(db->sql_cmd," from main.album where album_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    } 
    
    /* album artwork */
    ret = pls_sql_prepare_ex(db, "SELECT album_id, artwork, artwork_size, artwork_parser_path, filetype from  main.album_artwork where album_id = 1", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    } 

    /* genre */
    /* SELECT genre_id, genre_name, p_name, ischar from main.genre where genre_id = 1 */
    /* SELECT genre_id, genre_name from main.genre where genre_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd,", p_name, ischar");
    }
    strcat(db->sql_cmd," from main.genre where genre_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);    
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    } 

    /* meta */
    ret = pls_sql_prepare_ex(db, "SELECT media_id, user_rating from main.meta where media_id = 1", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    /* meta_slim */
    ret = pls_sql_prepare_ex(db, "SELECT media_id, path, is_exist from main.meta_slim where media_id = 1", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    
    /* plst */
    /* SELECT plst_id, plst_name, create_time from main.plst where plst_id = 1 */
    /* SELECT plst_id, plst_name from main.plst where plst_id = 1 */
    kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name");
    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        strcat(db->sql_cmd,", create_time");
    }
    strcat(db->sql_cmd," from main.plst where plst_id = 1");

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    
    /* plst_item */
    ret = pls_sql_prepare_ex(db, "SELECT plstitem_id, plst_id, idx, play_count, ordinal from main.plst_item where plstitem_id = 1", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    ret = SRV_PLST_OK;

    /* playing_info */
    if(base->config_store_play_info == SRV_PLST_PLAY_INFO_STORE ||
       base->config_store_play_info == SRV_PLST_PLAY_INFO_STORE_MANUAL )
    {
        ret = pls_sql_prepare_ex(db, "SELECT unque_id, plst_id, idx, playing_type, filtertype from main.playing_info where unque_id = 1", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret != SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return SRV_PLST_OK;
        }
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_media_for_version_wrong
 * DESCRIPTION
 *  delete media after media change
 * PARAMETERS
 *  
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_media_for_version_wrong(srv_plst_db_context_struct *db, U8 drv_letter, MMI_BOOL single_db)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    sqlite3_stmt *stmt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* For single DB case, no need to handle play list not sync problem */
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(drv_letter == SRV_FMGR_PUBLIC_DRV)
    {
        ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst_item WHERE media_id < ?", &stmt);
    }
    else
    {
        if(single_db)
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst_item WHERE media_id > ?", &stmt);
        }
        else
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM db2.plst_item WHERE media_id > ?", &stmt);
        }
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, 0X8000);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    /* set security info */
    if (drv_letter == SRV_FMGR_PUBLIC_DRV)
    {
        srv_plst_security sec;

        mmi_ucs2cpy((S8*) sec.ver, (S8*)SRV_PLST_DB_VERSION_NUM);
        sec.ver_int = med_crc_calculate((kal_uint8*  )sec.ver, mmi_ucs2strlen((S8*)sec.ver) * ENCODING_LENGTH);
        pls_db_util_get_security_info(drv_letter, &sec);    
        ret = pls_sql_prepare_ex(db, "UPDATE main.security SET card_id = ?, phone_id = ? WHERE sec_id = 1", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, sec.card_id);
        sqlite3_bind_kal_uint32(stmt, 2, sec.phone_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
    }
    else if (drv_letter == SRV_FMGR_CARD_DRV)
    {
        srv_plst_security sec;

        mmi_ucs2cpy((S8*) sec.ver, (S8*)SRV_PLST_DB_VERSION_NUM);
        sec.ver_int = med_crc_calculate((kal_uint8*  )sec.ver, mmi_ucs2strlen((S8*)sec.ver) * ENCODING_LENGTH);
        pls_db_util_get_security_info(drv_letter, &sec);    
        if(single_db || g_srv_plst_control_ptr->card_state == SRV_PLST_DRIVE_CARD_ONLY)
        {
            ret = pls_sql_prepare_ex(db, "UPDATE main.security SET card_id = ? , phone_id = ? WHERE sec_id = 1", &stmt);
        }
        else
        {
            ret = pls_sql_prepare_ex(db, "UPDATE db2.security SET card_id = ?, phone_id = ? WHERE sec_id = 1", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, sec.card_id);
        sqlite3_bind_kal_uint32(stmt, 2, sec.phone_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);        
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_crc_get_uniuqe_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  name  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static U32 pls_sql_crc_get_uniuqe_id(UI_string_type name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 input_len;
    kal_uint8 digest[16];
    //MMI_BOOL success;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(digest, 0, sizeof(digest));
    input_len = mmi_ucs2strlen((S8*)name) * 2;

    che_init(&che_context, CHE_MD5); 
    che_process(&che_context,CHE_MD5,CHE_MODE_NULL,CHE_HASH,(kal_uint8*)name,digest,input_len, KAL_TRUE);
    che_deinit(&che_context);
    return med_crc_calculate((kal_uint8*  )digest, 16); 
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_check_id_exist_by_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_check_id_exist_by_id(srv_plst_db_context_struct *db, MMI_BOOL is_inphone, srv_plst_id_enum id_type , U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_inphone)
    {
        switch (id_type)
        {
            case SRV_PLST_ARTIST_ID:
                //ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ? limit 1", &stmt);
                ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_MAIN_ARTIST, &stmt, NULL);
                break;

            case SRV_PLST_ALBUM_ID:
                //ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE album_id = ? limit 1", &stmt);
                ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_MAIN_ALBUM, &stmt, NULL);
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_GENRE_ID:
                 //ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM main.genre WHERE genre_id = ? limit 1", &stmt);
                 ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_MAIN_GENRE, &stmt, NULL);
                 break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

            default:
                ret = SRV_PLST_OK;
        }
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else 
    {
        switch (id_type)
        {
            case SRV_PLST_ARTIST_ID:
                //ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM db2.artist WHERE artist_id = ? limit 1", &stmt);
                ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTIST_NAME_BY_ID_DB2_ARTIST, &stmt, NULL);
                break;

            case SRV_PLST_ALBUM_ID:
                //ret = pls_sql_prepare_ex(db, "SELECT album_name FROM db2.album WHERE album_id = ? limit 1", &stmt);
                ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ALBUM_NAME_BY_ID_DB2_ALBUM, &stmt, NULL);
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_GENRE_ID:
                 //ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM db2.genre WHERE genre_id = ? limit 1", &stmt);
                 ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_GENRE_NAME_BY_ID_DB2_GENRE, &stmt, NULL);
                 break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

            default:
                ret = SRV_PLST_OK;
        }

    }
#endif /*__PLST_DUAL_DB_SUPPORT__*/
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_check_id_if_exist_by_text
 * DESCRIPTION
 *   check id if exist
 * PARAMETERS
 *  db             :         [IN]   see srv_plst_db_context_struct
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_check_id_if_exist_by_text(srv_plst_db_context_struct *db, UI_string_type name, MMI_BOOL is_inphone, srv_plst_id_enum id_type , U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if (is_inphone)
    {
        switch (id_type)
        {
            case SRV_PLST_ARTIST_ID:
                ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM main.artist WHERE artist_name = ?", &stmt);
                break;

            case SRV_PLST_ALBUM_ID:
                ret = pls_sql_prepare_ex(db, "SELECT album_id FROM main.album WHERE album_name = ?", &stmt);
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_GENRE_ID:
                 ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM main.genre WHERE genre_name = ?", &stmt);
                 break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

            default:
                ret = SRV_PLST_OK;
        }
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        switch (id_type)
        {
            case SRV_PLST_ARTIST_ID:
                ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM db2.artist WHERE artist_name = ?", &stmt);
                break;

            case SRV_PLST_ALBUM_ID:
                ret = pls_sql_prepare_ex(db, "SELECT album_id FROM db2.album WHERE album_name = ?", &stmt);
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_GENRE_ID:
                 ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM db2.genre WHERE genre_name = ?", &stmt);
                 break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

            default:
                ret = SRV_PLST_OK;
        }

    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    ret = pls_sql_step_ex(db, stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        *id = sqlite3_column_kal_uint32(stmt, 0);
    }
    pls_sql_finalize(stmt);
    return ret;
}



/*****************************************************************************
 * FUNCTION
 *  pls_sql_check_file_is_exist
 * DESCRIPTION
 *   add  file to db
 * PARAMETERS
 *  base           :         [IN]   srv_plst_base_info_struct
 *  path           :         [IN]   filepath
 *  is_short       :         [IN]   is_short
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_check_file_is_exist(srv_plst_base_info_struct* base, UI_string_type path, UI_string_type file_ext, MMI_BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_db_context_struct *db;
    S32 ret = SRV_PLST_OK;
    MMI_BOOL is_video = MMI_FALSE;
    MMI_BOOL is_inphone = MMI_FALSE;
    U32 id = 0;
    U32 stmt_id = PLS_SQL_STMT_NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);     

#if defined(__PLST_DUAL_DB_SUPPORT__)
    is_video = pls_db_util_get_if_is_video(file_ext);
    is_inphone = pls_db_util_check_if_in_phone(path);

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if (is_video)
    {
        if(is_inphone)
        {
            ret = pls_sql_prepare_ex(db, "SELECT vdo_id FROM main.video Where path = ? limit 1", &stmt);
        }
        else
        {
            ret = pls_sql_prepare_ex(db, "SELECT vdo_id FROM db2.video Where path = ? limit 1",&stmt);
        }
    } 
    else
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
    {
        if(is_inphone)
        {
            //ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.meta_slim Where path = ? limit 1",&stmt);
            stmt_id = PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_MAIN_AUDIO;
            ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);
        }
        else
        {
            //ret = pls_sql_prepare_ex(db, "SELECT media_id FROM db2.meta_slim Where path = ? limit 1",&stmt);
            stmt_id = PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_DB2_AUDIO;
            ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);
        }
    } 
#else /*__PLST_DUAL_DB_SUPPORT__*/
    //ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.meta_slim Where path = ? limit 1",&stmt);
    stmt_id = PLS_SQL_STMT_SELECT_MEDIA_ID_BY_PATH_MAIN_AUDIO;
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);
#endif /*__PLST_DUAL_DB_SUPPORT__*/

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, path);
    ret = pls_sql_step_ex(db, stmt);
    if (ret ==  SRV_PLST_RET_ITEM_EXIST)
    {
        id = sqlite3_column_kal_uint32(stmt, 0);
    }
    else
    {
        id = 0;
    }  
    //pls_sql_finalize(stmt);
    pls_sql_finalize_or_clear_binding(stmt, stmt_id);

    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        S32 ret_t;

        stmt_id = PLS_SQL_STMT_NULL;
        if (base->is_refresh && id)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            if (is_video && is_inphone)
            {
                if(is_inphone)
                {
                    ret_t = pls_sql_prepare_ex(db, "UPDATE main.video SET is_exist = ? WHERE vdo_id = ?",&stmt);
                }
                else
                {
                    ret_t = pls_sql_prepare_ex(db, "UPDATE db2.video SET is_exist = ? WHERE vdo_id = ?", &stmt);
                }
            }
            else
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            {
                if(is_inphone)
                {
                    //ret_t = pls_sql_prepare_ex(db, "UPDATE main.meta_slim SET is_exist = ? WHERE media_id = ?", &stmt);
                    stmt_id = PLS_SQL_STMT_UPDATE_MAIN_META_SLIM_IS_EXIST_BY_ID;
                    ret_t = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);    
                }
                else
                {
                    //ret_t = pls_sql_prepare_ex(db, "UPDATE db2.meta_slim SET is_exist = ? WHERE media_id = ?", &stmt);
                    stmt_id = PLS_SQL_STMT_UPDATE_DB2_META_SLIM_IS_EXIST_BY_ID;
                    ret_t = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);    
                }
            }
        #else /*__PLST_DUAL_DB_SUPPORT__*/
            //ret_t = pls_sql_prepare_ex(db, "UPDATE main.meta_slim SET is_exist = ? WHERE media_id = ?", &stmt);
            stmt_id = PLS_SQL_STMT_UPDATE_MAIN_META_SLIM_IS_EXIST_BY_ID;
            ret_t = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, NULL);    
        #endif /*__PLST_DUAL_DB_SUPPORT__*/
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt, 1, db->Ucount);
            sqlite3_bind_kal_uint32(stmt, 2, id);
            ret_t = pls_sql_step_ex(db, stmt);

            //pls_sql_finalize(stmt);
            pls_sql_finalize_or_clear_binding(stmt,stmt_id);
            
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }               
        }                                      
        return ret;
    }            
    return ret;
}

static MMI_BOOL pls_sql_util_ischar(UI_string_type string)
{
    MMI_BOOL ret = MMI_TRUE;

    if(mmi_ucs2strlen((S8*)string))
    {
        if((string[0] >= 65 && string[0] <= 90) || 
            (string[0] >= 97 && string[0] <= 122))
        {
            return MMI_FALSE;
        }
    }
    return ret;
}

static S32 pls_sql_append_insert_meta_table(srv_plst_base_info_struct *base, MMI_BOOL is_inphone, srv_plst_id_enum id_type, UI_string_type string, U32 id)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_db_context_struct *db;
    S32 ret;
    U32 stmt_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);

    /* INSERT INTO main.artist(artist_id, artist_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO db2.artist(artist_id, artist_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO main.artist(artist_id, artist_name) VALUES (?,?) */
    /* INSERT INTO db2.artist(artist_id, artist_name) VALUES (?,?) */
    /* INSERT INTO main.album(album_id, album_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO db2.album(album_id, album_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO main.album(album_id, album_name) VALUES (?,?) */
    /* INSERT INTO db2.album(album_id, album_name) VALUES (?,?) */
    /* INSERT INTO main.genre(genre_id, genre_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO db2.genre(genre_id, genre_name, p_name, ischar) VALUES (?,?,?,?) */
    /* INSERT INTO main.genre(genre_id, genre_name) VALUES (?,?) */
    /* INSERT INTO db2.genre(genre_id, genre_name) VALUES (?,?) */

    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_MAIN_ARTIST_ALBUM_GENRE;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_DB2_ARTIST_ALBUM_GENRE;
    }

    switch(id_type)
    {
        case SRV_PLST_ARTIST_ID:
            strcat(db->sql_cmd, ".artist(artist_id, artist_name");
            stmt_id = stmt_id + 1; /* PLS_SQL_STMT_INSERT_MAIN_ARTIST, PLS_SQL_STMT_INSERT_DB2_ARTIST */
            break;
        case SRV_PLST_ALBUM_ID:
            strcat(db->sql_cmd, ".album(album_id, album_name");
            stmt_id = stmt_id + 3; /* PLS_SQL_STMT_INSERT_MAIN_ALBUM, PLS_SQL_STMT_INSERT_DB2_ALBUM */
            break;
        case SRV_PLST_GENRE_ID:
            strcat(db->sql_cmd, ".genre(genre_id, genre_name");
            stmt_id = stmt_id + 5; /*PLS_SQL_STMT_INSERT_MAIN_GENRE, PLS_SQL_STMT_INSERT_DB2_GENRE */
            break;
        default:
            ASSERT(0);
            break;
    }

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, ", p_name, ischar");
        /*PLS_SQL_STMT_INSERT_MAIN_ARTIST_PINYIN*/
        /*PLS_SQL_STMT_INSERT_MAIN_ALBUM_PINYIN*/
        /*PLS_SQL_STMT_INSERT_MAIN_GENRE_PINYIN*/
        /*PLS_SQL_STMT_INSERT_DB2_ARTIST_PINYIN*/
        /*PLS_SQL_STMT_INSERT_DB2_ALBUM_PINYIN*/
        /*PLS_SQL_STMT_INSERT_DB2_GENRE_PINYIN*/        
        stmt_id = stmt_id + 1;
    }
    strcat(db->sql_cmd, ") VALUES");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, " (?,?,?,?)");
    }
    else
    {
        strcat(db->sql_cmd, " (?,?)");
    }

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    sqlite3_bind_kal_uint32(stmt, 1, id);
    sqlite3_bind_kal_wstr(stmt, 2, string);
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        U16 temp_string[SRV_PLST_META_INFO_MAX_LEN + 1];
        U32 count = 0;

        temp_string[0] = 0;
        if(pls_check_ucs2_character(string))
        {
            count = pls_db_util_convert_to_pingyin(string, temp_string, SRV_PLST_META_INFO_MAX_LEN);
            temp_string[count++] = 0x00;
        }
        else
        {
            mmi_ucs2ncpy((S8*)temp_string, (S8*)string, SRV_PLST_META_INFO_MAX_LEN);
        }

        sqlite3_bind_kal_wstr(stmt,3, temp_string);
        sqlite3_bind_kal_uint8(stmt, 4, pls_sql_util_ischar(temp_string));
    }

    ret = pls_sql_step_ex(db, stmt);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    return ret;
}

static S32 pls_sql_append_insert_album_artwork(srv_plst_base_info_struct *base, MMI_BOOL is_inphone, void* resized_data, U32 resized_size, U32 id, UI_string_type artwork_parser_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_db_context_struct *db;
    S32 ret;
    U32 stmt_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);     

    /* INSERT INTO main.album_artwork(album_id, artwork, artwork_size, artwork_parser_path, filetype) VALUES (?, ?, ?, ?, ?) */
    /* INSERT INTO db2.album_artwork(album_id, artwork, artwork_size, artwork_parser_path, filetype) VALUES (?, ?, ?, ?, ?) */
    
    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_MAIN_ALBUM_ARTWORK;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_DB2_ALBUM_ARTWORK;
    }
    strcat(db->sql_cmd, ".album_artwork(album_id, artwork, artwork_size, artwork_parser_path, filetype) VALUES (?, ?, ?, ?, ?)");

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    sqlite3_bind_blob(stmt, 2, resized_data, resized_size, SQLITE_STATIC);
    sqlite3_bind_kal_uint32(stmt,3, resized_size);
    sqlite3_bind_kal_wstr(stmt, 4, artwork_parser_path);
    sqlite3_bind_kal_uint32(stmt, 5, META_TAG_IMG_JPG); 
    ret = pls_sql_step_ex(db, stmt);    
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    return ret;
}

static S32 pls_sql_append_insert_audio(srv_plst_base_info_struct *base, MMI_BOOL is_inphone, UI_string_type path, 
                           U32 artist_id, U32 album_id, U32 genre_id, srv_plst_media_details_struct *details, UI_string_type file_ext)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_db_context_struct *db;
    S32 ret;
    U32 media_id = 0;
    U32 id;
    U32 stmt_id = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);

    /* SELECT MAX(media_id) FROM main.audio */
    /* SELECT MAX(media_id) FROM db2.audio */
    
    kal_sprintf(db->sql_cmd, "SELECT MAX(media_id) FROM");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main.audio");
        stmt_id = PLS_SQL_STMT_SELECT_MAX_MEDIA_ID_MAIN_AUDIO;
    }
    else
    {
        strcat(db->sql_cmd, " db2.audio");
        stmt_id = PLS_SQL_STMT_SELECT_MAX_MEDIA_ID_DB2_AUDIO;
    }
    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
        return ret;
    }
    id = sqlite3_column_kal_uint32(stmt, 0);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);

    /* add media_id to audio*/
    /* INSERT INTO main.audio(media_id, artist_id, album_id, genre_id, name, p_name, track_num, ischar) VALUES (?,?,?,?,?,?,?,?) */
    /* INSERT INTO db2.audio(media_id, artist_id, album_id, genre_id, name, p_name, track_num, ischar) VALUES (?,?,?,?,?,?,?,?) */
    /* INSERT INTO main.audio(media_id, artist_id, album_id, genre_id, name) VALUES (?,?,?,?,?) */
    /* INSERT INTO db2.audio(media_id, artist_id, album_id, genre_id, name) VALUES (?,?,?,?,?) */

    stmt_id = 0;
    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_MAIN_AUDIO;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_DB2_AUDIO;
    }
    strcat(db->sql_cmd, ".audio(media_id, artist_id, album_id, genre_id, name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, ", p_name, track_num, ischar");
        stmt_id = stmt_id + 1; /* PLS_SQL_STMT_INSERT_INTO_MAIN_AUDIO_PINYIN, PLS_SQL_STMT_INSERT_INTO_DB2_AUDIO_PINYIN */
    }
    strcat(db->sql_cmd, ") VALUES");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, " (?,?,?,?,?,?,?,?)");
    }
    else
    {
        strcat(db->sql_cmd, " (?,?,?,?,?)");
    }

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    media_id = id +1;
    if (is_inphone)
    {
        media_id = media_id | 0X8000;
    }
    else
    {
        media_id = media_id & 0X7FFF;
    }
    sqlite3_bind_kal_uint32(stmt, 1, media_id);
    sqlite3_bind_kal_uint32(stmt, 2, artist_id);;
    sqlite3_bind_kal_uint32(stmt, 3, album_id);
    sqlite3_bind_kal_uint32(stmt, 4, genre_id);
    
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        U16 temp_string[SRV_PLST_META_INFO_MAX_LEN + 1];
        U32 count = 0;
        temp_string[0] = 0;
        if(pls_check_ucs2_character(details->title))
        {
           count = pls_db_util_convert_to_pingyin(details->title, temp_string, SRV_PLST_META_INFO_MAX_LEN);
           temp_string[count++] = 0x00;
        }
        else
        {
            mmi_ucs2ncpy((S8*)temp_string, (S8*)details->title, SRV_PLST_META_INFO_MAX_LEN);
        }

        sqlite3_bind_kal_wstr(stmt, 5, details->title);
        sqlite3_bind_kal_wstr(stmt, 6, temp_string);
        if(details->track_num < 0)
        {
            sqlite3_bind_kal_uint16(stmt, 7, 65535); /* U16 */
        }
        else
        {
            sqlite3_bind_kal_uint16(stmt, 7, details->track_num);
        }
        sqlite3_bind_kal_uint8(stmt, 8, pls_sql_util_ischar(temp_string));
    }
    else
    {    
        if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
        {
            sqlite3_bind_kal_wstr(stmt, 5, details->filename);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 5, details->title);
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
        return ret;
    }
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);


    /*  add media_id to meta*/
    /* INSERT INTO main.meta(media_id, title, copyrights, description, author, year, track_num, artwork_type, volume, user_rating, bits_rate, sample_rate, sample_bits, duration) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?) */
    /* INSERT INTO db2.meta(media_id, title, copyrights, description, author, year, track_num, artwork_type, volume, user_rating, bits_rate, sample_rate, sample_bits, duration) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?) */

#ifdef __COSMOS_MMI_PACKAGE__
    /* For cosmos mmi, only insert required meta info (duration for current design) to enhance performance*/
    /* Double check pls_sql_update_view_details(), pls_sql_get_view_details() when revise */

    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_MAIN_META;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_DB2_META;
    }
    strcat(db->sql_cmd, ".meta(media_id, duration) VALUES (?,?)");

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, media_id);
    sqlite3_bind_kal_uint32(stmt, 2, details->duration);
    ret = pls_sql_step_ex(db,stmt);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

#else /* __COSMOS_MMI_PACKAGE__ */

    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_MAIN_META;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_DB2_META;
    }
    strcat(db->sql_cmd, ".meta(media_id, title, copyrights, description, author, year, track_num, artwork_type, volume, user_rating, bits_rate, sample_rate, sample_bits, duration) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)");

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, media_id);
    if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
    {
        sqlite3_bind_kal_wstr(stmt, 2, details->title);
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 2, details->filename);
    }
    sqlite3_bind_kal_wstr(stmt, 3, details->copyrights);
    sqlite3_bind_kal_wstr(stmt, 4, details->description);
    sqlite3_bind_kal_wstr(stmt, 5, details->author);
    sqlite3_bind_kal_uint32(stmt, 6, details->year);
    sqlite3_bind_kal_uint16(stmt, 7, details->track_num);
    sqlite3_bind_kal_uint32(stmt, 8, details->artwork_type);
    sqlite3_bind_kal_uint32(stmt, 9, details->volume);
    sqlite3_bind_kal_uint32(stmt, 10, details->user_rating);
    sqlite3_bind_kal_uint32(stmt, 11, details->bits_rate);
    sqlite3_bind_kal_uint16(stmt, 12, details->sample_rate);
    sqlite3_bind_kal_uint8(stmt, 13,details->channel_num);
    sqlite3_bind_kal_uint32(stmt, 14, details->duration);
    ret = pls_sql_step_ex(db,stmt);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);    
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
#endif /* __COSMOS_MMI_PACKAGE__ */
    
    /*  add media_id to meta_slim*/
    /* INSERT INTO main.meta_slim(media_id, path, is_exist) VALUES (?,?,?) */
    /* INSERT INTO db2.meta_slim(media_id, path, is_exist) VALUES (?,?,?) */
    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_MAIN_META_SLIM;
    }
    else
    {
        strcat(db->sql_cmd, " db2");
        stmt_id = PLS_SQL_STMT_INSERT_INTO_DB2_META_SLIM;
    }
    strcat(db->sql_cmd, ".meta_slim(media_id, path, is_exist) VALUES (?,?,?)");

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, media_id);
    sqlite3_bind_kal_wstr(stmt, 2, path);
    sqlite3_bind_kal_uint8(stmt, 3, db->Ucount);
    ret = pls_sql_step_ex(db,stmt);
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }    
    return ret;
}

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
S32 pls_sql_append_insert_video(srv_plst_base_info_struct *base, MMI_BOOL is_inphone, UI_string_type path, UI_string_type title, U32 file_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_db_context_struct *db;
    S32 ret;
    U32 id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);     

    /* SELECT MAX(vdo_id) FROM main.video */
    /* SELECT MAX(vdo_id) FROM db2.video */

    kal_sprintf(db->sql_cmd, "SELECT MAX(vdo_id) FROM");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main.video");
    }
    else
    {
        strcat(db->sql_cmd, " db2.video");
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if (ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db,stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        id = sqlite3_column_kal_uint32(stmt, 0);
    }
    else 
    {
        id = 0;
    }
    if(is_inphone && id == 0)
    {
        id = id + 0X8000;
    }
    pls_sql_finalize(stmt);

    /* add */

    /* INSERT INTO main.video(vdo_id, path, is_short, name, p_name, format, is_exist) VALUES (?,?,?,?,?,?,?) */
    /* INSERT INTO db2.video(vdo_id, path, is_short, name, p_name, format, is_exist) VALUES (?,?,?,?,?,?,?) */
    /* INSERT INTO main.video(vdo_id, path, is_short, name, format, is_exist) VALUES (?,?,?,?,?,?) */
    /* INSERT INTO db2.video(vdo_id, path, is_short, name, format, is_exist) VALUES (?,?,?,?,?,?) */

    kal_sprintf(db->sql_cmd, "INSERT INTO");
    if(is_inphone)
    {
        strcat(db->sql_cmd, " main");
    }
    else
    {
        strcat(db->sql_cmd, " db2");
    }
    strcat(db->sql_cmd, ".video(vdo_id, path, is_short, name");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, ", p_name");
    }
    strcat(db->sql_cmd, ", format, is_exist) VALUES");
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        strcat(db->sql_cmd, " (?,?,?,?,?,?,?)");
    }
    else
    {
        strcat(db->sql_cmd, " (?,?,?,?,?,?)");
    }
    
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if (ret != SRV_PLST_OK)
    {
        return ret;
    }

    sqlite3_bind_kal_uint32(stmt, 1, id+1);
    sqlite3_bind_kal_wstr(stmt, 2, path);
    sqlite3_bind_kal_uint8(stmt, 3, 0);
    sqlite3_bind_kal_wstr(stmt, 4, title);

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        U16 temp_string[SRV_PLST_META_INFO_MAX_LEN + 1];
        U32 count = 0;
        temp_string[0] = 0;
        if(pls_check_ucs2_character(title))
        {
           count = pls_db_util_convert_to_pingyin(title, temp_string, SRV_PLST_META_INFO_MAX_LEN);
           temp_string[count++] = 0x00;
        }
        else
        {
            mmi_ucs2ncpy((S8*)temp_string, (S8*)title, SRV_PLST_META_INFO_MAX_LEN);
        }
        sqlite3_bind_kal_wstr(stmt, 5, temp_string);
        sqlite3_bind_kal_uint8(stmt, 6, file_type);
        sqlite3_bind_kal_uint8(stmt, 7, db->Ucount);
    }    
    else
    {
        sqlite3_bind_kal_uint8(stmt, 5, file_type);
        sqlite3_bind_kal_uint8(stmt, 6, db->Ucount);
    }

    ret = pls_sql_step_ex(db,stmt);
    pls_sql_finalize(stmt);
    return ret;
}
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */

/*****************************************************************************
 * FUNCTION
 *  pls_sql_append_file_to_db
 * DESCRIPTION
 *   add  file to db
 * PARAMETERS
 *  db             :         [IN]   srv_plst_db_context_struct
 *  path           :         [IN]   filepath
 *  is_short       :         [IN]   is_short
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_append_file_to_db(srv_plst_base_info_struct *base, UI_string_type path, UI_string_type file_ext,MMI_BOOL is_short)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 artist_id = 0;
    U32 album_id = 0;
    U32 genre_id = 0;
    S32 ret = SRV_PLST_OK;
    srv_plst_media_details_struct *details;
    srv_plst_gen_lib_context_struct *gen;
    srv_plst_db_context_struct *db;
    srv_plst_list_view_history_struct *list_view;
    U32 file_type = pls_db_util_get_file_type(file_ext);
    MMI_BOOL  is_video = pls_db_util_get_if_is_video(file_ext);
#if defined(__PLST_DUAL_DB_SUPPORT__)
    MMI_BOOL  is_inphone = pls_db_util_check_if_in_phone(path);
#else
    MMI_BOOL  is_inphone = MMI_TRUE; /* Set this flag to true to use main db */
#endif
    void* resized_data = NULL;
    void* row_data = NULL;
    U32 left_size;
    S32 resized_size = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    PTGB_START_3();
    db = (srv_plst_db_context_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->db_info);     
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(base->srv_handle))->list_view_history);
    gen = (srv_plst_gen_lib_context_struct*)(((srv_plst_main_context_struct*)(base->srv_handle))->gen);

    ret = pls_sql_check_file_is_exist(base, path,file_ext, is_short);

    PTGB_END_3();
    if (ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        PTGB_ITEM_REPORT();
        return ret;
    }
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        PTGB_ITEM_REPORT();
        return SRV_PLST_OK;
    }
    if(gen)
    {
        if(gen->run_type == SRV_PLST_GEN_ADD)
        {
            if((list_view->view_type[0] == SRV_PLST_VIEW_AUDIO && !is_video) ||
                (list_view->view_type[0] == SRV_PLST_VIEW_VIDEO && is_video))
            {
                gen->update_num ++;
            }
            else
            {
                return SRV_PLST_OK;
            }
        }
        else
        {
            gen->update_num++;
        }
    }
    /*  the path is not exist in db, add */
    details =  (srv_plst_media_details_struct*)kal_adm_alloc(base->create.mem_ptr,
                                          sizeof(srv_plst_media_details_struct));

    if (details == NULL)
    {
        return SRV_PLST_RET_ERR_MEMORY_NOT_ENOUGH;
    }
 
    PTGB_START_2();

    if (!is_video)
    {        
        meta_tag_img_info_struct image_info_p;
        
        PTGB_START_1();
 
        memset(details, 0, sizeof(srv_plst_media_details_struct));
        memset(&image_info_p, 0 , sizeof(meta_tag_img_info_struct));
        if(base->temp_memory_ptr)
        {
            resized_data = NULL;
            row_data = NULL;
            resized_data = (void*)(*(U32*)base->temp_memory_ptr);
            row_data = (void*)(*(S32*)base->temp_memory_ptr + SRV_PLS_MIN_ARTWORK_SIZE);  
            left_size = base->temp_memory_size - SRV_PLS_MIN_ARTWORK_SIZE;                    
            memset(row_data, 0 , left_size);
            memset(resized_data, 0 , SRV_PLS_MIN_ARTWORK_SIZE);
        }
        else
        {
            left_size = 0;
        }
        ret = pls_db_util_get_meta_parser_all(base, path, details, row_data, left_size, &image_info_p);
        if(gen->cancel_gen)
        {
            kal_adm_free(base->create.mem_ptr, details);
            return SRV_PLST_RET_CANCEL_ACTION;
        }
        PTGB_END_1();
        if(ret != SRV_PLST_OK)/* parser failed */
        {
            PS8 filename_ptr = NULL;
          
            filename_ptr = mmi_ucs2rchr((PS8)path, (U16)(L'\\'));
            if (filename_ptr == NULL)
            {
                details->filename[0] = 0;
            }
            else
            {
                //srv_fmgr_fileinfo_struct   file_info1;
                //srv_fmgr_fs_path_get_fileinfo((WCHAR*)path, &file_info1);
                mmi_ucs2ncpy((PS8)details->filename, (filename_ptr + 2), SRV_PLST_META_INFO_MAX_LEN - 1);
            }                 
            srv_fmgr_path_hide_extension((WCHAR*)((PS8)details->filename));
            pls_db_util_get_filename_as_title(path, details->title, META_TAG_FRAME_MAX_LEN + 1);

            /* Set these filed to empty and fill default string below */
            memset(details->artist, 0 , 2);
            memset(details->album, 0 , 2);
            memset(details->genre, 0 , 2);
            row_data = 0;/* no artwork */
        }  
        while(1)
        {
            /* artist */
            /* Change empty string to unknown according to language */
            if (mmi_ucs2strlen((S8*)details->artist) == 0)
            {
                mmi_ucs2ncpy((S8*)details->artist, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_ARTIST), META_TAG_FRAME_MAX_LEN);
            }
            artist_id = pls_sql_crc_get_uniuqe_id(details->artist);

            ret = pls_sql_check_id_exist_by_id(db, is_inphone, SRV_PLST_ARTIST_ID, artist_id);
            if(ret == SRV_PLST_OK)
            {
                ret = pls_sql_append_insert_meta_table(base, is_inphone, SRV_PLST_ARTIST_ID, details->artist, artist_id);  
                if(ret != SRV_PLST_OK)
                {
                    break;
                } 
            }
            else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                break;
            }

            /* album */
            {               
                /* Change empty string to unknown according to language */
                if (mmi_ucs2strlen((S8*)details->album) == 0)
                {
                    mmi_ucs2ncpy((S8*)details->album, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_ALBUM), META_TAG_FRAME_MAX_LEN);
                }
                album_id = pls_sql_crc_get_uniuqe_id(details->album);

                ret = pls_sql_check_id_exist_by_id(db, is_inphone, SRV_PLST_ALBUM_ID, album_id);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    break;
                }
                else if(ret == SRV_PLST_OK)
                {
                    U16*    temp_path = path;
                    U16     empty_path[2] = {0,0};
                    if(base->temp_memory_ptr && row_data)
                    {
                        PTGB_START_1();
                        ret = pls_db_util_resize_artwork(&image_info_p, row_data, left_size, resized_data, &resized_size);
                        if(resized_size < 0 || ret != SRV_PLST_OK)
                        {
                            resized_data = 0;
                            resized_size = 0;
                            temp_path = empty_path;
                        }

                        if (ret != SRV_PLST_OK)
                        {
                            resized_size = 0;
                            resized_data = NULL; 
                            row_data = NULL;
                            temp_path = empty_path;
                        } 
                        PTGB_END_1();
                    }
                    else if(row_data == NULL)
                    {
                        resized_size = 0;
                        resized_data = NULL; 
                        temp_path = empty_path;
                    }
                    
                    ret = pls_sql_append_insert_meta_table(base, is_inphone, SRV_PLST_ALBUM_ID, details->album, album_id);
                    if(ret == SRV_PLST_OK)
                    {
                        ret = pls_sql_append_insert_album_artwork(base, is_inphone, resized_data, resized_size, album_id, temp_path);
                        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_APPEND_FILE_TO_DB_IMAGE, ret, __LINE__);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR && db->err_code == SQLITE_NOMEM)
                        {
                            kal_adm_free(base->create.mem_ptr, details);
                            return ret;
                        }
                    }
                }
                else if(ret == SRV_PLST_RET_ITEM_EXIST)/* check if artwork exist */
                {
                    U16*    temp_path = path;
                    U16     empty_path[2] = {0,0};
                    sqlite3_stmt *stmt;
                    U32 temp_size;
                    if(is_inphone) 
                    {
                        //ret = pls_sql_prepare_ex(db, "SELECT artwork_size from main.album_artwork WHERE album_id = ?",  &stmt);
                        ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_MAIN_ALBUM_ART, &stmt, NULL);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)                    
                    else
                    {
                        //ret = pls_sql_prepare_ex(db, "SELECT artwork_size from db2.album_artwork WHERE album_id = ?",  &stmt);
                        ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTSIZE_BY_ID_DB2_ALBUM_ART, &stmt, NULL);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    if(ret != SRV_PLST_OK)
                    {
                        kal_adm_free(base->create.mem_ptr, details);
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, album_id);
                    ret = pls_sql_step_ex(db,stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        //pls_sql_finalize(stmt);
                        pls_sql_clear_binding(stmt);
                        break;
                    }
                    else
                    {
                        temp_size = sqlite3_column_kal_uint32(stmt, 0);
                        //pls_sql_finalize(stmt);
                        pls_sql_clear_binding(stmt);
                        ret = SRV_PLST_OK;

                        /* update artwork if artwork_size is null, or else it will skip and do nothing */
                        if(!temp_size && base->temp_memory_ptr && row_data)
                        {
                            PTGB_START_1();
                            ret = pls_db_util_resize_artwork(&image_info_p, row_data, left_size, resized_data, &resized_size);
                            if(resized_size < 0 || ret != SRV_PLST_OK)
                            {                            
                                resized_size = 0;
                                temp_path = empty_path;
                            }
                            if (ret != SRV_PLST_OK)
                            {
                                resized_size = 0;
                                resized_data = NULL; 
                                row_data = NULL;
                                temp_path = empty_path;
                            } 

                            PTGB_END_1();                                
                            sprintf(db->sql_cmd, "UPDATE main.album_artwork set artwork = ?, artwork_size = ? , artwork_parser_path = ? WHERE album_id = ?");
                            //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                            ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_UPDATE_MAIN_ALBUM_ART, &stmt, db->sql_cmd);
                            if(ret != SRV_PLST_OK)
                            {
                                kal_adm_free(base->create.mem_ptr, details);
                                return ret;
                            }
                            sqlite3_bind_blob(stmt, 1, resized_data, resized_size, SQLITE_STATIC);
                            sqlite3_bind_kal_uint32(stmt, 2, resized_size);
                            sqlite3_bind_kal_wstr(stmt, 3, temp_path);
                            sqlite3_bind_kal_uint32(stmt, 4,album_id);
                            ret = pls_sql_step_ex(db,stmt);
                            //pls_sql_finalize(stmt);
                            pls_sql_clear_binding(stmt);
                            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                            {
                                break;
                            }
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd, "UPDATE db2.album_artwork set artwork = ?, artwork_size = ? , artwork_parser_path = ? WHERE album_id = ?");
                                //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                                ret = pls_sql_stmt_cache_prepare(db,PLS_SQL_STMT_UPDATE_DB2_ALBUM_ART, &stmt, db->sql_cmd);
                                if(ret != SRV_PLST_OK)
                                {
                                    kal_adm_free(base->create.mem_ptr, details);
                                    return ret;
                                }
                                sqlite3_bind_blob(stmt, 1, resized_data, resized_size, SQLITE_STATIC);
                                sqlite3_bind_kal_uint32(stmt, 2, resized_size);
                                sqlite3_bind_kal_wstr(stmt, 3, temp_path);
                                sqlite3_bind_kal_uint32(stmt, 4, album_id);
                                ret = pls_sql_step_ex(db,stmt);    
                                //pls_sql_finalize(stmt);
                                pls_sql_clear_binding(stmt);
                                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                                {
                                    break;
                                }                                                                 
                            } /* update artwork */
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }/*end of find artwork*/                            
                    }/* udpate artwork */        
                }/* album id exist */
                }/* album end */

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            /*genre*/
            /* Change empty string to unknown according to language */
            if (mmi_ucs2strlen((S8*)details->genre) == 0)
            {
                mmi_ucs2ncpy((S8*)details->genre, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_GENRE), META_TAG_FRAME_MAX_LEN);
            }
            genre_id = pls_sql_crc_get_uniuqe_id(details->genre);

            ret = pls_sql_check_id_exist_by_id(db, is_inphone, SRV_PLST_GENRE_ID, genre_id);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                break;
            }
            else if(ret == SRV_PLST_OK )
            {
                ret = pls_sql_append_insert_meta_table(base, is_inphone, SRV_PLST_GENRE_ID, details->genre, genre_id);
                if(ret != SRV_PLST_OK)
                {
                    break;
                }
            }
            /* genre end */
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

            ret = pls_sql_append_insert_audio(base, is_inphone, path, artist_id, album_id, genre_id, details, file_ext);
                break;
            } /* while end */
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else  /* add to video table */
    {
        pls_db_util_get_filename_as_title(path, details->title, SRV_PLST_META_INFO_MAX_LEN + 1);
        ret = pls_sql_append_insert_video(base, is_inphone, path, details->title, file_type);        
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    PTGB_END_2();
    PTGB_ITEM_REPORT();
    kal_adm_free(base->create.mem_ptr, details);
    details = NULL;
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_predefine_list_count
 * DESCRIPTION
 *  get number of default play list (favorite, most played, recently played)
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static S32 pls_sql_get_predefine_list_count(srv_plst_db_context_struct *db, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *play_info;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    U32 count_p = 0;
    S32 ret = SRV_PLST_OK;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    play_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    //MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_ONE, view_type, g_srv_plst_control_ptr->card_state);

    sprintf(db->sql_cmd, "SELECT COUNT(plst_id) FROM main.plst WHERE plst_name = \"\"");
    
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        count_p = sqlite3_column_kal_int32(stmt,0);
    }
    pls_sql_finalize(stmt);

    *count = count_p;
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_playlist_item_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_playlist_item_count(srv_plst_db_context_struct *db, U32 plst_id, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/   
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(plst_id <= 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM db2.plst_item WHERE plst_id = ?", &stmt);
    }
    else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    {
        ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id = ?", &stmt);
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, plst_id);
    ret = pls_sql_step_ex(db,stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        *count = sqlite3_column_kal_uint32(stmt, 0);
    }
    else
    {
        *count = 0;
    }
    pls_sql_finalize(stmt);   
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_default_list_count
 * DESCRIPTION
 *  Get active play list count
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_get_default_list_count(srv_plst_db_context_struct *db,srv_plst_playing_context_struct *play_info, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
#ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
#endif
        )
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM video ");
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt); 
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }             

        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video");
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count += sqlite3_column_kal_uint32(stmt, 0);;
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);    
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__*/
        return ret;
    }
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
        {
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio ");               
            }
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE media_id NOT IN (SELECT id FROM main.mark)");
                }
                else
                { 
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE media_id IN (SELECT id FROM main.mark)");
                }               
            }
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db,stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio");
                }
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                else
                {
                    if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE media_id NOT IN (SELECT id FROM db2.mark)");
                    }
                    else
                    { 
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE media_id IN (SELECT id FROM db2.mark)");
                    }  
                }
                #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db,stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            return ret;
        }
        else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
        {
            const S8* ptr;
            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else /* genre */
            {
                ptr = Sqlgenreid;
            }
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {               
               kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s", ptr);               
            }
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else 
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s AND media_id NOT IN (SELECT id FROM main.mark)", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s AND media_id IN (SELECT id FROM main.mark)", ptr);
                }                              
            }/* end of temp audio */
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
            }
            ret = pls_sql_step_ex(db,stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s", ptr);
                }
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                else
                {
                    if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s AND media_id NOT IN (SELECT id FROM db2.mark)", ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s AND media_id IN (SELECT id FROM db2.mark)", ptr);
                    } 
                }
                #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                }                
                ret = pls_sql_step_ex(db,stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            return ret;
        }
        else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                 play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            const S8* ptr1, *ptr2;

            ptr1 = Sqlartistid;
            ptr2 = Sqlalbumid;
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s AND %s", ptr1, ptr2);               
            }
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else /* temp audio */ 
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s AND %s AND media_id NOT IN (SELECT id FROM main.mark)", ptr1, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE %s AND %s AND media_id IN (SELECT id FROM main.mark)", ptr1, ptr2);
                }
            }/* temp audio */
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
            }
            ret = pls_sql_step_ex(db,stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                {
                    kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s AND %s", ptr1, ptr2);
                }
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                else
                {
                    if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)                
                    {
                        kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s AND %s AND media_id NOT IN (SELECT id FROM db2.mark)", ptr1, ptr2);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE %s AND %s AND media_id  IN (SELECT id FROM db2.mark)", ptr1, ptr2);
                    }
                }
                #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                }
                ret = pls_sql_step_ex(db,stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            return ret;                
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(play_info->plst_id > 0X8000)
            {
                //MAUI_03343406
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM main.plst_item, main.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id UNION ");
                    strcat(db->sql_cmd, " SELECT plstitem_id FROM main.plst_item, db2.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id )");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                }
                else
                {
                    ret = pls_sql_prepare_ex(db,"SELECT COUNT(plstitem_id) FROM main.plst_item, main.audio WHERE plst_id = ? AND audio.media_id > 32768 AND audio.media_id = plst_item.media_id", &stmt);
                }
            #else
                ret = pls_sql_prepare_ex(db,"SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ?", &stmt);
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM db2.plst_item, main.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id UNION ");
                strcat(db->sql_cmd, " SELECT plstitem_id FROM db2.plst_item, db2.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id )");
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else
        {
            if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->plst_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark) ",  &stmt);
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark)",  &stmt);
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->plst_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 AND plstitem_id NOT IN (SELECT id FROM main.mark) ",  &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM main.mark)",  &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->plst_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM db2.mark) ",  &stmt);
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM db2.mark)",  &stmt);
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->plst_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 AND plstitem_id IN (SELECT id FROM main.mark) ",  &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM main.mark)",  &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }

            }
        }
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
        if(play_info->plst_id < 0X8000 ||
            (play_info->plst_id >= 0X8000 && IS_CARD_EXIST))
        {
            sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
        }
        ret = pls_sql_step_ex(db,stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *count = sqlite3_column_kal_uint32(stmt, 0);            
        }
        else
        {
            *count = 0;
        }
        pls_sql_finalize(stmt);
        return ret;
    }
    else 
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }   
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_for_active_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static S32 pls_sql_get_view_count_for_active_list(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_playing_context_struct *play_info;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    play_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);  
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_ACTIVE_LIST_COUNT, play_info->plst_id);
    if(play_info->plst_id == 0)
    {
        *count = 0;
    }
    else
    {
        ret = pls_sql_get_default_list_count(db, play_info,count);
    }
    return ret;   
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_for_addto_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static S32 pls_sql_get_view_count_for_addto_plst(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    U32 count_p = 0;
    U32 count_c = 0;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    ret = pls_sql_prepare_ex(db, "SELECT COUNT(plst_id) FROM main.plst WHERE plst_name != \"\" ", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db,stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        count_p = sqlite3_column_kal_uint32(stmt,0);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {       
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plst_id) FROM db2.plst WHERE plst_name != \"\" ", &stmt);  
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db,stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count_c = sqlite3_column_kal_uint32(stmt,0);
        }
        pls_sql_finalize(stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    *count = count_p + count_c;
    if(pls_sql_util_check_default_list_exist(db, SRV_PLST_DEF_MY_FAVOURITE))
    {
        *count = *count + 1;   
    }        
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_one_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
static S32 pls_sql_get_view_count_one_level(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *play_info;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    U32 count_p = 0;
    U32 count_c = 0;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    play_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type = list_view->view_type[list_view->current_index];
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_ONE, view_type, g_srv_plst_control_ptr->card_state);
    if(list_view->is_search == MMI_TRUE && base->config_search == SRV_PLST_SEARCH_BY_PREFIX_CURRENT_LIST)
    {
        ret = pls_sql_get_view_count_two_level(db, index, count);
        return ret;
    }

#ifdef __PLST_SRV_DEFAULT_LIST__
    if(view_type == SRV_PLST_VIEW_PLST_DEFAULT)
    {
        ret = pls_sql_get_default_list_count(db, play_info,count);
        return ret;
    }
    else
#endif /* __PLST_SRV_DEFAULT_LIST__ */
    {
        if(view_type == SRV_PLST_VIEW_AUDIO ||
           view_type == SRV_PLST_VIEW_VIDEO ||
           view_type == SRV_PLST_VIEW_PLST ||
           (!IS_CARD_EXIST && (view_type == SRV_PLST_VIEW_ARTIST ||
           view_type == SRV_PLST_VIEW_ALBUM || view_type == SRV_PLST_VIEW_IMAGE_FLOW|| view_type == SRV_PLST_VIEW_GENRE)))
        {
        switch (view_type)
        {
            case SRV_PLST_VIEW_AUDIO:
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio");
                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video");
                break;
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            case SRV_PLST_VIEW_ARTIST:
                sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist");            
                break;
            case SRV_PLST_VIEW_ALBUM:
            case SRV_PLST_VIEW_IMAGE_FLOW:
                sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album");
                break;
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__                
            case SRV_PLST_VIEW_GENRE:
                sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre");
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            case SRV_PLST_VIEW_PLST:
            /* For cosoms project, it will handle default list in multi-select mode, so include default list for the count */
            #if !defined(__COSMOS_MMI_PACKAGE__)
                if(list_view->is_mark)
                {
                    sprintf(db->sql_cmd, "SELECT count(plst_id) FROM main.plst WHERE plst_name != \"\"");
                }
                else
            #endif
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plst_id) FROM main.plst");
                }
                break;            
            default :
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count_p = sqlite3_column_kal_int32(stmt,0);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        }
 
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if (IS_CARD_EXIST)
        {
            switch (view_type)
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio");
                    break;
            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video");
                    break;
            #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
                case SRV_PLST_VIEW_ARTIST:
                    count_p = 0; 
                    sprintf(db->sql_cmd, "SELECT COUNT(distinct artist_id) FROM (SELECT artist_id FROM main.artist UNION SELECT artist_id FROM db2.artist)");
                    break;
                case SRV_PLST_VIEW_ALBUM:
                case SRV_PLST_VIEW_IMAGE_FLOW:
                    count_p = 0;
                    sprintf(db->sql_cmd, "SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.album UNION SELECT album_id FROM db2.album) ");
                    break;
                case SRV_PLST_VIEW_GENRE:
                    count_p = 0;
                    sprintf(db->sql_cmd, "SELECT COUNT(distinct genre_id) FROM (SELECT genre_id FROM main.genre UNION SELECT genre_id FROM db2.genre)");
                    break;
                case SRV_PLST_VIEW_PLST:
                    sprintf(db->sql_cmd, "SELECT COUNT(plst_id) FROM db2.plst");
                    break;
                default :
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db,stmt);
            if (ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK; 
                count_c = sqlite3_column_kal_int32(stmt,0);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    
        *count = count_p + count_c;
     }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_two_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_get_view_count_two_level(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_view_type_enum view_type0,view_type1;
    U32 id0;
    U32 count_p = 0;
    U32 count_c = 0;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    if(list_view->current_index > 0 && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        view_type0 = list_view->view_type[0];
        view_type1 = list_view->view_type[1];
    }
    else
    {
        view_type0 = list_view->view_type[list_view->current_index - 1];
        view_type1 = list_view->view_type[list_view->current_index]; 
    }
    id0 = list_view->list_cache[list_view->current_index].parent_id;
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_TWO, view_type0,view_type1, g_srv_plst_control_ptr->card_state);

    if(view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->current_index == 1)
    {
        U32 length;
        U8 alpha_c = 0;
        UI_character_type alpha_s[2];
        
        alpha_s[0] = 0;
        alpha_s[1] = 0;
        
        mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN - 1);
        length = mmi_ucs2strlen((S8*)list_view->string);
        if(!length)
        {
            *count = 0;
            return SRV_PLST_OK;
        }
        list_view->string[length - 1] = list_view->string[length - 1] + 1;
        if(list_view->search[0] < 65) /* < A */
        {
            alpha_c = 1;
            alpha_s[0] = 91;
        }
        else if(list_view->search[0] > 122) /* > 'z' */
        {
            alpha_c = 2;
            alpha_s[0] = 96;
        }       
        if(view_type0 == SRV_PLST_VIEW_AUDIO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name >= ? AND name < ? ");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name >= ? AND name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name >= ? AND name < ? AND name < ?");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name >= ? AND name < ? AND name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name >= ? AND name < ? AND name > ?");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name >= ? AND name < ? AND name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name >= ? AND name < ?");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name >= ? AND name < ? AND name < ?");
                }
                else 
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name >= ? AND name < ? AND name > ?");
                }
            }
        }
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(view_type0 == SRV_PLST_VIEW_VIDEO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM ( SELECT vdo_id FROM main.video WHERE name >= ? AND name < ? ");
                    strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name >= ? AND name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM ( SELECT vdo_id FROM main.video WHERE name >= ? AND name < ? AND name < ?");
                    strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name >= ? AND name < ? AND name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM ( SELECT vdo_id FROM main.video WHERE name >= ? AND name < ? AND name >?");
                    strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name >= ? AND name < ? AND name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                   sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.video WHERE name >= ? AND name < ? ");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.video WHERE name >= ? AND name < ? AND name < ?");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.video WHERE name >= ? AND name < ? AND name > ? ");
                }
            }
        }
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        else if(view_type0 == SRV_PLST_VIEW_ARTIST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct artist_id) FROM (SELECT artist_id FROM main.artist WHERE artist_name >= ? AND artist_name < ? ");
                    strcat(db->sql_cmd, " UNION SELECT artist_id FROM db2.artist WHERE artist_name >= ? AND artist_name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct artist_id) FROM (SELECT artist_id FROM main.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT artist_id FROM db2.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct artist_id) FROM (SELECT artist_id FROM main.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name > ?");
                    strcat(db->sql_cmd, " UNION SELECT artist_id FROM db2.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(artist_id) FROM main.artist WHERE artist_name >= ? AND artist_name < ? ");
                }           
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(artist_id) FROM main.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name < ?");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(artist_id) FROM main.artist WHERE artist_name >= ? AND artist_name < ? AND artist_name > ?");
                }                
            }           
        }
        else if(view_type0 == SRV_PLST_VIEW_ALBUM)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.album WHERE album_name >= ? AND album_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT album_id FROM db2.album WHERE album_name >= ? AND album_name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.album WHERE album_name >= ? AND album_name < ? AND album_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT album_id FROM db2.album WHERE album_name >= ? AND album_name < ? AND album_name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.album WHERE album_name >= ? AND album_name < ? AND album_name >?");
                    strcat(db->sql_cmd, " UNION SELECT album_id FROM db2.album WHERE album_name >= ? AND album_name < ? AND album_name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(album_id) FROM main.album WHERE album_name >= ? AND album_name < ? ");
                }           
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(album_id) FROM main.album WHERE album_name >= ? AND album_name < ? AND album_name <?");
                }
                else 
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(album_id) FROM main.album WHERE album_name >= ? AND album_name < ? AND album_name > ?");
                }
            }           
        }
    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        else if(view_type0 == SRV_PLST_VIEW_GENRE)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct genre_id) FROM (SELECT genre_id FROM main.genre WHERE genre_name >= ? AND genre_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT genre_id FROM db2.genre WHERE genre_name >= ? AND genre_name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct genre_id) FROM (SELECT genre_id FROM main.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT genre_id FROM db2.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct genre_id) FROM (SELECT genre_id FROM main.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name > ?");
                    strcat(db->sql_cmd, " UNION SELECT genre_id FROM db2.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(genre_id) FROM main.genre WHERE genre_name >= ? AND genre_name < ? ");
                }           
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(genre_id) FROM main.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name < ?");
                }
                else 
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(genre_id) FROM main.genre WHERE genre_name >= ? AND genre_name < ? AND genre_name > ?");
                }
            }           
        }
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        else if(view_type0 == SRV_PLST_VIEW_PLST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM (SELECT plst_id FROM main.plst WHERE plst_name >= ? AND plst_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT plst_id FROM db2.plst WHERE plst_name >= ? AND plst_name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM (SELECT plst_id FROM main.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name < ?");
                    strcat(db->sql_cmd, " UNION SELECT plst_id FROM db2.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM (SELECT plst_id FROM main.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name > ?");
                    strcat(db->sql_cmd, " UNION SELECT plst_id FROM db2.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name > ?)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM main.plst WHERE plst_name >= ? AND plst_name < ?");
                }            
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM main.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name < ?");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plst_id) FROM main.plst WHERE plst_name >= ? AND plst_name < ? AND plst_name > ?");
                }
            }            
        }
        else 
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
        if(alpha_c)
        {
            sqlite3_bind_kal_wstr(stmt, 3, alpha_s);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 4, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 5, list_view->string);    
                sqlite3_bind_kal_wstr(stmt, 6, alpha_s);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 4, list_view->string);    
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db,stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *count = sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);
        return ret;        
    }
    else
    {
        if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.audio WHERE artist_id = ? UNION SELECT album_id FROM db2.audio WHERE artist_id = ?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.audio WHERE artist_id = ? )");
            }
        }
        else if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_MEDIA ||
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ?");
        }
        else if ((view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)&& (view_type1 == SRV_PLST_VIEW_MEDIA ||
             (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))  
        {
            sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM main.audio WHERE album_id = ?");
        }
        else if(view_type0 == SRV_PLST_VIEW_GENRE && (view_type1 == SRV_PLST_VIEW_MEDIA ||
             (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id = ?");
        }
        else if (view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
        {
            //MAUI_03343406
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item, main.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM db2.plst_item, main.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                }
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item, main.audio WHERE plst_id = ? AND audio.media_id > 32768 AND audio.media_id  = plst_item.media_id");
            }
        #else
            sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ?");
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST && (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM))))
        {
            sqlite3_bind_kal_uint32(stmt, 2, id0);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_step_ex(db,stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count_p = sqlite3_column_kal_uint32(stmt,0);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        *count = count_p;

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
                (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
            {
                return ret;
            }
            else if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_MEDIA ||
                (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ?");
            }
            else if ((view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW) && (view_type1 == SRV_PLST_VIEW_MEDIA ||
                (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
            {
                sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM db2.audio WHERE album_id = ?");
            }
            else if(view_type0 == SRV_PLST_VIEW_GENRE && (view_type1 == SRV_PLST_VIEW_MEDIA ||
                 (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE genre_id = ?");
            }
            else if (view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
            {
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item, db2.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM db2.plst_item, db2.audio WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }        
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            ret = pls_sql_step_ex(db, stmt);
            if (ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                count_c = sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        *count = count_p + count_c;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_three_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_get_view_count_three_level(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id0[SRV_PLST_VIEW_LIST_DEPTH - 1];
    U32 count_p = 0;
    U32 count_c = 0;
    S32 ret = SRV_PLST_OK;
    U8 i;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    view_type[list_view->current_index] = list_view->view_type[list_view->current_index];

    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id0[i] = list_view->list_cache[i + 1].parent_id;
    }

    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_THREE, view_type[0],view_type[1],view_type[2], g_srv_plst_control_ptr->card_state);

    if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->current_index == 2)/* prefix search */ 
    {
        U32 length;
        UI_character_type alpha_s[2];
        U8 alpha_c = 0;
        
        mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN - 1);
        length = mmi_ucs2strlen((S8*)(list_view->string));
        if(!length)
        {
            *count = 0;
            return SRV_PLST_OK;
        }
        list_view->string[length - 1] = list_view->string[length - 1] + 1;

        alpha_s[0] = 0;
        alpha_s[1] = 0;

        if(list_view->search[0] < 65) /* < A */
        {
            alpha_c = 1;
            alpha_s[0] = 91;
        }
        else if(list_view->search[0] > 122) /* > 'z' */
        {
            alpha_c = 2;
            alpha_s[0] = 96;
        }
        if((view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM ||
            view_type[0] == SRV_PLST_VIEW_GENRE) && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            const S8* ptr, *ptr2;
            ptr2 = Sqlsearchname;
            if(view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else
            {
                ptr = Sqlgenreid;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE %s AND %s \
UNION SELECT media_id FROM db2.audio WHERE %s AND %s)", ptr,ptr2, ptr, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE %s AND %s AND name < ?\
UNION SELECT media_id FROM db2.audio WHERE %s AND %s AND name < ?)", ptr,ptr2, ptr, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE %s AND %s AND name > ? \
UNION SELECT media_id FROM db2.audio WHERE %s AND %s AND name > ?)", ptr,ptr2, ptr, ptr2);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, " SELECT count(media_id) FROM main.audio WHERE %s AND %s", ptr, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, " SELECT count(media_id) FROM main.audio WHERE %s AND %s AND name < ?", ptr, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT count(media_id) FROM main.audio WHERE %s AND %s AND name > ?", ptr, ptr2);
                }
            }
        }
        else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM ( SELECT album.album_id AS ID FROM main.album, main.audio WHERE artist_id = ?  ");
                    strcat(db->sql_cmd, " AND main.audio.album_id = main.album.album_id AND album_name >= ? AND album_name < ? UNION ");
                    strcat(db->sql_cmd, " SELECT album.album_id AS ID FROM db2.audio, db2.album WHERE artist_id = ? AND db2.audio.album_id = db2.album.album_id  ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ?) ");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM ( SELECT album.album_id AS ID FROM main.album, main.audio WHERE artist_id = ?  ");
                    strcat(db->sql_cmd, " AND main.audio.album_id = main.album.album_id AND album_name >= ? AND album_name < ? AND album_name < ? UNION ");
                    strcat(db->sql_cmd, " SELECT album.album_id AS ID FROM db2.audio, db2.album WHERE artist_id = ? AND db2.audio.album_id = db2.album.album_id  ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ? AND album_name < ?) ");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM ( SELECT album.album_id AS ID FROM main.album, main.audio WHERE artist_id = ?  ");
                    strcat(db->sql_cmd, " AND main.audio.album_id = main.album.album_id AND album_name >= ? AND album_name < ? AND album_name > ? UNION ");
                    strcat(db->sql_cmd, " SELECT album.album_id AS ID FROM db2.audio, db2.album WHERE artist_id = ? AND db2.audio.album_id = db2.album.album_id  ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ? AND album_name > ?) ");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM (SELECT album.album_id AS ID FROM audio, album WHERE artist_id = ? and audio.album_id = album.album_id ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ? )");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM (SELECT album.album_id AS ID FROM audio, album WHERE artist_id = ? and audio.album_id = album.album_id ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ? AND album_name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(distinct ID) FROM (SELECT album.album_id AS ID FROM audio, album WHERE artist_id = ? and audio.album_id = album.album_id ");
                    strcat(db->sql_cmd, " AND album_name >= ? AND album_name < ? AND album_name > ? )");
                }
            }
        }
        else if(view_type[0] == SRV_PLST_VIEW_PLST && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(id0[0] > 0X8000)
                {
                    if(!alpha_c)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM main.audio, main.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? UNION SELECT plstitem_id FROM db2.audio, main.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND audio.media_id = plst_item.media_id )");
                    }
                    else if(alpha_c == 1)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM main.audio, main.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? AND name < ? UNION SELECT plstitem_id FROM db2.audio, main.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND name < ? AND audio.media_id = plst_item.media_id )");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM main.audio, main.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? AND name > ? UNION SELECT plstitem_id FROM db2.audio, main.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND name > ? AND audio.media_id = plst_item.media_id )");
                    }
                }
                else
                {   
                    if(!alpha_c)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM ( SELECT plstitem_id FROM main.audio, db2.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? UNION SELECT plstitem_id FROM db2.audio, db2.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND audio.media_id = plst_item.media_id )");
                    }                
                    else if(alpha_c == 1)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM ( SELECT plstitem_id FROM main.audio, db2.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? AND name < ? UNION SELECT plstitem_id FROM db2.audio, db2.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND name < ? AND audio.media_id = plst_item.media_id )");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM ( SELECT plstitem_id FROM main.audio, db2.plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id ");
                        strcat(db->sql_cmd, " AND name >= ? AND name < ? AND name > ? UNION SELECT plstitem_id FROM db2.audio, db2.plst_item WHERE plst_id = ? AND name >= ? AND name < ? ");
                        strcat(db->sql_cmd, " AND name > ? AND audio.media_id = plst_item.media_id )");
                    }
                }                 
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM audio, plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id AND name >= ? AND name < ?)");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM audio, plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id AND name >= ? AND name < ? AND name < ?)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM (SELECT plstitem_id FROM audio, plst_item WHERE plst_id = ? AND audio.media_id = plst_item.media_id AND name >= ? AND name < ? AND name > ?)");
                }
            }           
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
        sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
        if(!alpha_c)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 4, id0[0]);
                sqlite3_bind_kal_wstr(stmt, 5, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->string);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 4, alpha_s);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 5, id0[0]);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 7, list_view->string);
                sqlite3_bind_kal_wstr(stmt, 8, alpha_s);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *count = sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);
        return ret;
    }
    else
    {
        if (view_type[0] == SRV_PLST_VIEW_ARTIST &&
            view_type[1] == SRV_PLST_VIEW_ALBUM  &&
            (view_type[2] == SRV_PLST_VIEW_MEDIA ||
            (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)))
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ?");
        }
        else if(view_type[2] == SRV_PLST_VIEW_AUDIO)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio ");
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
        if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)
        {
            sqlite3_bind_kal_uint32(stmt, 2, id0[2]);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
        }
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count_p = sqlite3_column_kal_uint32(stmt,0);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if (view_type[0] == SRV_PLST_VIEW_ARTIST &&
                view_type[1] == SRV_PLST_VIEW_ALBUM  &&
                (view_type[2] == SRV_PLST_VIEW_MEDIA ||
                (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)))       
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ?");
            }
            else if(view_type[2] == SRV_PLST_VIEW_AUDIO)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio");
            }                 
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }        
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
            if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0[2]);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0[1]);          
            }
            ret = pls_sql_step_ex(db, stmt);
            if (ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                count_c = sqlite3_column_kal_uint32(stmt,0);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__) */

        *count = count_p + count_c;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_four_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/ 
S32 pls_sql_get_view_count_four_level(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id0[SRV_PLST_VIEW_LIST_DEPTH - 1];
    S32 ret = SRV_PLST_OK;
    U8 i;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    view_type[list_view->current_index] = list_view->view_type[list_view->current_index];
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_FOUR, view_type[0],view_type[1],view_type[2],view_type[3], g_srv_plst_control_ptr->card_state);
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id0[i] = list_view->list_cache[i + 1].parent_id;
    }
    if(view_type[3] == SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        U32 length;
        UI_character_type alpha_s[2];
        U8 alpha_c = 0;
        
        mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN);
        length = mmi_ucs2strlen((S8*)(list_view->string));
        if(!length)
        {
            *count = 0;
            return SRV_PLST_OK;
        }
        list_view->string[length - 1] = list_view->string[length - 1] + 1;
        alpha_s[0] = 0;
        alpha_s[1] = 0;
        
        if(list_view->search[0] < 65) /* < A */
        {
            alpha_c = 1;
            alpha_s[0] = 91;
        }
        else if(list_view->search[0] > 122) /* > 'z' */
        {
            alpha_c = 2;
            alpha_s[0] = 96;
        }
        if(view_type[0] == SRV_PLST_VIEW_ARTIST &&
           view_type[1] == SRV_PLST_VIEW_ALBUM  &&
           view_type[2] == SRV_PLST_VIEW_MEDIA )
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? ");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ?) ");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name < ?");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name < ?) ");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name > ?");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name > ?) ");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(!alpha_c)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ?");
                }
                else if(alpha_c == 1)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name < ?");
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio WHERE artist_id = ? AND album_id = ? AND name >= ? AND name < ? AND name > ?");
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
            if(!alpha_c)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, id0[0]);
                    sqlite3_bind_kal_uint32(stmt, 6, id0[1]);
                    sqlite3_bind_kal_wstr(stmt, 7, list_view->search);
                    sqlite3_bind_kal_wstr(stmt, 8, list_view->string);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else 
            {
                sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 6, id0[0]);
                    sqlite3_bind_kal_uint32(stmt, 7, id0[1]);
                    sqlite3_bind_kal_wstr(stmt, 8, list_view->search);
                    sqlite3_bind_kal_wstr(stmt, 9, list_view->string);
                    sqlite3_bind_kal_wstr(stmt, 10, alpha_s);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count_five_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_view_count_five_level(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_TYPE_FIVE);
    return SRV_PLST_RET_ERR_PARAM_ERR;   
}

S32 pls_sql_get_artist_media_count(srv_plst_db_context_struct *db, U32 id, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ?");
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db,stmt);
    if (ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        *count = sqlite3_column_kal_uint32(stmt,0);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ?");
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *count += sqlite3_column_kal_uint32(stmt,0);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
#endif /*__PLST_DUAL_DB_SUPPORT__*/
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_view_count(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_COUNT,list_view->current_index,list_view->view_type[list_view->current_index], index);
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
    {
        ret = pls_sql_get_view_count_for_addto_plst(db, index, count);
        return ret;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ACTIVE)
    {
        ret = pls_sql_get_view_count_for_active_list(db, index, count);
        return ret;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_IMAGE_FLOW)
    {
        ret = pls_sql_get_view_count_one_level(db, index, count);
    }
    else if(list_view->current_index > 1 && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
            list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_IMAGE_FLOW)
    {
        ret = pls_sql_get_view_count_two_level(db, index, count);
        return ret;
    }
    else if(list_view->current_index && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA &&
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_AUDIO ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ARTIST ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_GENRE))
    {
        ret = pls_sql_get_view_count_one_level(db, index, count);
        return ret;
    }
    else if(list_view->current_index > 2 && list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
        (list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST ||
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM  ||
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_GENRE))
    {
        ret = pls_sql_get_view_count_two_level(db, index, count);
        return ret;
    }
    else if(list_view->current_index > 3 && list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM)
    {
        ret = pls_sql_get_view_count_three_level(db, index, count);
        return ret;
    }
    else 
    {
    /* prefix search and organization both start from two level */
    switch(list_view->current_index)
    {
        case 0: /* one level list view */
            ret = pls_sql_get_view_count_one_level(db, index, count);            
            break;
            
        case 1:  /* two level list view */
            if(list_view->view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->current_index == 1 &&
                base->config_search == SRV_PLST_SEARCH_BY_WORD_FIX)
            {
                ret = pls_sql_search_count(db, list_view, count);
            }
            else
            {
                ret = pls_sql_get_view_count_two_level(db, index, count); 
            }
            break;
            
        case 2:  /* three level list view */
            if(list_view->view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH && 
                (list_view->view_type[2] == SRV_PLST_VIEW_MEDIA || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM))
            {
                if(base->config_search == SRV_PLST_SEARCH_BY_PREFIX_NEW_LIST)
                {
                    ret = pls_sql_get_view_count_two_level(db, index, count);
                }
                else
                {
                    ret = pls_sql_search_count(db, list_view, count);
                }
            }
            else
            {
                ret = pls_sql_get_view_count_three_level(db, index, count);
            }
            break;
            
        case 3:  /* four level list view */
            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
                list_view->view_type[1] == SRV_PLST_VIEW_ALBUM &&
                list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH &&
                list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)
            {
                ret = pls_sql_get_view_count_three_level(db, index, count);
            }
            else
            {
                ret = pls_sql_get_view_count_four_level(db, index, count);
            }
            break;
            
        case 4:  /* five level list view */
            ret = pls_sql_get_view_count_five_level(db, index, count);
            break;
        case 5:  /* six level list view */
        default: 
             ret = SRV_PLST_RET_ERR_PARAM_ERR;
             break;
    }
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_hint_count
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_view_hint_count(srv_plst_db_context_struct *db, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_list_view_history_struct *list_view;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    /* only for hint count of artist' album / artists/ albums/ genres/ plstlist list */
    if(list_view->hint_type == SRV_PLST_VIEW_MEDIA)
    {
        ret = pls_sql_util_get_hint_count(db, list_view, index, count);
    }
    else
    {
        ret = pls_sql_util_get_hint_count_as_hint_type(db, list_view, index, count);
    }
    return ret;
}


static MMI_BOOL pls_sql_util_check_default_list_exist(srv_plst_db_context_struct *db, srv_plst_default_playlist_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 i;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);    
    for(i = 1; i < SRV_PLST_DEF_LIST_ENUM_END ; i = i<<1)
    {
        if ((i & base->default_plst_config) && (i == type))
        {
            return MMI_TRUE;
        }
    }
    return MMI_FALSE;
}

static S32 pls_sql_util_get_default_list_id(srv_plst_db_context_struct *db, srv_plst_default_playlist_enum type, U32 *id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 i;
    U32 id_start = 1;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    for(i = 1; i < SRV_PLST_DEF_LIST_ENUM_END ; i = i<<1)
    {
        if (i & base->default_plst_config)
        {
            U32 temp_id;
            switch(i)
            {
                case SRV_PLST_DEF_MY_FAVOURITE:
                case SRV_PLST_DEF_MOST_PLST:
                case SRV_PLST_DEF_RECENTLY_PLST:
                case SRV_PLST_DEF_ON_THE_FLY:
                    temp_id = id_start|0X8000;  
                    if(type == i)
                    {
                        *id = temp_id;
                        return SRV_PLST_OK;
                    }
                    id_start++;
                    break;
                default :
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
    }
    return ret;
}


static S32 pls_sql_util_get_default_list_info(srv_plst_db_context_struct *db, U32 id, srv_plst_default_playlist_enum *type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 i;
    U32 id_start = 1;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    *type = SRV_PLST_DEF_LIST_ENUM_END;
    for(i = 1; i < SRV_PLST_DEF_LIST_ENUM_END ; i = i<<1)
    {
        if (i & base->default_plst_config)
        {
            U32 temp_id;
            switch(i)
            {
                case SRV_PLST_DEF_MY_FAVOURITE:
                case SRV_PLST_DEF_MOST_PLST:
                case SRV_PLST_DEF_RECENTLY_PLST:
                case SRV_PLST_DEF_ON_THE_FLY:
                    temp_id = id_start|0X8000;  
                    if(temp_id == id)
                    {
                        *type = (srv_plst_default_playlist_enum)i;
                        return SRV_PLST_OK;
                    }
                    id_start++;
                    break;
                default :
                    return SRV_PLST_OK;
            }
        }
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_util_update_fill_cache
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_util_update_fill_cache(srv_plst_list_context_struct *list_cache, S16 asc, S32 index, S32* index_o, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 temp_index;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/     
    if(asc > 0)
    {
        if(list_cache->tail)
        {
            temp_index = list_cache->cache[list_cache->tail - 1].idx_in_list;
        }
        else
        {
            temp_index = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].idx_in_list;
        }
        list_cache->cache[list_cache->tail].id = id;
        if(temp_index < (list_cache->total - 1))
        {
            list_cache->cache[list_cache->tail].idx_in_list = temp_index + 1; 
        }
        else
        {
            list_cache->cache[list_cache->tail].idx_in_list = 0; 
        }
        
        if(list_cache->cache[list_cache->tail].idx_in_list == index)
        {
            *index_o = list_cache->tail;
        }
        if(list_cache->tail < SRV_PLST_VIEW_LIST_CACHE - 1)
        {
             list_cache->tail++;
        }
        else if(list_cache->tail == SRV_PLST_VIEW_LIST_CACHE - 1)
        {
            list_cache->tail = 0;
        }
        if(list_cache->cache_num == SRV_PLST_VIEW_LIST_CACHE)
        {
            if(list_cache->head == SRV_PLST_VIEW_LIST_CACHE - 1)
            {
                list_cache->head = 0;
            }
            else
            {
                list_cache->head ++;
            }
        }
    }
    else
    {
        temp_index = list_cache->cache[list_cache->head].idx_in_list;
        if(list_cache->head)
        {
            list_cache->head--;
        }
        else
        {
            list_cache->head = SRV_PLST_VIEW_LIST_CACHE - 1;
        }
        list_cache->cache[list_cache->head].id = id;

        if(temp_index == 0)
        {
            list_cache->cache[list_cache->head].idx_in_list = list_cache->total - 1;

            if(index == list_cache->total - 1)
            {
                *index_o = list_cache->head;
            }
        }
        else
        {
            if(temp_index > 0)
            {
                list_cache->cache[list_cache->head].idx_in_list = temp_index - 1;                
            }
            else
            {
                list_cache->cache[list_cache->head].idx_in_list = list_cache->total - 1;                
            }
            
            if(list_cache->cache[list_cache->head].idx_in_list == index)
            {
                *index_o = list_cache->head;
            }
        }
        if(list_cache->cache_num == SRV_PLST_VIEW_LIST_CACHE)
        {
            if(list_cache->tail == 0)
            {
                list_cache->tail = SRV_PLST_VIEW_LIST_CACHE - 1;
            }
            else
            {
                list_cache->tail --;
            }
        }
    }  
    if(list_cache->cache_num < SRV_PLST_VIEW_LIST_CACHE)
    {
        list_cache->cache_num ++;
    }
    return SRV_PLST_OK;
}

static S32 pls_sql_util_fill_fix_index_cache(srv_plst_list_context_struct *list_cache, S16 asc, S32 index, S32 query_index, S32* index_o, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(asc > 0)
    {
        list_cache->cache[list_cache->tail].id = id;
        list_cache->cache[list_cache->tail].idx_in_list = index;
        if(query_index == index)
        {
            *index_o = list_cache->tail;
        }
        if(list_cache->tail == SRV_PLST_VIEW_LIST_CACHE - 1)
        {
            list_cache->tail = 0;
        }
        else
        {
            list_cache->tail++;
        }
    }
    else
    {
        if(list_cache->head == 0)
        {
            list_cache->head = SRV_PLST_VIEW_LIST_CACHE - 1;
        }
        else
        {
            list_cache->head --;
        }
        list_cache->cache[list_cache->head].id = id;
        list_cache->cache[list_cache->head].idx_in_list = index;
        if(query_index == index)
        {
            *index_o = list_cache->head;       
        }    
    }
    list_cache->cache_num +=1;
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_util_ill_first_cache
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_util_fill_first_cache(srv_plst_list_context_struct *list_cache, S16 asc, S32 index, S32* index_o, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_playing_context_struct *play_info;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/   
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(g_srv_plst_control_ptr->service_reg[g_srv_plst_control_ptr->number]))->base_info);
    play_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(g_srv_plst_control_ptr->service_reg[g_srv_plst_control_ptr->number]))->playing_info);
    if(asc > 0)
    {
        list_cache->cache[list_cache->tail].id = id;
        list_cache->cache[list_cache->tail].idx_in_list = index;
        *index_o = list_cache->tail;         
        if(list_cache->tail == SRV_PLST_VIEW_LIST_CACHE - 1)
        {
            list_cache->tail = 0;
        }
        else
        {
            list_cache->tail++;
        }
        if(list_cache->head >= list_cache->tail)
        {
            if(list_cache->head == SRV_PLST_VIEW_LIST_CACHE - 1)
            {
                list_cache->head = 0;
            }
            else
            {
                list_cache->head ++;
            }
        }
    }
    else
    {
        if(list_cache->head == 0)
        {
            list_cache->head = SRV_PLST_VIEW_LIST_CACHE - 1;
        }
        else
        {
            list_cache->head --;
        }
        list_cache->cache[list_cache->head].id = id;
        //MAUI_02940388
        //bql: only infect cosmos view style tempory
        if( base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && 
            (play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST ||
            play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO))
        {
            list_cache->cache[list_cache->head].idx_in_list = index;
        }
        else
        {
            list_cache->cache[list_cache->head].idx_in_list = list_cache->total - 1;
        }

        if(index == list_cache->total - 1)
        {
            *index_o = list_cache->head;       
        }
    }
    list_cache->cache_num = 1;
    return SRV_PLST_OK;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_cover_flow
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_cover_flow(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *playing_info;
    srv_plst_base_info_struct *base;
    srv_plst_list_context_struct *list_cache;
    S32 ret;
    U32 id0;
    U16 ischar = 1;
    UI_character_type name[SRV_PLST_MAX_FILE_LEN + 1];
    U8 count_t = 0;    
    const S8* ptr, *ptr2;
    MMI_BOOL is_jump = MMI_FALSE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);

    if(list_cache->cache_num == 0 && index != 0)
    {
        is_jump = MMI_TRUE;
        if(list_view->query_index < playing_info->active_idx)
        {
            asc = -1;
        }
        else
        {
            asc = 1;
        }
    }
    
    if(is_jump)
    {            
        /* must get the active id first while get the active index*/
        id0 = playing_info->active_id; 
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.album WHERE album_id = ? UNION SELECT p_name, ischar FROM db2.album WHERE album_id = ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT p_name, ischar from main.album WHERE album_id = ?");
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT album_name FROM main.album WHERE album_id = ? UNION SELECT album_name FROM db2.album WHERE album_id = ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT album_name from main.album WHERE album_id = ?");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 2, id0);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,0)))
            {
                mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ischar = sqlite3_column_kal_uint16(stmt, 1);
            }
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
            pls_sql_util_fill_first_cache(list_cache, asc, playing_info->active_idx, index_o, id0);
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            return ret;
        }
    }
    else
    {
        if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
        {  
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOalbumpnaidasc;
                }
                else
                {
                    ptr = SqlOalbumpnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name,ischar FROM main.album %s) \
UNION SELECT * FROM (SELECT album_id, p_name,ischar FROM db2.album %s )) %s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, p_name,ischar FROM album %s", ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOalbumnaidasc;
                }
                else
                {
                    ptr = SqlOalbumnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album %s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album %s )) %s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album %s", ptr);
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id0 = sqlite3_column_kal_uint32(stmt, 0);
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,1)))
                {
                    mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint16(stmt, 2);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
                //pls_sql_util_fill_first_cache(list_cache, asc, playing_info->active_idx, index_o, id0); 
                if(asc > 0)
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id0);
                }
                else
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id0);
                }                
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }        
        }        
        else
        {
            S32 last_index;
            if(asc > 0)
            {
                if(list_cache->tail)
                {
                    last_index = list_cache->tail - 1;
                }
                else
                {
                    last_index = SRV_PLST_VIEW_LIST_CACHE - 1;
                }
            }
            else
            {
                last_index = list_cache->head;
            }
            id0 = list_cache->cache[last_index].id; 
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.album WHERE album_id = ? UNION SELECT p_name, ischar FROM db2.album WHERE album_id = ?");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT p_name, ischar from main.album WHERE album_id = ?");
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_name FROM main.album WHERE album_id = ? UNION SELECT album_name FROM db2.album WHERE album_id = ?");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_name from main.album WHERE album_id = ?");
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,0)))
                {
                    mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint16(stmt, 1);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }       
        }
    }

    /* count same */
     /* load 20 items */
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        if(asc > 0)
        {
            ptr = SqlOalbumpnaidasc;
            ptr2 = Sqlalbumlarg;
        }
        else
        {
            ptr = SqlOalbumpnaiddesc;
            ptr2 = Sqlalbumsmal;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND p_name = ? and %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE ischar = ? AND p_name = ? and %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND p_name = ? and %s%s", ptr2, ptr);
        }
    }
    else
    {
        if(asc > 0)
        {
            ptr = SqlOalbumnaidasc;
            ptr2 = Sqlalbumlarg;
        }
        else
        {
            ptr = SqlOalbumnaiddesc;
            ptr2 = Sqlalbumsmal;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  WHERE album_name = ? and %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name = ? and %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT album_id , album_name FROM main.album  WHERE album_name = ? and %s%s", ptr2, ptr);
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        sqlite3_bind_kal_uint8(stmt, 1, ischar);
        sqlite3_bind_kal_wstr(stmt, 2, name);
        sqlite3_bind_kal_uint32(stmt,3, id0);
        sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 5, ischar);
            sqlite3_bind_kal_wstr(stmt, 6, name);
            sqlite3_bind_kal_uint32(stmt, 7, id0);
            sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, id0);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 4, name);
            sqlite3_bind_kal_uint32(stmt, 5, id0);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        count_t++;
        id0 = sqlite3_column_kal_uint32(stmt, 0);

        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }
        
    /* load differrent name */
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
       if(asc > 0)
        {
            ptr = SqlOalbumpnaidasc;
            ptr2 = Sqlpnamelarger;                
        }
        else
        {
            ptr = SqlOalbumpnaiddesc;
            ptr2 = Sqlpnamesmaller;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name, ischar  FROM db2.album WHERE ischar = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT album_id, p_name, ischar FROM album WHERE ischar = ? AND %s%s", ptr2, ptr);
        }
    }
    else
    {
        if(asc > 0)
        {
            ptr = SqlOalbumnaidasc;
            ptr2 = Sqlalbumnalarg;                
        }
        else
        {
            ptr = SqlOalbumnaiddesc;
            ptr2 = Sqlalbumnasmal;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE %s%s", ptr2, ptr);
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        sqlite3_bind_kal_uint8(stmt, 1, ischar);
        sqlite3_bind_kal_wstr(stmt, 2, name);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint8(stmt, 4, ischar);
            sqlite3_bind_kal_wstr(stmt, 5, name);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {       
        sqlite3_bind_kal_wstr(stmt, 1,name);       
        sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {  
            sqlite3_bind_kal_wstr(stmt, 3,name);            
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        }    
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    ret = pls_sql_step_ex(db, stmt);
    while (ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        count_t++;
        id0 = sqlite3_column_kal_uint32(stmt, 0);     
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt);     

    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return SRV_PLST_OK;
    }
    
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN )
    {
        if(asc > 0)
        {
            ptr2 = Sqlischarlarger;
            ptr = SqlOalbumpnaidasc;
        }
        else
        {
            ptr2 = Sqlischarsmaller;
            ptr = SqlOalbumpnaiddesc;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE  %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT album_id, p_name, ischar FROM album WHERE %s%s", ptr2, ptr);
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint8(stmt, 1, ischar);
        sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, ischar);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;

            temp_id = sqlite3_column_kal_uint32(stmt, 0);
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, temp_id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
            }
            ret = pls_sql_step_ex(db, stmt);
        }                    
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }       
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_one_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_one_level(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 id0 = 0;
    U32 create_time = 0;
    UI_character_type name[SRV_PLST_MAX_FILE_LEN + 1];
    U8 count_t = 0;
    U8 ischar = 1;
#if defined(__COSMOS_MMI_PACKAGE__)
    MMI_BOOL include_def_list = MMI_TRUE;  /* For cosoms project, it will handle default list in multi-select mode */
#else
    MMI_BOOL include_def_list = MMI_FALSE;
#endif
    U32 stmt_id = PLS_SQL_STMT_NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type = list_view->view_type[list_view->current_index];

    /*----------------------------------------- Find middle cache (Except play list) ----------------------------------------------------*/
    if (list_cache->cache_num == 0 && index != 0 && view_type != SRV_PLST_VIEW_PLST)
    {
    //MAUI_02956291
    //For View playlist, we need to cache default list first which should not union with created list and order by create time
    //So exclude middle index cache in the condition of View Plst
    //MAUI_02950649
    //Fill cache from middle idex
    //Add fill middle select logic in pls_sql_get_item_to_fill_cache_one_level()
        const S8 *ptr;
        const S8 *ptr2;
        const S8 *table_name;

        switch (view_type)
        {
            case SRV_PLST_VIEW_AUDIO:
                /* SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio ORDER BY ischar, p_name, media_id) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio ORDER BY ischar, p_name, media_id)) ORDER BY ischar, p_name, media_id limit ? OFFSET ? */
                /* SELECT media_id, p_name, ischar FROM audio ORDER BY ischar, p_name, media_id limit ? OFFSET ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio ORDER BY name, media_id) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio ORDER BY name, media_id)) ORDER BY name, media_id limit ? OFFSET ? */
                /* SELECT media_id, name FROM audio ORDER BY name, media_id limit ? OFFSET ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = SqlFieldIdPNameIsChar;
                    ptr2 = SqlOpnaidascnl;
                }
                else
                {
                    ptr = SqlFieldIdName;
                    ptr2 = SqlOnaidascnl;
                }
                table_name = "audio";

                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name, ischar FROM main.video ORDER BY p_name, vdo_id) UNION SELECT * FROM (SELECT vdo_id, p_name, ischar FROM db2.video ORDER BY p_name, vdo_id)) ORDER BY p_name, vdo_id limit ? OFFSET ? */
                /* SELECT vdo_id, p_name, ischar FROM video ORDER BY p_name, vdo_id limit ? OFFSET ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video ORDER BY name, vdo_id) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video ORDER BY name, vdo_id)) ORDER BY name, vdo_id limit ? OFFSET ? */
                /* SELECT vdo_id, name FROM video ORDER BY name, vdo_id limit ? OFFSET ?*/

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "vdo_id, p_name, ischar";
                    ptr2 = "ORDER BY p_name, vdo_id";
                }
                else
                {
                    ptr = "vdo_id, name";
                    ptr2 = "ORDER BY name, vdo_id";
                }
                table_name = "video";

                break;
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            case SRV_PLST_VIEW_ARTIST:
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name, ischar FROM main.artist ORDER BY ischar, p_name, artist_id) UNION SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist ORDER BY ischar, p_name, artist_id)) ORDER BY ischar, p_name, artist_id limit ? OFFSET ? */
                /* SELECT artist_id, p_name, ischar FROM artist ORDER BY ischar, p_name, artist_id limit ? OFFSET ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id  artist_name FROM main.artist ORDER BY artist_name, artist_id) UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist ORDER BY artist_name, artist_id)) ORDER BY artist_name, artist_id limit ? OFFSET ? */
                /* SELECT artist_id, artist_name FROM artist ORDER BY artist_name, artist_id limit ? OFFSET ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "artist_id, p_name, ischar";
                    ptr2 = "ORDER BY ischar, p_name, artist_id";
                }
                else
                {
                    ptr = "artist_id, artist_name";
                    ptr2 = "ORDER BY artist_name, artist_id";
                }
                table_name = "artist";

                break;
            case SRV_PLST_VIEW_ALBUM:
            case SRV_PLST_VIEW_IMAGE_FLOW:
                /* SELECT * FROM (SELECT * FROM (SELECT album_id, p_name, ischar FROM main.album ORDER BY ischar, p_name, album_id) UNION SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album ORDER BY ischar, p_name, album_id)) ORDER BY ischar, p_name, album_id limit ? OFFSET ? */
                /* SELECT album_id, p_name, ischar FROM album ORDER BY ischar, p_name, album_id limit ? OFFSET ? */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album ORDER BY album_name, album_id) UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album ORDER BY album_name, album_id)) ORDER BY album_name, album_id limit ? OFFSET ? */
                /* SELECT album_id, album_name FROM album ORDER BY album_name, album_id limit ? OFFSET ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "album_id, p_name, ischar";
                    ptr2 = "ORDER BY ischar, p_name, album_id";
                }
                else
                {
                    ptr = "album_id, album_name";
                    ptr2 = "ORDER BY album_name, album_id";
                }
                table_name = "album";

                break;
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_VIEW_GENRE:
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id, p_name,ischar FROM main.genre ORDER BY ischar, p_name, genre_id) UNION SELECT * FROM (SELECT genre_id, p_name,ischar FROM db2.genre ORDER BY ischar, p_name, genre_id)) ORDER BY ischar, p_name, genre_id limit ? OFFSET ? */
                /* SELECT genre_id, p_name,ischar FROM genre ORDER BY ischar, p_name, genre_id limit ? OFFSET ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre ORDER BY genre_name, genre_id) UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre ORDER BY genre_name, genre_id)) ORDER BY genre_name, genre_id limit ? OFFSET ? */
                /* SELECT genre_id, genre_name FROM genre ORDER BY genre_name, genre_id limit ? OFFSET ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "genre_id, p_name,ischar";
                    ptr2 = "ORDER BY ischar, p_name, genre_id";
                }
                else
                {
                    ptr = "genre_id, genre_name";
                    ptr2 = "ORDER BY genre_name, genre_id";
                }
                table_name = "genre";

                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            default :
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT %s FROM main.%s %s) \
UNION SELECT * FROM (SELECT %s FROM db2.%s %s)) %s limit ? OFFSET ?", ptr, table_name, ptr2, ptr, table_name, ptr2,ptr2);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT %s FROM %s %s limit ? OFFSET ?", ptr, table_name, ptr2);
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, 1);
        sqlite3_bind_kal_uint32(stmt, 2, index);
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(view_type == SRV_PLST_VIEW_PLST && base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                create_time = sqlite3_column_kal_uint32(stmt, 1);
            }
            else
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    if(view_type == SRV_PLST_VIEW_PLST)
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_MAX_FILE_LEN - 1);
                    }
                    else 
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                }
                else
                {
                    name[0] = 0;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint8(stmt, 2);
                }
            }
            id0 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);       
            ret = SRV_PLST_OK;
            pls_sql_util_fill_fix_index_cache(list_cache, asc, index, index, index_o, id0);
        }
        else
        {
            pls_sql_finalize(stmt);       
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
        }
    }
    /*-------------------------------------------- Find the first one or middle cache of play list ------------------------------------*/
    else if((list_cache->cache_num == 0) ||(index == 0 && asc > 0) || (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        const S8 *ptr;
        const S8 *ptr2;
        const S8 *ptr3;        
        const S8 *table_name;
        S32 offset = 0;
        U16 i;

        switch (view_type)
        {
            case SRV_PLST_VIEW_AUDIO:
                /* SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio  ORDER BY ischar, p_name, media_id limit ?) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio  ORDER BY ischar, p_name, media_id limit ?))  ORDER BY ischar, p_name, media_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio  ORDER BY ischar DESC, p_name DESC, media_id DESC limit ?) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio  ORDER BY ischar DESC, p_name DESC, media_id DESC limit ?))  ORDER BY ischar DESC, p_name DESC, media_id DESC limit ? */
                /* SELECT media_id, p_name, ischar FROM audio  ORDER BY ischar, p_name, media_id limit ? */
                /* SELECT media_id, p_name, ischar FROM audio  ORDER BY ischar DESC, p_name DESC, media_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio  ORDER BY name, media_id limit ? ) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio  ORDER BY name, media_id limit ?))  ORDER BY name, media_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio  ORDER BY name DESC, media_id DESC limit ? ) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio  ORDER BY name DESC, media_id DESC limit ?))  ORDER BY name DESC, media_id DESC limit ? */
                /* SELECT media_id, name FROM audio  ORDER BY name, media_id limit ? */
                /* SELECT media_id, name FROM audio  ORDER BY name DESC, media_id DESC limit ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = SqlFieldIdPNameIsChar;
                    if(asc > 0)
                    {
                        ptr2 = SqlOpnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOpnaiddesc;
                    }
                }
                else
                {
                    ptr = SqlFieldIdName;
                    if(asc > 0)
                    {
                        ptr2 = SqlOnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOnaiddesc;
                    }
                }
                table_name = "audio";

                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id , p_name, ischar FROM main.video  ORDER BY p_name, vdo_id limit ? ) UNION SELECT * FROM (SELECT vdo_id, p_name,ischar FROM db2.video  ORDER BY p_name, vdo_id limit ?)) ORDER BY p_name, vdo_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id , p_name, ischar FROM main.video  ORDER BY p_name DESC, vdo_id DESC limit ? ) UNION SELECT * FROM (SELECT vdo_id, p_name,ischar FROM db2.video  ORDER BY p_name DESC, vdo_id DESC limit ?)) ORDER BY p_name DESC, vdo_id DESC limit ? */
                /* SELECT vdo_id, p_name, ischar FROM video  ORDER BY p_name, vdo_id limit ? */
                /* SELECT vdo_id, p_name, ischar FROM video  ORDER BY p_name DESC, vdo_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id , name FROM main.video  ORDER BY name, vdo_id limit ? ) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video  ORDER BY name, vdo_id limit ?)) ORDER BY name, vdo_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id , name FROM main.video  ORDER BY name DESC, vdo_id DESC limit ? ) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video  ORDER BY name DESC, vdo_id DESC limit ?)) ORDER BY name DESC, vdo_id DESC limit ? */
                /* SELECT vdo_id, name FROM video  ORDER BY name, vdo_id limit ? */
                /* SELECT vdo_id, name FROM video  ORDER BY name DESC, vdo_id DESC limit ? */


                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "vdo_id, p_name, ischar";
                    if(asc > 0)
                    {
                        ptr2 = SqlOvideopnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOvideopnaiddesc;
                    }
                }
                else
                {
                    ptr = "vdo_id, name";
                    if(asc > 0)
                    {
                        ptr2 = SqlOvideonaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOvideonaiddesc;
                    }
                }
                table_name = "video";

                break;
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            case SRV_PLST_VIEW_ARTIST:
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name, ischar FROM main.artist  ORDER BY ischar, p_name, artist_id limit ?) UNION SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist  ORDER BY ischar, p_name, artist_id limit ?))  ORDER BY ischar, p_name, artist_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name, ischar FROM main.artist  ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ?) UNION SELECT * FROM (SELECT artist_id, p_name,ischar FROM db2.artist  ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ?))  ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ? */
                /* SELECT artist_id, p_name,ischar FROM artist  ORDER BY ischar, p_name, artist_id limit ? */
                /* SELECT artist_id, p_name,ischar FROM artist  ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id , artist_name FROM main.artist  ORDER BY artist_name, artist_id limit ?) UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist  ORDER BY artist_name, artist_id limit ?))  ORDER BY artist_name, artist_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id , artist_name FROM main.artist  ORDER BY artist_name DESC, artist_id DESC limit ?) UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist  ORDER BY artist_name DESC, artist_id DESC limit ?))  ORDER BY artist_name DESC, artist_id DESC limit ? */
                /* SELECT artist_id, artist_name FROM artist  ORDER BY artist_name, artist_id limit ? */
                /* SELECT artist_id, artist_name FROM artist  ORDER BY artist_name DESC, artist_id DESC limit ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "artist_id, p_name, ischar";
                    if(asc > 0)
                    {
                        ptr2 = SqlOartistpnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOartistpnaiddesc;
                    }
                }
                else
                {
                    ptr = "artist_id, artist_name";
                    if(asc > 0)
                    {
                        ptr2 = SqlOartistnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOartistnaiddesc;
                    }
                }
                table_name = "artist";

                break;
            case SRV_PLST_VIEW_ALBUM:
            case SRV_PLST_VIEW_IMAGE_FLOW:
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , p_name,ischar FROM main.album  ORDER BY ischar, p_name, album_id limit ? ) UNION SELECT * FROM (SELECT album_id, p_name,ischar FROM db2.album  ORDER BY ischar, p_name, album_id limit ?  ))  ORDER BY ischar, p_name, album_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , p_name,ischar FROM main.album  ORDER BY ischar DESC, p_name DESC, album_id DESC limit ? ) UNION SELECT * FROM (SELECT album_id, p_name,ischar FROM db2.album  ORDER BY ischar DESC, p_name DESC, album_id DESC limit ?  ))  ORDER BY ischar DESC, p_name DESC, album_id DESC limit ? */
                /* SELECT album_id, p_name,ischar FROM album  ORDER BY ischar, p_name, album_id limit ? */
                /* SELECT album_id, p_name,ischar FROM album  ORDER BY ischar DESC, p_name DESC, album_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  ORDER BY album_name, album_id limit ? ) UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album  ORDER BY album_name, album_id limit ?  ))  ORDER BY album_name, album_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  ORDER BY album_name DESC, album_id DESC limit ? ) UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album  ORDER BY album_name DESC, album_id DESC limit ?  ))  ORDER BY album_name DESC, album_id DESC limit ? */
                /* SELECT album_id, album_name FROM album  ORDER BY album_name, album_id limit ? */
                /* SELECT album_id, album_name FROM album  ORDER BY album_name DESC, album_id DESC limit ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "album_id, p_name, ischar";
                    if(asc > 0)
                    {
                        ptr2 = SqlOalbumpnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOalbumpnaiddesc;
                    }
                }
                else
                {
                    ptr = "album_id, album_name";
                    if(asc > 0)
                    {
                        ptr2 = SqlOalbumnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOalbumnaiddesc;
                    }
                }
                table_name = "album";

                break;
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_VIEW_GENRE:
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , p_name,ischar FROM main.genre  ORDER BY ischar, p_name, genre_id limit ?) UNION SELECT * FROM (SELECT genre_id, p_name,ischar FROM db2.genre  ORDER BY ischar, p_name, genre_id limit ?))  ORDER BY ischar, p_name, genre_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , p_name,ischar FROM main.genre  ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ?) UNION SELECT * FROM (SELECT genre_id, p_name,ischar FROM db2.genre  ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ?))  ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ? */
                /* SELECT genre_id, p_name,ischar FROM genre  ORDER BY ischar, p_name, genre_id limit ? */
                /* SELECT genre_id, p_name,ischar FROM genre  ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , genre_name FROM main.genre  ORDER BY genre_name , genre_id limit ?) UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre  ORDER BY genre_name , genre_id limit ?))  ORDER BY genre_name , genre_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , genre_name FROM main.genre  ORDER BY genre_name DESC, genre_id DESC limit ?) UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre  ORDER BY genre_name DESC, genre_id DESC limit ?))  ORDER BY genre_name DESC, genre_id DESC limit ? */
                /* SELECT genre_id, genre_name FROM genre  ORDER BY genre_name , genre_id limit ? */
                /* SELECT genre_id, genre_name FROM genre  ORDER BY genre_name DESC, genre_id DESC limit ? */

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ptr = "genre_id, p_name, ischar";
                    if(asc > 0)
                    {
                        ptr2 = SqlOgenrepnaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOgenrepnaiddesc;
                    }
                }
                else
                {
                    ptr = "genre_id, genre_name";
                    if(asc > 0)
                    {
                        ptr2 = SqlOgenrenaidasc;
                    }
                    else
                    {
                        ptr2 = SqlOgenrenaiddesc;
                    }
                }
                table_name = "genre";

                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            case SRV_PLST_VIEW_PLST:
                ptr2 = "";
                ptr3 = "";
                /* the offset does not include default play list */
                if(list_cache->cache_num == 0 && index != 0)
                {
                    U32 count;
                    pls_sql_get_predefine_list_count(db, &count);
                    offset = index - 1;
                    if(offset > 0)
                    {
                        ptr2 = "OFFSET ?";
                        asc = 1; /* Force to get id in ascending order when get middle cache*/
                    }
                }

                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(asc > 0)
                    {
                        ptr = SqlOplsttimeidasc;
                    }
                    else
                    {
                        ptr = SqlOplsttimeiddesc;
                    }
                    ptr3 = ptr;

                    if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        /* OFFSET = 0: SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE plst_name != ""   ORDER BY create_time DESC, plst_id DESC limit ?) UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst  ORDER BY create_time DESC, plst_id DESC limit ?))  ORDER BY create_time DESC, plst_id DESC limit ? */
                        /* OFFSET > 0: SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE plst_name != ""  ) UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst ))  ORDER BY create_time DESC, plst_id DESC limit ? OFFSET ? */
                        if(IS_CARD_EXIST)
                        {
                            /* Fill middle cache case for union db */
                            if(list_cache->cache_num == 0 && offset != 0)
                            {
                                ptr = "";
                            }

                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\"  %s) \
UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst %s)) %s %s", ptr, ptr, ptr3, ptr2);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT plst_id, create_time FROM plst WHERE plst_name != \"\" %s %s", ptr, ptr2);
                        }
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOplstnaidasc;
                    }
                    else
                    {
                        ptr = SqlOplstnaiddesc;
                    }
                    ptr3 = ptr;

                    if((!list_view->is_mark || include_def_list) && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            /* Fill middle cache case for union db */
                            if(list_cache->cache_num == 0 && offset != 0)
                            {
                                ptr = "";
                            }

                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst %s) \
UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst %s)) %s %s", ptr, ptr, ptr3, ptr2);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst %s %s", ptr, ptr2);
                        }
                    }
                    else
                    {
                        /* !(!list_view->is_mark || include_def_list) ||
                           ((!list_view->is_mark || include_def_list) && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST) */
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            /* Fill middle cache case for union db */
                            if(list_cache->cache_num == 0 && offset != 0)
                            {
                                ptr = "";
                            }

                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" %s) \
UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst %s)) %s %s", ptr, ptr, ptr3, ptr2);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name != \"\" %s %s", ptr, ptr2);
                        }
                    }
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                break;

            default :
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }

        if(view_type != SRV_PLST_VIEW_PLST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT %s FROM main.%s %s) \
UNION SELECT * FROM (SELECT %s FROM db2.%s %s)) %s", ptr, table_name, ptr2, ptr, table_name, ptr2, ptr2);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                 kal_sprintf(db->sql_cmd, "SELECT %s FROM %s %s", ptr, table_name, ptr2);
            }
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        /* Bind variable for play list middle cache */
        if(view_type == SRV_PLST_VIEW_PLST && list_cache->cache_num == 0 && offset != 0)
        {
            i = 1;
            sqlite3_bind_kal_uint32(stmt, i++, 1);
            sqlite3_bind_kal_uint32(stmt, i++, offset);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }

        ret = pls_sql_step_ex(db, stmt);

        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(view_type == SRV_PLST_VIEW_PLST && base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                create_time = sqlite3_column_kal_uint32(stmt, 1);
            }
            else
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    if(view_type == SRV_PLST_VIEW_PLST)
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_MAX_FILE_LEN - 1);
                    }
                    else 
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                }
                else
                {
                    name[0] = 0;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint8(stmt, 2);
                }
            }
            id0 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);       
            ret = SRV_PLST_OK;

        #ifdef __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__
            if(view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST && (!list_view->is_mark || include_def_list))
            {
                if(asc < 0)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id DESC", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    while(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        U32 temp_id;

                        temp_id = sqlite3_column_kal_uint32(stmt, 0);
                        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                        ret = pls_sql_step_ex(db, stmt);
                    }                    
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                }
            }
        #endif /* __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__ */

            /* Fill default list, if fill middle cache, need to ignore this step */
            if(view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST &&
                base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && (!list_view->is_mark || include_def_list))
            {
                if(asc > 0)
                {
                    /* ptr2 will be NULL if not fill middle cache case */
                    if(list_cache->cache_num == 0 && index != 0)
                    {
                        ptr2 = "LIMIT 10 OFFSET ?"; /* Assume no more than 10 default list */
                    }
                    else
                    {
                        ptr2 = "";
                    }
                    kal_sprintf(db->sql_cmd, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id ASC %s", ptr2);
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    if(list_cache->cache_num == 0 && index != 0)
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, index); /* Fill middle cache */
                    }

                    ret = pls_sql_step_ex(db, stmt);
                    while(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        U32 temp_id;
                        temp_id = sqlite3_column_kal_uint32(stmt, 0);
                        if(list_cache->cache_num == 0)
                        {
                            /* Fill middle cache, always fille in first item */
                            if(index != 0)
                            {
                                pls_sql_util_fill_fix_index_cache(list_cache, 1, index, index, index_o, id0);
                            }
                            else if(asc > 0)
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, temp_id);
                            }
                            else
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, temp_id);
                            }
                        }
                        else
                        {
                            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                    }                    
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = SRV_PLST_OK;
                }
            }
            if(list_cache->cache_num == 0)
            {
                /* Fill middle cache, always fille in first item */
                if(index != 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, 1, index, index, index_o, id0);
                }
                else if(asc > 0)
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id0);
                }
                else
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id0);
                }
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
            }            
        }
        else
        {
            pls_sql_finalize(stmt);

            /* No item found, fill default play list */
        #ifdef __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__
            if(view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST && (!list_view->is_mark || include_def_list))
            {
                ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id ASC", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                while(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    U32 temp_id;
                    temp_id = sqlite3_column_kal_uint32(stmt, 0);
                    if(list_cache->cache_num == 0)
                    {
                        if(asc > 0)
                        {
                            pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, temp_id);
                        }
                        else
                        {
                            pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, temp_id);
                        }
                    }
                    else
                    {
                        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                    }
                    ret = pls_sql_step_ex(db, stmt);
                }                    
                pls_sql_finalize(stmt);
                return ret;
            }
        #endif /* __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__ */

            if(view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST &&
               base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && (!list_view->is_mark || include_def_list))
            {
                if(asc > 0)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id ASC", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    while(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        U32 temp_id;
                        temp_id = sqlite3_column_kal_uint32(stmt, 0);
                        if(list_cache->cache_num == 0)
                        {
                            if(asc > 0)
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, temp_id);
                            }
                            else
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, temp_id);
                            }
                        }
                        else
                        {
                            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                    }                    
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    return ret;
                }
                else
                {
                    ret = SRV_PLST_RET_EMPTY;
                    return ret;
                }
            }
            else
            {
                return ret;
            }
        }    
    }
    /*----------------------------------------------- Find same media_id ----------------------------------------------------------------*/
    else
    {  
        S32 last_index;
        stmt_id = PLS_SQL_STMT_NULL;
        if(asc > 0)
        {
            if(list_cache->tail)
            {
                last_index = list_cache->tail - 1;
            }
            else
            {
                last_index = SRV_PLST_VIEW_LIST_CACHE - 1;
            }
        }
        else
        {
            last_index = list_cache->head;
        }
        id0 = list_cache->cache[last_index].id; 
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && view_type != SRV_PLST_VIEW_PLST)
        {
            const S8 *ptr;
            const S8 *select_item = "SELECT p_name, ischar FROM";
            name[0] = 0;
            switch (view_type)
            {
                case SRV_PLST_VIEW_AUDIO:
                    /* SELECT p_name, ischar FROM main.audio WHERE media_id = ? */
                    /* SELECT p_name, ischar FROM db2.audio WHERE media_id = ? */
                    if(id0 > 0X8000)
                    {
                        ptr = Sqlmaindot;
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_SAME_MEDIA_ID_MAIN;
                    }
                    else
                    {
                        ptr = Sqldb2dot;
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_SAME_MEDIA_ID_DB2;
                    }
                    kal_sprintf(db->sql_cmd, "%s %saudio WHERE media_id = ?", select_item, ptr);
                    break;
            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    /* SELECT p_name, ischar FROM main.video WHERE vdo_id = ? */
                    /* SELECT p_name, ischar FROM db2.video WHERE vdo_id = ?*/
                    if(id0 > 0X8000)
                    {
                        ptr = Sqlmaindot;
                    }
                    else
                    {
                        ptr = Sqldb2dot;
                    }
                    kal_sprintf(db->sql_cmd, "%s %svideo WHERE vdo_id = ?", select_item, ptr);
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    /* SELECT p_name, ischar FROM main.artist WHERE artist_id = ? UNION SELECT p_name, ischar FROM db2.artist WHERE artist_id = ? */
                    /* SELECT p_name, ischar FROM main.artist WHERE artist_id = ? */

                    kal_sprintf(db->sql_cmd, "%s main.artist WHERE artist_id = ?", select_item);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        strcat(db->sql_cmd, " UNION ");
                        strcat(db->sql_cmd, select_item);
                        strcat(db->sql_cmd, " db2.artist WHERE artist_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    break;
                case SRV_PLST_VIEW_ALBUM:
                    /* SELECT p_name, ischar FROM main.album WHERE album_id = ? UNION SELECT p_name, ischar FROM db2.album WHERE album_id = ? */
                    /* SELECT p_name, ischar FROM main.album WHERE album_id = ? */

                    kal_sprintf(db->sql_cmd, "%s main.album WHERE album_id = ?", select_item);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        strcat(db->sql_cmd, " UNION ");
                        strcat(db->sql_cmd, select_item);
                        strcat(db->sql_cmd, " db2.album WHERE album_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    break;
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    /* SELECT p_name, ischar FROM main.genre WHERE genre_id = ? UNION SELECT p_name, ischar FROM db2.genre WHERE genre_id = ? */
                    /* SELECT p_name, ischar FROM main.genre WHERE genre_id = ? */
                    
                    kal_sprintf(db->sql_cmd, "%s main.genre WHERE genre_id = ?", select_item);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        strcat(db->sql_cmd, " UNION ");
                        strcat(db->sql_cmd, select_item);
                        strcat(db->sql_cmd, " db2.genre WHERE genre_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            }

            if(stmt_id == PLS_SQL_STMT_NULL)
            {
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            }
            else
            {
                ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
            }

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST && (view_type == SRV_PLST_VIEW_ARTIST || view_type == SRV_PLST_VIEW_ALBUM || view_type == SRV_PLST_VIEW_GENRE))
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {   
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                ischar = sqlite3_column_kal_uint8(stmt, 1);
                ret = SRV_PLST_OK;
                pls_sql_finalize_or_clear_binding(stmt, stmt_id);
            }
            else
            {
                pls_sql_finalize_or_clear_binding(stmt, stmt_id);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }
        }
        else if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && view_type == SRV_PLST_VIEW_PLST)
        {
            /* SELECT create_time FROM main.plst WHERE plst_id = ? */
            /* SELECT create_time FROM db2.plst WHERE plst_id = ? */
            
            const S8 *ptr;
            if(id0> 0X8000)
            {
                ptr = Sqlmaindot;
            }
            else
            {
                ptr = Sqldb2dot;
            }
            kal_sprintf(db->sql_cmd, "SELECT create_time FROM %splst WHERE plst_id = ?", ptr);
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {   
                create_time = sqlite3_column_kal_uint32(stmt,0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }
        }
        else
        {
            srv_plst_list_get_display_struct data;

            name[0] = 0;
            if(view_type == SRV_PLST_VIEW_PLST)
            {
                data.buff_size = SRV_PLST_MAX_FILE_LEN - 1;
            }
            else
            {
                data.buff_size = SRV_PLST_META_INFO_MAX_LEN;
            }
            data.string_ptr = (U32)&name[0];
       
            ret = pls_sql_get_view_title(db, last_index, (U32*)&data);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
    }

    stmt_id = PLS_SQL_STMT_NULL;

    /* load 20 items */
    /* load same name media_id vdo_id */
    if(view_type == SRV_PLST_VIEW_AUDIO ||view_type == SRV_PLST_VIEW_VIDEO || 
       ((view_type == SRV_PLST_VIEW_ARTIST ||view_type == SRV_PLST_VIEW_ALBUM || view_type == SRV_PLST_VIEW_IMAGE_FLOW || view_type == SRV_PLST_VIEW_GENRE) &&
         (base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN || (base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_UNICODE && IS_CARD_EXIST))))
    {
        const S8 *select_item = NULL;
        const S8 *table_name = NULL;
        const S8 *cond = NULL;
        const S8 *cond2 = NULL;
        const S8 *ptr = NULL;
        const S8 *union_all = "";
        switch(view_type)
        {
            case SRV_PLST_VIEW_AUDIO:
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE ischar= ? AND p_name = ? AND  media_id > ? ORDER BY media_id ASC limit ? ) UNION ALL SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND  media_id > ? ORDER BY media_id ASC limit ?))  ORDER BY media_id ASC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE ischar= ? AND p_name = ? AND  media_id < ? ORDER BY media_id DESC limit ? )UNION ALL SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND  media_id < ? ORDER BY media_id DESC limit ?))  ORDER BY media_id DESC limit ? */
                /* SELECT media_id, p_name, ischar FROM audio WHERE ischar = ? AND p_name = ? AND  media_id > ? ORDER BY media_id ASC limit ? */
                /* SELECT media_id, p_name, ischar FROM audio WHERE ischar = ? AND p_name = ? AND  media_id < ? ORDER BY media_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE name = ? AND  media_id > ? ORDER BY media_id ASC limit ? )UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND  media_id > ? ORDER BY media_id ASC limit ?))  ORDER BY media_id ASC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE name = ? AND  media_id < ? ORDER BY media_id DESC limit ? )UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND  media_id < ? ORDER BY media_id DESC limit ?))  ORDER BY media_id DESC limit ? */
                /* SELECT media_id, name FROM audio WHERE name = ? AND  media_id > ? ORDER BY media_id ASC limit ? */
                /* SELECT media_id, name FROM audio WHERE name = ? AND  media_id < ? ORDER BY media_id DESC limit ? */
                table_name = "audio";
                union_all = "ALL";

                if(asc > 0)
                {
                    ptr = SqlOmediaidasc;
                    cond2 = Sqlmedialarger;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC;
                }
                else
                {
                    ptr = SqlOmediaiddesc;
                    cond2 = Sqlmediasmaller;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC;                    
                }

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    select_item = SqlFieldIdPNameIsChar;
                    cond = "ischar = ? AND p_name = ? AND";
                    stmt_id = stmt_id + 1; /* PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC_PINYIN or PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC_PINYIN */
                }
                else
                {
                    select_item = SqlFieldIdName;
                    cond = "name = ? AND";
                    stmt_id = stmt_id + 2; /* PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_ASC_UNICODE or PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_MEDIA_ID_DESC_UNICODE */
                }

                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE p_name = ? AND  vdo_id > ? ORDER BY vdo_id limit ?) UNION ALL SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE p_name = ? AND  vdo_id > ? ORDER BY vdo_id limit ?))  ORDER BY vdo_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE p_name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ?) UNION ALL SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE p_name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ?))  ORDER BY vdo_id DESC limit ? */
                /* SELECT vdo_id, p_name FROM video WHERE p_name = ? AND  vdo_id > ? ORDER BY vdo_id limit ? */
                /* SELECT vdo_id, p_name FROM video WHERE p_name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name = ? AND  vdo_id > ? ORDER BY vdo_id limit ?) UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ? AND  vdo_id > ? ORDER BY vdo_id limit ?))  ORDER BY vdo_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT vdo_id , name FROM main.video WHERE name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ?) UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ?))  ORDER BY vdo_id DESC limit ? */
                /* SELECT vdo_id, name FROM video WHERE name = ? AND  vdo_id > ? ORDER BY vdo_id limit ? */
                /* SELECT vdo_id, name FROM video WHERE name = ? AND  vdo_id < ? ORDER BY vdo_id DESC limit ? */
                table_name = "video";
                union_all = "ALL";

                if(asc > 0)
                { 
                    ptr = SqlOvideoidasc;
                    cond2 = Sqlvideolarg;
                }
                else
                {
                    ptr = SqlOvideoiddesc;
                    cond2 = Sqlvideosmal;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    select_item = "vdo_id, p_name";
                    cond = "p_name = ? AND";
                }
                else
                {
                    select_item = "vdo_id, name";
                    cond = "name = ? AND";
                }
                break;
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            case SRV_PLST_VIEW_ARTIST:
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name, ischar FROM main.artist WHERE ischar = ? AND p_name = ? AND  artist_id > ? ORDER BY ischar, p_name, artist_id limit ?) UNION  SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist WHERE ischar = ? AND p_name = ? AND  artist_id > ? ORDER BY ischar, p_name, artist_id limit ?))  ORDER BY ischar, p_name, artist_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id , p_name, ischar FROM main.artist WHERE ischar = ? AND p_name = ? and  artist_id < ? ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ?) UNION SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist WHERE ischar = ? AND p_name = ? and  artist_id < ? ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ?)) ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ? */
                /* SELECT artist_id, p_name, ischar FROM artist WHERE ischar = ? AND p_name = ? and  artist_id > ? ORDER BY ischar, p_name, artist_id limit ? */
                /* SELECT artist_id, p_name, ischar FROM artist WHERE ischar = ? AND p_name = ? and  artist_id < ? ORDER BY ischar DESC, p_name DESC, artist_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name = ? AND  artist_id > ? ORDER BY artist_name, artist_id limit ?) UNION  SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name = ? AND  artist_id > ? ORDER BY artist_name, artist_id limit ?))  ORDER BY artist_name, artist_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT artist_id , artist_name FROM main.artist WHERE artist_name = ? and  artist_id < ? ORDER BY artist_name DESC, artist_id DESC limit ?) UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name = ? and  artist_id < ? ORDER BY artist_name DESC, artist_id DESC limit ?)) ORDER BY artist_name DESC, artist_id DESC limit ? */
                table_name = "artist";
                
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(asc > 0)
                    {
                        ptr = SqlOartistpnaidasc;
                        cond2 = Sqlartistidlarg;
                    }
                    else
                    {
                        ptr = SqlOartistpnaiddesc;
                        cond2 = Sqlartistidsmal;
                    }
                    select_item = "artist_id, p_name, ischar";
                    cond = "ischar = ? AND p_name = ? AND";
                }
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOartistnaidasc;
                        cond2 = Sqlartistidlarg;
                    }
                    else
                    {
                        ptr = SqlOartistnaiddesc;
                        cond2 = Sqlartistidsmal;
                    }
                    select_item = "artist_id, artist_name";
                    cond = "artist_name = ? AND";
                }
                break;
                
            case SRV_PLST_VIEW_ALBUM:
            case SRV_PLST_VIEW_IMAGE_FLOW:
                /* SELECT * FROM (SELECT * FROM (SELECT album_id, p_name, ischar FROM main.album WHERE ischar = ? AND p_name = ? and  album_id > ? ORDER BY ischar, p_name, album_id limit ? ) UNION  SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE ischar = ? AND p_name = ? and  album_id > ? ORDER BY ischar, p_name, album_id limit ?  )) ORDER BY ischar, p_name, album_id limit ?  */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND p_name = ? and  album_id < ? ORDER BY ischar DESC, p_name DESC, album_id DESC limit ? ) UNION SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE ischar = ? AND p_name = ? and  album_id < ? ORDER BY ischar DESC, p_name DESC, album_id DESC limit ?  )) ORDER BY ischar DESC, p_name DESC, album_id DESC limit ?  */
                /* SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND p_name = ? and  album_id > ? ORDER BY ischar, p_name, album_id limit ?  */
                /* SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND p_name = ? and  album_id < ? ORDER BY ischar DESC, p_name DESC, album_id DESC limit ?  */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  WHERE album_name = ? and  album_id > ? ORDER BY album_name, album_id limit ? ) UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name = ? and  album_id > ? ORDER BY album_name, album_id limit ?  )) ORDER BY album_name, album_id limit ?  */
                /* SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  WHERE album_name = ? and  album_id < ? ORDER BY album_name DESC, album_id DESC limit ? ) UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name = ? and  album_id < ? ORDER BY album_name DESC, album_id DESC limit ?  )) ORDER BY album_name DESC, album_id DESC limit ?  */
                table_name = "album";

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(asc > 0)
                    {
                        ptr = SqlOalbumpnaidasc;
                        cond2 = Sqlalbumlarg;

                    }
                    else
                    {
                        ptr = SqlOalbumpnaiddesc;
                        cond2 = Sqlalbumsmal;
                    }
                    select_item = "album_id, p_name, ischar";
                    cond = "ischar = ? AND p_name = ? AND";
                }
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOalbumnaidasc;
                        cond2 = Sqlalbumlarg;
                    }
                    else
                    {
                        ptr = SqlOalbumnaiddesc;
                        cond2 = Sqlalbumsmal;
                    }
                    select_item = "album_id, album_name";
                    cond = "album_name = ? AND";
                }
                break;
                
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_VIEW_GENRE:
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , p_name FROM main.genre WHERE p_name = ? and  genre_id > ? ORDER BY ischar, p_name, genre_id limit ?) UNION SELECT * FROM (SELECT genre_id, p_name FROM db2.genre WHERE p_name = ? and  genre_id > ? ORDER BY ischar, p_name, genre_id limit ?)) ORDER BY ischar, p_name, genre_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , p_name FROM main.genre WHERE p_name = ? and  genre_id < ? ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ?) UNION SELECT * FROM (SELECT genre_id, p_name FROM db2.genre WHERE p_name = ? and  genre_id < ? ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ?)) ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ? */
                /* SELECT genre_id , p_name FROM main.genre WHERE p_name = ? and  genre_id > ? ORDER BY ischar, p_name, genre_id limit ? */
                /* SELECT genre_id , p_name FROM main.genre WHERE p_name = ? and  genre_id < ? ORDER BY ischar DESC, p_name DESC, genre_id DESC limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , genre_name FROM main.genre WHERE genre_name = ? and  genre_id > ? ORDER BY genre_name , genre_id limit ?) UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name = ? and  genre_id > ? ORDER BY genre_name , genre_id limit ?)) ORDER BY genre_name , genre_id limit ? */
                /* SELECT * FROM (SELECT * FROM (SELECT genre_id , genre_name FROM main.genre WHERE genre_name = ? and  genre_id < ? ORDER BY genre_name DESC, genre_id DESC limit ?) UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name = ? and  genre_id < ? ORDER BY genre_name DESC, genre_id DESC limit ?)) ORDER BY genre_name DESC, genre_id DESC limit ? */
                table_name = "genre";

                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(asc > 0)
                    {
                        ptr = SqlOgenrepnaidasc;
                        cond2 = Sqlgenrelarg;
                    }
                    else
                    {
                        ptr = SqlOgenrepnaiddesc;
                        cond2 = Sqlgenresmal;
                    }
                    select_item = "genre_id , p_name";
                    cond = "p_name = ? AND";
                }
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOgenrenaidasc;
                        cond2 = Sqlgenrelarg;
                    }
                    else
                    {
                        ptr = SqlOgenrenaiddesc;
                        cond2 = Sqlgenresmal;
                    }
                    select_item = "genre_id, genre_name";
                    cond = "genre_name = ? AND";
                }
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.%s WHERE %s %s%s) UNION %s SELECT * FROM (SELECT %s FROM db2.%s WHERE %s %s%s)) %s", 
                        select_item, table_name, cond, cond2, ptr, union_all, select_item, table_name, cond, cond2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT %s FROM %s WHERE %s %s%s", select_item, table_name, cond, cond2, ptr);
        }

        if(stmt_id == PLS_SQL_STMT_NULL)
        {
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        }
        else
        {
            ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
        }
        
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint8(stmt, 1, ischar);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt,3, id0);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 5, ischar);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_uint32(stmt, 7, id0);
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, id0);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 4, name);
                sqlite3_bind_kal_uint32(stmt, 5, id0);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count_t++;
            id0 = sqlite3_column_kal_uint32(stmt, 0);

            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
            ret = pls_sql_step_ex(db, stmt);       
        }

        pls_sql_finalize_or_clear_binding(stmt, stmt_id);

        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return ret;
        }
    }
    else if(view_type == SRV_PLST_VIEW_PLST)
    {
        /* SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE create_time = ? AND plst_id < ? AND plst_name != "" ORDER BY plst_id DESC limit ?) UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE create_time = ? AND plst_id < ? ORDER BY plst_id DESC limit ?))  ORDER BY plst_id DESC limit ? */
        /* SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE create_time = ? AND plst_id > ? AND plst_name != "" ORDER BY plst_id limit ?) UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE create_time = ? AND plst_id > ? ORDER BY plst_id limit ?))  ORDER BY plst_id limit ?  */
        /* SELECT plst_id, create_time FROM main.plst WHERE create_time = ? AND plst_id < ? AND plst_name != "" ORDER BY plst_id DESC limit ? */
        /* SELECT plst_id , create_time FROM main.plst WHERE create_time = ? AND plst_id > ? AND plst_name != "" ORDER BY plst_id ASC limit ? */
        /* SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name = ? AND plst_id > ? ORDER BY plst_id ASC limit ?) UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name = ? AND plst_id > ? ORDER BY plst_id limit ?))  ORDER BY plst_id limit ? */
        /* SELECT * FROM (SELECT * FROM (SELECT plst_id , plst_name FROM main.plst WHERE plst_name = ? AND plst_id < ? ORDER BY plst_id DESC limit ?) UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name = ? AND plst_id < ? ORDER BY plst_id  DESC limit ?))  ORDER BY plst_id DESC limit ? */
        /* SELECT plst_id , plst_name FROM main.plst WHERE plst_name = ? AND plst_id > ? ORDER BY plst_id ASC limit ? */
        /* SELECT plst_id , plst_name FROM main.plst WHERE plst_name = ? AND plst_id < ? ORDER BY plst_id DESC limit ? */

        const S8 *select_item = "";
        const S8 *cond = "";
        const S8 *cond2 = "";
        const S8 *cond3 = "";
        const S8 *order_by = "";

        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            select_item = "plst_id, create_time";
            cond = "create_time = ? AND";
            cond3 = "AND plst_name != \"\"";
            if(asc > 0)
            {            
                cond2 = Sqlplstsmal;
                order_by = "plst_id DESC";
            }
            else
            {
                cond2 = Sqlplstlarg;
                order_by = "plst_id";
            }
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            select_item = "plst_id, plst_name";
            cond = "plst_name = ? AND";
            if(asc > 0)
            {            
                cond2 = Sqlplstlarg;
                order_by = "plst_id ASC";
            }
            else
            {
                cond2 = Sqlplstsmal;
                order_by = "plst_id DESC";
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.plst WHERE %s %s %s ORDER BY %s limit ?) UNION ALL \
SELECT * FROM (SELECT %s FROM db2.plst WHERE %s %s ORDER BY %s limit ?))  ORDER BY %s limit ? ",
                        select_item, cond, cond2, cond3, order_by, select_item, cond, cond2,order_by, order_by);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT %s FROM main.plst WHERE %s %s %s ORDER BY %s limit ?", select_item, cond, cond2, cond3, order_by);
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            sqlite3_bind_kal_uint32(stmt, 1, create_time);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
        }
        sqlite3_bind_kal_uint32(stmt, 2, id0);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                sqlite3_bind_kal_uint32(stmt, 4, create_time);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 4, name);
            }
            sqlite3_bind_kal_uint32(stmt, 5, id0);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count_t++;
            id0 = sqlite3_column_kal_uint32(stmt, 0);

            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return ret;
        }
    }

    /* load differrent name media_id vdo_id */    
    count_t = 0;
    stmt_id = PLS_SQL_STMT_NULL;
    switch (view_type)
    {
        const S8* ptr, *ptr2;
        case SRV_PLST_VIEW_AUDIO:
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOpnaidasc;
                    ptr2 = Sqlpnamelarger;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC;
                }
                else
                {
                    ptr = SqlOpnaiddesc;
                    ptr2 = Sqlpnamesmaller;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC;
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE ischar = ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    stmt_id = stmt_id + 1; /* PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC_ATTACH, PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC_ATTACH */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio WHERE ischar = ? AND %s%s" , ptr2, ptr);
                    stmt_id = stmt_id + 2; /* PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_ASC_SINGLE, PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_PINYIN_DESC_SINGLE */
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOnaidasc;
                    ptr2 = Sqlnamelarger;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC;
                }
                else
                {
                    ptr = SqlOnaiddesc;
                    ptr2 = Sqlnamesmaller;
                    stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    stmt_id = stmt_id + 1; /*PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC_ATTACH, PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC_ATTACH */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s%s" , ptr2, ptr);
                    stmt_id = stmt_id + 2; /*PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_ASC_SINGLE, PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_UNICODE_DESC_SINGLE */
                }
            }
            break;
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        case SRV_PLST_VIEW_VIDEO:
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOvideopnaidasc;
                    ptr2 = Sqlpnamelarger;
                }
                else
                {
                    ptr = SqlOvideopnaiddesc;
                    ptr2 = Sqlpnamesmaller;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id , p_name FROM main.video WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, p_name FROM video WHERE %s%s", ptr2, ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOvideonaidasc;
                    ptr2 = Sqlnamelarger;
                }
                else
                {
                    ptr = SqlOvideonaiddesc;
                    ptr2 = Sqlnamesmaller;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id , name FROM main.video WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM video WHERE %s%s", ptr2, ptr);
                }
            }
            break;
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        case SRV_PLST_VIEW_ARTIST:
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOartistpnaidasc;
                    ptr2 = Sqlpnamelarger;
                }
                else
                {
                    ptr = SqlOartistpnaiddesc;
                    ptr2 = Sqlpnamesmaller;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id , p_name, ischar FROM main.artist WHERE ischar = ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist WHERE ischar = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name, ischar FROM artist WHERE ischar = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOartistnaidasc;
                    ptr2 = Sqlartistnalarg;
                }
                else
                {
                    ptr = SqlOartistnaiddesc;
                    ptr2 = Sqlartistnasmal;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id , artist_name FROM main.artist WHERE %s%s) \
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM artist WHERE %s%s", ptr2, ptr);
                }
            }
            break;
        case SRV_PLST_VIEW_ALBUM:
        case SRV_PLST_VIEW_IMAGE_FLOW:
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
               if(asc > 0)
                {
                    ptr = SqlOalbumpnaidasc;
                    ptr2 = Sqlpnamelarger;                
                }
                else
                {
                    ptr = SqlOalbumpnaiddesc;
                    ptr2 = Sqlpnamesmaller;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album  WHERE ischar = ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name, ischar  FROM db2.album WHERE ischar = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT album_id, p_name, ischar FROM album WHERE ischar = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOalbumnaidasc;
                    ptr2 = Sqlalbumnalarg;                
                }
                else
                {
                    ptr = SqlOalbumnaiddesc;
                    ptr2 = Sqlalbumnasmal;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , album_name FROM main.album  WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE %s%s", ptr2, ptr);
                }
            }
            break;
    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        case SRV_PLST_VIEW_GENRE:
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOgenrepnaidasc;
                    ptr2 = Sqlpnamelarger;
                }
                else
                {
                    ptr = SqlOgenrepnaiddesc;
                    ptr2 = Sqlpnamesmaller;
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id , p_name FROM main.genre WHERE %s%s) \
UNION SELECT * FROM (SELECT genre_id, p_name FROM db2.genre WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT genre_id, p_name FROM genre WHERE %s%s", ptr2, ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOgenrenaidasc;
                    ptr2 = Sqlgenrenalarg;
                }
                else
                {
                    ptr = SqlOgenrenaiddesc;
                    ptr2 = Sqlgenrenasmal;
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id , genre_name FROM main.genre WHERE %s%s) \
    UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM genre WHERE %s%s", ptr2, ptr);
                }
            }
            break;
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        case SRV_PLST_VIEW_PLST:
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
               if(asc > 0)
                {
                    ptr = SqlOplsttimeidasc;
                    ptr2 = Sqlplsttimesmal;
                }
                else
                {
                    ptr = SqlOplsttimeiddesc;
                    ptr2 = Sqlplsttimelarg;
                }

                if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id , create_time FROM main.plst WHERE plst_name != \"\" AND %s%s) \
UNION ALL SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plst_id, create_time FROM plst WHERE plst_name != \"\" AND %s%s", ptr2, ptr);             
                    }
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOplstnaidasc;
                    ptr2 = Sqlplstnalarg;
                }
                else
                {
                    ptr = SqlOplstnaiddesc;
                    ptr2 = Sqlplstnasmal;
                }
                if((!list_view->is_mark || include_def_list) && (base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST))
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id , plst_name FROM main.plst WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE %s%s", ptr2, ptr);             
                    }
                }
                else
                {
                    /* !(!list_view->is_mark || include_def_list) ||
                       ((!list_view->is_mark || include_def_list) && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST) */
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id , plst_name FROM main.plst WHERE plst_name != \"\" AND %s%s) \
UNION ALL SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr); 
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE %s  AND plst_name != \"\" %s", ptr2, ptr);
                    }
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            break;

        default :
            return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(stmt_id == PLS_SQL_STMT_NULL)
    {
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    }
    else
    {
        ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
    }
    
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(view_type != SRV_PLST_VIEW_PLST && base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        sqlite3_bind_kal_uint8(stmt, 1, ischar);
        sqlite3_bind_kal_wstr(stmt, 2, name);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint8(stmt, 4, ischar);
            sqlite3_bind_kal_wstr(stmt, 5, name);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && view_type == SRV_PLST_VIEW_PLST)
        {
            sqlite3_bind_kal_uint32(stmt, 1, create_time);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1,name);
        }
        sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && view_type == SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, create_time);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 3,name);
            }
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        }    
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    ret = pls_sql_step_ex(db, stmt);
    while (ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        count_t++;
        id0 = sqlite3_column_kal_uint32(stmt, 0);     
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id0);
        ret = pls_sql_step_ex(db, stmt);       
    }

    pls_sql_finalize_or_clear_binding(stmt, stmt_id);

#ifdef __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__
    if( view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST &&
        count_t < SRV_PLST_SELECT_SQL_MIN_NUM && asc > 0)
    {        
        ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id ASC", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;

            temp_id = sqlite3_column_kal_uint32(stmt, 0);
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, temp_id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
            }
            ret = pls_sql_step_ex(db, stmt);
        }                    
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }       
    }
#endif /* __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__ */

    if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }

    if(view_type == SRV_PLST_VIEW_PLST && base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST &&
        base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && (!list_view->is_mark || include_def_list))
    {
        if(asc < 0)
        {
            ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id DESC", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 temp_id;
                temp_id = sqlite3_column_kal_uint32(stmt, 0);
                if(list_cache->cache_num == 0)
                {
                    if(asc > 0)
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, temp_id);
                    }
                    else
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, temp_id);
                    }
                }
                else
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                }
                ret = pls_sql_step_ex(db, stmt);
            }                    
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = SRV_PLST_OK;
        }
    }

    /* same name but different ischar */
    stmt_id = PLS_SQL_STMT_NULL;
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && view_type != SRV_PLST_VIEW_PLST)
    {
        const S8* ptr, *ptr2;
        if(asc > 0)
        {
            ptr2 = Sqlischarlarger;
            ptr = SqlOpnaidasc;
        }
        else
        {
            ptr2 = Sqlischarsmaller;
            ptr = SqlOpnaiddesc;
        }
        switch(view_type)
        {
            case SRV_PLST_VIEW_AUDIO:
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    if(asc > 0)
                    {
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_ASC_ATTACH;
                    }
                    else
                    {
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_DESC_ATTACH;
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio WHERE %s%s" , ptr2, ptr);
                    if(asc > 0)
                    {
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_ASC_SINGLE;
                    }
                    else
                    {
                        stmt_id = PLS_SQL_STMT_SELECT_ONE_LEVEL_AUDIO_DIFF_ISCHAR_DESC_SINGLE;
                    }
                }
                break;

            case SRV_PLST_VIEW_ARTIST:
                if(asc > 0)
                {
                    ptr = SqlOartistpnaidasc;
                }
                else
                {
                    ptr = SqlOartistpnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id , p_name, ischar FROM main.artist WHERE %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name, ischar FROM artist WHERE %s%s", ptr2, ptr);
                }
                break;

            case SRV_PLST_VIEW_ALBUM:
                if(asc > 0)
                {
                    ptr = SqlOalbumpnaidasc;
                }
                else
                {
                    ptr = SqlOalbumpnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id , p_name, ischar FROM main.album WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE  %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, p_name, ischar FROM album WHERE %s%s", ptr2, ptr);
                }
                break;

            default:
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        if(stmt_id == PLS_SQL_STMT_NULL)
        {
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        }
        else
        {
            ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);
        }
        
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint8(stmt, 1, ischar);
        sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, ischar);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;

            temp_id = sqlite3_column_kal_uint32(stmt, 0);
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, temp_id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
            }
            ret = pls_sql_step_ex(db, stmt);
        }

        pls_sql_finalize_or_clear_binding(stmt, stmt_id);
        
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }       
    }
    return ret;
}


static S32 pls_sql_get_item_to_fill_cache_two_level_for_search(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type0;
    S32 ret = SRV_PLST_OK;
    U32 id = 0;
    U32 count_t = 0;
    UI_character_type name_s[META_TAG_FRAME_MAX_LEN + 1];
    UI_character_type name_t[2];
    UI_character_type name_p[2];
    const S8 *ptr, *ptr2;
    MMI_BOOL is_prematach = MMI_FALSE;
    MMI_BOOL is_chinese = MMI_FALSE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type0 = list_view->view_type[0];
    name_t[0] = 0;
    name_p[0] = 92;
    name_p[1] = 0;
    if((list_view->search[0] >= 0x4E00) && (list_view->search[0] <= 0x9FA5))
    {
        is_chinese = MMI_TRUE;
    }
    memset(name_s, 0, sizeof(name_s));
    pls_sql_util_parser_search_string(list_view->search, name_s,META_TAG_FRAME_MAX_LEN);
    //kal_wsprintf(name_s, "%w%c", list_view->search, '%');
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
        (index == 0 && asc > 0))
    {
        if(view_type0 == SRV_PLST_VIEW_AUDIO)
        {    
            if(asc > 0)
            {
                ptr = SqlOmediaidasc;
            }
            else
            {
                ptr = SqlOmediaiddesc;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {                
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, p_name FROM main.audio WHERE  p_name like ? escape ? %s) UNION \
select * from (select media_id, p_name FROM db2.audio WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM main.audio WHERE  p_name like ? escape ? %s", ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, name FROM main.audio WHERE  name like ? escape ? %s) UNION \
select * from (select media_id, name FROM db2.audio WHERE  name like ? escape ? %s))%s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name like ? escape ? %s", ptr);
                }
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ARTIST)
        {
            if(asc > 0)
            {
                ptr = SqlOartistidasc;
            }
            else
            {
                ptr = SqlOartistiddesc;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  p_name like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE  p_name like ? escape ? %s", ptr);  
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE  artist_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? %s", ptr);  
                }
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ALBUM)
        {
            if(asc > 0)
            {
                ptr = SqlOalbumidasc;
            }
            else
            {
                ptr = SqlOalbumiddesc;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE  p_name like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE  p_name like ? escape ? %s", ptr);  
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE  album_name like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE  album_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE  album_name like ? escape ? %s", ptr);  
                }
            }
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(asc > 0)
        {
            sqlite3_bind_kal_wstr(stmt, 1 ,name_s);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
        }
        sqlite3_bind_kal_wstr(stmt, 2, name_p);
        sqlite3_bind_kal_uint32(stmt, 3, 1);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(asc > 0)
            {
                sqlite3_bind_kal_wstr(stmt, 4 ,name_s);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
            }
            sqlite3_bind_kal_wstr(stmt, 5, name_p);
            sqlite3_bind_kal_uint32(stmt, 6, 1);   
            sqlite3_bind_kal_uint32(stmt, 7, 1);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {   
            if(asc > 0)
            {
                is_prematach = MMI_TRUE;
            }
            id = sqlite3_column_kal_uint32(stmt,0);            
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            }
            pls_sql_finalize(stmt);  
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);  
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

            /* not found by first match */
            if(view_type0 == SRV_PLST_VIEW_AUDIO)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, p_name FROM main.audio WHERE  p_name like ? escape ? %s) UNION \
select * from (select media_id, p_name FROM db2.audio WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM main.audio WHERE  p_name like ? escape ? %s", ptr);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, name FROM main.audio WHERE  name like ? escape ? %s) UNION \
select * from (select media_id, name FROM db2.audio WHERE  name like ? escape ? %s))%s", ptr, ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE  name like ? escape ? %s", ptr);
                    }
                }
            }
            else if(view_type0 == SRV_PLST_VIEW_ARTIST)
            {    
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  p_name like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE  p_name like ? escape ? %s", ptr);  
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE  artist_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? %s", ptr);  
                    }
                }
            }
            else if(view_type0 == SRV_PLST_VIEW_ALBUM)
            {   
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE  p_name like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE  p_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE  p_name like ? escape ? %s", ptr);  
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE  album_name like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE  album_name like ? escape ? %s))%s", ptr, ptr, ptr);  
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE  album_name like ? escape ? %s", ptr);  
                    }
                }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(asc > 0)
            {
                sqlite3_bind_kal_wstr(stmt, 1 ,list_view->string);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 1, name_s);
            }
			// MAUI_02942522
			//Error sqlite api usage
			//Should use sqlite3_bind_kal_wstr for string bind but not sqlite3_bind_kal_uint32
            sqlite3_bind_kal_wstr(stmt, 2, name_p);
            sqlite3_bind_kal_uint32(stmt, 3, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(asc > 0)
                {
                    sqlite3_bind_kal_wstr(stmt, 4 ,list_view->string);
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 4, name_s);
                }
                sqlite3_bind_kal_wstr(stmt, 5, name_p);
                sqlite3_bind_kal_uint32(stmt, 6, 1);    
                sqlite3_bind_kal_uint32(stmt, 7, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(asc < 0)
                {
                    is_prematach = MMI_TRUE;
                }
                id = sqlite3_column_kal_uint32(stmt,0);            
                if(list_cache->cache_num == 0)
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                }
                else
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                }
                pls_sql_finalize(stmt);  
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }          
    }
    else
    {
        S32 last_index;
        if(asc > 0)
        {
            if(list_cache->tail)
            {
                last_index = list_cache->tail - 1;
            }
            else
            {
                last_index = SRV_PLST_VIEW_LIST_CACHE - 1;
            }
        }
        else
        {
            last_index = list_cache->head;
        }
        id = list_cache->cache[last_index].id;  
        if(view_type0 == SRV_PLST_VIEW_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
                if(id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM db2.audio WHERE media_id = ?", &stmt);
                } 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ARTIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name from main.artist WHERE artist_id = ? UNION SELECT p_name FROM db2.artist WHERE artist_id = ? ", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.artist WHERE artist_id = ?", &stmt);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT artist_name from main.artist WHERE artist_id = ? UNION SELECT artist_name FROM db2.artist WHERE artist_id = ? ", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ?", &stmt);
                }

            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ALBUM)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name from main.album WHERE album_id = ? UNION SELECT p_name FROM db2.album WHERE album_id = ? ", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.album WHERE album_id = ?", &stmt);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT album_name from main.album WHERE album_id = ? UNION SELECT album_name FROM db2.album WHERE album_id = ? ", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE album_id = ?", &stmt);
                }

            }
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST && view_type0 != SRV_PLST_VIEW_AUDIO)
        {
            sqlite3_bind_kal_uint32(stmt, 2, id);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 length = 0;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,0)))
            {
                mmi_ucs2ncpy((S8*) name_s, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name_s[0] = 0;
            }
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;

            length = mmi_ucs2strlen((S8*)list_view->search);
            if(length > 0 && !mmi_ucs2nicmp((S8*)name_s, (S8*)list_view->search,length))
            {
                is_prematach = MMI_TRUE;
            }

            kal_wsprintf(name_s, "%w%c", list_view->search, '%');
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            return ret;
        }            
    }

//find more
    count_t = 0;
    if(view_type0 == SRV_PLST_VIEW_AUDIO)
    {
        if(asc > 0)
        {
            ptr = SqlOmediaidasc;
            ptr2 = Sqlmedialarger;
        }
        else
        {
            ptr = SqlOmediaiddesc;
            ptr2 = Sqlmediasmaller;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, p_name FROM main.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s) UNION \
select * from (select media_id, p_name FROM db2.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM main.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s %s", ptr2, ptr);
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, name FROM main.audio WHERE name like ? escape ? AND name not like ? escape ? AND %s%s) UNION \
select * from (select media_id, name FROM db2.audio WHERE name like ? escape ? AND name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name like ? escape ? AND name not like ? escape ? AND %s %s", ptr2, ptr);
            }
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ARTIST)
    {
        if(asc > 0)
        {
            ptr = SqlOartistidasc;
            ptr2 = Sqlartistidlarg;
        }
        else
        {
            ptr = SqlOartistiddesc;
            ptr2 = Sqlartistidsmal;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s", ptr2, ptr);  
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? AND artist_name not like ? escape ? AND %s%s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE artist_name like ? escape ? AND artist_name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE artist_name like ? escape ? AND artist_name not like ? escape ? AND %s%s", ptr2, ptr);  
            }
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ALBUM)
    {
        if(asc > 0)
        {
            ptr = SqlOalbumidasc;
            ptr2 = Sqlalbumlarg;
        }
        else
        {
            ptr = SqlOalbumiddesc;
            ptr2 = Sqlalbumsmal;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE p_name like ? escape ? AND p_name not like ? escape ? AND %s%s", ptr2, ptr);  
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE album_name like ? escape ? AND album_name not like ? escape ? AND %s%s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE album_name like ? escape ? AND album_name not like ? escape ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE album_name like ? escape ? AND album_name not like ? escape ? AND %s%s", ptr2, ptr);  
            }
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    if(is_prematach)
    {
        sqlite3_bind_kal_wstr(stmt, 1, name_s);
        sqlite3_bind_kal_wstr(stmt, 2, name_p);
        sqlite3_bind_kal_wstr(stmt, 3, name_t);
        sqlite3_bind_kal_wstr(stmt, 4, name_p);
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
        sqlite3_bind_kal_wstr(stmt, 2, name_p);
        sqlite3_bind_kal_wstr(stmt, 3, name_s);
        sqlite3_bind_kal_wstr(stmt, 4, name_p);
    }
    sqlite3_bind_kal_uint32(stmt, 5, id);
    sqlite3_bind_kal_uint32(stmt, 6, 5);
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        if(is_prematach)
        {
            sqlite3_bind_kal_wstr(stmt, 7, name_s);
            sqlite3_bind_kal_wstr(stmt, 8, name_p);
            sqlite3_bind_kal_wstr(stmt, 9, name_t);
            sqlite3_bind_kal_wstr(stmt, 10, name_p);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 7, list_view->string);
            sqlite3_bind_kal_wstr(stmt, 8, name_p);
            sqlite3_bind_kal_wstr(stmt, 9, name_s);
            sqlite3_bind_kal_wstr(stmt, 10, name_p);
        }
        sqlite3_bind_kal_uint32(stmt, 11, id);
        sqlite3_bind_kal_uint32(stmt, 12, 5);
        sqlite3_bind_kal_uint32(stmt, 13, 5);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {    
        count_t++;
        id = sqlite3_column_kal_uint32(stmt,0);            
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);           
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);    
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }  

    if(count_t >= 5 || (asc > 0 && !is_prematach) || (asc < 0 && is_prematach))
    {
        return ret;
    }
    if(view_type0 == SRV_PLST_VIEW_AUDIO)
    {
        if(asc > 0)
        {
            ptr = SqlOmediaidasc;
        }
        else
        {
            ptr = SqlOmediaiddesc;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, p_name FROM main.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? %s) UNION \
select * from (select media_id, p_name FROM db2.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? %s))%s", ptr, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM main.audio WHERE p_name like ? escape ? AND p_name not like ? escape ? %s",  ptr);
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT media_id, name FROM main.audio WHERE name like ? escape ? AND name not like ? escape ? %s) UNION \
select * from (select media_id, name FROM db2.audio WHERE name like ? escape ? AND name not like ? escape ? %s))%s", ptr,  ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name like ? escape ? AND name not like ? escape ? %s", ptr);
            }
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ARTIST)
    {
        if(asc > 0)
        {
            ptr = SqlOartistidasc;
            ptr2 = Sqlartistidlarg;
        }
        else
        {
            ptr = SqlOartistiddesc;
            ptr2 = Sqlartistidsmal;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? %s))%s", ptr, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE p_name like ? escape ? AND p_name not like ? escape ? %s", ptr);  
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT artist_id, artist_name FROM main.artist WHERE  artist_name like ? escape ? AND artist_name not like ? escape ? %s) UNION \
select * from (select artist_id, artist_name FROM db2.artist WHERE artist_name like ? escape ? AND artist_name not like ? escape ? %s))%s", ptr, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE artist_name like ? escape ? AND artist_name not like ? escape ? %s", ptr);  
            }
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ALBUM)
    {
        if(asc > 0)
        {
            ptr = SqlOalbumidasc;
            ptr2 = Sqlalbumlarg;
        }
        else
        {
            ptr = SqlOalbumiddesc;
            ptr2 = Sqlalbumsmal;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE p_name like ? escape ? AND p_name not like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE p_name like ? escape ? AND p_name not like ? escape ? %s))%s", ptr, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE p_name like ? escape ? AND p_name not like ? escape ? %s", ptr);  
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "select * from (select * from (SELECT album_id, album_name FROM main.album WHERE album_name like ? escape ? AND album_name not like ? escape ? %s) UNION \
select * from (select album_id, album_name FROM db2.album WHERE album_name like ? escape ? AND album_name not like ? escape ? %s))%s", ptr, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE album_name like ? escape ? AND album_name not like ? escape ? %s", ptr);  
            }
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(asc > 0)
    {
        sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
        sqlite3_bind_kal_wstr(stmt, 2, name_p);
        sqlite3_bind_kal_wstr(stmt, 3, name_s);
        sqlite3_bind_kal_wstr(stmt, 4, name_p);
        sqlite3_bind_kal_uint32(stmt, 5, 5);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {       
            sqlite3_bind_kal_wstr(stmt, 6, list_view->string);
            sqlite3_bind_kal_wstr(stmt, 7, name_p);
            sqlite3_bind_kal_wstr(stmt, 8, name_s);
            sqlite3_bind_kal_wstr(stmt, 9, name_p);
            sqlite3_bind_kal_uint32(stmt, 10, 5);
            sqlite3_bind_kal_uint32(stmt, 11, 5);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 1, name_s);
        sqlite3_bind_kal_wstr(stmt, 2, name_p);
        sqlite3_bind_kal_wstr(stmt, 3, name_t);
        sqlite3_bind_kal_wstr(stmt, 4, name_p);
        sqlite3_bind_kal_uint32(stmt, 5, 5);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {       
            sqlite3_bind_kal_wstr(stmt, 6, name_s);
            sqlite3_bind_kal_wstr(stmt, 7, name_p);
            sqlite3_bind_kal_wstr(stmt, 8, name_t);
            sqlite3_bind_kal_wstr(stmt, 9, name_p);
            sqlite3_bind_kal_uint32(stmt, 10, 5);
            sqlite3_bind_kal_uint32(stmt, 11, 5);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {    
        count_t++;
        id = sqlite3_column_kal_uint32(stmt,0);            
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);           
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);    
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }  
    return ret;
}


#ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_two_level_for_prefix_search
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_two_level_for_prefix_search(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type0;
    S32 ret = SRV_PLST_OK;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    U32 length;
    U32 id = 0;
    U32 count_t = 0;
    const S8 *ptr, *ptr2;
    U8  alpha_c = 0;  /*0: IN  1: <A  2: 2:>z  */
    UI_character_type alpha_s[2];
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type0 = list_view->view_type[0];
    mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN - 1);
    mmi_ucs2ncpy((S8*) name, (S8*) list_view->search, SRV_PLST_META_INFO_MAX_LEN);
    length = mmi_ucs2strlen((S8*)(list_view->string));
    if(!length)
    {
        return SRV_PLST_RET_EMPTY;
    }
    list_view->string[length - 1] = list_view->string[length - 1] + 1;        
    alpha_s[0] = 0;
    alpha_s[1] = 0;

    if(list_view->search[0] < 65) /* < A */
    {
        alpha_c = 1;
        alpha_s[0] = 91;
    }
    else if(list_view->search[0] > 122) /* > 'z' */
    {
        alpha_c = 2;
        alpha_s[0] = 96;
    }
    /* to do: should modify for artist: Coldplay, coldplay */
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
        (index == 0 && asc > 0))
    {
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(view_type0 == SRV_PLST_VIEW_VIDEO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ptr2 = Sqlsearchpname;
                if(asc > 0)
                {
                    ptr = SqlOvideopnaidasc;
                }
                else
                {
                    ptr = SqlOvideopnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE %s%s) \
UNION SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE p_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE p_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE p_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE p_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, p_name FROM main.video WHERE %s%s", ptr2, ptr);                
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, p_name FROM main.video WHERE p_name < ? AND %s%s", ptr2, ptr); 
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, p_name FROM main.video WHERE p_name > ? AND %s%s", ptr2, ptr); 
                    }
                }
            }
            else
            {
                ptr2 = Sqlsearchname;
                if(asc > 0)
                {
                    ptr = SqlOvideonaidasc;
                }
                else
                {
                    ptr = SqlOvideonaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s%s) \
    UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name < ? AND %s%s) \
    UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name > ? AND %s%s) \
    UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, name FROM main.video WHERE %s%s", ptr2, ptr);                
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, name FROM main.video WHERE name < ? AND %s%s", ptr2, ptr); 
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT vdo_id, name FROM main.video WHERE name > ? AND %s%s", ptr2, ptr); 
                    }
                }
            }
        }
        else
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
        if(view_type0 == SRV_PLST_VIEW_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ptr2 = Sqlsearchpname;
                if(asc > 0)
                {
                    ptr = SqlOpnaidasc;                
                }
                else
                {
                    ptr = SqlOpnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE p_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE p_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE p_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE p_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, p_name FROM main.audio WHERE %s%s", ptr2, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, p_name FROM main.audio WHERE p_name < ? AND %s%s", ptr2, ptr);    
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, p_name FROM main.audio WHERE p_name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
            else
            {
                ptr2 = Sqlsearchname;
                if(asc > 0)
                {
                    ptr = SqlOnaidasc;                
                }
                else
                {
                    ptr = SqlOnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name > ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, name FROM main.audio WHERE %s%s", ptr2, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, name FROM main.audio WHERE name < ? AND %s%s", ptr2, ptr);    
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, name FROM main.audio WHERE name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ARTIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ptr2 = Sqlsearchpname;
                if(asc > 0)
                {
                    ptr = SqlOartistpnaidasc;
                }
                else
                {
                    ptr = SqlOartistpnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE %s%s)\
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE p_name < ? AND %s%s)\
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE p_name < ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE p_name > ? AND %s%s)\
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE p_name > ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, p_name FROM main.artist WHERE %s%s", ptr2, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, p_name FROM main.artist WHERE p_name < ? AND %s%s", ptr2, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, p_name FROM main.artist WHERE p_name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
            else
            {
                ptr2 = Sqlsearchartistname;
                if(asc > 0)
                {
                    ptr = SqlOartistnaidasc;
                }
                else
                {
                    ptr = SqlOartistnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE %s%s)\
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name < ? AND %s%s)\
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name < ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name > ? AND %s%s)\
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name > ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, artist_name FROM main.artist WHERE %s%s", ptr2, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, artist_name FROM main.artist WHERE artist_name < ? AND %s%s", ptr2, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT artist_id, artist_name FROM main.artist WHERE artist_name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_ALBUM)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ptr2 = Sqlsearchpname;
                if(asc > 0)
                {
                    ptr = SqlOalbumpnaidasc;
                }
                else
                {
                    ptr = SqlOalbumpnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE p_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE p_name < ? AND %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE p_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE p_name > ? AND %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE %s%s", ptr2, ptr);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE album_name < ? AND %s%s", ptr2, ptr);
                    }
                    else 
                    {
                        kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE album_name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
            else
            {
                ptr2 = Sqlsearchalbumname;
                if(asc > 0)
                {
                    ptr = SqlOalbumnaidasc;
                }
                else
                {
                    ptr = SqlOalbumnaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name < ? AND %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                else
                {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name > ? AND %s%s ))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                    kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE %s%s", ptr2, ptr);
                }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE album_name < ? AND %s%s", ptr2, ptr);
                    }
                    else 
                    {
                        kal_sprintf(db->sql_cmd, " SELECT album_id, album_name FROM main.album WHERE album_name > ? AND %s%s", ptr2, ptr);
                    }
                }
            }
        }
    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        else if(view_type0 == SRV_PLST_VIEW_GENRE)
        {
            ptr2 = Sqlsearchgenrename;
            if(asc > 0)
            {
                ptr = SqlOgenrenaidasc;
            }
            else
            {
                ptr = SqlOgenrenaiddesc;
            }
            if(IS_CARD_EXIST)
            {               
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE %s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM main.genre WHERE %s%s", ptr2, ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM main.genre WHERE genre_name < ? AND %s%s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM main.genre WHERE genre_name > ? AND %s%s", ptr2, ptr);
                }                   
            }
        }
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        else if(view_type0 == SRV_PLST_VIEW_PLST) 
        {
            ptr2 = Sqlsearchplstname;
            if(asc > 0)
            {
                ptr = SqlOplstnaidasc;
            }
            else
            {
                ptr = SqlOplstnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE %s%s", ptr2, ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name < ? AND %s%s", ptr2, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name > ? AND %s%s", ptr2, ptr);
                }
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(!alpha_c)
        {
        sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
        sqlite3_bind_kal_uint32(stmt, 3, 1);
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 4, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 5, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 6, 1);
            sqlite3_bind_kal_uint32(stmt, 7, 1);
        }
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 4, 1);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 7, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 8, 1);
                sqlite3_bind_kal_uint32(stmt, 9, 1);
            }            
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id = sqlite3_column_kal_uint32(stmt, 0); 
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
            } 
            else
            {
                name[0] = 0;
            }
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            }
            pls_sql_finalize(stmt);  
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);              
            return ret;
        }             
    }
    else
    {
        U32 last_index;
        srv_plst_list_get_display_struct data;
        if(asc > 0)
        {
            if(list_cache->tail == 0)
            {
                last_index = SRV_PLST_VIEW_LIST_CACHE - 1;
            }
            else
            {
                last_index = list_cache->tail - 1;
            }
        }
        else
        {
            last_index = list_cache->head;
        }
        id = list_cache->cache[last_index].id;

        name[0] = 0;
        data.buff_size = SRV_PLST_META_INFO_MAX_LEN;
        data.string_ptr = (U32)&name[0];

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            switch (view_type0)
            {
                case SRV_PLST_VIEW_AUDIO:
                    if(id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.audio WHERE media_id = ?", &stmt);
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM db2.audio WHERE media_id = ?", &stmt);
                    }
                    break;
            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    if(id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.video WHERE vdo_id = ?", &stmt);                
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM db2.video WHERE vdo_id = ?", &stmt);
                    }
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.artist WHERE artist_id = ? UNION SELECT p_name FROM db2.artist WHERE artist_id = ?", &stmt);
                    }
                    else
                    {

                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.artist WHERE artist_id = ?", &stmt);
                    }
                    break;
                case SRV_PLST_VIEW_ALBUM:
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.album WHERE album_id = ? UNION SELECT p_name FROM db2.album WHERE album_id = ?", &stmt);
                    }
                    else
                    {

                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.album WHERE album_id = ?", &stmt);
                    }
                    break;
                case SRV_PLST_VIEW_GENRE:
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.genre WHERE genre_id = ? UNION SELECT p_name FROM db2.genre WHERE genre_id = ?", &stmt);
                    }
                    else
                    {

                        ret = pls_sql_prepare_ex(db, "SELECT p_name FROM main.genre WHERE genre_id = ?", &stmt);
                    }
                    break;
                case SRV_PLST_VIEW_PLST:
                   // todo: 
                    break;                  
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            if(IS_CARD_EXIST && (view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_GENRE))
            {
                sqlite3_bind_kal_uint32(stmt, 2, id);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    if(view_type0 == SRV_PLST_VIEW_PLST)
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_MAX_FILE_LEN - 1);
                    }
                    else 
                    {
                        mmi_ucs2ncpy((S8*)name,(const S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                    }
                }
                else
                {
                    name[0] = 0;
                }
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }
        }
        else
        {
            ret= pls_sql_get_view_title(db, last_index, (U32*)&data);
        }
        
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }            
    }        

    /* load 20 to cache same name */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(view_type0 == SRV_PLST_VIEW_VIDEO)
    {
        if(asc > 0)
        {
            ptr2 = Sqlvideolarg;
            ptr = SqlOvideoidasc;
        }
        else
        {
            ptr2 = Sqlvideosmal;
            ptr = SqlOvideoiddesc;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name FROM main.video WHERE p_name = ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, p_name FROM db2.video WHERE p_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd,"SELECT vdo_id, p_name FROM video WHERE p_name = ? AND %s%s", ptr2, ptr);
            }
        }
        else
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name = ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr,ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd,"SELECT vdo_id, name FROM video WHERE name = ? AND %s%s", ptr2, ptr);
            } 
        }
    }
    else
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(view_type0 == SRV_PLST_VIEW_AUDIO)
    {
        if(asc > 0)
        {
            ptr2 = Sqlmedialarger;
            ptr = SqlOmediaidasc;
        }
        else
        {
            ptr2 = Sqlmediasmaller;
            ptr = SqlOmediaiddesc;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE p_name = ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE p_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, nap_nameme FROM audio WHERE p_name = ? AND %s%s", ptr2, ptr);
            }
        }
        else
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name = ? AND %s%s", ptr2, ptr);
            } 
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ARTIST)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlartistidlarg;
                ptr = SqlOartistpnaidasc;
            }
            else
            {
                ptr2 = Sqlartistidsmal;
                ptr = SqlOartistpnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE p_name = ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE p_name = ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr,ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name FROM artist WHERE p_name = ? AND %s%s", ptr2, ptr);
            } 
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlartistidlarg;
                ptr = SqlOartistnaidasc;
            }
            else
            {
                ptr2 = Sqlartistidsmal;
                ptr = SqlOartistnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name = ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name = ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr,ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM artist WHERE artist_name = ? AND %s%s", ptr2, ptr);
            } 
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ALBUM)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlalbumlarg;
                ptr = SqlOalbumpnaidasc;
            }
            else
            {
                ptr2 = Sqlalbumsmal;
                ptr = SqlOalbumpnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE p_name = ? AND %s%s )\
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE p_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, p_name FROM album WHERE p_name = ? AND %s%s", ptr2, ptr);
            } 
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlalbumlarg;
                ptr = SqlOalbumnaidasc;
            }
            else
            {
                ptr2 = Sqlalbumsmal;
                ptr = SqlOalbumnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name = ? AND %s%s )\
UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE album_name = ? AND %s%s", ptr2, ptr);
            } 
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_GENRE)
    {// todo:
        if(asc > 0)
        {
            ptr2 = Sqlgenrelarg;
            ptr = SqlOgenrenaidasc;
        }
        else
        {
            ptr2 = Sqlgenresmal;
            ptr = SqlOgenrenaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name = ? AND %s%s)\
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM genre WHERE genre_name = ? AND %s%s", ptr2, ptr);
        } 
    }
    else if(view_type0 == SRV_PLST_VIEW_PLST)
    {// todo:
        if(asc > 0)
        {
            ptr2 = Sqlplstlarg;
            ptr = SqlOplstnaidasc;
        }
        else
        {
            ptr2 = Sqlplstsmal;
            ptr = SqlOplstnaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name = ? AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name = ? AND %s%s", ptr2, ptr);
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = pls_sql_prepare_ex(db,db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    sqlite3_bind_kal_uint32(stmt, 2, id);
    sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_wstr(stmt, 4, name);
        sqlite3_bind_kal_uint32(stmt, 5, id);  
        sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);        
    }

    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
        
        count_t++;        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t >= SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {            
        return ret;
    }               

    /* load 20 to the cache differrent name */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(view_type0 == SRV_PLST_VIEW_VIDEO)
    { //todo  
        if(asc > 0)
        {
            ptr2 = Sqlsearchname2;
            ptr = SqlOvideonaidasc;
        }
        else
        {
            ptr2 = Sqlsearchname;
            ptr = SqlOvideonaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name < ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
        else
        {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name > ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
        }
        else
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM video WHERE %s%s", ptr2, ptr);
        } 
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM video WHERE name < ? AND %s%s", ptr2, ptr);
            }
            else 
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM video WHERE name > ? AND %s%s", ptr2, ptr);
            }
        } 
    }
    else
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(view_type0 == SRV_PLST_VIEW_AUDIO)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchpname2;
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchpname;
                ptr = SqlOpnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE p_name < ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE p_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name FROM main.audio WHERE p_name > ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name FROM db2.audio WHERE p_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE %s%s", ptr2, ptr);
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE p_name < ? AND %s%s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE p_name > ? AND %s%s", ptr2, ptr);
                }
            }                     
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchname2;
                ptr = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchname;
                ptr = SqlOnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name > ? AND %s%s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s%s", ptr2, ptr);
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name < ? AND %s%s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name > ? AND %s%s", ptr2, ptr);
                }
            } 
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ARTIST)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchpname2;
                ptr = SqlOartistpnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchpname;
                ptr = SqlOartistpnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE p_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE p_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name FROM main.artist WHERE p_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, p_name FROM db2.artist WHERE p_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name FROM artist WHERE %s%s", ptr2, ptr);
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name FROM artist WHERE p_name < ? AND %s%s", ptr2, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, p_name FROM artist WHERE p_name > ? AND %s%s", ptr2, ptr);
                }
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchartistname2;
                ptr = SqlOartistnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchartistname;
                ptr = SqlOartistnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE %s%s) \
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                 }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name < ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name > ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM artist WHERE %s%s", ptr2, ptr);
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM artist WHERE artist_name < ? AND %s%s", ptr2, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM artist WHERE artist_name > ? AND %s%s", ptr2, ptr);
                }
            }
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_ALBUM)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchpname2;
                ptr = SqlOalbumpnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchpname;
                ptr = SqlOalbumpnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE p_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE p_name < ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name FROM main.album WHERE p_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT album_id, p_name FROM db2.album WHERE p_name > ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }                
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, p_name FROM album WHERE %s%s", ptr2, ptr);         
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, p_name FROM album WHERE p_name < ? AND %s%s", ptr2, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, p_name FROM album WHERE p_name > ? AND %s%s", ptr2, ptr);
                }
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlsearchalbumname2;
                ptr = SqlOalbumnaidasc;
            }
            else
            {
                ptr2 = Sqlsearchalbumname;
                ptr = SqlOalbumnaiddesc;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE %s%s) \
    UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name < ? AND %s%s) \
    UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name < ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name > ? AND %s%s) \
    UNION SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name > ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }                
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE %s%s", ptr2, ptr);         
                } 
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE album_name < ? AND %s%s", ptr2, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT album_id, album_name FROM album WHERE album_name > ? AND %s%s", ptr2, ptr);
                }
            } 
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_GENRE)
    {// todo
        if(asc > 0)
        {
            ptr2 = Sqlsearchgenrename2;
            ptr = SqlOgenrenaidasc;
        }
        else
        {
            ptr2 = Sqlsearchgenrename;
            ptr = SqlOgenrenaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE %s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
        }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name < ? AND%s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name < ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else 
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name > ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
            }
        }
        else
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM genre WHERE %s%s", ptr2, ptr);
        } 
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM genre WHERE genre_name < ? AND %s%s", ptr2, ptr);
            }
            else 
            {
                kal_sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM genre WHERE genre_name > ? AND %s%s", ptr2, ptr);
            }
        } 
    }
    else if(view_type0 == SRV_PLST_VIEW_PLST)
    {// to do
        if(asc > 0)
        {
            ptr2 = Sqlsearchplstname2;
            ptr = SqlOplstnaidasc;
        }
        else
        {
            ptr2 = Sqlsearchplstname;
            ptr = SqlOplstnaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE %s%s)%s", ptr2, ptr, ptr2, ptr, ptr);
        }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name < ? AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name < ? AND %s%s)%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else 
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name > ? AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name > ? AND %s%s)%s", ptr2, ptr, ptr2, ptr, ptr);
            }
        }
        else
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE %s%s", ptr2, ptr);
        }
            else if(alpha_c)
            {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name < ? AND %s%s", ptr2, ptr);
            }
            else 
            {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM plst WHERE plst_name > ? AND %s%s", ptr2, ptr);
            }
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = pls_sql_prepare_ex(db,db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(IS_CARD_EXIST)
    {
        if(alpha_c)
        {
            sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
            if(asc > 0)
            {
                sqlite3_bind_kal_wstr(stmt, 2, name);
                sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_wstr(stmt, 7, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 3, name);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 7, name);                
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        }
        else
        {
        if(asc > 0)
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_wstr(stmt, 4, name);
            sqlite3_bind_kal_wstr(stmt, 5, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_wstr(stmt, 4, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 5, name);                
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    }
    }
    else
    {
        if(asc > 0)
        {
            if(!alpha_c)
            {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
        else
        {
                sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 2, name);
                sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        }
        else
        {
            if(!alpha_c)
            {
            sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 2, name);          
                sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 3, name);  
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            }               
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
        
        count_t++;        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt);
    return ret;
}
#endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_two_level_for_general_view
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_two_level_for_general_view(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type0,view_type1;
    S32 ret;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];    
    U32 id0;
    U32 special_id; 
    U32 ordinal = 0;
    U32 count_t = 0;
    U16 track_num = 0;
    const S8 *ptr2 = "", *ptr = "", *ptr_select_field;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    if(list_view->current_index > 0 && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        view_type0 = list_view->view_type[0];
        view_type1 = list_view->view_type[1];
    }
    else
    {
        view_type0 = list_view->view_type[list_view->current_index - 1];
        view_type1 = list_view->view_type[list_view->current_index];
    }
    id0 = list_cache->parent_id;

    /* For play list, add a find middle cache function */
    if(view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
    {
        U32 ordinal = 0;
        if (base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME &&
            list_cache->cache_num == 0 && index != 0)
        {
            //@TODO: Need real owner to review and modify all the cache mechanism to support fill cache from mid!
            //MAUI_02935689
            //for the case of reorder, we should suport fill cache from middle idex
            //but currently , we only handle modify time style (cosmos only).
    		//MAUI_02947735: should not use ascend order to query with offset data because the sort is fixed
			ptr = SqlOplstidxiddesc;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)// to do check
            {                
                if(id0 > 0X8000)
                {
                    kal_sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? %s OFFSET ?", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? %s OFFSET ?", ptr);                       
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 %s OFFSET ?", ptr);
            } 
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            sqlite3_bind_kal_uint32(stmt, 3, index);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 id;
     
                ordinal = sqlite3_column_kal_uint32(stmt, 1);
                //list_cache->cache[0].idx_in_list = index;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                if(asc > 0)
                {
                    list_cache->cache[0].id = id;
                    list_cache->cache[0].idx_in_list = index;
                    *index_o = 0;         
                    list_cache->tail++;
                }
                else
                {
                    list_cache->head = SRV_PLST_VIEW_LIST_CACHE - 1;
                    list_cache->cache[list_cache->head].id = id;
                    list_cache->cache[list_cache->head].idx_in_list = index;
                    *index_o = list_cache->head;       
                }
                list_cache->cache_num = 1;
                pls_sql_finalize(stmt);       
            }
        }
    }

    /* general list :find the first one or fill middle cache */
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            /* Fill middle cache*/
            if (list_cache->cache_num == 0 && index != 0)
            {
                /* only file one item and get offset from begining in ascending order */
                ptr = SqlOpnaidascnl;
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOpnaidasc;
                }
                else
                {
                    ptr = SqlOpnaiddesc;
                }
            }
        }
        else
        {
            /* Fill middle cache*/
            if (list_cache->cache_num == 0 && index != 0)
            {
                /* only file one item and get offset from begining in ascending order */
                ptr = SqlOnaidascnl;
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOnaidasc;
                }
                else
                {
                    ptr = SqlOnaiddesc;
                }
            }
        }

        if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                /* Fill middle cache*/
                if (list_cache->cache_num == 0 && index != 0)
                {
                    /* only file one item and get offset from begining in ascending order */
                    ptr = SqlOalbumpnaidasc2nl;
                }
                else
                {
                    if(asc > 0)
                    {                
                        ptr = SqlOalbumpnaidasc2;                
                    }
                    else
                    {
                        ptr = SqlOalbumpnaiddesc2;
                    }
                }
                ptr_select_field = SqlFieldAidAPNameIsChar;
            }
            else
            {
                /* Fill middle cache*/
                if (list_cache->cache_num == 0 && index != 0)
                {
                    /* only file one item and get offset from begining in ascending order */
                    ptr = SqlOalbumnaidasc2nl;
                }
                else
                {
                    if(asc > 0)
                    {                
                        ptr = SqlOalbumnaidasc2;                
                    }
                    else
                    {
                        ptr = SqlOalbumnaiddesc2;
                    }
                }
                ptr_select_field = SqlFieldAidAName;
            }

            /* Combine SQLite command */
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN (SELECT album_id FROM main.audio WHERE artist_id = ?) %s) \
UNION SELECT * FROM (SELECT %s FROM db2.album WHERE album_id IN (SELECT album_id FROM db2.audio WHERE artist_id = ?) %s))%s", ptr_select_field, ptr, ptr_select_field, ptr, ptr);  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT %s FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id %s", ptr_select_field, ptr);
            }

        }
        else if ((view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW ||
            view_type0 == SRV_PLST_VIEW_GENRE )&& (view_type1 == SRV_PLST_VIEW_MEDIA || 
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA)))
        {
            const S8* ptr_p;
            if(view_type0 == SRV_PLST_VIEW_ARTIST)
            {
                ptr_p = Sqlartistid;
            }
            else if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
            {
                ptr_p = Sqlalbumid; /* order by tack num first */
            }
            else
            {
                ptr_p = Sqlgenreid;
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {  
                if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
                {
                    /* Fill middle cache*/
                    if (list_cache->cache_num == 0 && index != 0)
                    {
                        /* only file one item and get offset from begining in ascending order */
                        ptr = SqlOtracknaidascnl;
                    }
                    else
                    {
                        if(asc > 0)
                        {
                            ptr = SqlOtracknaidasc;
                        }
                        else
                        {
                            ptr = SqlOtracknaiddesc;
                        }
                    }
                    ptr_select_field = SqlFieldIdPNameTrack;
                }
                else
                {
                    ptr_select_field = SqlFieldIdPNameIsChar;
                }
            }
            else
            {
                ptr_select_field = SqlFieldIdName;
            }

            /* Combine SQLite command */
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {                    
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT %s FROM main.audio WHERE %s %s) \
UNION ALL SELECT * FROM (SELECT %s FROM db2.audio WHERE %s %s))%s",ptr_select_field, ptr_p, ptr, ptr_select_field, ptr_p, ptr, ptr);                    
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT %s FROM audio WHERE %s %s", ptr_select_field, ptr_p, ptr);
            }

            /* Fill middle cache */
            if (list_cache->cache_num == 0 && index != 0)
            {
                strcat(db->sql_cmd, " limit ? OFFSET ?");
            }
        }
        else if (view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
        {   
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxiddesc;
                }
                else
                {
                    ptr = SqlOplstidxidasc;
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxidasc;
                }
                else
                {
                    ptr = SqlOplstidxiddesc;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {          
                if(id0 > 0X8000)
                {
                    kal_sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? %s", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? %s", ptr);                       
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 %s", ptr);                
            } 
        }        
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }  
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        /* fill middle cache */
        if (list_cache->cache_num == 0 && index != 0 && view_type0 != SRV_PLST_VIEW_PLST)
        {
            U8 i = 1;
            sqlite3_bind_kal_uint32(stmt, i, id0);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST && view_type0 != SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, ++i, id0);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            sqlite3_bind_kal_uint32(stmt, ++i, 1);
            sqlite3_bind_kal_uint32(stmt, ++i, index);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST && view_type0 != SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id0);
                sqlite3_bind_kal_uint32(stmt, 4, 1);
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
            {
                ordinal = sqlite3_column_kal_uint32(stmt, 1);
            }
            else
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                track_num = sqlite3_column_kal_uint16(stmt, 2);
            }
            ret = SRV_PLST_OK;
            special_id = sqlite3_column_kal_uint32(stmt, 0);
            if(list_cache->cache_num == 0)
            {
                /* fill middle cache */
                if(index != 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, asc, index, index, index_o, special_id);
                }
                else
                {
                    if(asc > 0)
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, special_id);
                    }
                    else
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, special_id);
                    }
                }
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, special_id);
            }
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;            
        }        
    }
    else
    {
        S32 last_index;
        srv_plst_list_get_display_struct data;

        if(asc > 0)
        {
            if(list_cache->tail)
            {
                last_index = list_cache->tail - 1;
            }
            else
            {
                last_index = SRV_PLST_VIEW_LIST_CACHE - 1;
            }
        }
        else
        {
            last_index = list_cache->head;
        }
        special_id = list_cache->cache[last_index].id;

        name[0] = 0;
        if(view_type0 != SRV_PLST_VIEW_PLST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
//MAUI_02947174
//should consider cover flow view is the same as ablum view
                if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
                {
                    if(special_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, track_num from main.audio WHERE media_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, track_num FROM db2.audio WHERE media_id = ?", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else if(view_type1 == SRV_PLST_VIEW_MEDIA)
                {
                    if(special_id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar from main.audio WHERE media_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM main.album WHERE album_id = ? UNION SELECT p_name,ischar FROM db2.album WHERE album_id = ?", &stmt);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM main.album WHERE album_id = ?", &stmt);
                    }
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, special_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(view_type1 != SRV_PLST_VIEW_MEDIA && IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, special_id);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                    }
                    else
                    {
                        name[0] = 0;
                    }  
                    track_num = sqlite3_column_kal_uint16(stmt, 1);                
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_OK)
                    {
                        ret = SRV_PLST_RET_EMPTY;
                    }
                    return ret;
                }
            }
            else
            {
                data.buff_size = SRV_PLST_META_INFO_MAX_LEN;
                data.string_ptr = (U32)&name[0];
                ret = pls_sql_get_view_title(db, last_index, (U32*)&data);
            }
        }        
        else if (view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
        {            
            if(id0 > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, special_id);
            sqlite3_bind_kal_uint32(stmt, 2, id0);
            ret = pls_sql_step_ex(db, stmt);
            if (ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                if(view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
                {
                    ordinal = sqlite3_column_kal_uint32(stmt, 0);
                }    
            }
            pls_sql_finalize(stmt);
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }        
    }

   
    /* load 20 items */
    /* load same name record first to do revise*/
    if((view_type1 == SRV_PLST_VIEW_MEDIA && (view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM ||
        view_type0 == SRV_PLST_VIEW_GENRE || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)) ||
        (view_type1 == SRV_PLST_VIEW_ALBUM && view_type0 == SRV_PLST_VIEW_ARTIST))
    {
        if(asc > 0)
        {
            ptr2 = Sqlmedialarger;
            ptr = SqlOmediaidasc;
        }
        else
        {
            ptr2 = Sqlmediasmaller;
            ptr = SqlOmediaiddesc;
        }
        if(view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr2 = Sqlalbumlarg;
                    ptr = SqlOalbumpnaidasc2;
                }
                else
                {
                    ptr2 = Sqlalbumsmal;
                    ptr = SqlOalbumpnaiddesc2;
                }
                ptr_select_field = SqlFieldAidAPNameIsChar;

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN (SELECT album_id FROM main.audio \
WHERE artist_id = ? ) AND album.p_name = ? and %s AND album.ischar = ? %s) UNION SELECT * FROM (SELECT %s FROM db2.album WHERE album_id IN \
(SELECT album_id FROM db2.audio WHERE artist_id = ? )AND album.p_name = ? and %s AND album.ischar = ? %s))%s", ptr_select_field, ptr2, ptr, ptr_select_field, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(asc > 0)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album.p_name as pp_name, album.ischar as p_ischar FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND album.p_name = ? and album.album_id > ? GROUP BY album_name %s", ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album.p_name as pp_name, album.ischar as p_ischar FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND album.p_name = ? and album.album_id < ? GROUP BY album_name %s", ptr);
                    }
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr2 = Sqlalbumlarg;
                    ptr = SqlOalbumnaidasc2;
                }
                else
                {
                    ptr2 = Sqlalbumsmal;
                    ptr = SqlOalbumnaiddesc2;
                }
                ptr_select_field = SqlFieldAidAName;

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN (\
SELECT album_id FROM main.audio WHERE artist_id = ? ) AND album_name = ? and %s%s) UNION SELECT * FROM (SELECT %s \
FROM db2.album WHERE album_id IN (SELECT album_id FROM db2.audio WHERE artist_id = ? )AND album_name = ? and %s%s))%s", ptr_select_field, ptr2, ptr, ptr_select_field, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(asc > 0)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND album.album_name = ? and album.album_id > ? GROUP BY album_name %s", ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND album.album_name = ? and album.album_id < ? GROUP BY album_name %s", ptr);
                    }
                }
            }
        }
        else if ((view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW ||
            view_type0 == SRV_PLST_VIEW_GENRE )&& (view_type1 == SRV_PLST_VIEW_MEDIA || 
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA)))
        {
            const S8 *ptr_p, *ptr_cond1, *ptr_cond2;
            
            if(view_type0 == SRV_PLST_VIEW_ARTIST)
            {
                ptr_p = Sqlartistid;
            }            
            else if(view_type0 == SRV_PLST_VIEW_GENRE)
            {
                ptr_p = Sqlgenreid;
            }
            else
            {                
                ptr_p = Sqlalbumid;               
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
                {
                    if(asc > 0)
                    {
                        ptr = SqlOtracknaidasc;
                    }
                    else
                    {
                        ptr = SqlOtracknaiddesc;
                    }
                }

                ptr_cond1 = " AND p_name = ?";
                if(view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_GENRE)
                {
                    ptr_select_field = SqlFieldIdPNameIsChar;
                    ptr_cond2 = " AND ischar = ? ";
                }
                else
                {
                    ptr_select_field = SqlFieldIdPNameTrack;
                    ptr_cond2 = " AND track_num = ? ";
                }


            }
            else
            {
                ptr_select_field = SqlFieldIdName;
                ptr_cond1 = " AND name = ?";
                ptr_cond2 = "";
            }

            /* Combine SQLite command */
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.audio WHERE %s%s AND %s%s%s) UNION ALL SELECT * FROM \
(SELECT %s FROM db2.audio WHERE %s%s AND %s%s%s))%s", ptr_select_field, ptr_p, ptr_cond1, ptr2, ptr_cond2, ptr, ptr_select_field, ptr_p, ptr_cond1, ptr2, ptr_cond2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT %s FROM audio WHERE %s%s AND %s%s%s", ptr_select_field, ptr_p, ptr_cond1, ptr2, ptr_cond2, ptr);
            }
        }
        else if(view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
        {        
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxiddesc;
                }
                else
                {
                    ptr = SqlOplstidxidasc;
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxidasc;
                }
                else
                {
                    ptr = SqlOplstidxiddesc;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                
            if(id0 > 0X8000)
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND idx = ? %s", ptr);                
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? AND idx = ? %s", ptr);               
            }           
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }        
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && view_type0 != SRV_PLST_VIEW_PLST)
        {
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            sqlite3_bind_kal_wstr(stmt, 2,name);
            sqlite3_bind_kal_uint32(stmt, 3, special_id);
            sqlite3_bind_kal_uint32(stmt, 4, track_num);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 6, id0);
                sqlite3_bind_kal_wstr(stmt, 7,name);
                sqlite3_bind_kal_uint32(stmt, 8, special_id);
                sqlite3_bind_kal_uint32(stmt, 9, track_num);
                sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
            }    
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            if(view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
            {
                sqlite3_bind_kal_uint32(stmt, 1, id0);
                sqlite3_bind_kal_uint32(stmt, 2, ordinal);
                sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, id0);
                sqlite3_bind_kal_wstr(stmt, 2,name);
                sqlite3_bind_kal_uint32(stmt, 3, special_id);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, id0);
                    sqlite3_bind_kal_wstr(stmt, 6,name);
                    sqlite3_bind_kal_uint32(stmt, 7, special_id);
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
                }    
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 id2;
            
            count_t++;        
            id2 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count_t >= SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return ret;
        }   
    }

    /* load different name record*/
    if(view_type0 == SRV_PLST_VIEW_PLST)
    {    
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(asc > 0)
            {
                ptr2 = Sqlplstidxsmal;
                ptr = SqlOplstidxiddesc;
            }
            else
            {
                ptr2 = Sqlplstidxlarg;
                ptr = SqlOplstidxidasc;
            }

        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else        
        {
            if(asc > 0)
            {
                ptr2 = Sqlplstidxlarg;
                ptr = SqlOplstidxidasc;
            }
            else
            {
                ptr2 = Sqlplstidxsmal;
                ptr = SqlOplstidxiddesc;
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
    }
    else
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {        
            if(asc > 0)
            {
                ptr2 = Sqlpnamelarger;
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr2 = Sqlpnamesmaller;
                ptr = SqlOpnaiddesc;
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlnamelarger;
                ptr = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlnamesmaller;
                ptr = SqlOnaiddesc;
            }
        }
    }
    if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
        (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlpalbumnamelarger;
                ptr = SqlOalbumpnaidasc2;
            }
            else
            {
                ptr2 = Sqlpalbumnamesmaller;
                ptr = SqlOalbumpnaiddesc2;
            }
            ptr_select_field = SqlFieldAidAPNameIsChar;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN \
(SELECT album_id FROM main.audio WHERE artist_id = ?) AND %s AND album.ischar = ? %s) UNION SELECT * FROM (SELECT %s FROM db2.album \
 WHERE album_id IN (SELECT album_id FROM db2.audio WHERE artist_id = ? ) AND %s AND album.ischar = ? %s))%s", ptr_select_field, ptr2, ptr, ptr_select_field, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album.p_name as pp_name, album.ischar as p_ischar FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND %s AND album.ischar = ? GROUP BY album_name %s", ptr2, ptr);
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlalbumnalarg;
                ptr = SqlOalbumnaidasc2;
            }
            else
            {
                ptr2 = Sqlalbumnasmal;
                ptr = SqlOalbumnaiddesc2;
            }
            ptr_select_field = SqlFieldAidAName;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN \
(SELECT album_id FROM main.audio WHERE artist_id = ?) AND %s%s) UNION SELECT * FROM (SELECT %s FROM db2.album \
WHERE album_id IN (SELECT album_id FROM db2.audio WHERE artist_id = ? ) AND %s%s))%s", ptr_select_field, ptr2, ptr, ptr_select_field, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND %s GROUP BY album_name %s", ptr2, ptr);
            }
        }
    }
    else if ((view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW ||
        view_type0 == SRV_PLST_VIEW_GENRE )&& (view_type1 == SRV_PLST_VIEW_MEDIA || 
        (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA)))
    {
        const S8 *ptr_p, *ptr_cond;
        if(view_type0 == SRV_PLST_VIEW_ARTIST)
        {
            ptr_p = Sqlartistid;
        }
        else if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
        {
            ptr_p = Sqlalbumid;
        }
        else
        {
            ptr_p = Sqlgenreid;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
            {
                if(asc > 0)
                {
                    ptr = SqlOtracknaidasc;
                }
                else
                {
                    ptr = SqlOtracknaiddesc;
                }            
            }

            if(view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_GENRE)
            {
                ptr_select_field = SqlFieldIdPNameIsChar;
                ptr_cond = " AND ischar = ? ";
            }
            else
            {
                ptr_select_field = SqlFieldIdPNameTrack;
                ptr_cond = " AND track_num= ? ";
            }
        }
        else
        {
            ptr_select_field = SqlFieldIdName;
            ptr_cond = "";
        }

        /* Combine SQLite command */
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.audio WHERE %s AND %s%s%s) UNION ALL SELECT * FROM \
(SELECT %s FROM db2.audio WHERE %s AND %s%s%s))%s", ptr_select_field, ptr_p, ptr2, ptr_cond, ptr, ptr_select_field, ptr_p, ptr2, ptr_cond, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT %s FROM audio WHERE %s AND %s%s%s", ptr_select_field, ptr_p, ptr2, ptr_cond, ptr);
        }
    }
    else if (view_type0 == SRV_PLST_VIEW_PLST && view_type1 == SRV_PLST_VIEW_MEDIA)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(id0 > 0X8000)
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND %s%s", ptr2, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? AND %s%s", ptr2, ptr);
            }
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 AND %s%s", ptr2, ptr);
        }       
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }  
        
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(view_type1 != SRV_PLST_VIEW_PLST_ADDTO && view_type0 != SRV_PLST_VIEW_PLST)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, track_num);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 5, id0);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_uint32(stmt, 7, track_num);
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }    
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 4, id0);
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            } 
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    else if(view_type0 == SRV_PLST_VIEW_PLST) 
    {
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        sqlite3_bind_kal_uint32(stmt, 2, ordinal);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);

    while (ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        U32 id2;
        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);

        ret = pls_sql_step_ex(db, stmt);       
		count_t++;
    }
    pls_sql_finalize(stmt); 
    
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    if(count_t >= SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }


    /* album song list order by track num */
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && view_type0 != SRV_PLST_VIEW_PLST)
    {
        if (view_type0 == SRV_PLST_VIEW_ARTIST && (view_type1 == SRV_PLST_VIEW_ALBUM ||
                (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM)))
        {           
            if(asc > 0)
            {
                ptr2 = Sqlalbumischarlarger;
                ptr = SqlOalbumpnaidasc2;
            }
            else
            {
                ptr2 = Sqlalbumischarsmaller;
                ptr = SqlOalbumpnaiddesc2;
            }
            ptr_select_field = SqlFieldAidAPNameIsChar;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.album WHERE album_id IN \
(SELECT album_id FROM main.audio WHERE artist_id = ?) AND %s %s) UNION SELECT * FROM (SELECT %s FROM db2.album  \
WHERE album_id IN (SELECT album_id FROM db2.audio WHERE artist_id = ? ) AND %s%s))%s", ptr_select_field, ptr2, ptr, ptr_select_field, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album.p_name as pp_name, album.ischar as p_ischar FROM audio, album WHERE artist_id = ? AND audio.album_id = album.album_id AND %s GROUP BY album_name %s", ptr2, ptr);
            }
        }
        else if ((view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW ||
            view_type0 == SRV_PLST_VIEW_GENRE )&& (view_type1 == SRV_PLST_VIEW_MEDIA || 
            (view_type1 == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA)))
        {
            const S8* ptr_p;
            if(asc > 0)
            {
                ptr2 = Sqlischarlarger;
            }
            else
            {
                ptr2 = Sqlischarsmaller;
            }
            
            if(view_type0 == SRV_PLST_VIEW_ARTIST)
            {
                ptr_p = Sqlartistid;
            }
            else if(view_type0 == SRV_PLST_VIEW_ALBUM || view_type0 == SRV_PLST_VIEW_IMAGE_FLOW)
            {
                ptr_p = Sqlalbumid;
                if(asc > 0)
                {
                    ptr = SqlOtracknaidasc;
                }
                else
                {
                    ptr = SqlOtracknaiddesc;
                }
                        
                /* find differrent */
                if(asc > 0)
                {
                    ptr2 = Sqltracklarger;
                }
                else
                {
                    ptr2 = Sqltracksmaller;
                }
            }
            else
            {
                ptr_p = Sqlgenreid;
            }

            if(view_type0 == SRV_PLST_VIEW_ARTIST || view_type0 == SRV_PLST_VIEW_GENRE)
            {
                ptr_select_field = SqlFieldIdPNameIsChar;
            }
            else
            {
                ptr_select_field = SqlFieldIdPNameTrack;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT %s FROM main.audio WHERE %s AND %s%s) \
UNION ALL SELECT * FROM (SELECT %s FROM db2.audio WHERE %s AND %s%s))%s", ptr_select_field, ptr_p, ptr2, ptr, ptr_select_field, ptr_p, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT %s FROM audio WHERE %s AND %s%s", ptr_select_field, ptr_p, ptr2, ptr);
            }
        }        
        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        sqlite3_bind_kal_uint16(stmt, 2, track_num);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 4, id0);
            sqlite3_bind_kal_uint16(stmt, 5, track_num);
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);      
            sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        while (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 id2;            
            count_t++;        
            id2 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }  
    }
    return ret;
}


#ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_three_level_for_prefix_search
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_three_level_for_prefix_search(srv_plst_db_context_struct *db, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    S32 ret;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    UI_character_type alpha_s[2];
    U32 length;
    U32 id = 0;
    U32 id0[SRV_PLST_VIEW_LIST_DEPTH];
    U8 count_t = 0;
    U8 i;
    U8 alpha_c = 0;
    const S8* ptr, *ptr2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type[0] = list_view->view_type[0];
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id0[i] = list_view->list_cache[i + 1].parent_id;
    }       
    view_type[list_view->current_index] = list_view->view_type[ list_view->current_index];
       
    mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN);
    mmi_ucs2ncpy((S8*) name, (S8*) list_view->search, SRV_PLST_META_INFO_MAX_LEN);
    length = mmi_ucs2strlen((S8*)(list_view->string));
    if(!length)
    {
        return SRV_PLST_RET_EMPTY;
    }
    list_view->string[length - 1] = list_view->string[length - 1] + 1;
    alpha_s[0] = 0;
    alpha_s[1] = 0;

    if(list_view->search[0] < 65) /* < A */
    {
        alpha_c = 1;
        alpha_s[0] = 91;
    }
    else if(list_view->search[0] > 122) /* > 'z' */
    {
        alpha_c = 2;
        alpha_s[0] = 96;
    }
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        if((view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM || 
            view_type[0] == SRV_PLST_VIEW_GENRE) && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            const S8* ptr3;

            ptr3 = Sqlsearchname;
            if(view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else 
            {
                ptr = Sqlgenreid;
            }

            if(asc > 0)
            {
                ptr2 = SqlOnaidasc;
            }
            else
            {
                ptr2 = SqlOnaiddesc;
            }
            
            if(IS_CARD_EXIST)
            {
                  if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND \
%s%s) UNION SELECT *  FROM (SELECT media_id, name FROM db2.audio WHERE %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND %s AND \
%s%s) UNION SELECT *  FROM (SELECT media_id, name FROM db2.audio WHERE name < ? AND %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
                    }
                    else 
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name > ? AND %s AND \
%s%s) UNION SELECT *  FROM (SELECT media_id, name FROM db2.audio WHERE name > ? AND %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);  
                    }
               
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s AND %s%s", ptr3, ptr, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name < ? AND %s AND %s%s", ptr3, ptr, ptr2);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name > ? AND %s AND %s%s", ptr3, ptr, ptr2);
                }
            }
        }        
        else if(view_type[0] == SRV_PLST_VIEW_PLST && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            const S8* ptr3;
            ptr3 = Sqlsearchname;
            if(asc > 0)
            {
                ptr2 = SqlOnaidasc2;
            }
            else
            {
                ptr2 = SqlOnaiddesc2;
            }
            if(IS_CARD_EXIST)
            {
                if(id0[0] > 0X8000)
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s)) %s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s)) %s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s)) %s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                }
                else
                {
                    if(!alpha_c)
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id , name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                    else if(alpha_c == 1)
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id , name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                    else 
                    {
                        kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id , name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                    }
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s", ptr3, ptr2);
                }
                else if(alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s", ptr3, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s", ptr3, ptr2);
                }
            }                
        }
        else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            const S8* ptr3;
            ptr3 = Sqlsearchalbumname;
            if(asc > 0)
            {
                ptr2 = SqlOalbumnaidasc2;
            }
            else
            {
                ptr2 = SqlOalbumnaiddesc2;
            }
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
%s AND artist_id = ? AND audio.album_id = album.album_id %s) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
album_name < ? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE album_name < ? AND %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
album_name >? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE album_name > ? AND %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr3, ptr2, ptr3, ptr2, ptr2);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE %s AND artist_id = ? AND audio.album_id = album.album_id %s", ptr3, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE album_name < ? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s", ptr3, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT audio.album_id AS id, album_name FROM audio, album WHERE album_name > ? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s", ptr3, ptr2);
                }
            }
        }
        else 
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(!alpha_c)
        {
        sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
        sqlite3_bind_kal_uint32(stmt, 3, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 4, 1);
        if(IS_CARD_EXIST)
        {
                sqlite3_bind_kal_wstr(stmt, 5, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
                sqlite3_bind_kal_uint32(stmt, 8, 1);
                sqlite3_bind_kal_uint32(stmt, 9, 1);
            }
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 4, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 5, 1);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 6, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 7, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 8, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 9, id0[0]);
                sqlite3_bind_kal_uint32(stmt, 10, 1);
                sqlite3_bind_kal_uint32(stmt, 11, 1);
            }
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id = sqlite3_column_kal_uint32(stmt, 0);
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*) name,(const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            }
            ret = SRV_PLST_OK;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    else
    {
        if(asc > 0)
        {
            if(!list_cache->tail)
            {
                id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;                
            }
            else
            {
                id = list_cache->cache[list_cache->tail - 1].id;
            }
        }
        else
        {
            id = list_cache->cache[list_cache->head].id;
        }

        if(view_type[0] == SRV_PLST_VIEW_PLST &&view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            if(IS_CARD_EXIST)
            {
                if(list_cache->parent_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT audio.media_id, name FROM main.audio, main.plst_item WHERE plstitem_id = ? AND audio.media_id = plst_item.media_id UNION");
                    strcat(db->sql_cmd, " SELECT audio.media_id, name FROM db2.audio, main.plst_item WHERE plstitem_id = ? AND audio.media_id = plst_item.media_id ");
                }
                else 
                {
                    sprintf(db->sql_cmd, "SELECT audio.media_id , name FROM main.audio, db2.plst_item WHERE plstitem_id = ? AND audio.media_id = plst_item.media_id UNION");
                    strcat(db->sql_cmd, " SELECT audio.media_id , name FROM db2.audio, db2.plst_item WHERE plstitem_id = ? AND audio.media_id = plst_item.media_id ");
                }
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT audio.media_id, name FROM main.audio, main.plst_item WHERE plstitem_id = ? AND audio.media_id = plst_item.media_id");
            }
        }
        else if(view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE media_id = ?");
            }
            else 
            {
                sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id = ? ");
            }
        }
        else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE album_id = ? UNION SELECT album_id, album_name FROM db2.album WHERE album_id = ?");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE album_id = ?");
            }
        }
        else 
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        if(((view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM) || 
            (view_type[0] == SRV_PLST_VIEW_PLST &&view_type[1] == SRV_PLST_VIEW_MEDIA)) &&
            IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 2, id);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            ret = SRV_PLST_OK;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    
    /* load same 20 to cache */
    if((view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM ||
        view_type[0] == SRV_PLST_VIEW_GENRE )&& view_type[1] == SRV_PLST_VIEW_MEDIA)
    {
       const S8* ptr3;
        if(view_type[0] == SRV_PLST_VIEW_ARTIST)
        {
            ptr = Sqlartistid;
        }
        else if(view_type[0] == SRV_PLST_VIEW_ALBUM)
        {
            ptr = Sqlalbumid;
        }
        else
        {
            ptr = Sqlgenreid;
        }

        if(asc > 0)
        {
            ptr3 = Sqlmedialarger;
            ptr2 = SqlOmediaidasc;
        }
        else
        {
            ptr3 = Sqlmediasmaller;
            ptr2 = SqlOmediaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND %s%s) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
            }
            else
            {
            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name = ? AND %s AND %s%s", ptr3, ptr, ptr2);         
            }
        }
        else if(view_type[0] == SRV_PLST_VIEW_PLST && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
        if(asc > 0)
        {
            ptr = Sqlplstitemlarg;
            ptr2 = SqlOnaidasc2;
        }
        else
        {
            ptr = Sqlplstitemsmal;
            ptr2 = SqlOnaiddesc2;
        }
        if(IS_CARD_EXIST)
        {
            if(id0[0] > 0X8000)
            {
                kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND name = ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, \
main.plst_item WHERE audio.media_id = plst_item.media_id AND name = ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
                else
                {
                kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND name = ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, \
db2.plst_item WHERE audio.media_id = plst_item.media_id AND name = ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);               
            }
        }
        else
        {
            kal_sprintf(db->sql_cmd, " SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND name = ? AND %s AND plst_id = ? %s", ptr, ptr2);
        }                
    }
    else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM)
    {
        if(IS_CARD_EXIST)
        {
            if(asc > 0)
            {
                sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS ID, album_name FROM main.audio, main.album WHERE album_name = ? AND album.album_id < ? AND artist_id = ? AND audio.album_id = album.album_id ORDER BY ID ASC limit ? ) UNION ");
                strcat(db->sql_cmd, " SELECT * FROM (SELECT album.album_id AS ID, album_name FROM db2.audio, db2.album WHERE album_name = ? AND album.album_id < ? AND artist_id = ? AND album.album_id = audio.album_id ORDER BY ID ASC limit ?)) ");
                strcat(db->sql_cmd, " ORDER BY ID ASC limit ? ");
            }
            else
            {
                sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS ID, album_name FROM main.audio, main.album WHERE album_name = ? AND album.album_id > ? AND artist_id = ? AND audio.album_id = album.album_id ORDER BY ID DESC limit ? ) UNION ");
                strcat(db->sql_cmd, " SELECT * FROM (SELECT album.album_id AS ID, album_name FROM db2.audio, db2.album WHERE album_name = ? AND album.album_id > ? AND artist_id = ? AND album.album_id = audio.album_id ORDER BY ID DESC limit ?)) ");
                strcat(db->sql_cmd, " ORDER BY ID DESC limit ? ");
            }
        }
        else
        {
            if(asc > 0)
            {
                sprintf(db->sql_cmd, "SELECT album.album_id, album_name FROM audio,album WHERE album_name = ? AND album.album_id > ? AND artist_id = ? AND audio.album_id = album.album_id GROUP BY album_name ORDER BY album.album_id ASC limit ?");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT album.album_id, album_name FROM audio,album WHERE album_name = ? AND album.album_id < ? AND artist_id = ? AND audio.album_id = album.album_id GROUP BY album_name ORDER BY album.album_id DESC limit ?");
            }
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    sqlite3_bind_kal_uint32(stmt, 2, id);
    sqlite3_bind_kal_uint32(stmt, 3, id0[0]);
    if(view_type[0] == SRV_PLST_VIEW_PLST)
    {
        sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM/4);
    }
    else
    {
        sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_wstr(stmt, 5, name);
        sqlite3_bind_kal_uint32(stmt, 6, id);
        sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
        if(view_type[0] == SRV_PLST_VIEW_PLST)
        {
            sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM/4);
            sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM/4);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 temp_id;
        count_t ++;
        temp_id = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
        ret = pls_sql_step_ex(db, stmt);            
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }

    /* load differrent to cache*/
    if((view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM ||
        view_type[0] == SRV_PLST_VIEW_GENRE)&& view_type[1] == SRV_PLST_VIEW_MEDIA)
    {
        const S8* ptr3;
        
        if(view_type[0] == SRV_PLST_VIEW_ARTIST)
        {
            ptr = Sqlartistid;
        }
        else if(view_type[0] == SRV_PLST_VIEW_ALBUM)
        {
            ptr = Sqlalbumid;
        }
        else
        {
            ptr = Sqlgenreid;
        }

        if(asc > 0)
        {
            ptr2 = SqlOnaidasc;
            ptr3 = Sqlsearchname2;
        }
        else
        {
            ptr2 = SqlOnaiddesc;
            ptr3 = Sqlsearchname;
        }

        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND %s%s) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
            }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND %s AND %s%s) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name<? AND %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
            }
            else
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name > ? AND %s AND %s%s) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name > ? AND %s AND %s%s))%s", ptr3, ptr, ptr2, ptr3, ptr, ptr2, ptr2);
            }
        }
        else
        {
            if(!alpha_c)
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s AND %s%s", ptr3, ptr, ptr2);
            }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name < ? AND %s AND %s%s", ptr3, ptr, ptr2);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name > ? AND %s AND %s%s", ptr3, ptr, ptr2);
            }
        }
    }
    else if(view_type[0] == SRV_PLST_VIEW_PLST && view_type[1] == SRV_PLST_VIEW_MEDIA)
    {
        if(asc > 0)
        {
            ptr = Sqlsearchname2;
            ptr2 = SqlOnaidasc2;
        }
        else
        {
            ptr = Sqlsearchname;
            ptr2 = SqlOnaiddesc2;
        }
        if(IS_CARD_EXIST)
        {
            if(id0[0] > 0X8000)
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, main.plst_item WHERE \
audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, main.plst_item \
WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
            }
            else
            {
                if(!alpha_c)
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
                else
                {
                    kal_sprintf(db->sql_cmd," SELECT * FROM (SELECT * FROM (SELECT plstitem_id AS id, name FROM main.audio, db2.plst_item WHERE \
audio.media_id = plst_item.media_id AND name > ? AND  %s AND plst_id = ? %s) UNION SELECT * FROM (SELECT plstitem_id AS id, name FROM db2.audio, db2.plst_item \
WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
                }
            }
        }
        else
        {
            if(!alpha_c)
            {
                kal_sprintf(db->sql_cmd, " SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND %s AND plst_id = ? %s", ptr, ptr2);
            }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, " SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND name < ? AND %s AND plst_id = ? %s", ptr, ptr2);
            }
            else
            {
                kal_sprintf(db->sql_cmd, " SELECT plstitem_id as id, name FROM audio, plst_item WHERE audio.media_id = plst_item.media_id AND name > ? AND %s AND plst_id = ? %s", ptr, ptr2);
            }
        }                
    }
    else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM)
    {
        if(asc > 0)
        {
            ptr = Sqlsearchalbumname2;
            ptr2 = SqlOalbumnaidasc2;
        }
        else
        {
            ptr = Sqlsearchalbumname;
            ptr2 = SqlOalbumnaiddesc2;
        }
        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
%s AND artist_id = ? AND audio.album_id = album.album_id %s ) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
            }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
album_name < ? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s ) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE album_name < ? AND %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
            }
            else
            {
                kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT album.album_id AS id, album_name FROM main.audio, main.album WHERE \
album_name > ? AND %s AND artist_id = ? AND audio.album_id = album.album_id %s ) UNION SELECT * FROM (SELECT album.album_id AS id, album_name FROM db2.audio, db2.album \
WHERE album_name > ? AND %s AND artist_id = ? AND album.album_id = audio.album_id %s))%s", ptr, ptr2, ptr, ptr2, ptr2);
            }
        }
        else
        {
            if(!alpha_c)
            {
                kal_sprintf(db->sql_cmd, "SELECT album.album_id as id, album_name FROM audio,album WHERE %s AND artist_id = ? AND \
audio.album_id = album.album_id GROUP BY album_name %s", ptr, ptr2);
            }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT album.album_id as id, album_name FROM audio,album WHERE album_name < ? AND %s AND artist_id = ? AND \
audio.album_id = album.album_id GROUP BY album_name %s", ptr, ptr2);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT album.album_id as id, album_name FROM audio,album WHERE album_name > ? AND %s AND artist_id = ? AND \
audio.album_id = album.album_id GROUP BY album_name %s", ptr, ptr2);
            }
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    } 
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(!alpha_c)
    {
        if(asc > 0)
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, id0[0]);
            if(view_type[0] == SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM/4);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 7, id0[0]);   
                if(view_type[0] == SRV_PLST_VIEW_PLST)
                {
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 5, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
                if(view_type[0] == SRV_PLST_VIEW_PLST)
                {
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        }
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 1, alpha_s);
        if(asc > 0)
        {
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 4, id0[0]);
            if(view_type[0] == SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, 5,SRV_PLST_SELECT_SQL_MIN_NUM/4);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 6, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 7, name);
                sqlite3_bind_kal_wstr(stmt, 8, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 9, id0[0]);              
                if(view_type[0] == SRV_PLST_VIEW_PLST)
                {
                    sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                    sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 3, name);
            sqlite3_bind_kal_uint32(stmt, 4, id0[0]);
            if(view_type[0] == SRV_PLST_VIEW_PLST)
            {
                sqlite3_bind_kal_uint32(stmt, 5,SRV_PLST_SELECT_SQL_MIN_NUM/4);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 6, alpha_s);
                sqlite3_bind_kal_wstr(stmt, 7, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 8, name);
                sqlite3_bind_kal_uint32(stmt, 9, id0[0]);
                if(view_type[0] == SRV_PLST_VIEW_PLST)
                {
                    sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                    sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM/4);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 temp_id;

        temp_id = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    return ret;   
}
#endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/

/* pls_sql_get_item_to_fill_cache_two_level_for_reorder() seems same as pls_sql_get_item_to_fill_cache_two_level_for_general_view(), remove it */
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_three_level_for_general_view
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static pls_sql_get_item_to_fill_cache_three_level_for_general_view(srv_plst_db_context_struct *db, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    S32 ret;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    U32 id0[SRV_PLST_VIEW_LIST_DEPTH];
    U32 special_id = 0;
    U16 track_num = 0;
    U8 count_t = 0;
    U8 i;
    const S8* ptr2, *ptr;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id0[i] = list_view->list_cache[i + 1].parent_id;
    }       
    view_type[list_view->current_index] = list_view->view_type[ list_view->current_index];
    /* find the first one, general cache */
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        if (view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM && (view_type[2] == SRV_PLST_VIEW_MEDIA ||
            (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN) /* album song order by track num */
            {
                /* Fill middle cache*/
                if (list_cache->cache_num == 0 && index != 0)
                {
                    /* only file one item and get offset from begining in ascending order */
                    ptr = SqlOtracknaidascnl;
                }
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOtracknaidasc;
                    }
                    else
                    {
                        ptr = SqlOtracknaiddesc;
                    }    
                }
            }
            else
            {
                /* Fill middle cache*/
                if (list_cache->cache_num == 0 && index != 0)
                {
                    /* only file one item and get offset from begining in ascending order */
                    ptr = SqlOnaidascnl;
                }
                else
                {
                    if(asc > 0)
                    {
                        ptr = SqlOnaidasc;
                    }
                    else
                    {
                        ptr = SqlOnaiddesc;
                    }
                }
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE artist_id = ? AND album_id = ? %s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd,"SELECT media_id, p_name, track_num FROM audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? %s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd,"SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                }
            }

            /* Fill middle cache */
            if (list_cache->cache_num == 0 && index != 0)
            {
                strcat(db->sql_cmd, " limit ? OFFSET ?");
            }
        }
        else if(view_type[2] == SRV_PLST_VIEW_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(asc > 0)
                {
                    ptr = SqlOpnaidasc;
                }
                else
                {
                    ptr = SqlOpnaiddesc;
                }    
            }
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOnaidasc;
                }
                else
                {
                    ptr = SqlOnaiddesc;
                }
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , p_name FROM main.audio %s) UNION \
SELECT * FROM (SELECT media_id, p_name FROM db2.audio %s)) %s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio %s", ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio %s) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio %s)) %s", ptr, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio %s", ptr);
                }
            }
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }  

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM && view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
        {
            U8 i = 1;
            sqlite3_bind_kal_uint32(stmt, i, id0[0]);
            if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
            {
                sqlite3_bind_kal_uint32(stmt, ++i, id0[2]);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, ++i, id0[1]);
            }

            /* not middle cache, set limit to 1 */
            if (!(list_cache->cache_num == 0 && index != 0))
            {
                sqlite3_bind_kal_uint32(stmt, ++i, 1);
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, ++i, id0[0]);
                if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, ++i, id0[2]);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, ++i, id0[1]);
                }
                /* not middle cache, set limit to 1 */
                if (!(list_cache->cache_num == 0 && index != 0))
                {
                    sqlite3_bind_kal_uint32(stmt, ++i, 1);
                    sqlite3_bind_kal_uint32(stmt, ++i, 1);
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            /* Fill middle cache , offset to index*/
            if (list_cache->cache_num == 0 && index != 0)
            {
                sqlite3_bind_kal_uint32(stmt, ++i, 1);
                sqlite3_bind_kal_uint32(stmt, ++i, index);
            }
        }
        else if(view_type[2] == SRV_PLST_VIEW_AUDIO)
        {
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 id;

            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt,1), META_TAG_FRAME_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                track_num = sqlite3_column_kal_uint16(stmt, 2);
            }
            list_cache->cache[0].idx_in_list = 0;
            ret = SRV_PLST_OK;
            id = sqlite3_column_kal_uint32(stmt, 0);
            special_id = id;
            if(list_cache->cache_num == 0)
            {
                /* fill middle cache */
                if(index != 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, asc, index, index, index_o, id);
                }
                else
                {
                    if(asc > 0)
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id);
                    }
                    else
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id);
                    }
                }
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            }
        }
        pls_sql_finalize(stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
    }
    else
    {
        U32 id2;

        if(asc > 0)
        {
            if(!list_cache->tail)
            {
                id2 = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
            }
            else
            {
                id2 = list_cache->cache[list_cache->tail - 1].id;
            }
        }
        else
        {
            id2 = list_cache->cache[list_cache->head].id;
        }
        special_id = id2;
        
        if (view_type[2] == SRV_PLST_VIEW_AUDIO || (view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM && view_type[2] == SRV_PLST_VIEW_MEDIA))
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(id2 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT p_name, track_num FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT p_name, track_num FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(id2 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id2);
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt,0), META_TAG_FRAME_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                track_num = sqlite3_column_kal_uint16(stmt,1);
            }
            ret = SRV_PLST_OK;
        }
        pls_sql_finalize(stmt);
    }

   /* load 20 items */
   /* load same name */
   
    if ((view_type[0] == SRV_PLST_VIEW_ARTIST && 
        view_type[1] == SRV_PLST_VIEW_ALBUM  && 
        view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA) || view_type[2] == SRV_PLST_VIEW_AUDIO)
    { 
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlmedialarger;
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr = SqlOpnaiddesc;
            }
            if(view_type[2] == SRV_PLST_VIEW_AUDIO)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? AND %s%s) UNION ALL \
SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio WHERE p_name = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
                if(asc > 0)
                {
                    ptr2 = Sqlmedialarger;
                    ptr = SqlOtracknaidasc;
                }
                else
                {
                    ptr2 = Sqlmediasmaller;
                    ptr = SqlOtracknaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND p_name = ? AND %s \
AND artist_id = ? AND album_id = ? %s) UNION ALL SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND p_name = ? AND %s \
AND artist_id = ? AND album_id = ? %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE track_num = ? AND p_name = ? AND %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlmedialarger;
                ptr = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr = SqlOnaiddesc;
            }
            if(view_type[2] == SRV_PLST_VIEW_AUDIO)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE name = ? AND %s%s) UNION ALL \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? %s) UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE name = ? AND %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
        }
         
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint32(stmt, 1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, special_id);
            if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM && (view_type[2] == SRV_PLST_VIEW_MEDIA ||
                (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
            {
                sqlite3_bind_kal_uint32(stmt, 4, id0[0]);
                if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, id0[2]);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 5, id0[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM  &&view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, track_num);
                    sqlite3_bind_kal_wstr(stmt, 8, name);
                    sqlite3_bind_kal_uint32(stmt, 9, special_id);
                    sqlite3_bind_kal_uint32(stmt, 10, id0[0]);
                    if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                    {
                        sqlite3_bind_kal_uint32(stmt, 11, id0[2]);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 11, id0[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 12, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 13, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 5, track_num);
                    sqlite3_bind_kal_wstr(stmt, 6, name);            
                    sqlite3_bind_kal_uint32(stmt, 7, special_id);                
                    sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, special_id);
            if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM && (view_type[2] == SRV_PLST_VIEW_MEDIA ||
                (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
            {
                sqlite3_bind_kal_uint32(stmt, 3, id0[0]);
                if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, id0[2]);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 4, id0[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM  &&view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_wstr(stmt, 6, name);
                    sqlite3_bind_kal_uint32(stmt, 7, special_id);
                    sqlite3_bind_kal_uint32(stmt, 8, id0[0]);
                    if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, id0[2]);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, id0[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 4, name);            
                    sqlite3_bind_kal_uint32(stmt, 5, special_id);                
                    sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                    sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;

            count_t++;
            temp_id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return ret;
        }   
    }
   /* load differrent name */
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        if(asc > 0)
        {
            ptr2 = Sqlpnamelarger;
            ptr = SqlOpnaidasc;
        }
        else
        {
            ptr2 = Sqlpnamesmaller;
            ptr = SqlOpnaiddesc;
        }
    }
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlnamelarger;
            ptr = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlnamesmaller;
            ptr = SqlOnaiddesc;
        }
    }
    if (view_type[0] == SRV_PLST_VIEW_ARTIST && 
        view_type[1] == SRV_PLST_VIEW_ALBUM  && 
        (view_type[2] == SRV_PLST_VIEW_MEDIA || 
        (view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)))
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr = SqlOtracknaidasc;
            }
            else
            {
                ptr = SqlOtracknaiddesc;
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND artist_id = ? \
AND album_id = ? AND %s%s) UNION ALL SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND artist_id = ? AND album_id = ? \
AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE track_num = ? AND artist_id = ? AND album_id = ? AND %s%s", ptr2, ptr);
            }

        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? \
AND album_id = ? AND %s%s) UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? \
AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s%s", ptr2, ptr);
            }
        }
    }
    else if(view_type[2] == SRV_PLST_VIEW_AUDIO)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE ischar = ? AND %s%s) UNION ALL \
SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name FROM audio WHERE ischar = ? %s%s", ptr2, ptr);
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE %s%s) UNION ALL \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s%s", ptr2, ptr);
            }
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }  
        
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        sqlite3_bind_kal_uint32(stmt, 1, track_num);
        if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM  &&view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
        {           
            sqlite3_bind_kal_uint32(stmt, 2, id0[0]);
            if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id0[2]);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, id0[1]);
            }
            sqlite3_bind_kal_wstr(stmt, 4, name);
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 6, track_num);
                sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
                if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, 8, id0[2]);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 8, id0[1]);
                }
                sqlite3_bind_kal_wstr(stmt, 9, name);
                sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 4, track_num);
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }        
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    else
    {
        if(view_type[0] == SRV_PLST_VIEW_ARTIST &&view_type[1] == SRV_PLST_VIEW_ALBUM  &&view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
        {
            sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
            if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0[2]);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
            }
            sqlite3_bind_kal_wstr(stmt, 3, name);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 5, id0[0]);
                if(view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA)
                {
                    sqlite3_bind_kal_uint32(stmt, 6, id0[2]);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 6, id0[1]);
                }
                sqlite3_bind_kal_wstr(stmt, 7, name);
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, name);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }        
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    while (ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        U32 id2;
        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt); 

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && (view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM && view_type[2] == SRV_PLST_VIEW_MEDIA))
    {
        if(count_t >= SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return ret;
        } 
        if(asc > 0)
        {
            ptr = SqlOtracknaidasc;
            ptr2 = Sqltracklarger;
        }
        else
        {
            ptr = SqlOtracknaiddesc;
            ptr2 = Sqltracksmaller;
        }
       
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name,track_num FROM main.audio WHERE artist_id = ? AND album_id = ? AND %s %s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE artist_id = ? AND album_id = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT media_id, p_name,track_num FROM audio WHERE artist_id = ? AND album_id = ? AND %s %s", ptr2, ptr);
        }  
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
        sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
        sqlite3_bind_kal_uint16(stmt, 3, track_num);
        sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 5, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 6, id0[1]);
            sqlite3_bind_kal_uint16(stmt, 7, track_num);
            sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);      
            sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        while (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 id2;            
            count_t++;        
            id2 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }       
    }
    return ret;
}


#ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_four_level_for_prefix_search
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_four_level_for_prefix_search(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];    
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    UI_character_type alpha_s[2];
    U32 length;
    U32 id = 0;
    S32 ret;
    U32 id0[SRV_PLST_VIEW_LIST_DEPTH];
    const S8* ptr2, *ptr;
    U8 count_t = 0;
    U8 i;
    U8 alpha_c = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type[list_view->current_index] = list_view->view_type[list_view->current_index];
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id0[i] = list_view->list_cache[i + 1].parent_id;
    }     
    mmi_ucs2ncpy((S8*) list_view->string, (S8*) list_view->search, SRV_PLST_MAX_FILE_LEN - 1);
    mmi_ucs2ncpy((S8*) name, (S8*) list_view->search, SRV_PLST_META_INFO_MAX_LEN);
    length = mmi_ucs2strlen((S8*)list_view->string);
    list_view->string[length - 1] = list_view->string[length - 1] + 1;

    alpha_s[0] = 0;
    alpha_s[1] = 0;

    if(list_view->search[0] < 65) /* < A */
    {
        alpha_c = 1;
        alpha_s[0] = 91;
    }
    else if(list_view->search[0] > 122) /* > 'z' */
    {
        alpha_c = 2;
        alpha_s[0] = 96;
    }
    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) || 
        (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        ptr2 = Sqlsearchname;
        if(asc > 0)
        {
            ptr = SqlOnaidasc;
        }
        else
        {
            ptr = SqlOnaiddesc;
        }
        if(view_type[0] == SRV_PLST_VIEW_ARTIST &&
           view_type[1] == SRV_PLST_VIEW_ALBUM  &&
           view_type[2] == SRV_PLST_VIEW_MEDIA)
        {                
            if(IS_CARD_EXIST)
            {
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? \
AND album_id = ? AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? \
AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? \
AND album_id = ? AND %s AND name < ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? \
AND %s AND name < ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? \
AND album_id = ? AND %s AND name > ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? \
AND %s AND name > ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
            }
            else
            {
                if(!alpha_c)
                {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s%s", ptr2, ptr);
            }
                else if(alpha_c == 1)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s AND name < ? %s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s AND name > ? %s", ptr2, ptr);
                }
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
        sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
        if(!alpha_c)
        {
        sqlite3_bind_kal_uint32(stmt, 5, 1);
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 6, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 7, id0[1]);
            sqlite3_bind_kal_wstr(stmt, 8, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 9, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 10, 1);
            sqlite3_bind_kal_uint32(stmt, 11, 1);
        }
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
            sqlite3_bind_kal_uint32(stmt, 6, 1);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
                sqlite3_bind_kal_uint32(stmt, 8, id0[1]);
                sqlite3_bind_kal_wstr(stmt, 9, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 10, list_view->string);
                sqlite3_bind_kal_wstr(stmt, 11, alpha_s);
                sqlite3_bind_kal_uint32(stmt, 12, 1);
                sqlite3_bind_kal_uint32(stmt, 13, 1);
            }            
        }
        
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id = sqlite3_column_kal_uint32(stmt, 0);
            if(mmi_ucs2strlen((const S8*) sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*) name, (const S8*) sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*) name, (S8*) list_view->search, META_TAG_FRAME_MAX_LEN);
            } 
            if(list_cache->cache_num == 0)
            {
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            }
            pls_sql_finalize(stmt);       
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);              
            return ret;
        }   
    }
    else
    {
        if(asc > 0)
        {
            if(!list_cache->tail)
            {
                id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
            }
            else
            {
                id = list_cache->cache[list_cache->tail - 1].id;
            }
        }
        else
        {
            id = list_cache->cache[list_cache->head].id;
        }
        if(view_type[0] == SRV_PLST_VIEW_ARTIST &&
           view_type[1] == SRV_PLST_VIEW_ALBUM  &&
           view_type[2] == SRV_PLST_VIEW_MEDIA)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE media_id = ?");
            }
            else
            {
                sprintf(db->sql_cmd, " SELECT media_id, name FROM db2.audio WHERE media_id = ?");
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*) sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*) name, (const S8*) sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*) name, (S8*) list_view->search, META_TAG_FRAME_MAX_LEN);
            }                
            ret = SRV_PLST_OK;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }            
    }

    /* load same name to cache */
    if(view_type[0] == SRV_PLST_VIEW_ARTIST &&
       view_type[1] == SRV_PLST_VIEW_ALBUM  &&
       view_type[2] == SRV_PLST_VIEW_MEDIA)
    {
        if(asc > 0)
        {
            ptr2 = Sqlmedialarger;
            ptr = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlmediasmaller;
            ptr = SqlOnaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? \
AND name = ? AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name = ? AND \
%s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND name = ?  AND %s%s", ptr2, ptr);
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
    sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
    sqlite3_bind_kal_wstr(stmt, 3, name);
    sqlite3_bind_kal_uint32(stmt, 4, id);
    sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 6, id0[0]);
        sqlite3_bind_kal_uint32(stmt, 7, id0[1]);
        sqlite3_bind_kal_wstr(stmt, 8, name);
        sqlite3_bind_kal_uint32(stmt, 9, id);
        sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 temp_id;
        count_t ++;

        temp_id = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }

    /*  load differrent name to cache */
    if(view_type[0] == SRV_PLST_VIEW_ARTIST &&
       view_type[1] == SRV_PLST_VIEW_ALBUM  &&
       view_type[2] == SRV_PLST_VIEW_MEDIA)
    {
        if(asc > 0)
        {
            ptr2 = Sqlsearchname2;
            ptr = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlsearchname;
            ptr = SqlOnaiddesc;
        }
        if(IS_CARD_EXIST)
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? \
AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? \
AND %s AND name < ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? AND %s AND name < ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
        else
        {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? \
AND %s AND name > ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? AND %s AND name > ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
            }
        }
        else
        {
            if(!alpha_c)
            {
            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s%s", ptr2, ptr);
        }
            else if(alpha_c == 1)
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s AND name < ? %s", ptr2, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE artist_id = ? AND album_id = ? AND %s AND name > ? %s", ptr2, ptr);
            }
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id0[0]);
    sqlite3_bind_kal_uint32(stmt, 2, id0[1]);
    if(asc > 0)
    {
        sqlite3_bind_kal_wstr(stmt, 3, name);
        sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
        sqlite3_bind_kal_wstr(stmt, 4, name);
    }
    if(!alpha_c)
    {
    sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 6, id0[0]);
        sqlite3_bind_kal_uint32(stmt, 7, id0[1]);
        if(asc > 0)
        {
            sqlite3_bind_kal_wstr(stmt, 8, name);
            sqlite3_bind_kal_wstr(stmt, 9, list_view->string);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 8, list_view->search);
            sqlite3_bind_kal_wstr(stmt, 9, name);
        }
        sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 5, alpha_s);
        sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 7, id0[0]);
            sqlite3_bind_kal_uint32(stmt, 8, id0[1]);
            if(asc > 0)
            {
                sqlite3_bind_kal_wstr(stmt, 9, name);
                sqlite3_bind_kal_wstr(stmt, 10, list_view->string);
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 9, list_view->search);
                sqlite3_bind_kal_wstr(stmt, 10, name);
            }
            sqlite3_bind_kal_wstr(stmt, 11, alpha_s);
            sqlite3_bind_kal_uint32(stmt, 12, SRV_PLST_SELECT_SQL_MIN_NUM);
            sqlite3_bind_kal_uint32(stmt, 13, SRV_PLST_SELECT_SQL_MIN_NUM);
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 temp_id;
        count_t ++;

        temp_id = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    return ret;       
}
#endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_four_level_for_general_view
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_four_level_for_general_view(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    return SRV_PLST_RET_ERR_PARAM_ERR;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_five_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_five_level(srv_plst_db_context_struct *db, S32 index,S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    return SRV_PLST_RET_ERR_PARAM_ERR;    
}

#ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_file_cache_for_playing_list_plst_most_recent
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_file_cache_for_playing_list_plst_most_recent(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, MMI_BOOL is_default, S32 index, S16 asc, S32* index_o, srv_plst_default_playlist_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    S32 ret = SRV_PLST_OK;
    U32 special_id = 0;    
    U32 played_data = 0;
    U32 count_t = 0;
    const S8* ptr, *ptr2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_FILL_CACHE_PLAYING_LIST, is_default, index, play_info->pick_index);
    if(is_default)
    {
        list_cache = &(list_view->list_cache[0]);
        memset(&(list_cache->cache[0]), 0, SRV_PLST_VIEW_LIST_CACHE * sizeof(srv_plst_list_cache_struct));
        asc  = 1;
        list_cache->cache_num = 0;
        list_cache->first_index = 0;
        list_cache->last_index = 0;
        list_cache->head = 0;
        list_cache->tail = 0;
        if(type == SRV_PLST_DEF_MOST_PLST)
        {
            if(asc > 0)
            {
                ptr = SqlOmostlistdesc;
            }
            else
            {
                ptr = SqlOmostlistasc;
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr = SqlOrecentlistdesc;
            }
            else
            {
                ptr = SqlOrecentlistasc;
            }
        }
      //  if((index == 0 &&  asc > 0) || 
      //      (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
        {
            if(type == SRV_PLST_DEF_MOST_PLST)
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s)) %s", ptr, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id %s", ptr);
                }          
            }
            else if(type == SRV_PLST_DEF_RECENTLY_PLST)
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst \
INNER JOIN main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s)) %s", ptr, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id %s", ptr);
                }                
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 4, 1);
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {            
                special_id = sqlite3_column_kal_uint32(stmt, 0); 
                played_data = sqlite3_column_kal_uint32(stmt, 1);
                if(asc > 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index, index_o, special_id);
                }
                else
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, special_id);
                }
                list_cache->cache_num = 1;
                ret = SRV_PLST_OK;
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
                return ret;
            }       
        }
    }
    else
    {
        if(type == SRV_PLST_DEF_MOST_PLST)
        {
            if(asc > 0)
            {
                ptr = SqlOmostlistdesc;
            }
            else
            {
                ptr = SqlOmostlistasc;
            }   
        }
        else
        {
            if(asc > 0)
            {
                ptr = SqlOrecentlistdesc;
            }
            else
            {
                ptr = SqlOrecentlistasc;
            }
        }
        list_cache = &(list_view->list_cache[list_view->current_index]);
        /* find the first one */
        if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
            (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
            (index == 0 && asc > 0))
        {
            if(type == SRV_PLST_DEF_MOST_PLST)
            {                
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s)) %s", ptr, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id %s", ptr);
                }                      
            }
            else if(type == SRV_PLST_DEF_RECENTLY_PLST)
            {                
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s)) %s", ptr, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id %s", ptr);
                }                
            }            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 4, 1);
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            }            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                special_id = sqlite3_column_kal_uint32(stmt, 0);
                played_data = sqlite3_column_kal_uint32(stmt, 1);
                if(list_cache->cache_num == 0)
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, special_id);
                }
                else
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, special_id);     
                }
                ret = SRV_PLST_OK;
            }            
            pls_sql_finalize(stmt);
            //bql:MAUI_02659117
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else
        {            
            if(asc > 0)
            {
                if(!list_cache->tail)
                {
                    special_id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                }
                else
                {
                    special_id = list_cache->cache[list_cache->tail - 1].id;
                }
            }
            else
            {
                special_id = list_cache->cache[list_cache->head].id;
            }
          
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, special_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 temp_id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);

                if(temp_id > 0X8000)
                {
                    if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT played_count FROM main.meta WHERE media_id = ?", &stmt);
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT played FROM main.meta WHERE media_id = ?", &stmt);
                    }
                }
                else
                {
                    if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT played_count FROM db2.meta WHERE media_id = ?", &stmt);
                    }
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT played FROM db2.meta WHERE media_id = ?", &stmt);
                    }
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, temp_id);
            }
            else
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }
           
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                played_data = sqlite3_column_kal_uint32(stmt, 1);                     
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
               return ret;
            }            
        }
    }
        /* find next: same */
    if(asc > 0)
    {
        ptr2 = Sqlplstitemsmal;
    }
    else
    {
        ptr2 = Sqlplstitemlarg;
    }        
    if(type == SRV_PLST_DEF_MOST_PLST)
    {      
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
AND played_count = ? AND %s%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item \
ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id \
AND played_count = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
AND played_count = ? AND %s%s", ptr2, ptr);
        }       
    }
    else
    {
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id \
AND played = ? AND %s%s) UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id AND played = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND played = ? AND %s%s", ptr2, ptr);
        }        
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
    sqlite3_bind_kal_uint32(stmt, 2, played_data);
    sqlite3_bind_kal_uint32(stmt, 3, special_id);
    sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);
        sqlite3_bind_kal_uint32(stmt, 6, played_data);
        sqlite3_bind_kal_uint32(stmt, 7, special_id);
        sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
        
        count_t++;        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    if(count_t >= SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return ret;
    }  
    /* find next: differrent */
    if(type == SRV_PLST_DEF_MOST_PLST)
    {
        if(asc > 0)
        {
            ptr2 = sqlplaycountsmal;
        }
        else
        {
            ptr2 = Sqlplaycountlarg;
        }        
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
AND %s%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id AND %s%s", ptr2, ptr);
        }                
    }
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlplayedsmal;
        }
        else
        {
            ptr2 = Sqlplayedlarg;
        }
        
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND\
%s%s) UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND %s%s", ptr2, ptr);
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
    sqlite3_bind_kal_uint32(stmt, 2, played_data);
     sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
        sqlite3_bind_kal_uint32(stmt, 5, played_data);
        sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
       
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);    
    return ret;
}
#endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_file_cache_for_playing_list_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_file_cache_for_playing_list_plst(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, MMI_BOOL is_default, S32 index, S16 asc, S32* index_o)
{  
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    S32 ret = SRV_PLST_OK;
    U32 idx = 0;
    U32 id = 0;
    U32 count = 0;
    const S8* ptr = "", *ptr2 = "";
    srv_plst_default_playlist_enum type = SRV_PLST_DEF_LIST_ENUM_END;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_FILL_CACHE_PLAYING_LIST, is_default, index, play_info->pick_index);

    pls_sql_util_get_default_list_info(db, play_info->plst_id, &type);
    if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
    {
    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        ret = pls_sql_get_item_to_file_cache_for_playing_list_plst_most_recent(db, play_info, is_default, index, asc, index_o, type);
        return ret;
    #else
        return SRV_PLST_RET_ERR_PARAM_ERR;
    #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
    }    
 
    if(is_default)
    {   
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(asc > 0)
            {
                ptr = SqlOplstidxiddesc;
            }
            else
            {
                ptr = SqlOplstidxidasc;
            }
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            if(asc > 0)
            {
                ptr = SqlOplstidxidasc;
            }
            else
            {
                ptr = SqlOplstidxiddesc;
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

        list_cache = &(list_view->list_cache[0]);
        if((index == 0 &&  asc > 0) || 
            ((index <= 20 && asc > 0) ||( index + 20 > list_view->total_count && asc < 0)))        
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? %s", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? %s", ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 %s", ptr);
            } 
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {            
                id = sqlite3_column_kal_uint32(stmt, 0);  
                idx = sqlite3_column_kal_uint32(stmt, 1);
                if(!list_cache->cache_num)
                {
                if(asc > 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index, index_o, id);
                }
                else
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);   
                }
                list_cache->cache_num = 1;
                }
                else
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                }
                ret = SRV_PLST_OK;
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
        else
        {
            if(list_cache->cache_num == 0)
            {
                id = play_info->current_picked_id;
            }
            else
            {
                if(asc > 0)
                {
                    if(!list_cache->tail)
                    {
                        id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                    }
                    else
                    {
                        id = list_cache->cache[list_cache->tail - 1].id;
                    }
                }
                else
                {
                    id = list_cache->cache[list_cache->head].id;
                }
            }
            if(play_info->plst_id > 0X8000)   
            {
                sprintf(db->sql_cmd, "SELECT media_id, idx FROM main.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, "SELECT media_id, idx FROM db2.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {            
                idx = sqlite3_column_kal_uint32(stmt, 1);
                if(list_cache->cache_num == 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, asc, play_info->pick_index, index, index_o, id);
                    list_cache->cache_num = 1;
                }
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
                return ret;
            }
        }
    }
    else
    {
        list_cache = &(list_view->list_cache[list_view->current_index]);
        /* find the first one */
        if (base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME &&
            list_cache->cache_num == 0 && index != 0)
        {
            //@TODO: Need real owner to review and modify all the cache mechanism to support fill cache from mid!
            //bql: MAUI_02940388
            //PLS service can not support to fill middle index in current playing list
            //Add fill cache logic for current playing list

            ptr = SqlOplstidxiddesc;
            
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? %s OFFSET ?", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? %s OFFSET ?", ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 %s OFFSET ?", ptr);
            }  
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            sqlite3_bind_kal_uint32(stmt, 3, index);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {              
                id = sqlite3_column_kal_uint32(stmt, 0);
                idx = sqlite3_column_kal_uint32(stmt, 1);
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
            (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
            (index == 0 && asc > 0))
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxiddesc;
                }
                else
                {
                    ptr = SqlOplstidxidasc;
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(asc > 0)
                {
                    ptr = SqlOplstidxidasc;
                }
                else
                {
                    ptr = SqlOplstidxiddesc;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? %s", ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? %s", ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 %s", ptr);
            }  
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, 1);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {              

                id = sqlite3_column_kal_uint32(stmt, 0);
                idx = sqlite3_column_kal_uint32(stmt, 1);
                //bql:  MAUI_02455413 acitive playing list display error after remove
                if(list_cache->cache_num == 0)
                {
                    if(asc > 0)
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id);
                    }
                    else
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id);
                    }
                }
                else
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);     
                }
             }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else
        {            
            if(asc > 0)
            {
                if(!list_cache->tail)
                {
                    id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                }
                else
                {
                    id = list_cache->cache[list_cache->tail - 1].id;
                }
            }
            else
            {
                id = list_cache->cache[list_cache->head].id;
            }
                       
            if(play_info->plst_id > 0X8000)   
            {
                sprintf(db->sql_cmd, "SELECT media_id, idx FROM main.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, "SELECT media_id, idx FROM db2.plst_item WHERE plstitem_id = ? AND plst_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {            
                idx = sqlite3_column_kal_uint32(stmt, 1);
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
                return ret;
            }
        }
    }

    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        if(asc > 0)
        {
            ptr2 = Sqlplstitemsmal;
            ptr = SqlOplstidxiddesc;
        }
        else
        {
            ptr2 = Sqlplstitemlarg;
            ptr = SqlOplstidxidasc;
        }
    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlplstitemlarg;
            ptr = SqlOplstidxidasc;
        }
        else
        {
            ptr2 = Sqlplstitemsmal;
            ptr = SqlOplstidxiddesc;
        }
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

        /* fill cache */
        /* idx same media_id not same */
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(play_info->plst_id > 0X8000)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s%s",ptr2, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s AND media_id > 32768 %s", ptr2, ptr);
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND idx = ? AND %s%s",ptr2, ptr);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND plstitem_id NOT IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd,"SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND plstitem_id NOT IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND media_id > 32768 AND plstitem_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND plstitem_id IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND plstitem_id IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND idx = ? AND %s \
AND media_id > 32768 AND plstitem_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
            }
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
    sqlite3_bind_kal_uint32(stmt, 2, idx);
    sqlite3_bind_kal_uint32(stmt, 3, id);
    sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        count ++;
        id = sqlite3_column_kal_uint32(stmt, 0);
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
        if(ret != SRV_PLST_OK)
        {
            pls_sql_finalize(stmt);
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return SRV_PLST_OK;
    }

    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        if(asc > 0)
        {
            ptr2 = Sqlplstidxsmal;
        }
        else
        {
            ptr2 = Sqlplstidxlarg;
        }
    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlplstidxlarg;
        }
        else
        {
            ptr2 = Sqlplstidxsmal;
        }
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

        /* load differrent */
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(play_info->plst_id > 0X8000)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, " SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s%s", ptr2, ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s \
AND media_id > 32768 %s", ptr2, ptr);
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND %s%s", ptr2, ptr);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s \
AND plstitem_id NOT IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND %s \
AND plstitem_id NOT IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s \
AND media_id > 32768 AND plstitem_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);               
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->plst_id > 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s \
AND plstitem_id IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND %s \
AND plstitem_id IN (SELECT id FROM db2.mark) %s", ptr2, ptr);
                }
            }
            else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND %s \
media_id > 32768 AND plstitem_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
            }
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
    sqlite3_bind_kal_uint32(stmt, 2, idx);
    sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        count ++;
        id = sqlite3_column_kal_uint32(stmt, 0);
        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    return ret;
}

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static S32 pls_sql_get_item_to_file_cache_for_playing_list_video(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, MMI_BOOL is_default, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    S32 ret = SRV_PLST_OK;
    U32 id;
    U32 specical_id = 0;
    U32 count = 0;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    const S8* ptr, *ptr2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
     /* active list */
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_FILL_CACHE_PLAYING_VIDEO, is_default, index, play_info->pick_index);
    {
        list_cache = &(list_view->list_cache[list_view->current_index]);
        if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
            (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
            (index == 0 && asc > 0))
        {
            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_VIDEO)
            {
                if(asc > 0)
                {
                    ptr = SqlOvideonaidasc;
                }
                else
                {
                    ptr = SqlOvideonaiddesc;
                }
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video %s) UNION \
SELECT * FROM (SELECT vdo_id, name FROM db2.video %s))%s", ptr, ptr, ptr);
                }
                else 
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video %s", ptr);
                }           
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, 1);
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                    sqlite3_bind_kal_uint32(stmt, 3, 1);
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    count ++;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                         mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }                  
                    else
                    {
                        name[0] = 0;
                    }
                    id = sqlite3_column_kal_uint32(stmt, 0);
                   // play_info->current_picked_id = id;                        
                    specical_id = id;
                    if(list_cache->cache_num == 0)
                    {
                        ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                    }
                    else
                    {
                        ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                    }
                    ret = SRV_PLST_OK;
                    pls_sql_finalize(stmt);

                }
                else
                {                    
                    pls_sql_finalize(stmt);
                    return SRV_PLST_RET_EMPTY;
                }
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
            }       
        }
        else
        {
            if(asc > 0)
            {
                if(list_cache->tail)
                {
                    specical_id = list_cache->cache[list_cache->tail - 1].id;
                }
                else
                {
                    specical_id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                }
            }
            else
            {
                specical_id = list_cache->cache[list_cache->head].id;
            }
        	
            if(specical_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT name FROM db2.video WHERE vdo_id = ?");
            }
            name[0] = 0 ;
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, specical_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {        
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
                return ret;
            }
        }
        /* fillcache */
        /* get same name */
      //  if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_VIDEO)
        {
            if(asc > 0)
            {
                ptr2 = Sqlvideolarg;
                ptr = SqlOvideoidasc;
            }
            else
            {
                ptr2 = Sqlvideosmal;
                ptr = SqlOvideoiddesc;
            }
            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_VIDEO)
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name = ? AND %s%s ) \
UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE name = ? AND %s%s", ptr2, ptr);
                }
            }              
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, specical_id);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 4, name);
                sqlite3_bind_kal_uint32(stmt, 5, specical_id);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count ++;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }

            if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
            {
                return SRV_PLST_OK;
            }
        }

        /* get differrent name */
      //  if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_VIDEO)
        {
            if(asc > 0)
            {
                ptr2 = Sqlnamelarger;
                ptr = SqlOvideonaidasc;
            }
            else
            {
                ptr2 = Sqlnamesmaller;
                ptr = SqlOvideonaiddesc;
            }
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s%s) \
UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s%s", ptr2, ptr);
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, name);     
            sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, name);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count ++;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }        
    }               
    return ret;
}
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_file_cache_for_playing_list_audio
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_file_cache_for_playing_list_audio(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, MMI_BOOL is_default, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_list_context_struct *list_cache;
    S32 ret = SRV_PLST_OK;
    U32 id;
    U32 specical_id = 0;
    U32 count = 0;
    U16 track_num = 0;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    const S8* ptr2, *ptr;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_FILL_CACHE_PLAYING_AUDIO, is_default, index, play_info->pick_index);
    if(is_default)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr = SqlOpnaiddesc;
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr = SqlOnaidasc;
            }
            else
            {
                ptr = SqlOnaiddesc;
            }
        }
        list_cache = &(list_view->list_cache[0]);

        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
            if((index == 0 &&  asc > 0) || 
                ((index <= 20 && asc > 0) || (index + 20 > list_view->total_count && asc < 0)))
            {  
                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio %s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio %s))%s", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, p_name,ischar FROM main.audio %s", ptr);
                        } 
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio %s))%s", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio %s", ptr);
                        }    
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }                  
                        else
                        {
                            name[0] = 0;
                        }
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt, 2);
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
    		            ret = SRV_PLST_OK;
                        specical_id = id;
                        if(!list_cache->cache_num)
                        {
                        if(asc > 0)
                        {        
                            pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index, index_o, id);
                        }
                        else
                        {
                            pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        list_cache->cache_num += 1;
                    }
                        else
                        {
                            pls_sql_util_update_fill_cache(list_cache, asc,index, index_o, id);
                        }
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                }
                else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                        play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                        play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                        (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
                {
                    
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM && base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(asc > 0)
                        {
                            ptr = SqlOtracknaidasc;
                        }
                        else
                        {
                            ptr = SqlOtracknaiddesc;
                        }
                    }
                    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio \
WHERE artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE artist_id = ? %s)) %s", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio \
WHERE album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE album_id = ? %s))%s", ptr, ptr, ptr);                      
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name,ischar FROM main.audio \
WHERE genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE genre_id = ? %s))%s", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE artist_id = ? %s", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE album_id = ? %s", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name,ischar FROM main.audio WHERE genre_id = ? %s", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio \
WHERE artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? %s)) %s", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio \
WHERE album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE album_id = ? %s))%s", ptr, ptr, ptr);                      
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio \
WHERE genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE genre_id = ? %s))%s", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? %s", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE album_id = ? %s", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE genre_id = ? %s", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SQLITE_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint32(stmt, 5, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else
                        {
                            name[0] = 0;
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt, 2);
                        }
    		            ret = SRV_PLST_OK;
                        specical_id = id;
                        if(!list_cache->cache_num)
                        {
                         if(asc > 0)
                        {        
                            pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index, index_o, id);
                        }
                        else
                        {
                            pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        list_cache->cache_num += 1;
                    }
                        else
                        {
                            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                }
                else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                         play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            if(asc > 0)
                            {
                                ptr = SqlOtracknaidasc;
                            }
                            else
                            {
                                ptr = SqlOtracknaiddesc;
                            }
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name,track_num FROM main.audio WHERE \
artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name,track_num FROM main.audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                            }
                        }
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                    if(play_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 3, 1);

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[0]);
                        if(play_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, play_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 6, 1);
                        sqlite3_bind_kal_uint32(stmt, 7, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else
                        {
                            name[0] = 0;
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt,2);
                        }
                        specical_id = id;
                        if(!list_cache->cache_num)
                        {
                         if(asc > 0)
                        {        
                            pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index, index_o, id);
                        }
                        else
                        {
                            pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        list_cache->cache_num += 1;
                    }
                        else
                        {
                            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                    if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
                    {
                        return SRV_PLST_OK;
                    }
                }
                else
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                ret = SRV_PLST_OK;
            }        
            else
            {
            	if(list_cache->cache_num == 0)
            	{
            		specical_id = play_info->current_picked_id;
            	}
            	else
            	{
                    if(asc > 0)
                    {
                        if(list_cache->tail)
                        {
                            specical_id = list_cache->cache[list_cache->tail - 1].id;
                        }
                        else
                        {
                            specical_id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                        }
                    }
                    else
                    {
                        specical_id = list_cache->cache[list_cache->head].id;
                    }
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        (play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                    {
                        if(specical_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT p_name, track_num FROM main.audio WHERE media_id = ?");
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT p_name, track_num FROM db2.audio WHERE media_id = ?");
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                    else
                    {
                        if(specical_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.audio WHERE media_id = ?");
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?");
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
                else
                {
                    if(specical_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                name[0] = 0 ;
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, specical_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {        
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                    }
                    else
                    {
                        name[0] = 0;
                    }
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        track_num = sqlite3_column_kal_uint16(stmt, 1);
                    }
                    if(list_cache->cache_num == 0)
                    {
                        pls_sql_util_fill_fix_index_cache(list_cache, asc, play_info->pick_index, index, index_o, specical_id);
                        list_cache->cache_num = 1;
                    }            
                }
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_RET_ITEM_EXIST)
                {
                    return ret;
                }
            }
        }
    }
    else /* active list */
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr = SqlOpnaiddesc;
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr = SqlOnaidasc;
            }
            else
            {
                ptr = SqlOnaiddesc;
            }
        }
        list_cache = &(list_view->list_cache[list_view->current_index]);
////bql: MAUI_02456413
        if( !(list_cache->cache_num == 0 && index != 0) &&
            ((list_cache->cache_num == 0 && index == 0) || 
            (index == 0 && asc > 0) ||
            (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0) ||
            (index == 0 && asc > 0)))
        {
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO )
            { 
                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio %s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio %s))%s", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio %s", ptr);
                        }    
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio %s))%s", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio %s", ptr);
                        }    
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }                  
                        else
                        {
                            name[0] = 0;
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt,2);
                        }
                        specical_id = id;
                        //bql: MAUI_02659510 
                        //all songs playing and delete ... error happened for cache
                        ////bql: MAUI_02456413
                        if(list_cache->cache_num == 0 && index == 0)
                        {
                            if(asc > 0)
                            {
                                ret = pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id);
                            }
                            else
                            {
                                ret = pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id);
                            }
                        }
                        ////bql: MAUI_02456413
                        else if(list_cache->cache_num == 0 && index != 0)
                        {
                           ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        else
                        {
                            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }
                        /*
                        if(list_cache->cache_num == 0)
                        {
                             ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        else
                        {
                            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }*/
                        ret = pls_sql_step_ex(db, stmt);
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                }
                else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                        play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                        play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                        (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
                {
                    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                            {
                                if(asc > 0)
                                {
                                    ptr = SqlOtracknaidasc;
                                }
                                else
                                {
                                    ptr = SqlOtracknaiddesc;
                                }
                            }
                            
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE \
artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE  artist_id = ? %s))%s", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE album_id = ? %s)) %s", ptr, ptr, ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE \
genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE genre_id = ? %s))%s", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id , p_name, ischar FROM main.audio WHERE artist_id = ? %s", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE album_id = ? %s", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE genre_id = ? %s", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE  artist_id = ? %s))%s", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE album_id = ? %s)) %s", ptr, ptr, ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE genre_id = ? %s))%s", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id , name FROM main.audio WHERE artist_id = ? %s", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE album_id = ? %s", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE genre_id = ? %s", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    if(!play_info->play_info.current_index)
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        if(!play_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint32(stmt, 5, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else
                        {
                            name[0] = 0;
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt,2);
                        }
                        specical_id = id;
                        if(list_cache->cache_num == 0)
                        {
                            //ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                            //bql: MAUI_02455907
                            if(asc > 0)
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, id);
                            }
                            else
                            {
                                pls_sql_util_fill_first_cache(list_cache, asc, list_view->total_count - 1, index_o, id);
                            }
                        }
                        else
                        {
                            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                }
                else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                         play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            if(asc > 0)
                            {
                                ptr = SqlOtracknaidasc;
                            }
                            else
                            {
                                ptr = SqlOtracknaiddesc;
                            }
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE \
artist_id = ? AND album_id = ? %s )UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
artist_id = ? AND album_id = ? %s )UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? %s", ptr);
                            }
                        }
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                    if(play_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 3, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[0]);
                        if(play_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, play_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 6, 1);
                        sqlite3_bind_kal_uint32(stmt, 7, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        count ++;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                             mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else
                        {
                            name[0] = 0;
                        }
                        id = sqlite3_column_kal_uint32(stmt, 0);
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            track_num = sqlite3_column_kal_uint16(stmt, 2);
                        }
                        specical_id = id;
                        if(list_cache->cache_num == 0)
                        {
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        else
                        {
                            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                        }
                    }
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                    if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
                    {
                        return SRV_PLST_OK;
                    }
                }
                else
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                ret = SRV_PLST_OK;
            }
        }        
        // MAUI_02456413
        else if (list_cache->cache_num == 0 && index != 0)
        {
        //@TODO: Need real owner to review and modify all the cache mechanism to support fill cache from mid!
        //PLS service can not support to update data initialize with index != 0
        //Need support query from medium in pinyin style (cosmos only) 
        //in order to break orginal design limitation 
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO )
                { 
                    // MAUI_02936039
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        //static const S8 SqlOpnaidascnl[] = " ORDER BY ischar, p_name, media_id ";
                        ptr = SqlOpnaidascnl;
                        
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio %s ) UNION SELECT * FROM \
(SELECT media_id, p_name, ischar FROM db2.audio %s )) %s LIMIT ? OFFSET ?", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio %s LIMIT ? OFFSET ?", ptr);
                        }    
                        
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, 1);
                        sqlite3_bind_kal_uint32(stmt, 2, index);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }                  
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            track_num = sqlite3_column_kal_uint16(stmt,2);
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                            ret = pls_sql_step_ex(db, stmt);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    //bql: MAUI_02936633
                    else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                            //bql: MAUI_02936644
                            play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                            play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                            (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
                    {
                        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                        {
                            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                            {
                                //static const S8 SqlOtracknaidascnl[] = " ORDER BY track_num, p_name, media_id ";

                                ptr = SqlOtracknaidascnl;
                            }
                            else
                            {
                                //static const S8 SqlOpnaidascnl[] = " ORDER BY ischar, p_name, media_id ";

                                ptr = SqlOpnaidascnl;
                            }
                            
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE \
    artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE  artist_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE \
    album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE album_id = ? %s)) %s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE \
    genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE genre_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id , p_name, ischar FROM main.audio WHERE artist_id = ? %s limit ? OFFSET ?", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE album_id = ? %s limit ? OFFSET ?", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE genre_id = ? %s limit ? OFFSET ?", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            }
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                            sqlite3_bind_kal_uint32(stmt, 4, index);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 2, index);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                track_num = sqlite3_column_kal_uint16(stmt,2);
                            }
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    //bql: MAUI_02936641
                    else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                             play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                        {
                            //static const S8 SqlOtracknaidascnl[] = " ORDER BY track_num, p_name, media_id ";
                            ptr = SqlOtracknaidascnl;
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE \
    artist_id = ? AND album_id = ? %s )UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE artist_id = ? AND album_id = ? %s limit ? OFFSET ?", ptr);
                            }
                        }
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 5, 1);
                            sqlite3_bind_kal_uint32(stmt, 6, index);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                            sqlite3_bind_kal_uint32(stmt, 4, index);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            track_num = sqlite3_column_kal_uint16(stmt, 2);
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    else
                    {
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                    }
                    ret = SRV_PLST_OK;
                }
            }
            else
            {
                if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO )
                { 
                    // MAUI_02936039
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        //static const S8 SqlOpnaidascnl[] = " ORDER BY name, media_id ";
                        ptr = SqlOnaidascnl;

                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio %s ) UNION SELECT * FROM \
(SELECT media_id, name FROM db2.audio %s )) %s LIMIT ? OFFSET ?", ptr, ptr, ptr);
                        }
                        else 
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio %s LIMIT ? OFFSET ?", ptr);
                        }    
                        
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, 1);
                        sqlite3_bind_kal_uint32(stmt, 2, index);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }                  
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                            ret = pls_sql_step_ex(db, stmt);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    //bql: MAUI_02936633
                    else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                            //bql: MAUI_02936644
                            play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                            play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                            (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
                    {
                        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                        {
                            //static const S8 SqlOpnaidascnl[] = " ORDER BY name, media_id ";
                            ptr = SqlOnaidascnl;
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE  artist_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE album_id = ? %s)) %s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE genre_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id , name FROM main.audio WHERE artist_id = ? %s limit ? OFFSET ?", ptr);
                                }
                                else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE album_id = ? %s limit ? OFFSET ?", ptr);
                                }
                            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                                else /* genre */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE genre_id = ? %s limit ? OFFSET ?", ptr);
                                }
                            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                            }
                        }
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            }
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                            sqlite3_bind_kal_uint32(stmt, 4, index);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            if(!play_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 2, index);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    //bql: MAUI_02936641
                    else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                             play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                        {
                            static const S8 SqlOtracknaidascnl[] = " ORDER BY name, media_id ";
                            ptr = SqlOtracknaidascnl;
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            { 
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
    artist_id = ? AND album_id = ? %s )UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? %s))%s limit ? OFFSET ?", ptr, ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? %s limit ? OFFSET ?", ptr);
                            }
                        }
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 5, 1);
                            sqlite3_bind_kal_uint32(stmt, 6, index);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sqlite3_bind_kal_uint32(stmt, 1, play_info->play_info.id[0]);
                            if(play_info->play_info.current_index == 1)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[1]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                            sqlite3_bind_kal_uint32(stmt, 4, index);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            count ++;
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                            {
                                 mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                            }
                            else
                            {
                                name[0] = 0;
                            }
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            specical_id = id;
                            ret = pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, id);
                        }
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                    }
                    else
                    {
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                    }
                    ret = SRV_PLST_OK;
                }
            }
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_ITEM_TO_FILE_CACHE_FOR_PLAYING_LIST_AUDIO, __LINE__);
            //return ret;
            
        }
        else
        {
            if(asc > 0)
            {
                if(list_cache->tail)
                {
                    specical_id = list_cache->cache[list_cache->tail - 1].id;
                }
                else
                {
                    specical_id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
                }
            }
            else
            {
                specical_id = list_cache->cache[list_cache->head].id;
            }
        	if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {    
                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    (play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                {
                    if(specical_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT p_name, track_num FROM main.audio WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT p_name, track_num FROM db2.audio WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    if(specical_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.audio WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
            else
            {
                if(specical_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            name[0] = 0 ;
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, specical_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {        
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    track_num = sqlite3_column_kal_uint16(stmt,1);
                }
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_RET_ITEM_EXIST)
            {
                return ret;
            }
        }
    }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(asc > 0)
            {
                ptr2 = Sqlmedialarger;
                ptr = SqlOpnaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr = SqlOpnaiddesc;
            }
        }
        else
        {
            if(asc > 0)
            {
                ptr2 = Sqlmedialarger;
                ptr = SqlOmediaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr = SqlOmediaiddesc;
            }    
        }
       
   
    /* fillcache */
    /* get same name */
    if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s%s", ptr2, ptr);
                }
            }
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND media_id NOT IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s \
AND media_id NOT IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND media_id IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s \
AND media_id IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr, ptr, ptr);
                }                
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND media_id NOT IN (SELECT id FROM main.mark %s", ptr2, ptr);
                }
                else
                { 
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND media_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                }
            }
        }
    #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, specical_id);
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 5, track_num);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_uint32(stmt, 7, specical_id);
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, specical_id);
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 4, name);
                sqlite3_bind_kal_uint32(stmt, 5, specical_id);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
//bql: MAUI_02941451
//Coding defect on fill cach for current playing audio
//Forget to return while exceed select item
//In order select more for the same name.
        if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return SRV_PLST_OK;
        }    
    }
    else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
            play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
            play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
            (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? \
AND %s AND artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND %s AND artist_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        if(asc > 0)
                        {
                            ptr = SqlOtracknaidasc;
                        }
                        else
                        {
                            ptr = SqlOtracknaiddesc;
                        }
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND p_name = ? \
AND %s AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND p_name = ? AND %s AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? \
AND %s AND genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND %s AND genre_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE ischar= ? AND p_name = ? AND %s AND artist_id = ? %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        if(asc > 0)
                        {
                            ptr = SqlOtracknaidasc;
                        }
                        else
                        {
                            ptr = SqlOtracknaiddesc;
                        }
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE track_num = ? AND p_name = ? AND %s AND album_id = ? %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE ischar = ? AND p_name = ? AND %s AND genre_id = ? %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND artist_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND artist_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND genre_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND genre_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND artist_id = ? %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND album_id = ? %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND genre_id = ? %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else 
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND artist_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND artist_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND genre_id = ? AND media_id NOT IN (SELECT id FROM db2.mark)%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND genre_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND artist_id = ? AND media_id IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND artist_id = ? AND media_id IN (SELECT id FROM db2.mark) %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND album_id = ? AND media_id IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND album_id = ? AND media_id IN (SELECT id FROM db2.mark) %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND genre_id = ? AND media_id IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND genre_id = ? AND media_id IN (SELECT id FROM db2.mark) %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
            else /* phone only */
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND artist_id = ? AND \
media_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND album_id = ? AND \
media_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND genre_id = ? AND \
media_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND artist_id = ? \
AND media_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND album_id = ? \
AND media_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND genre_id = ? \
AND media_id IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }                
        }/* end of temp audio */
    #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt,1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, specical_id);
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 6, track_num);
                sqlite3_bind_kal_wstr(stmt, 7, name);
                sqlite3_bind_kal_uint32(stmt, 8, specical_id);
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->plst_id);                    
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
            }  
        #endif /* __PLST_DUAL_DB_SUPPORT__*/
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, specical_id);
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_uint32(stmt, 6, specical_id);
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->plst_id);                    
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }    
        #endif /* __PLST_DUAL_DB_SUPPORT__*/
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

        if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return SRV_PLST_OK;
        }
    }
    else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
             play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
    {

        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                //bql: MAUI_02744179 and MAUI_02456358
                if(asc > 0)
                {
                    ptr = SqlOtracknaidasc;
                }
                else
                {
                    ptr = SqlOtracknaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND p_name = ? AND %s \
AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND p_name = ? AND %s \
AND artist_id = ? AND album_id = ? %s )) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE track_num = ? AND p_name = ? AND %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
            else
            {
                // MAUI_02744179 and MAUI_02456358
                //wrongly usage of order by cmd (side effect by ablum track num new UE)
                if(asc > 0)
                {
                    ptr = SqlOnaidasc;
                }
                else
                {
                    ptr = SqlOnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? %s )) %s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else /* temp audio */ 
        {
            if(play_info->play_info.is_mark && play_info->play_info.is_mark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark) %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND artist_id = ? AND album_id = ? AND \
media_id NOT IN (SELECT id FROM main.mark) %s", ptr2, ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s \
AND artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM db2.mark) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE name = ? AND %s AND artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM db2.mark) %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE name = ? AND %s AND artist_id = ? AND album_id = ? \
AND media_id IN (SELECT id FROM main.mark) %s", ptr2 , ptr);
                }
            }
        }/* temp audio */
    #endif  /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt,1,track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, specical_id);
            sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 5, play_info->play_info.id[1]);
            }
            sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt,7, track_num);
                sqlite3_bind_kal_wstr(stmt, 8, name);
                sqlite3_bind_kal_uint32(stmt, 9, specical_id);
                sqlite3_bind_kal_uint32(stmt, 10, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 11, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 11, play_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 12, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 13, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, specical_id);
            sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[1]);
            }
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 6, name);
                sqlite3_bind_kal_uint32(stmt, 7, specical_id);
                sqlite3_bind_kal_uint32(stmt, 8, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
        {
            return SRV_PLST_OK;
        }                
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        if(asc > 0)
        {
            ptr2 = Sqlpnamelarger;
            ptr = SqlOpnaidasc;
        }
        else
        {
            ptr2 = Sqlpnamesmaller;        
            ptr = SqlOpnaiddesc;
        }
    }
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlnamelarger;
            ptr = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlnamesmaller;        
            ptr = SqlOnaiddesc;
        }    
    }
    /* get differrent name */
    if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s%s", ptr2, ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE %s%s", ptr2, ptr);
                }
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);     
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt,4, track_num);
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);     
            sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, name);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
            play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
            play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
            (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
    {       
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    if(asc > 0)
                    {
                        ptr2 = Sqlpnamelarger;
                        ptr = SqlOtracknaidasc;
                    }
                    else
                    {
                        ptr2 = Sqlpnamesmaller;        
                        ptr = SqlOtracknaiddesc;
                    }
                 }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar =? AND %s AND artist_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND %s AND artist_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND %s AND album_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND %s AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s AND genre_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE ischar = ? AND %s AND genre_id = ? %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE ischar= ? AND %s AND artist_id = ? %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE track_num = ? AND %s AND album_id = ? %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE ischar= ? AND %s AND genre_id = ? %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }

            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND artist_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND artist_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND album_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND genre_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND genre_id = ? %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND artist_id = ? %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND album_id = ? %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND genre_id = ? %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 5, track_num);
                sqlite3_bind_kal_wstr(stmt, 6, name);
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->plst_id);                    
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }    
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 4, name);
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);                    
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 5, play_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }    
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
             play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
    {
        if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {                 
                if(asc > 0)
                {
                    ptr2 = Sqlpnamelarger;
                    ptr = SqlOtracknaidasc;
                }
                else
                {
                    ptr2 = Sqlpnamesmaller;        
                    ptr = SqlOtracknaiddesc;
                }
               
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND %s AND artist_id = ? \
AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE track_num = ? AND %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE track_num = ? AND %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND artist_id = ? \
AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 4, play_info->play_info.id[1]);
            }
            sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt,6, track_num);
                sqlite3_bind_kal_wstr(stmt, 7, name);               
                sqlite3_bind_kal_uint32(stmt, 8, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 9, play_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 10, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 11, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[1]);
            }
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 5, name);               
                sqlite3_bind_kal_uint32(stmt, 6, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count ++;
            id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(count > SRV_PLST_SELECT_SQL_MIN_NUM/2)
    {
        return SRV_PLST_OK;
    } 

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        if(asc > 0)
        {
            ptr = SqlOpnaidasc;
            ptr2 = Sqlischarlarger;
        }
        else
        {
            ptr = SqlOpnaiddesc;
            ptr2 = Sqlischarsmaller;
        }
        if(!play_info->play_info.current_index && play_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
        {
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {                   
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE %s%s", ptr2, ptr);
                }                    
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }                
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt,3, track_num);
                sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count ++;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else if((play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                play_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && (!play_info->play_info.current_index ||
                (play_info->play_info.current_index == 1 && play_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
        {
            if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM )
            {
                if(asc > 0)
                {
                    ptr = SqlOtracknaidasc;
                    ptr2 = Sqltracklarger;
                }
                else
                {
                    ptr = SqlOtracknaiddesc;
                    ptr2 = Sqltracksmaller;
                }
            }
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            { 
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s AND artist_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s AND artist_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE %s AND album_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE %s AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s AND genre_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE %s AND genre_id = ? %s)) %s", ptr2, ptr, ptr2, ptr, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE  %s AND artist_id = ? %s", ptr2, ptr);
                    }
                    else if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND album_id = ? %s", ptr2, ptr);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else /* genre */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND genre_id = ? %s", ptr2, ptr);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }                
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            if(!play_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 4, track_num);
                if(!play_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, play_info->plst_id);                    
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 5, play_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count ++;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
        else if((play_info->play_info.current_index == 1 || (play_info->play_info.current_index == 2 && play_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                 play_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && play_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            if(asc > 0)
            {
                ptr = SqlOtracknaidasc;
                ptr2 = Sqltracklarger;
            }
            else
            {
                ptr = SqlOtracknaiddesc;
                ptr2 = Sqltracksmaller;
            }
            if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            { 
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                { 
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE %s AND artist_id = ? \
AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr, ptr2, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND artist_id = ? AND album_id = ? %s", ptr2, ptr);
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            
            sqlite3_bind_kal_uint16(stmt, 1, track_num);
            sqlite3_bind_kal_uint32(stmt, 2, play_info->play_info.id[0]);
            if(play_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 3, play_info->play_info.id[1]);
            }
            sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt,5, track_num);       
                sqlite3_bind_kal_uint32(stmt, 6, play_info->play_info.id[0]);
                if(play_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 7, play_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
                sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count ++;
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id);
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_file_cache_for_default_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_file_cache_for_default_list(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, S32 index, S16 asc, S32* index_o)
{  
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST )
    {
        ret = pls_sql_get_item_to_file_cache_for_playing_list_plst(db, play_info, MMI_TRUE, index, asc, index_o);
    }
    else if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
    {
        ret = pls_sql_get_item_to_file_cache_for_playing_list_audio(db, play_info, MMI_TRUE, index, asc, index_o);
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_file_cache_for_active_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_file_cache_for_active_list(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, S32 index, S16 asc, S32* index_o)
{  
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(play_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        ret = pls_sql_get_item_to_file_cache_for_playing_list_plst(db, play_info, MMI_FALSE, index, asc, index_o);
    }
    else if(play_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        ret = pls_sql_get_item_to_file_cache_for_playing_list_audio(db, play_info, MMI_FALSE, index, asc, index_o);
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(play_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        /* only for current playlist default playlist should modify*/
        ret = pls_sql_get_item_to_file_cache_for_playing_list_video(db, play_info, MMI_FALSE, index, asc, index_o);
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;

}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache_for_addto_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_get_item_to_fill_cache_for_addto_plst(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    S32 ret;
    UI_character_type name[SRV_PLST_MAX_FILE_LEN];
    U32 special_id; 
    U32 count_t = 0;
    U32 create_time = 0;
    const S8 *ptr, *ptr2, *ptr3;
    S32 offset = 0;
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);   

    if(list_cache->cache_num == 0 || (index == 0 && asc > 0) || (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        ptr2 = "";
        ptr3 = "";
        /* File middle cache, force to fill in ascending order */
        if(list_cache->cache_num == 0 && index != 0)
        {
            U32 count;
            pls_sql_get_predefine_list_count(db, &count);
            offset = index - 1;
            if(offset > 0)
            {
                ptr2 = "OFFSET ?";
                asc = 1; /* Force to get id in ascending order when get middle cache*/
            }
        }


        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(asc > 0)
            {
                ptr = SqlOplsttimeidasc;
            }
            else
            {
                ptr = SqlOplsttimeiddesc;
            }            
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            if(asc > 0)
            {
                ptr = SqlOplstnaidasc;
            }
            else
            {
                ptr = SqlOplstnaiddesc;
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        ptr3 = ptr;

        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                /* Fill middle cache case for union db */
                if(list_cache->cache_num == 0 && offset != 0)
                {
                    ptr = "";
                }

                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\" %s) \
UNION SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE plst_name != \"\" %s)) %s %s", ptr, ptr, ptr3, ptr2);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\" %s %s", ptr, ptr2);
            }

        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                /* Fill middle cache case for union db */
                if(list_cache->cache_num == 0 && offset != 0)
                {
                    ptr = "";
                }

                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" %s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name != \"\" %s)) %s", ptr, ptr, ptr3, ptr2);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" %s", ptr, ptr2);
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        /* Bind variable for play list middle cache */
        if(list_cache->cache_num == 0 && offset != 0)
        {
            i = 1;
            sqlite3_bind_kal_uint32(stmt, i++, 1);
            sqlite3_bind_kal_uint32(stmt, i++, offset);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }        
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }

        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                create_time = sqlite3_column_kal_uint32(stmt, 1);
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_MAX_FILE_LEN - 1);
                }
                else
                {
                    name[0] = 0;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        
            //list_cache->cache[0].idx_in_list = 0;
            special_id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);

            /* Only consider favorite list here, shall refer to fill cache part in pls_sql_get_item_to_fill_cache_one_level() */
            if(pls_sql_util_check_default_list_exist(db, SRV_PLST_DEF_MY_FAVOURITE) && index == 0)
            {
                U32 temp_id;
                pls_sql_util_get_default_list_id(db, SRV_PLST_DEF_MY_FAVOURITE, &temp_id);
                if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST)
                {
                    if(asc > 0)
                    {
                        pls_sql_util_fill_first_cache(list_cache, asc, 0, index_o, temp_id);
                    }
                }
            #ifdef __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__
                else if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST)
                {
                    if(asc < 0)
                    {
                        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);        
                    }
                }
            #endif /* __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__ */
            }

            if(list_cache->cache_num == 0)
            {
                /* Fill middle cache, always fille in first item */
                if(index != 0)
                {
                    pls_sql_util_fill_fix_index_cache(list_cache, 1, index, index, index_o, special_id);
                }
                else
                {
                    pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, special_id);
                }
            }
            else
            {
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, special_id);
            }
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(pls_sql_util_check_default_list_exist(db, SRV_PLST_DEF_MY_FAVOURITE))
            {
                U32 temp_id;
                pls_sql_util_get_default_list_id(db, SRV_PLST_DEF_MY_FAVOURITE, &temp_id);
                pls_sql_util_fill_first_cache(list_cache, asc, index, index_o, temp_id);
                return SRV_PLST_OK;
            }
            return SRV_PLST_RET_EMPTY;
        }
    }
    else
    {
        if(asc > 0)
        {
            if(list_cache->tail)
            {
                special_id = list_cache->cache[list_cache->tail - 1].id;
            }
            else
            {
                special_id = list_cache->cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;
            }
        }
        else
        {
            special_id = list_cache->cache[list_cache->head].id;
        }
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if (special_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT create_time FROM main.plst WHERE plst_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, "SELECT create_time FROM db2.plst WHERE plst_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            if (special_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT plst_name FROM main.plst WHERE plst_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, "SELECT plst_name FROM db2.plst WHERE plst_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, special_id);
        ret = pls_sql_step_ex(db, stmt);
        if (ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                create_time = sqlite3_column_kal_uint32(stmt, 0);
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*)name, (const S8*)sqlite3_column_kal_wstr(stmt,0), SRV_PLST_MAX_FILE_LEN - 1);
                }
                else
                {
                    name[0] = 0;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
        pls_sql_finalize(stmt); 
        if(ret != SRV_PLST_RET_ITEM_EXIST)
        {
            return ret;
        }
    }

    /* load same name */
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(asc > 0)
            {
                ptr2 = Sqlplstsmal;
                ptr = SqlOplsttimeidasc;
            }
            else
            {
                ptr2 = Sqlplstlarg;
                ptr = SqlOplsttimeiddesc;
            }
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            if (asc > 0)
            {
                ptr2 = Sqlplstlarg;
                ptr = SqlOplstnaidasc;
            }
            else
            {
                ptr2 = Sqlplstsmal;
                ptr = SqlOplstnaiddesc;
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
    
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE create_time = ? AND %s%s) UNION \
SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE create_time = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);

        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name = ? AND %s%s) UNION \
SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name = ? AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
    
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            sqlite3_bind_kal_uint32(stmt, 1, create_time);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1,name);
        }
        sqlite3_bind_kal_uint32(stmt, 2, special_id);
        sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            sqlite3_bind_kal_uint32(stmt, 4, create_time);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 4, name);
        }
        sqlite3_bind_kal_uint32(stmt, 5, special_id);
        sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM); 
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 id2;            
            count_t++;        
            id2 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
            ret = pls_sql_step_ex(db, stmt);       
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }    
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    count_t = 0;

    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        if(asc > 0)
        {
            ptr2 = Sqlplsttimesmal;
            ptr = SqlOplsttimeidasc;
        }
        else
        {
            ptr2 = Sqlplsttimelarg;
            ptr = SqlOplsttimeiddesc;
        }

    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlplstnalarg;
            ptr = SqlOplstnaidasc;
        }
        else
        {
            ptr2 = Sqlplstnasmal;
            ptr = SqlOplstnaiddesc;
        }    
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

    /* load different name record*/  
    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\" AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, create_time FROM db2.plst WHERE plst_name != \"\" AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\" AND %s%s", ptr2, ptr);
        }
    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" AND %s%s) \
UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_name != \"\" AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" AND %s%s", ptr2, ptr);
        }
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        sqlite3_bind_kal_uint32(stmt, 1, create_time);
    }
    else
    {
        sqlite3_bind_kal_wstr(stmt, 1, name);
    }
    sqlite3_bind_kal_uint32(stmt, 2, SRV_PLST_SELECT_SQL_MIN_NUM);
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            sqlite3_bind_kal_uint32(stmt, 3, create_time);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 3, name);
        }
        sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 5, SRV_PLST_SELECT_SQL_MIN_NUM);
    } 
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    ret = pls_sql_step_ex(db, stmt);
    while (ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        U32 id2;
        
        count_t++;
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);       
    }
    pls_sql_finalize(stmt); 

    if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST && base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        if(asc < 0)
        {
            ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id DESC", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 temp_id;
                temp_id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                ret = pls_sql_step_ex(db, stmt);
            }                    
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = SRV_PLST_OK;
        }
    }

#ifdef __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__
    if(count_t < SRV_PLST_SELECT_SQL_MIN_NUM)
    {
        if(pls_sql_util_check_default_list_exist(db, SRV_PLST_DEF_MY_FAVOURITE))
        {
            if(base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_LAST)
            {
                U32 temp_id;
                pls_sql_util_get_default_list_id(db, SRV_PLST_DEF_MY_FAVOURITE, &temp_id);
                if(asc > 0)
                {
                    pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, temp_id);
                }
            }
        }
    }
#endif /* __PLST_SRV_FEATURE_DEFAULT_SHOW_LAST__ */

    return ret;    
}

#ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
static S32 pls_sql_get_item_to_fill_cache_for_most_recent_list(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_info, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    S32 ret;
    U32 special_id = 0; 
    U32 parent_id;
    U32 played_data = 0;
    U32 count_t = 0;
    const S8* ptr, *ptr2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    list_cache = &(list_view->list_cache[list_view->current_index]);   
    parent_id = list_cache->parent_id;
    count_t = list_cache->total;
    memset(list_cache, 0, sizeof(srv_plst_list_context_struct));
    list_cache->parent_id = parent_id;
    list_cache->total = count_t;
    count_t = 0;
    asc  = 1;

    if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
    {
        if(asc > 0)
        {
            ptr = SqlOmostlistdesc;
        }
        else
        {
            ptr = SqlOmostlistasc;
        }
    }
    else
    {
        if(asc > 0)
        {
            ptr = SqlOrecentlistdesc;
        }
        else
        {
            ptr = SqlOrecentlistasc;
        }
    }
  //  if(list_cache->cache_num == 0 || (index == 0 && asc > 0) ||
  //      (list_cache->cache[list_cache->head].idx_in_list == 0 && asc < 0))
    {
        if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
        {            
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s))%s", ptr, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id %s", ptr);
            } 
        }
        else /* recently list */
        {           
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id \
%s) UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id %s)) %s", ptr, ptr, ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id %s", ptr);
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, parent_id);
        sqlite3_bind_kal_uint32(stmt, 2, 1);
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, parent_id);
            sqlite3_bind_kal_uint32(stmt, 4, 1);
            sqlite3_bind_kal_uint32(stmt, 5, 1);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            special_id = sqlite3_column_kal_uint32(stmt, 0);
            played_data = sqlite3_column_kal_uint32(stmt, 1);
            pls_sql_util_fill_fix_index_cache(list_cache, asc, 0, index,index_o, special_id);
            pls_sql_finalize(stmt);
        }
        else 
        {
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                return SRV_PLST_RET_EMPTY;

            }
            else
            {
                return ret;
            }
        }
    }

    /* find next: same */
    if(asc > 0)
    {
        ptr2 = Sqlplstitemsmal;
    }
    else
    {
        ptr2 = Sqlplstitemlarg;
    }
    if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
    {        
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
AND played_count = ? AND %s%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id AND \
played_count = ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id AND played_count = ? AND %s%s", ptr2, ptr);
        }       
    }
    else
    {
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id  AND played = ? AND %s%s) UNION \
SELECT * FROM (SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, \
db2.meta WHERE plst_item.media_id = meta.media_id AND played = ? AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? \
AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND played = ? AND %s%s", ptr2, ptr);
        }        
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, parent_id);
    sqlite3_bind_kal_uint32(stmt, 2, played_data);
    sqlite3_bind_kal_uint32(stmt, 3, special_id);
    sqlite3_bind_kal_uint32(stmt, 4, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 5, parent_id);
        sqlite3_bind_kal_uint32(stmt, 6, played_data);
        sqlite3_bind_kal_uint32(stmt, 7, special_id);
        sqlite3_bind_kal_uint32(stmt, 8, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 9, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
        
        count_t++;        
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
  
    /* find next: differrent */
    if(list_view->default_type == SRV_PLST_DEF_MOST_PLST)
    {
        if(asc > 0)
        {
            ptr2 = sqlplaycountsmal;            
        }
        else
        {
            ptr2 = Sqlplaycountlarg;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN \
main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id \
AND %s%s) UNION SELECT * FROM ( SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, db2.meta WHERE plst_item.media_id = meta.media_id AND %s%s))%s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, " SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, main.meta WHERE plst_item.media_id = meta.media_id AND %s%s", ptr2, ptr);
        }           
    }
    else
    {
        if(asc > 0)
        {
            ptr2 = Sqlplayedsmal;
        }
        else
        {
            ptr2 = Sqlplayedlarg;
        }
        if(IS_CARD_EXIST)
        {
            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON \
plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND %s%s) UNION SELECT * FROM \
(SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND plst.plst_id = plst_item.plst_id, \
db2.meta WHERE plst_item.media_id = meta.media_id AND %s%s)) %s", ptr2, ptr, ptr2, ptr, ptr);
        }
        else
        {
            kal_sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON plst.plst_id = ? AND \
plst.plst_id = plst_item.plst_id, meta WHERE plst_item.media_id = meta.media_id AND %s%s", ptr2, ptr);
        }        
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, parent_id);
    sqlite3_bind_kal_uint32(stmt, 2, played_data);
     sqlite3_bind_kal_uint32(stmt, 3, SRV_PLST_SELECT_SQL_MIN_NUM);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 4, parent_id);
        sqlite3_bind_kal_uint32(stmt, 5, played_data);
        sqlite3_bind_kal_uint32(stmt, 6, SRV_PLST_SELECT_SQL_MIN_NUM);
        sqlite3_bind_kal_uint32(stmt, 7, SRV_PLST_SELECT_SQL_MIN_NUM);
    }
    ret = pls_sql_step_ex(db, stmt);
    while(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        U32 id2;
       
        id2 = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_util_update_fill_cache(list_cache, asc, index, index_o, id2);
        ret = pls_sql_step_ex(db, stmt);
    }
    pls_sql_finalize(stmt);
    return ret;
}
#endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_item_to_fill_cache
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_item_to_fill_cache(srv_plst_db_context_struct *db, S32 index, S16 asc, S32* index_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *playing_info;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type, view_type_pre = SRV_PLST_VIEW_DUMMY;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type = list_view->view_type[list_view->current_index];
    if(list_view->current_index > 0)
    {
        view_type_pre = list_view->view_type[list_view->current_index - 1];
    }
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_GET_VIEW_FILL_CACHE, list_view->current_index, list_view->view_type[list_view->current_index],g_srv_plst_control_ptr->card_state);

    if(list_view->current_index > 0 && view_type == SRV_PLST_VIEW_MEDIA && view_type_pre == SRV_PLST_VIEW_PLST)
    {
        srv_plst_default_playlist_enum type;
        U32 id_parent = list_view->list_cache[list_view->current_index].parent_id;

        pls_sql_util_get_default_list_info(db, id_parent, &type);
        if(type == SRV_PLST_DEF_RECENTLY_PLST || type == SRV_PLST_DEF_MOST_PLST)
        {
            list_view->default_type = type;
        }        
    }
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ACTIVE)
    {
        ret = pls_sql_get_item_to_file_cache_for_active_list(db, playing_info, index, asc, index_o);
        return ret;
    }
#ifdef __PLST_SRV_DEFAULT_LIST__
    else if(!list_view->current_index && list_view->view_type[0] == SRV_PLST_VIEW_PLST_DEFAULT)
    {
        ret = pls_sql_get_item_to_file_cache_for_default_list(db, playing_info, index, asc, index_o);
        return ret;
    }
#endif /* __PLST_SRV_DEFAULT_LIST__ */
    else if(view_type == SRV_PLST_VIEW_PLST_ADDTO)
    {
        ret = pls_sql_get_item_to_fill_cache_for_addto_plst(db, playing_info, index, asc, index_o);
        return ret;
    }
    else if(view_type == SRV_PLST_VIEW_IMAGE_FLOW)
    {
        #ifdef __COSMOS_MMI_PACKAGE__
            ret = pls_sql_get_item_to_fill_cache_cover_flow(db, index, asc, index_o);
        #else
            ret = pls_sql_get_item_to_fill_cache_one_level(db, index, asc, index_o);
        #endif
        return ret;
    }
    if(list_view->current_index > 1 && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
            list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_IMAGE_FLOW)
    {
        ret = pls_sql_get_item_to_fill_cache_two_level_for_general_view(db, index, asc, index_o);
        return ret;
    } 
    else if(list_view->current_index > 0 &&
        list_view->view_type[list_view->current_index -1] == SRV_PLST_VIEW_PLST && 
        (list_view->default_type == SRV_PLST_DEF_MOST_PLST ||
        list_view->default_type == SRV_PLST_DEF_RECENTLY_PLST))
    {
    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        ret = pls_sql_get_item_to_fill_cache_for_most_recent_list(db, playing_info, index, asc, index_o);
        return ret;
    #else
        return SRV_PLST_RET_ERR_PARAM_ERR;
    #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
    }
    else if(list_view->current_index && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA &&
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_AUDIO ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ARTIST ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM  ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_GENRE))
    {
        ret = pls_sql_get_item_to_fill_cache_one_level(db, index, asc, index_o);
        return ret;
    }
    else if(list_view->current_index > 2 && list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
        (list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST ||
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM  ||
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_GENRE))
    {
        ret = pls_sql_get_item_to_fill_cache_two_level_for_general_view(db, index, asc, index_o);
        return ret;
    }
    else if(list_view->current_index > 3 && list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM)
    {
        ret = pls_sql_get_item_to_fill_cache_three_level_for_general_view(db, index, asc, index_o);
        return ret;
    }

    else
    {
    /* organization/ search only happened start from two level */
    switch(list_view->current_index)
    {
        case 0: /* one level list view */
            ret = pls_sql_get_item_to_fill_cache_one_level(db, index, asc, index_o);            
            break;
            
        case 1:  /* two level list view */
            if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
            {
                if(base->config_search == SRV_PLST_SEARCH_BY_PREFIX_NEW_LIST)
                {
                #ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
                    ret = pls_sql_get_item_to_fill_cache_two_level_for_prefix_search(db, index, asc, index_o);
                #endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/
                }
                else
                {
                    ret = pls_sql_get_item_to_fill_cache_two_level_for_search(db, index, asc, index_o);
                }
            }
        #if 0 /* pls_sql_get_item_to_fill_cache_two_level_for_reorder() seems same as pls_sql_get_item_to_fill_cache_two_level_for_general_view(), remove it */
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
        #endif
            else
            {
                ret = pls_sql_get_item_to_fill_cache_two_level_for_general_view(db, index, asc, index_o);                      
            }
            break;
            
        case 2:  /* three level list view , reorder only happen in this case*/
            if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
            {
            #ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
                ret = pls_sql_get_item_to_fill_cache_three_level_for_prefix_search(db, index, asc, index_o);
            #endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/
            }
            else if(view_type_pre == SRV_PLST_VIEW_PREFIX_SEARCH && (view_type == SRV_PLST_VIEW_MEDIA ||
                view_type == SRV_PLST_VIEW_ALBUM))
            {
                ret = pls_sql_get_item_to_fill_cache_two_level_for_general_view(db, index, asc, index_o);
            }
            else
            {
                ret = pls_sql_get_item_to_fill_cache_three_level_for_general_view(db, index, asc, index_o);
            }
            break;
            
        case 3:  /* four level list view */
            if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
            {
            #ifdef __PLST_SRV_FEATURE_PREFIX_SEARCH__
                ret = pls_sql_get_item_to_fill_cache_four_level_for_prefix_search(db, index, asc,index_o);
            #endif /*__PLST_SRV_FEATURE_PREFIX_SEARCH__*/
            }
            else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
                list_view->view_type[1] == SRV_PLST_VIEW_ALBUM   &&
                view_type_pre == SRV_PLST_VIEW_PREFIX_SEARCH &&
                view_type == SRV_PLST_VIEW_MEDIA)
            {
                ret = pls_sql_get_item_to_fill_cache_three_level_for_general_view(db, index, asc, index_o);
            }
            else
            {
                ret = pls_sql_get_item_to_fill_cache_four_level_for_general_view(db, index, asc,index_o);
            }
            break;
            
        case 4:  /* five level list view */
            ret = pls_sql_get_item_to_fill_cache_five_level(db, index, asc,index_o);
            break;
        case 5:  /* six level list view */
        default: 
             ret = SRV_PLST_RET_ERR_PARAM_ERR;
             break;
    }
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_media_id_from_cache
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_media_id_from_cache(srv_plst_db_context_struct *db, S32 index, U32 *id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type;
    srv_plst_playing_context_struct *playing_info;
    S32 ret = SRV_PLST_OK;
    U32 id0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type = list_view->view_type[list_view->current_index];

    if(index < 0)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    id0 = list_cache->cache[index].id;

    if(((playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )&& (view_type == SRV_PLST_VIEW_PLST_DEFAULT || view_type == SRV_PLST_VIEW_PLST_ACTIVE)) ||
		(((list_view->current_index == 1 && list_view->view_type[0]== SRV_PLST_VIEW_PLST 
        && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA) ||(list_view->current_index == 2 && list_view->view_type[0]== SRV_PLST_VIEW_PLST 
        && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA && list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH)) && 
        list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_IMAGE_FLOW))
    {
        if(view_type == SRV_PLST_VIEW_PLST_DEFAULT || view_type == SRV_PLST_VIEW_PLST_ACTIVE)
        {
            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            if(list_cache->parent_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *id = sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);
    }
    else
    {
        *id = id0;
    }
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_title
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_view_title(srv_plst_db_context_struct *db, S32 index, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type_pre, view_type_last;
    srv_plst_playing_context_struct *playing_info;
    S32 ret = SRV_PLST_OK;
    U32 id0;
    srv_plst_list_get_display_struct *data2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type_last = list_view->view_type[list_view->current_index];
    if(list_view->current_index)
    {
        view_type_pre = list_view->view_type[list_view->current_index - 1];
    }
    else
    {
        view_type_pre = list_view->view_type[list_view->current_index];
    }

    if(index < 0)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    id0 = list_cache->cache[index].id;
    data2 = (srv_plst_list_get_display_struct*)data;

    if(((view_type_last == SRV_PLST_VIEW_PLST_DEFAULT || view_type_last == SRV_PLST_VIEW_PLST_ACTIVE )&& 
        (playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )) ||((list_view->current_index == 1 && list_view->view_type[0]== SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA ) ||
        (list_view->current_index == 2 && list_view->view_type[0]== SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH)))
    {
        if(view_type_last == SRV_PLST_VIEW_PLST_DEFAULT || view_type_last == SRV_PLST_VIEW_PLST_ACTIVE)
        {
            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            U32 parent_id; 
             
            parent_id = list_cache->parent_id;
            if(parent_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            id0 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    
    if(view_type_last == SRV_PLST_VIEW_PLST_ACTIVE)
    {
        view_type_last = playing_info->play_info.view_type[playing_info->play_info.current_index];
        if(playing_info->active_type != SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            view_type_last = SRV_PLST_VIEW_MEDIA;
        }
        else
        {
            view_type_last = SRV_PLST_VIEW_VIDEO;
        }
    }
    if(view_type_last != SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        switch(view_type_last)
        {
            case SRV_PLST_VIEW_AUDIO:
            case SRV_PLST_VIEW_MEDIA:
            case SRV_PLST_VIEW_PLST_DEFAULT:
            case SRV_PLST_VIEW_PLST_ACTIVE:

                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.video WHERE vdo_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            case SRV_PLST_VIEW_ARTIST:
                sprintf(db->sql_cmd, "SELECT artist_name FROM main.artist WHERE artist_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT artist_name FROM db2.artist WHERE artist_id = ?");
                }   
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
                
            case SRV_PLST_VIEW_ALBUM:            
            case SRV_PLST_VIEW_IMAGE_FLOW:
                sprintf(db->sql_cmd, "SELECT album_name FROM main.album WHERE album_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT album_name FROM db2.album WHERE album_id = ?");
                } 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
                
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_VIEW_GENRE:
                sprintf(db->sql_cmd, "SELECT genre_name FROM main.genre WHERE genre_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT genre_name FROM db2.genre WHERE genre_id = ?");
                }  
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            case SRV_PLST_VIEW_PLST:
            case SRV_PLST_VIEW_PLST_ADDTO:
                if (id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT plst_name FROM main.plst WHERE plst_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, "SELECT plst_name FROM db2.plst WHERE plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;           
            
            default: 
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        switch(view_type_pre)
        {
            case SRV_PLST_VIEW_AUDIO:
            case SRV_PLST_VIEW_MEDIA:
            
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT name FROM db2.video WHERE vdo_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            case SRV_PLST_VIEW_ARTIST:
                sprintf(db->sql_cmd, "SELECT artist_name FROM main.artist WHERE artist_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT artist_name FROM db2.artist WHERE artist_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
                
            case SRV_PLST_VIEW_ALBUM:            
                sprintf(db->sql_cmd, "SELECT album_name FROM main.album WHERE album_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT album_name FROM db2.album WHERE album_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_VIEW_GENRE:
                sprintf(db->sql_cmd, "SELECT genre_name FROM main.genre WHERE genre_id = ?" );
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT genre_name FROM db2.genre WHERE genre_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            case SRV_PLST_VIEW_PLST:
            case SRV_PLST_VIEW_PLST_ADDTO:
                if (id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT plst_name FROM main.plst WHERE plst_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, "SELECT plst_name FROM db2.plst WHERE plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;           
            
            default: 
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id0);
    if(((view_type_last == SRV_PLST_VIEW_ARTIST || view_type_last == SRV_PLST_VIEW_ALBUM ||
         view_type_last == SRV_PLST_VIEW_IMAGE_FLOW ||
        view_type_last == SRV_PLST_VIEW_GENRE)|| (view_type_last == SRV_PLST_VIEW_PREFIX_SEARCH && 
        (view_type_pre == SRV_PLST_VIEW_ARTIST || view_type_pre == SRV_PLST_VIEW_ALBUM ||
       view_type_pre == SRV_PLST_VIEW_GENRE))) && IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 2, id0);
    }

    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        //bql: MAUI_02973483
        //need to trancate the string in service because of UI limiatation.
        U32 len = (mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)));
        ret = SRV_PLST_OK;
        if(len)
        {   
            mmi_ucs2ncpy((S8*)(data2->string_ptr), (const S8*)sqlite3_column_kal_wstr(stmt, 0),data2->buff_size);
            if (len > data2->buff_size)
            {
                mmi_ucs2ncpy((S8*)(data2->string_ptr + (data2->buff_size - 3)*2), (PS8)L"...", 3);
            }
        }
        else
        {
//bql: MAUI_02456466
            ((U16*)data2->string_ptr)[0] = 0;
        }        
    }
    pls_sql_finalize(stmt);
    return ret ;    
}

S32 pls_sql_get_artwork_parser_path_by_id(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 album_id = 0;
    srv_plst_list_get_display_struct *data2;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 

    data2 = (srv_plst_list_get_display_struct*)data;
    ((U16*)data2->string_ptr)[0] = 0;

    /* Get album ID by song ID */
    if(id > 0X8000)
    {
        ret =  pls_sql_prepare_ex(db, "SELECT album_id FROM main.audio WHERE media_id = ? limit 1", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT album_id from db2.audio WHERE media_id = ? limit 1", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        album_id = sqlite3_column_kal_uint32(stmt, 0);
        ret = SRV_PLST_OK;
    }
    else
    {
        album_id = 0;
    }
    pls_sql_finalize(stmt);

    if(album_id == 0)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    /* Get album path from album ID */
    ret = pls_sql_prepare_ex(db, "SELECT artwork_parser_path FROM main.album_artwork WHERE album_id = ?", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, album_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        {
            mmi_ucs2ncpy((S8*)(data2->string_ptr), (const S8*)sqlite3_column_kal_wstr(stmt, 0),data2->buff_size);
        }
        else
        {
            ((U16*)data2->string_ptr)[0] = 0;
        }
        pls_sql_finalize(stmt);
        return SRV_PLST_OK;
    }
    else
    {
        pls_sql_finalize(stmt);
        ret = pls_sql_prepare_ex(db, "SELECT artwork_parser_path FROM db2.album_artwork WHERE album_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, album_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*)(data2->string_ptr), (const S8*)sqlite3_column_kal_wstr(stmt, 0),data2->buff_size);
            }
            else
            {
                ((U16*)data2->string_ptr)[0] = 0;
            }
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
    }
    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_ARTWORK_PARSER_PATH_BY_ID_NOT_FOUND, __LINE__);
    pls_sql_finalize(stmt);
    return ret;        
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_artwork_context_by_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_artwork_context_by_id(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 album_id = 0;
    srv_plst_list_get_display_struct *data2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    data2 = (srv_plst_list_get_display_struct*)data;
    if(id > 0X8000)
    {
        ret =  pls_sql_prepare_ex(db, "SELECT album_id FROM main.audio WHERE media_id = ? limit 1", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT album_id from db2.audio WHERE media_id = ? limit 1", &stmt);
    }
#endif /*__PLST_DUAL_DB_SUPPORT__*/

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        album_id = sqlite3_column_kal_uint32(stmt, 0);
        ret = SRV_PLST_OK;
    }
    else
    {
        album_id = 0;
    }
    pls_sql_finalize(stmt);
    if(album_id == 0)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

        ret = pls_sql_prepare_ex(db, "SELECT artwork, artwork_size FROM main.album_artwork WHERE album_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, album_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_size;
            temp_size = sqlite3_column_kal_uint32(stmt, 1);
            if(temp_size <= data2->buff_size)
            {         
                data2->buff_size = temp_size;
                if(sqlite3_column_blob(stmt, 0) != NULL)
                {
                    memcpy((S8*)((U32*)data2->string_ptr), (const S8*)sqlite3_column_blob(stmt, 0),data2->buff_size);
                } 
                else
                {
                    data2->buff_size = 0;
                }
            }
            else
            {
                data2->buff_size = 0;
            }
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_prepare_ex(db, "SELECT artwork, artwork_size FROM db2.album_artwork WHERE album_id = ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, album_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 temp_size;
                temp_size = sqlite3_column_kal_uint32(stmt, 1);
                if(temp_size <= data2->buff_size)
                {         
                    data2->buff_size = temp_size;
                    if(sqlite3_column_blob(stmt, 0) != NULL)
                    {
                        memcpy((S8*)((U32*)data2->string_ptr), (const S8*)sqlite3_column_blob(stmt, 0),data2->buff_size);
                    } 
                    else
                    {
                        data2->buff_size = 0;
                    }
                }
                else
                {
                    data2->buff_size = 0;
                }
                pls_sql_finalize(stmt);
                return SRV_PLST_OK;
            }
        }
        pls_sql_finalize(stmt);
        return ret;        
}


S32 pls_sql_update_artwork_context(srv_plst_db_context_struct *db, S32 index, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 id0;
    UI_string_type path;
    void* resized_data = NULL;
    void* row_data = NULL;
    U32 left_size;
    S32 resized_size;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type = list_view->view_type[list_view->current_index];

    id0 = list_cache->cache[index].id;
    path = (UI_string_type)data;
    if(base->temp_memory_ptr)
    {
        resized_data = NULL;
        row_data = NULL;
        resized_data = (void*)(*(U32*)base->temp_memory_ptr);
        row_data = (void*)(*(S32*)base->temp_memory_ptr + SRV_PLS_MIN_ARTWORK_SIZE);  
        left_size = base->temp_memory_size - SRV_PLS_MIN_ARTWORK_SIZE;                    
        memset(row_data, 0 , left_size);
        memset(resized_data, 0 , SRV_PLS_MIN_ARTWORK_SIZE);
        if(base->temp_memory_ptr && row_data)
        {          
            ret = pls_db_util_resize_artwork_by_path(path, row_data, left_size, resized_data, &resized_size);
            if(resized_size < 0)
            {
                resized_data = 0;
                resized_size = 0;
            }
            if (ret != SRV_PLST_OK)
            {
                resized_size = 0;
                resized_data = NULL; 
                row_data = NULL;
                return ret;
            } 
        }
        else 
        {
            return SRV_PLST_RET_ERR_MEMORY_NOT_ENOUGH;
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_MEMORY_NOT_ENOUGH;
    }
    
    if(view_type == SRV_PLST_VIEW_ALBUM || 
        (view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->current_index && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM))
    {
        sprintf(db->sql_cmd, "UPDATE  main.album_artwork set artwork = ?, artwork_size = ? WHERE album_id = ?");
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_blob(stmt, 1, resized_data, resized_size, SQLITE_STATIC);
        sqlite3_bind_kal_uint32(stmt, 2, resized_size);
        sqlite3_bind_kal_uint32(stmt, 3,id0);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "UPDATE  db2.album_artwork set artwork = ?, artwork_size = ? WHERE album_id = ?");
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_blob(stmt, 1, resized_data, resized_size, SQLITE_STATIC);
            sqlite3_bind_kal_uint32(stmt, 2, resized_size);
            sqlite3_bind_kal_uint32(stmt, 3,id0);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        return ret;
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }     
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_artwork_context
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_artwork_context(srv_plst_db_context_struct *db, S32 index, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_playing_context_struct *playing_info;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 id0;
    srv_plst_list_get_display_struct *data2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type = list_view->view_type[list_view->current_index];

    id0 = list_cache->cache[index].id;
    data2 = (srv_plst_list_get_display_struct*)data;

    if(((view_type == SRV_PLST_VIEW_PLST_DEFAULT || view_type == SRV_PLST_VIEW_PLST_ACTIVE) && (playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )) ||  ((list_view->current_index == 1 && list_view->view_type[0]== SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA) ||
        (list_view->current_index == 2 && list_view->view_type[0]== SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH)))
    {
        if((view_type == SRV_PLST_VIEW_PLST_DEFAULT && playing_info->plst_id > 0X8000) ||
           (id0 > 0X8000))
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            id0 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    else if(view_type == SRV_PLST_VIEW_MEDIA || view_type == SRV_PLST_VIEW_AUDIO) /* get artwork in all song list  */
    {
        ret = pls_sql_get_artwork_context_by_id(db, id0, data); 
        return ret;
    }
    else if(view_type == SRV_PLST_VIEW_ARTIST || view_type == SRV_PLST_VIEW_GENRE)
    {
        if(view_type == SRV_PLST_VIEW_ARTIST)
        {
            sprintf(db->sql_cmd, "SELECT album_id from main.audio WHERE artist_id = ?");
        }
    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        else
        {
            sprintf(db->sql_cmd, "SELECT album_id FROM main.audio WHERE genre_id = ?");
        }
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id0 = sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
        }
        else if(ret != SRV_PLST_OK)
        {
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(view_type == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd, "SELECT album_id from db2.audio WHERE artist_id = ?");
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else
                {
                    sprintf(db->sql_cmd, "SELECT album_id FROM db2.audio WHERE genre_id = ?");
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id0);
                ret = pls_sql_step_ex(db, stmt);        
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id0 = sqlite3_column_kal_uint32(stmt,0);
                    pls_sql_finalize(stmt);
                }
                else if(ret != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
    }

#ifdef  __PLST_SRV_DEFAULT_LIST__
    if(view_type == SRV_PLST_VIEW_PLST_DEFAULT)
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO 
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST 
            #endif
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
             ret = pls_sql_get_artwork_context_by_id(db, id0, data);    
              return ret;        
        }
    }
    else
#endif /* __PLST_SRV_DEFAULT_LIST__ */
    if(view_type == SRV_PLST_VIEW_ALBUM || view_type == SRV_PLST_VIEW_IMAGE_FLOW|| view_type == SRV_PLST_VIEW_ARTIST || view_type == SRV_PLST_VIEW_GENRE ||
        (view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM && list_view->current_index > 0))
    {
        sprintf(db->sql_cmd, "SELECT artwork, artwork_size FROM main.album_artwork WHERE album_id = ?");
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_size;
            temp_size = sqlite3_column_kal_uint32(stmt, 1);
            if(temp_size <= data2->buff_size)
            {         
                data2->buff_size = temp_size;
                if(sqlite3_column_blob(stmt, 0) != NULL)
                {
                    memcpy((S8*)((U32*)data2->string_ptr), (const S8*)sqlite3_column_blob(stmt, 0),data2->buff_size);
                }
                else
                {
                    data2->buff_size = 0;
                }
            }
            else
            {
                data2->buff_size = 0;
            }
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
        else if(ret == SRV_PLST_OK)
        {
            pls_sql_finalize(stmt);
            sprintf(db->sql_cmd, "SELECT artwork, artwork_size FROM db2.album_artwork WHERE album_id = ?");
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 temp_size;

                ret = SRV_PLST_OK;
                temp_size = sqlite3_column_kal_uint32(stmt, 1);
                if(temp_size <= data2->buff_size)
                {         
                    data2->buff_size = temp_size;
                    if(sqlite3_column_blob(stmt, 0) != NULL)
                    {
                        memcpy((S8*)((U32*)data2->string_ptr), (const S8*)sqlite3_column_blob(stmt, 0),data2->buff_size);
                        #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                        #endif
                    }
                    else
                    {
                        data2->buff_size = 0;
                    }
                }
                else
                {
                    data2->buff_size = 0;
                }
            }            
        }
        pls_sql_finalize(stmt);
    }
    else
    {  
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }   
    return ret ;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_media_path_by_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_media_path_by_index(srv_plst_db_context_struct *db, U32 index, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_view_type_enum view_type_pre, view_type_last;
    S32 ret = SRV_PLST_OK;
    U32 id0;
    srv_plst_list_get_display_struct *data2;
    srv_plst_playing_context_struct *play_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    play_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);

    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type_last = list_view->view_type[list_view->current_index];
    if(list_view->current_index)
    {
        view_type_pre = list_view->view_type[list_view->current_index - 1];
    }
    else
    {
        view_type_pre = list_view->view_type[list_view->current_index];
    }
    id0 = list_cache->cache[index].id;
    
    if((list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA && 
        list_view->current_index == 1) ||
        (list_view->current_index == 2 && list_view->view_type[0]== SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH))
    {
        if(list_view->list_cache[1].parent_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ? ");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id0);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            id0 = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            return ret;
        }
    }

    if(view_type_last == SRV_PLST_VIEW_PLST_ACTIVE)
    {
        view_type_last = play_info->play_info.view_type[play_info->play_info.current_index];
        if(play_info->active_type != SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            view_type_last = SRV_PLST_VIEW_AUDIO;
        }
        else
        {
            view_type_last = SRV_PLST_VIEW_VIDEO;
        }
        if(play_info->play_info.view_type[0] == SRV_PLST_VIEW_PLST)
        {
            if(play_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id0);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id0 = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }
        }
    }
    data2 = (srv_plst_list_get_display_struct*)data;
    if(view_type_last != SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        switch(view_type_last)
        {
            case SRV_PLST_VIEW_AUDIO:
            case SRV_PLST_VIEW_MEDIA:
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT path FROM main.meta_slim WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT path FROM db2.meta_slim WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT path FROM main.video WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT path FROM db2.video WHERE vdo_id = ?");
                }
                break;            
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            default: 
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        switch(view_type_pre)
        {
            case SRV_PLST_VIEW_AUDIO:
            case SRV_PLST_VIEW_MEDIA:
            
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT path FROM main.meta_slim WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT path FROM db2.meta_slim WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                if(id0 > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT path FROM main.video WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT path FROM db2.video WHERE vdo_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                break;            
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            default: 
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }   
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id0);

    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        {
            mmi_ucs2ncpy((S8*)(data2->string_ptr), (const S8*)sqlite3_column_kal_wstr(stmt, 0),data2->buff_size);
        }
        else
        {
            ((U16*)data2->string_ptr)[0] = 0;
        }        
    }
    pls_sql_finalize(stmt);
    return ret ;    
}

#ifdef __COSMOS_MMI_PACKAGE__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_details
 * DESCRIPTION
 *  only get necessary field for cosmos
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_view_details(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 artist_id, album_id;
    srv_plst_media_details_struct *data2;
    U32 stmt_id;
    const S8* ptr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type = list_view->view_type[list_view->current_index];
    data2 = (srv_plst_media_details_struct*)data;
    kal_mem_set(data2, 0, sizeof(srv_plst_media_details_struct));

    if(!id)
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    else
    {
        data2->media_id = id;
    }
/*
typedef struct
{
    UI_character_type filename[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type title[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type artist[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type album[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type author[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type genre[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type copyrights[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type description[SRV_PLST_META_INFO_MAX_LEN + 1];  
    U32 artwork_type;
    U32 bits_rate;
    U16 sample_rate;
    S16 track_num;    
    S16 year;        
    U8 channel_num;     
    U16 play_count;  
    S16 volume;
    U8  user_rating;    
    U8 sample_bits;
    srv_plst_time_struct last_played;  
    srv_plst_time_struct last_modified;  
}srv_plst_media_details_struct;
*/
    if(view_type == SRV_PLST_VIEW_VIDEO || (list_view->current_index == 1 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[0] == SRV_PLST_VIEW_VIDEO))
    {
        return SRV_PLST_OK;
    }

    if(id > 0X8000)
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, name from main.audio WHERE media_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_MAIN_AUDIO;
        ptr = Sqlmaindot;
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, name from db2.audio WHERE media_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_DB2_AUDIO;
        ptr = Sqldb2dot;
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    kal_sprintf(db->sql_cmd, "SELECT artist_id, album_id, name from %saudio WHERE media_id = ?", ptr);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        artist_id = sqlite3_column_kal_uint32(stmt, 0);
        album_id = sqlite3_column_kal_uint32(stmt, 1);
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 2)))
        { 
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                mmi_ucs2ncpy((S8*)data2->filename, (const S8*)sqlite3_column_kal_wstr(stmt, 2),SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*)data2->title, (const S8*)sqlite3_column_kal_wstr(stmt, 2),SRV_PLST_META_INFO_MAX_LEN);
            }
        }
        else
        {
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->filename[0] = 0;
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->title[0] = 0;
            }
        }   
        ret = SRV_PLST_OK;
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_name from main.artist WHERE artist_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ARTIST_NAME_MAIN_ARTIST;
        ptr = Sqlmaindot;
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_name from db2.artist WHERE artist_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ARTIST_NAME_DB2_ARTIST;
        ptr = Sqldb2dot;        
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    kal_sprintf(db->sql_cmd, "SELECT artist_name from %sartist WHERE artist_id = ?", ptr);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, artist_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            mmi_ucs2ncpy((S8*)data2->artist, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        { 
            data2->artist[0] = 0;
        }   
        ret = SRV_PLST_OK;
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        //ret = pls_sql_prepare_ex(db, "SELECT album_name from main.album WHERE album_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ALBUM_NAME_MAIN_ALBUM;
        ptr = Sqlmaindot;
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        //ret = pls_sql_prepare_ex(db, "SELECT album_name from db2.album WHERE album_id = ?", &stmt);
        stmt_id = PLS_SQL_STMT_SELECT_ALBUM_NAME_DB2_ALBUM;
        ptr = Sqldb2dot;
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    kal_sprintf(db->sql_cmd, "SELECT album_name from %salbum WHERE album_id = ?", ptr);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, album_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            mmi_ucs2ncpy((S8*)data2->album, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        { 
            data2->album[0] = 0;
        }   
        ret = SRV_PLST_OK;
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        //strcat(db->sql_cmd, "SELECT duration FROM main.meta WHERE media_id = ?");
        stmt_id = PLS_SQL_STMT_SELECT_DURATION_MAIN_META;
        ptr = Sqlmaindot;
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        //strcat(db->sql_cmd, "SELECT duration FROM db2.meta WHERE media_id = ?");
        stmt_id = PLS_SQL_STMT_SELECT_DURATION_DB2_META;
        ptr = Sqldb2dot;
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    //ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    kal_sprintf(db->sql_cmd, "SELECT duration FROM %smeta WHERE media_id = ?", ptr);
    ret = pls_sql_stmt_cache_prepare(db, stmt_id, &stmt, db->sql_cmd);

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        data2->duration = sqlite3_column_kal_uint32(stmt, 0);
        ret = SRV_PLST_OK;
    }
    else if(ret == SRV_PLST_OK)
    {
        ret = SRV_PLST_RET_EMPTY;
    }
    //pls_sql_finalize(stmt);
    pls_sql_clear_binding(stmt);
    return ret ;    
}

S32 pls_sql_get_view_details_by_filter(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 artist_id, album_id;
    srv_plst_media_details_struct *data2;
     /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type = list_view->view_type[list_view->current_index];
    data2 = (srv_plst_media_details_struct*)data;
    kal_mem_set(data2, 0, sizeof(srv_plst_media_details_struct));

    if(!id)
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    else
    {
        data2->media_id = id;
    }
/*
typedef struct
{
    UI_character_type filename[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type title[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type artist[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type album[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type author[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type genre[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type copyrights[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type description[SRV_PLST_META_INFO_MAX_LEN + 1];  
    U32 artwork_type;
    U32 bits_rate;
    U16 sample_rate;
    S16 track_num;    
    S16 year;        
    U8 channel_num;     
    U16 play_count;  
    S16 volume;
    U8  user_rating;    
    U8 sample_bits;
    srv_plst_time_struct last_played;  
    srv_plst_time_struct last_modified;  
}srv_plst_media_details_struct;
*/
    if(view_type == SRV_PLST_VIEW_VIDEO || (list_view->current_index == 1 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[0] == SRV_PLST_VIEW_VIDEO))
    {
        return SRV_PLST_OK;
    }

    if(id > 0X8000)
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, name from main.audio WHERE media_id = ?", &stmt);
        ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_MAIN_AUDIO, &stmt, NULL);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        //ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, name from db2.audio WHERE media_id = ?", &stmt);
        ret = pls_sql_stmt_cache_prepare(db, PLS_SQL_STMT_SELECT_ARTIST_ALBUM_NAME_DB2_AUDIO, &stmt, NULL);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        artist_id = sqlite3_column_kal_uint32(stmt, 0);
        album_id = sqlite3_column_kal_uint32(stmt, 1);
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 2)))
        { 
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                mmi_ucs2ncpy((S8*)data2->filename, (const S8*)sqlite3_column_kal_wstr(stmt, 2),SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*)data2->title, (const S8*)sqlite3_column_kal_wstr(stmt, 2),SRV_PLST_META_INFO_MAX_LEN);
            }
        }
        else
        {
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->filename[0] = 0;
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->title[0] = 0;
            }
        }   
        ret = SRV_PLST_OK;
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);

    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        //pls_sql_finalize(stmt);
        pls_sql_clear_binding(stmt);

        return ret;
    }

    return ret ;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_update_view_details
 * DESCRIPTION
 *  only update duration for cosmos
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_update_view_details(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_media_details_struct *data2;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *playing_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    data2 = (srv_plst_media_details_struct*)data;
    if (id)
    {
        data2->media_id = id;
    }
/*
    UI_character_type title[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type artist[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type album[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type author[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type genre[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type copyrights[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type description[SRV_PLST_META_INFO_MAX_LEN + 1];  
    U32 artwork_type;
    U32 format;
    S16 track_num;   
    S16 year;         
    S16 channel_num;    
    U16 play_count;     
    S16 volume;
    U8  user_rating;   
    U32 bits_rate;
    U16 sample_rate;
    U8 sample_bits;
    srv_plst_time_struct last_played; 
    srv_plst_time_struct last_modified;  
    
            CREATE TABLE meta(
                media_id       INTEGER     PRIMARY KEY,
                path           TEXT        NOT NULL,
                is_short       INTEGER,
                title          TEXT,
                copyrights     TEXT,
                description    TEXT,
                author         TEXT,
                year           INTEGER,
                track_num      INTEGER,
                artwork_type   INTEGER,
                volume         INTEGER,
                user_rating    INTEGER,
                played         INTEGER,
                modified       INTEGER,
                format         INTEGER,
                played_count   INTEGER,
                is_exist       INTEGER)
               
                sprintf(db->sql_cmd, "CREATE TABLE meta(media_id INTEGER PRIMARY KEY, path TEXT, is_short INTEGER ,\
title TEXT, copyrights TEXT, description TEXT, author TEXT, year INTEGER, track_num INTEGER, artwork_type TEXT, \
volume TEXT, user_rating INTEGER, played INTEGER, modified INTEGER,format INTEGER, played_count INTEGER, is_exist INTEGER)");
       */         

    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "UPDATE main.meta SET duration = ? WHERE media_id = ?");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, "UPDATE db2.meta SET duration = ? WHERE media_id = ?");
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, data2->duration);
    sqlite3_bind_kal_uint32(stmt, 2, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        pls_sql_finalize(stmt);
        return ret;
    }
    pls_sql_finalize(stmt);

    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
    }
    return ret ; 
}


#else /* __COSMOS_MMI_PACKAGE__ */

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_view_details
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_view_details(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    S32 ret = SRV_PLST_OK;
    U32 artist_id, album_id, genre_id;
    srv_plst_media_details_struct *data2;
     /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type = list_view->view_type[list_view->current_index];
    data2 = (srv_plst_media_details_struct*)data;
    kal_mem_set(data2, 0, sizeof(srv_plst_media_details_struct));

    if(!id)
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    else
    {
        data2->media_id = id;
    }
/*
typedef struct
{
    UI_character_type filename[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type title[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type artist[SRV_PLST_META_INFO_MAX_LEN + 1];  
    UI_character_type album[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type author[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type genre[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type copyrights[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type description[SRV_PLST_META_INFO_MAX_LEN + 1];  
    U32 artwork_type;
    U32 bits_rate;
    U16 sample_rate;
    S16 track_num;    
    S16 year;        
    U8 channel_num;     
    U16 play_count;  
    S16 volume;
    U8  user_rating;    
    U8 sample_bits;
    srv_plst_time_struct last_played;  
    srv_plst_time_struct last_modified;  
}srv_plst_media_details_struct;
*/
    if(view_type == SRV_PLST_VIEW_VIDEO || (list_view->current_index == 1 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->view_type[0] == SRV_PLST_VIEW_VIDEO))
    {
        return SRV_PLST_OK;
    }

    if(id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, genre_id, name from main.audio WHERE media_id = ?", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, genre_id, name from db2.audio WHERE media_id = ?", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        artist_id = sqlite3_column_kal_uint32(stmt, 0);
        album_id = sqlite3_column_kal_uint32(stmt, 1);
        genre_id = sqlite3_column_kal_uint32(stmt, 2);
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 3)))
        { 
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                mmi_ucs2ncpy((S8*)data2->filename, (const S8*)sqlite3_column_kal_wstr(stmt, 3),SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*)data2->title, (const S8*)sqlite3_column_kal_wstr(stmt, 3),SRV_PLST_META_INFO_MAX_LEN);
            }
        }
        else
        {
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->filename[0] = 0;
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->title[0] = 0;
            }
        }   
        ret = SRV_PLST_OK;
        pls_sql_finalize(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        pls_sql_finalize(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT artist_name from main.artist WHERE artist_id = ?", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT artist_name from db2.artist WHERE artist_id = ?", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, artist_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            mmi_ucs2ncpy((S8*)data2->artist, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        { 
            data2->artist[0] = 0;
        }   
        ret = SRV_PLST_OK;
        pls_sql_finalize(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        pls_sql_finalize(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT album_name from main.album WHERE album_id = ?", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT album_name from db2.album WHERE album_id = ?", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, album_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            mmi_ucs2ncpy((S8*)data2->album, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        { 
            data2->album[0] = 0;
        }   
        ret = SRV_PLST_OK;
        pls_sql_finalize(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        pls_sql_finalize(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT genre_name from main.genre WHERE genre_id = ?", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT genre_name from db2.genre WHERE genre_id = ?", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, genre_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            mmi_ucs2ncpy((S8*)data2->genre, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        { 
            data2->genre[0] = 0;
        }   
        ret = SRV_PLST_OK;
        pls_sql_finalize(stmt);
    }
    else
    {
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_EMPTY;
        }
        pls_sql_finalize(stmt);
        return ret;
    }

    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "SELECT title, author, copyrights, description, artwork_type, track_num, year, user_rating, bits_rate,sample_rate, sample_bits, duration ");
        strcat(db->sql_cmd, " FROM main.meta WHERE media_id = ? ");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, "SELECT title, author, copyrights, description, artwork_type, track_num, year, user_rating, bits_rate,sample_rate, sample_bits, duration  ");
        strcat(db->sql_cmd, " FROM db2.meta WHERE media_id = ?");
    } 
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        /* title, author, copyrights, description, artwork_type, track_num, year, user_rating, bits_rate,sample_rate, sample_bits, duration */
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
        { 
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                mmi_ucs2ncpy((S8*)data2->title, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                mmi_ucs2ncpy((S8*)data2->filename, (const S8*)sqlite3_column_kal_wstr(stmt, 0),SRV_PLST_META_INFO_MAX_LEN);
            }
        }
        else
        {
            if(base->config_view_sort_type == SRV_PLST_VIEW_SORT_BY_FILENAME)
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->title[0] = 0;
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                data2->filename[0] = 0;
            }
        } 
 
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
        {
            mmi_ucs2ncpy((S8*)data2->author, (const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        {
            data2->author[0] = 0;
        }
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 2)))
        {
            mmi_ucs2ncpy((S8*)data2->copyrights, (const S8*)sqlite3_column_kal_wstr(stmt, 2), SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        {
            data2->copyrights[0] = 0;
        }
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 3)))
        {
            mmi_ucs2ncpy((S8*)data2->description, (const S8*)sqlite3_column_kal_wstr(stmt, 3), SRV_PLST_META_INFO_MAX_LEN);
        }
        else
        {
            data2->description[0] = 0;
        }
        data2->artwork_type = sqlite3_column_kal_uint32(stmt, 4);
        data2->track_num = sqlite3_column_kal_uint32(stmt, 5);
        data2->year = sqlite3_column_kal_uint32(stmt, 6);
        data2->user_rating = sqlite3_column_kal_uint32(stmt, 7);
        data2->bits_rate = sqlite3_column_kal_uint32(stmt, 8);
        data2->sample_rate = sqlite3_column_kal_uint16(stmt, 9);
        data2->channel_num = sqlite3_column_kal_uint8(stmt, 10);
        data2->duration = sqlite3_column_kal_uint32(stmt, 11);
        ret = SRV_PLST_OK;
    }
    else if(ret == SRV_PLST_OK)
    {
        ret = SRV_PLST_RET_EMPTY;
    }
    pls_sql_finalize(stmt);
    return ret;    
}

S32 pls_sql_get_view_details_by_filter(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    // TODO: check if plutommi need this API
    return SRV_PLST_OK;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_update_view_details
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_update_view_details(srv_plst_db_context_struct *db, U32 id, U32 *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_media_details_struct *data2;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *playing_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    data2 = (srv_plst_media_details_struct*)data;
    if (id)
    {
        data2->media_id = id;
    }
/*
    UI_character_type title[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type artist[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type album[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type author[SRV_PLST_META_INFO_MAX_LEN + 1];    
    UI_character_type genre[SRV_PLST_META_INFO_MAX_LEN + 1];     
    UI_character_type copyrights[SRV_PLST_META_INFO_MAX_LEN + 1];   
    UI_character_type description[SRV_PLST_META_INFO_MAX_LEN + 1];  
    U32 artwork_type;
    U32 format;
    S16 track_num;   
    S16 year;         
    S16 channel_num;    
    U16 play_count;     
    S16 volume;
    U8  user_rating;   
    U32 bits_rate;
    U16 sample_rate;
    U8 sample_bits;
    srv_plst_time_struct last_played; 
    srv_plst_time_struct last_modified;  
    
            CREATE TABLE meta(
                media_id       INTEGER     PRIMARY KEY,
                path           TEXT        NOT NULL,
                is_short       INTEGER,
                title          TEXT,
                copyrights     TEXT,
                description    TEXT,
                author         TEXT,
                year           INTEGER,
                track_num      INTEGER,
                artwork_type   INTEGER,
                volume         INTEGER,
                user_rating    INTEGER,
                played         INTEGER,
                modified       INTEGER,
                format         INTEGER,
                played_count   INTEGER,
                is_exist       INTEGER)
               
                sprintf(db->sql_cmd, "CREATE TABLE meta(media_id INTEGER PRIMARY KEY, path TEXT, is_short INTEGER ,\
title TEXT, copyrights TEXT, description TEXT, author TEXT, year INTEGER, track_num INTEGER, artwork_type TEXT, \
volume TEXT, user_rating INTEGER, played INTEGER, modified INTEGER,format INTEGER, played_count INTEGER, is_exist INTEGER)");
       */         

    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "UPDATE main.meta SET title = ?, year = ?, author = ?, copyrights = ?, description = ?, track_num = ?, \
user_rating = ?, duration = ? WHERE media_id = ?");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, "UPDATE db2.meta SET title = ?, year = ?, author = ?, copyrights = ?, description = ?, track_num = ?, \
user_rating = ?, duration = ? WHERE media_id = ?");
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, data2->title);
    sqlite3_bind_kal_uint32(stmt, 2, data2->year);
    sqlite3_bind_kal_wstr(stmt, 3, data2->author);
    sqlite3_bind_kal_wstr(stmt, 4, data2->copyrights);
    sqlite3_bind_kal_wstr(stmt, 5, data2->description);
    sqlite3_bind_kal_uint32(stmt, 6, data2->track_num);
    sqlite3_bind_kal_uint32(stmt, 7, data2->user_rating);
    sqlite3_bind_kal_uint32(stmt, 8, data2->duration);
    sqlite3_bind_kal_uint32(stmt, 9, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        pls_sql_finalize(stmt);
        return ret;
    }
    pls_sql_finalize(stmt);
#if 1
    /* update artist/album/genre */
    {   
         U32 length;
         U32 artist_id_o, artist_id;
         U32 album_id_o, album_id;
         U32 genre_id_o, genre_id;
         U32 artist_media_c = 0;
         U32 album_media_c = 0;
         U32 genre_media_c = 0;

        if(id > 0x8000)
        {
            sprintf(db->sql_cmd, "SELECT artist_id, album_id, genre_id FROM main.audio WHERE media_id = ? ");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT artist_id, album_id, genre_id FROM db2.audio WHERE media_id = ? ");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            artist_id_o = sqlite3_column_kal_uint32(stmt, 0);
            album_id_o = sqlite3_column_kal_uint32(stmt, 1);
            genre_id_o = sqlite3_column_kal_uint32(stmt, 2);
            ret = SRV_PLST_OK;
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;            
        }

        /* count artist */
        if(id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? ");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, artist_id_o);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {                
            artist_media_c = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            artist_media_c = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

        /* count album */
        if(id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE album_id = ? ");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE album_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, album_id_o);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {                
            album_media_c = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            album_media_c = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        /* count genre */
        if(id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id = ? ");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE genre_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, genre_id_o);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {                
            genre_media_c = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            genre_media_c = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        
        /* check if the artist_name exist */       
        if (mmi_ucs2strlen((S8*)data2->artist) == 0)
        {
            mmi_ucs2ncpy((S8*)data2->artist, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_ARTIST), META_TAG_FRAME_MAX_LEN);
        }
        artist_id = pls_sql_crc_get_uniuqe_id(data2->artist);

        if(artist_id != artist_id_o) /* artist modified */
        {
            if(id > 0X8000)
            {
               ret = pls_sql_check_id_exist_by_id(db, MMI_TRUE, SRV_PLST_ARTIST_ID, artist_id);   
            }
            else 
            {
                ret = pls_sql_check_id_exist_by_id(db, MMI_FALSE, SRV_PLST_ARTIST_ID, artist_id); 
            }
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                /* change artist id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET artist_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET artist_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, artist_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(artist_media_c <= 1)
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {   
                        memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                    }
                }
                /* check playing */
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO &&
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }                     
                }
            } 
            else if(ret == SRV_PLST_OK) /* not exist */
            {
                /* add new artist name */
                if(id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO main.artist(artist_id, artist_name) VALUES (?,?)", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO db2.artist(artist_id, artist_name) VALUES (?,?)", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = sqlite3_bind_kal_uint32(stmt, 1, artist_id);
                ret = sqlite3_bind_kal_wstr(stmt, 2, data2->artist);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                /* change artist id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET artist_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET artist_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, artist_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }

                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                {   
                    memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                }

                /* check playing */
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO &&
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST )
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }                     
                }
            }
            else
            {
                return ret;
            }
        
            if(artist_media_c <= 1)
            {
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, artist_id_o);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    U32 temp_id;

                    temp_id = list_view->list_cache[1].parent_id;
                    memset(&(list_view->list_cache[1]), 0, sizeof(srv_plst_list_context_struct));
                    list_view->list_cache[1].parent_id = temp_id;
                }
            } 
        }

        /* check if the album_name exist */       
        if (mmi_ucs2strlen((S8*)data2->album) == 0)
        {
            mmi_ucs2ncpy((S8*)data2->album, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_ALBUM), META_TAG_FRAME_MAX_LEN);
        }
        album_id = pls_sql_crc_get_uniuqe_id(data2->album);

        if(album_id != album_id_o)
        {
            if(id > 0X8000)
            {
               ret = pls_sql_check_id_exist_by_id(db, MMI_TRUE, SRV_PLST_ALBUM_ID, album_id);   
            }
            else 
            {
                ret = pls_sql_check_id_exist_by_id(db, MMI_FALSE, SRV_PLST_ALBUM_ID, album_id); 
            }
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                /* change album_id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET album_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET album_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, album_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }

                if(album_media_c <= 1)
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {   
                        memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                    }
                }
                                /* check playing */
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO)
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }                     
                }
            } 
            else if(ret == SRV_PLST_OK) /* not exist */
            {
                /* add new album name */
                if(id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO main.album(album_id, album_name) VALUES (?,?)", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO db2.album(album_id, album_name) VALUES (?,?)", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;                    
                }
                ret = sqlite3_bind_kal_uint32(stmt, 1, album_id);
                ret = sqlite3_bind_kal_wstr(stmt, 2, data2->album);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }

                /* change album_id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET album_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET album_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, album_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM))
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                    }
                    else
                    {
                        U32 temp_id;

                        temp_id = list_view->list_cache[1].parent_id;
                        memset(&(list_view->list_cache[1]), 0, sizeof(srv_plst_list_context_struct));
                        list_view->list_cache[1].parent_id = temp_id;
                    }
                }
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO )
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }                     
                }
            }
            else
            {
                return ret;
            }
        
            if(album_media_c <= 1)
            {
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.album WHERE album_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, album_id_o);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM))
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                    }
                    else
                    {
                        U32 temp_id;

                        temp_id = list_view->list_cache[1].parent_id;
                        memset(&(list_view->list_cache[1]), 0, sizeof(srv_plst_list_context_struct));
                        list_view->list_cache[1].parent_id = temp_id;
                    }
                }
            } 
        }
        /* check if the genre_name exist */       
        if (mmi_ucs2strlen((S8*)data2->genre) == 0)
        {
            mmi_ucs2ncpy((S8*)data2->genre, (S8*)GetString(STR_ID_SRV_PLST_UNKNOWN_GENRE), META_TAG_FRAME_MAX_LEN);
        }
        genre_id = pls_sql_crc_get_uniuqe_id(data2->genre);

        if(genre_id != genre_id_o)
        {
            if(id > 0X8000)
            {
               ret = pls_sql_check_id_exist_by_id(db, MMI_TRUE, SRV_PLST_GENRE_ID, genre_id);   
            }
            else 
            {
                ret = pls_sql_check_id_exist_by_id(db, MMI_FALSE, SRV_PLST_GENRE_ID, genre_id); 
            }
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                /* change genre_id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET genre_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET genre_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, genre_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(genre_media_c <= 1)
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_GENRE)
                    {   
                        memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                    }
                }
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO &&
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }                     
                }
            } 
            else if(ret == SRV_PLST_OK) /* not exist */
            {
                /* add new genre name */
                if(id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO main.genre(genre_id, genre_name) VALUES (?,?)", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "INSERT INTO db2.genre(genre_id, genre_name) VALUES (?,?)", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;                    
                }
                ret = sqlite3_bind_kal_uint32(stmt, 1, genre_id);
                ret = sqlite3_bind_kal_wstr(stmt, 2, data2->genre);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                /* change genre_id */
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET genre_id = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET genre_id = ? WHERE media_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd,  &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, genre_id);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                }
                if(playing_info->is_load && playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO &&
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE )
                {
                    pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
                    pls_sql_get_active_play_count_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_count);
                    pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
                    playing_info->play_info.total_count = playing_info->total;
                    if(playing_info->total == 0)
                    {
                        playing_info->plst_id = 0;            
                    }      
                }
            }
            else
            {
                return ret;
            }
        
            if(genre_media_c <= 1)
            {
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.genre WHERE genre_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.genre WHERE genre_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, genre_id_o);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    memset(&(list_view->list_cache[0]), 0, sizeof(srv_plst_list_context_struct));
                }
            } 
        }/* update genre */       
    }    
#endif
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
    }
    return ret ; 
}

#endif /* __COSMOS_MMI_PACKAGE__ */


/*****************************************************************************
 * FUNCTION
 *  pls_sql_util_check_item_if_exist_in_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_util_check_item_if_exist_in_plst(srv_plst_db_context_struct *db, MMI_BOOL unique_flag, U32 media_id, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(unique_flag)
    {
        if(id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT plstitem_id from main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "SELECT plstitem_id from db2.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);        
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_add_mark_sort_type_to_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_add_mark_sort_type_to_plst(srv_plst_db_context_struct *db, U32 input_id, U32 idx, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    U32 media_id;
    U32 sort_id;
    U32 count = 0;
    S32 ret = SRV_PLST_OK;
    UI_character_type name[SRV_PLST_META_INFO_MAX_LEN + 1];
    U16 ischar = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    if(list_view->is_mark_all && !list_view->is_unmark_all)
    {
        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM && 
            list_view->view_type[2] == SRV_PLST_VIEW_PLST_ADDTO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id FROM main.audio where artist_id = ? AND album_id >= ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1)  group by album_id order by album_id limit 1 )");
                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT album_id FROM db2.audio WHERE artist_id = ? AND album_id >=? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) group by album_id order by album_id limit 1)) order by album_id limit 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT album_id FROM main.audio WHERE artist_id =? and album_id >= ? AND album_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) group by album_id order by album_id limit 1");
            }
        }
        else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id FROM main.artist where artist_id >= ? AND artist_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by artist_id limit 1 )");
                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT artist_id FROM db2.artist WHERE artist_id >= ? AND artist_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by artist_id limit 1)) order by artist_id limit 1");                
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT artist_id FROM main.artist WHERE artist_id >=? and artist_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) order by artist_id limit 1");
            }
        }
        else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id FROM main.album where album_id >= ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by album_id limit 1 )");
                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT album_id FROM db2.album WHERE album_id >= ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by album_id limit 1)) order by album_id limit 1");                
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT album_id FROM main.album WHERE album_id >=? and album_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) order by album_id limit 1");
            }
        }
    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id FROM main.genre where genre_id >= ? AND genre_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by genre_id limit 1 )");
                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT genre_id FROM db2.genre WHERE genre_id >= ? AND genre_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by genre_id limit 1)) order by genre_id limit 1");                
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT genre_id FROM main.genre WHERE genre_id >=? and genre_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) order by genre_id limit 1");
            }
        }
    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
    }
    else
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd,"SELECT id FROM db2.mark WHERE mark_flag = 1");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd,"SELECT id FROM main.mark WHERE mark_flag = 1");
        }   
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(list_view->is_mark_all && !list_view->is_unmark_all)
    {
        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM && 
            list_view->view_type[2] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[1].parent_id);
            sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, list_view->list_cache[1].parent_id);
                sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, list_view->sort_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        const S8* ptr;
        sort_id = sqlite3_column_kal_uint32(stmt, 0);
        if(list_view->sort_id != sort_id)
        {
            list_view->added_id = 0;
            list_view->sort_id = sort_id;
        }
        pls_sql_finalize(stmt);
        name[0] = 0;
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(list_view->added_id > 0X8000 || !list_view->added_id )
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(list_view->added_id > 0X8000 || !list_view->added_id )
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*) name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint16(stmt, 1);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }

                // MAUI_03091154, only select max name from specific artist, album or genre
                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    ptr = "artist_id = ? AND album_id = ?";
                }
                else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    ptr = Sqlartistid;
                }
                else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    ptr = Sqlalbumid;
                }
                else 
                {
                    ptr = Sqlgenreid;
                }

                /* First add, find max name */
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM(SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s ORDER by ischar desc, p_name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s ORDER BY ischar desc, p_name desc, media_id limit 1 )) order by ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE %s ORDER by ischar desc, p_name desc, media_id limit 1", ptr);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM(SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s ORDER by name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s ORDER BY name desc, media_id limit 1 )) order by name desc, media_id limit 1", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE %s ORDER by name desc, media_id limit 1", ptr);
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }

                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[1].parent_id);            
                    sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->list_cache[1].parent_id);            
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 1, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }

                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*) name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
                    }
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        ischar = sqlite3_column_kal_uint16(stmt, 2);
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;                    
                }
            }
        }

        {
            /* check the songs in the artist/album/genre */
            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = "artist_id = ? AND album_id = ?";
            }
            else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else 
            {
                ptr = Sqlgenreid;
            }

            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar from main.audio where ischar = ? AND p_name = ? AND \
media_id > ? and %s order by ischar desc, p_name desc, media_id ASC limit 1) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND \
p_name = ? AND media_id > ? and %s order by ischar desc, p_name desc, media_id ASC limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where ischar = ? AND p_name = ? AND media_id > ? and %s order by ischar desc, p_name desc, media_id ASC limit 1", ptr);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name from main.audio where name = ? AND media_id > ? and %s order by name desc, media_id ASC limit 1)  \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND media_id > ? and %s order by name desc, media_id ASC limit 1)) ORDER BY name desc, media_id limit 1", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where name = ? AND media_id > ? and %s order by name desc, media_id ASC limit 1", ptr);
                    }

                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name from main.audio where media_id > ? and %s order by media_id ASC limit 1)  \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE media_id > ? and %s order by media_id ASC limit 1)) ORDER BY media_id limit 1", ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where media_id > ? and %s order by media_id ASC limit 1", ptr);
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint16(stmt, 1, ischar);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 4, list_view->list_cache[1].parent_id);            
                    sqlite3_bind_kal_uint32(stmt, 5, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint16(stmt, 6, ischar);
                        sqlite3_bind_kal_wstr(stmt, 7, name);
                        sqlite3_bind_kal_uint32(stmt, 8, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 9, list_view->list_cache[1].parent_id);                
                        sqlite3_bind_kal_uint32(stmt, 10, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->list_cache[1].parent_id);            
                    sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 7, list_view->list_cache[1].parent_id);                
                        sqlite3_bind_kal_uint32(stmt, 8, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                sqlite3_bind_kal_uint32(stmt, 2, list_view->list_cache[1].parent_id);            
                sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 5, list_view->list_cache[1].parent_id);                
                    sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
        else
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint16(stmt, 1, ischar);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint16(stmt, 5, ischar);
                        sqlite3_bind_kal_wstr(stmt, 6, name);
                        sqlite3_bind_kal_uint32(stmt, 7, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 8, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 4, name);
                        sqlite3_bind_kal_uint32(stmt, 5, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);           
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            sqlite3_stmt *stmt_t;
            media_id = sqlite3_column_kal_uint32(stmt, 0);            
            
            ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
            if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, " INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, media_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, id);
            sqlite3_bind_kal_uint32(stmt_t, 3, idx);
            ret = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            idx ++;
            if(ret != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            count ++;
            list_view->added_id = media_id;
            (base->plstitem_count)++;
            if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
            {             
                ret = SRV_PLST_RET_PLST_FULL;                                    
            }
            if (list_view->is_add_cancel)
            {    
                pls_sql_finalize(stmt);
                return SRV_PLST_OK;                
            }         

            if(count > SRV_PLST_SQL_OP_TIME)
            {
                ret = SRV_PLST_RET_CONTINUE;
            }
            sqlite3_reset(stmt);
            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        sqlite3_bind_kal_wstr(stmt, 2, name);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->list_cache[1].parent_id);            
                        sqlite3_bind_kal_uint32(stmt, 5, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint16(stmt, 6, ischar);
                            sqlite3_bind_kal_wstr(stmt, 7, name);
                            sqlite3_bind_kal_uint32(stmt, 8, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 9, list_view->list_cache[1].parent_id);                
                            sqlite3_bind_kal_uint32(stmt, 10, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                    else
                    {
                        sqlite3_bind_kal_wstr(stmt, 1, name);
                        sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->list_cache[1].parent_id);            
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 5, name);
                            sqlite3_bind_kal_uint32(stmt, 6, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 7, list_view->list_cache[1].parent_id);                
                            sqlite3_bind_kal_uint32(stmt, 8, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 2, list_view->list_cache[1].parent_id);            
                    sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 5, list_view->list_cache[1].parent_id);                
                        sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            else
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        sqlite3_bind_kal_wstr(stmt, 2, name);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint16(stmt, 5, ischar);
                            sqlite3_bind_kal_wstr(stmt, 6, name);
                            sqlite3_bind_kal_uint32(stmt, 7, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 8, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                    else
                    {
                        sqlite3_bind_kal_wstr(stmt, 1, name);
                        sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 4, name);
                            sqlite3_bind_kal_uint32(stmt, 5, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                    sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);           
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            ret = pls_sql_step_ex(db,stmt);
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_OK) /* Current empty delete from mark */
        {            
            const S8* ptr;

            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                {
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = "artist_id = ? AND album_id = ?";
                    }
                    else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;
                    }
                    else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else 
                    {
                        ptr = Sqlgenreid;
                    }

                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar from main.audio where ischar = ? AND p_name < ? AND \
%s order by ischar desc, p_name desc, media_id ASC limit 1) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND \
p_name < ? and %s order by ischar desc, p_name desc, media_id ASC limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where ischar = ? AND p_name < ? and %s order by ischar desc, p_name desc, media_id ASC limit 1", ptr);
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name from main.audio where name < ? and %s order by name desc, media_id ASC limit 1)  \
    UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name < ? and %s order by name desc, media_id ASC limit 1)) ORDER BY name desc, media_id limit 1", ptr, ptr);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where name < ? and %s order by name desc, media_id ASC limit 1", ptr);
                        }
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
                    list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                {                    
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        sqlite3_bind_kal_wstr(stmt, 2, name);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->list_cache[1].parent_id);            
                        sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint16(stmt, 5, ischar);
                            sqlite3_bind_kal_wstr(stmt, 6, name);
                            sqlite3_bind_kal_uint32(stmt, 7, list_view->list_cache[1].parent_id);                
                            sqlite3_bind_kal_uint32(stmt, 8, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                    else
                    {
                        sqlite3_bind_kal_wstr(stmt, 1, name);
                        sqlite3_bind_kal_uint32(stmt, 2, list_view->list_cache[1].parent_id);            
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 4, name);
                            sqlite3_bind_kal_uint32(stmt, 5, list_view->list_cache[1].parent_id);                
                            sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }                                      
                }
                else
                {                    
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        sqlite3_bind_kal_wstr(stmt, 2, name);
                        sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint16(stmt, 4, ischar);
                            sqlite3_bind_kal_wstr(stmt, 5, name);
                            sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                    else
                    {
                        sqlite3_bind_kal_wstr(stmt, 1, name);
                        sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 3, name);
                            sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    media_id = sqlite3_column_kal_uint32(stmt, 0);            
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt,1), SRV_PLST_META_INFO_MAX_LEN);
                    }
                    ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */

                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret != SRV_PLST_OK)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, media_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, id);
                    sqlite3_bind_kal_uint32(stmt_t, 3, idx);
                    ret = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    idx ++;
                    if(ret != SRV_PLST_OK)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    count ++;
                    list_view->added_id = media_id;
                    (base->plstitem_count)++;
                    if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
                    {             
                        ret = SRV_PLST_RET_PLST_FULL;                                    
                    }
                    if (list_view->is_add_cancel)
                    {    
                        pls_sql_finalize(stmt);
                        return SRV_PLST_OK;                
                    }
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                    }
                    
                    pls_sql_finalize(stmt);
                }
                else
                {
                    pls_sql_finalize(stmt);

                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                        {
                            ptr = "artist_id = ? AND album_id = ?";
                        }
                        else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                        {
                            ptr = Sqlartistid;
                        }
                        else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                            ptr = Sqlalbumid;
                        }
                        else 
                        {
                            ptr = Sqlgenreid;
                        }                        

                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar from main.audio where ischar < ? AND \
%s order by ischar desc, p_name desc, media_id ASC limit 1) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar < ? AND \
%s order by ischar desc, p_name desc, media_id ASC limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name from main.audio where ischar < ? AND  %s order by ischar desc, p_name desc, media_id ASC limit 1", ptr);
                        }

                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }

                        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                        {  
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                            //sqlite3_bind_kal_wstr(stmt,2, name);
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->list_cache[1].parent_id);            
                            sqlite3_bind_kal_uint32(stmt, 3, list_view->sort_id);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_uint16(stmt, 4, ischar);
                                //sqlite3_bind_kal_wstr(stmt,6, name);
                                sqlite3_bind_kal_uint32(stmt, 5, list_view->list_cache[1].parent_id);                
                                sqlite3_bind_kal_uint32(stmt, 6, list_view->sort_id);           
                            }                                     
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                        else
                        {   
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);                        
                            //sqlite3_bind_kal_wstr(stmt,2, name);
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->sort_id);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_uint16(stmt, 3, ischar);                            
                                //sqlite3_bind_kal_wstr(stmt,5, name);
                                sqlite3_bind_kal_uint32(stmt, 4, list_view->sort_id);           
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                        ret = pls_sql_step_ex(db, stmt);

                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            sqlite3_stmt *stmt_t;
                            media_id = sqlite3_column_kal_uint32(stmt, 0);            
                            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,1)))
                            {
                                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt,1), SRV_PLST_META_INFO_MAX_LEN);
                            }
                            ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
                            if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                            {
                                pls_sql_finalize(stmt);
                                return ret;
                            }
                            if(id > 0X8000)
                            {
                                sprintf(db->sql_cmd, " INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                            }
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            else
                            {
                                sprintf(db->sql_cmd, " INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */

                            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                            if(ret != SRV_PLST_OK)
                            {
                                pls_sql_finalize(stmt);
                                return ret;
                            }
                            sqlite3_bind_kal_uint32(stmt_t, 1, media_id);
                            sqlite3_bind_kal_uint32(stmt_t, 2, id);
                            sqlite3_bind_kal_uint32(stmt_t, 3, idx);
                            ret = pls_sql_step_ex(db, stmt_t);
                            pls_sql_finalize(stmt_t);
                            idx ++;
                            if(ret != SRV_PLST_OK)
                            {
                                pls_sql_finalize(stmt);
                                return ret;
                            }
                            count ++;
                            list_view->added_id = media_id;
                            (base->plstitem_count)++;
                            if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
                            {             
                                ret = SRV_PLST_RET_PLST_FULL;                                    
                            }
                            if (list_view->is_add_cancel)
                            {    
                                pls_sql_finalize(stmt);
                                return SRV_PLST_OK;                
                            }         

                            {
                                ret = SRV_PLST_RET_CONTINUE;
                            }
                        }
                        pls_sql_finalize(stmt);
                    }
                }
            }
            
            if(list_view->is_mark_all && !list_view->is_unmark_all && ret == SRV_PLST_OK)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, " INSERT INTO db2.mark(id, mark_flag) VALUES (?, 1)");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, " INSERT INTO main.mark(id, mark_flag) VALUES (?, 1)");
                }
            }
            else if(list_view->is_mark && !list_view->is_mark_all && ret == SRV_PLST_OK)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {   
                    sprintf(db->sql_cmd, " DELETE FROM db2.mark WHERE id = ? ");                   
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, " DELETE FROM main.mark WHERE id = ? ");   
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, list_view->sort_id);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            ret = SRV_PLST_RET_CONTINUE;
        }        
        return ret;
    }
    else 
    {
        sort_id = 0;        
        pls_sql_finalize(stmt);
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_add_media_to_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_add_media_to_plst(srv_plst_db_context_struct *db, U32 input_id, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_list_context_struct *list_cache;
    srv_plst_base_info_struct *base;
    srv_plst_view_type_enum view_type;
    U32 media_id;
    U32 count = 0;
    U32 idx = 0;
    S32 ret = SRV_PLST_OK;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type = list_view->view_type[list_view->current_index - 1];
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    if (!list_view->is_mark && !input_id)
    {
        ret = SRV_PLST_RET_ERR_UNKOWN_ERR;
        return ret;
    }    
    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, " SELECT MAX(idx) FROM main.plst_item WHERE plst_id = ? ");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, " SELECT MAX(idx) FROM db2.plst_item WHERE plst_id = ? ");
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        idx = sqlite3_column_kal_uint32(stmt, 0) + 1;
    }
    else
    {
        idx = 1;
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
      
    if(!list_view->is_mark)
    { 
        if(view_type == SRV_PLST_VIEW_MEDIA ||
           view_type == SRV_PLST_VIEW_AUDIO ||
           (list_view->current_index >= 2 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH &&
            (list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_AUDIO ||list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_MEDIA)))
        {
            if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA)
            {
                if(list_view->list_cache[1].parent_id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ? ", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ? ", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, input_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    media_id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return SRV_PLST_RET_ERR_UNKOWN_ERR;
                }
            }
            else
            {
                media_id = input_id;
            }
            ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
            if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?)");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?)");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, media_id);
            sqlite3_bind_kal_uint32(stmt, 2, id);
            sqlite3_bind_kal_uint32(stmt, 3, idx);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            base->plstitem_count++;
            if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
            {
                ret = SRV_PLST_RET_PLST_FULL;
            }
            return ret;       
        }
        else if((list_view->current_index == 1 && /* general add */
                 (view_type == SRV_PLST_VIEW_ARTIST || view_type == SRV_PLST_VIEW_ALBUM  || view_type == SRV_PLST_VIEW_GENRE)) ||
                (list_view->current_index == 2 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH &&  /* prefix search add */
                 (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || list_view->view_type[0] == SRV_PLST_VIEW_GENRE)))
        {  
            S32 ret1 = SRV_PLST_OK;
            const S8* ptr;
            sqlite3_stmt* stmt_t;
            srv_plst_view_type_enum switch_view;

            if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
            {
                switch_view = list_view->view_type[0];
            }
            else
            {
                switch_view = view_type;
            }

            if(switch_view == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(switch_view == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else
            {
                ptr = Sqlgenreid;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                switch (switch_view)
                {
                    case SRV_PLST_VIEW_ARTIST:
                    case SRV_PLST_VIEW_ALBUM:
                    case SRV_PLST_VIEW_GENRE:
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s ORDER BY ischar DESC, p_name DESC, media_id DESC) UNION \
SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s ORDER BY ischar DESC, p_name DESC, media_id DESC)) ORDER BY ischar DESC, p_name DESC, media_id DESC", ptr, ptr);
                            }
                            else
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s ORDER BY name DESC, media_id DESC) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s ORDER BY name DESC, media_id DESC)) ORDER BY name DESC, media_id DESC", ptr, ptr);
                            }
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id FROM main.audio WHERE %s ORDER BY media_id) UNION \
SELECT * FROM (SELECT media_id FROM db2.audio WHERE %s ORDER BY media_id)) ORDER BY media_id", ptr, ptr);
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                        break;
                    default: 
                        break;
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                switch (switch_view)
                {
                    case SRV_PLST_VIEW_ARTIST:
                    case SRV_PLST_VIEW_ALBUM:
                    case SRV_PLST_VIEW_GENRE:
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s ORDER BY ischar desc, p_name desc, media_id desc", ptr);
                            }
                            else
                            {
                                kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s ORDER BY name desc, media_id desc", ptr);
                            }
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s ORDER BY media_id", ptr);
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                        break;
                    default: 
                        break;
                }
            }

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, input_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, input_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, " INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret1 = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret1 != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret1;
                }                
                while(ret == SRV_PLST_RET_ITEM_EXIST && ret1 == SRV_PLST_OK)
                {
                    if(list_view->is_add_cancel)
                    {
                        break;
                    }
                    media_id = sqlite3_column_kal_uint32(stmt, 0);
                    ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {   pls_sql_finalize(stmt);
                        pls_sql_finalize(stmt_t);
                        return ret;
                    }
                    sqlite3_reset(stmt_t);
                    sqlite3_bind_kal_uint32(stmt_t, 1, media_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, id);
                    sqlite3_bind_kal_uint32(stmt_t, 3, idx);
                    ret1 = pls_sql_step_ex(db, stmt_t);
                    if(ret1 == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        pls_sql_finalize(stmt_t);
                        pls_sql_finalize(stmt);
                        return ret1;
                    }
                    base->plstitem_count++;
                    if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
                    {
                        ret1 = SRV_PLST_RET_PLST_FULL;
                        pls_sql_finalize(stmt_t);
                        pls_sql_finalize(stmt);
                        return ret1;                            
                    }
                    idx ++;
                    ret = pls_sql_step_ex(db, stmt);
                }
                pls_sql_finalize(stmt_t);
            }
            pls_sql_finalize(stmt); 
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {   
                return ret;
            }
            else if(ret1 < SRV_PLST_OK)
            {
                return ret1;
            }
            else 
            {
                ret = SRV_PLST_OK;
            }
            return ret;
        }
        else if ((list_view->current_index == 2 && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && view_type == SRV_PLST_VIEW_ALBUM) ||
                 (list_view->current_index == 3 && view_type == SRV_PLST_VIEW_PREFIX_SEARCH &&
                  list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM))
        {
            U32 artist_id;
            S32 ret1 = SRV_PLST_OK;
            sqlite3_stmt* stmt_t;
            list_cache = &(list_view->list_cache[1]);
            artist_id = list_cache->parent_id;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE artist_id = ? and album_id = ? \
ORDER BY ischar desc, p_name desc, media_id desc) UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE artist_id = ? AND album_id = ? \
ORDER BY ischar desc, p_name desc, media_id desc)) order by ischar desc, p_name desc, media_id desc");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? and album_id = ? \
ORDER BY name desc, media_id desc) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? \
ORDER BY name desc, media_id desc)) order by name desc, media_id desc");
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
//bql: MAUI_02986068
//design change side effect, lack of consider the database in memory card while add artist->album to playlist
//change to consider db2.audio data.
                    sprintf(db->sql_cmd, 
"SELECT * FROM \
( \
SELECT * FROM (SELECT media_id FROM main.audio WHERE artist_id = ? and album_id = ? ORDER BY media_id) \
UNION \
SELECT * FROM (SELECT media_id FROM db2.audio WHERE artist_id = ? and album_id = ? ORDER BY media_id) \
)ORDER BY media_id");
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? and album_id = ? ORDER BY ischar desc, p_name desc, media_id desc");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? and album_id = ? ORDER BY name desc, media_id desc");
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? and album_id = ? ORDER BY media_id");
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, artist_id);
            sqlite3_bind_kal_uint32(stmt, 2, input_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, artist_id);
                sqlite3_bind_kal_uint32(stmt, 4, input_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(id > 0X8000)
                {
                    sprintf(db->sql_cmd, "INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret1 = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret1 != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret1;
                }
                while(ret == SRV_PLST_RET_ITEM_EXIST && ret1 == SRV_PLST_OK)
                {
                    if(list_view->is_add_cancel)
                    {
                        break;
                    }
                    media_id = sqlite3_column_kal_uint32(stmt, 0);
                    ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {   pls_sql_finalize(stmt);
                        pls_sql_finalize(stmt_t);
                        return ret;
                    }
                    sqlite3_reset(stmt_t);
                    sqlite3_bind_kal_uint32(stmt_t, 1, media_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, id);
                    sqlite3_bind_kal_uint32(stmt_t, 3, idx);
                    ret1 = pls_sql_step_ex(db, stmt_t);
                    if(ret1 == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        pls_sql_finalize(stmt_t);
                        pls_sql_finalize(stmt);
                        return ret1;
                    }
                    base->plstitem_count++;
                    if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
                    {
                        ret1 = SRV_PLST_RET_PLST_FULL;
                        pls_sql_finalize(stmt_t);
                        pls_sql_finalize(stmt);
                        return ret1;                            
                    }
                    idx++;
                    ret = pls_sql_step_ex(db, stmt);
                }
                pls_sql_finalize(stmt_t);
            }
            pls_sql_finalize(stmt);
            if((ret == SRV_PLST_RET_ERR_SQLITE_ERR) ||(ret1 == SRV_PLST_RET_ERR_SQLITE_ERR))
            {   
                return SRV_PLST_RET_ERR_SQLITE_ERR;
            }
            else if(ret1 < SRV_PLST_OK)
            {
                return ret1;
            }
            else 
            {
                ret = SRV_PLST_OK;
            }            
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_SQLITE_ERR;
            return ret;
        }
    }    
    else if(list_view->is_mark)
    {
        U32 plstitem_id = 0;
        UI_character_type name[SRV_PLST_META_INFO_MAX_LEN + 1];
        U16 ischar = 1;

        name[0] = 0;
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(list_view->added_id > 0X8000 || !list_view->added_id )
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(list_view->added_id > 0X8000 || !list_view->added_id)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT name FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                {
                    mmi_ucs2ncpy((S8*) name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    ischar = sqlite3_column_kal_uint16(stmt, 1);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                /* find max name */
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM(SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio ORDER by ischar desc, p_name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio ORDER BY ischar desc, p_name desc, media_id limit 1 )) order by ischar desc, p_name desc, media_id limit 1");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio ORDER by ischar desc, p_name desc, media_id limit 1");
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM(SELECT * FROM (SELECT media_id, name FROM main.audio ORDER by name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio ORDER BY name desc, media_id limit 1 )) order by name desc, media_id limit 1");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio ORDER by name desc, media_id limit 1");
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*) name, (const S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
                    }
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        ischar = sqlite3_column_kal_uint16(stmt, 2);
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;                    
                }
            }
        }
        
        do
        {
            if(list_view->is_add_cancel)
            {
                break;
            }
            if (list_view->is_mark_all && !list_view->is_unmark_all)
            {
                if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                    (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                    (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name = ? and media_id > ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1) UNION ");
                                strcat(db->sql_cmd," SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND \
media_id > ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar DESC, p_name DESC, media_id limit 1)) ORDER BY ischar desc, p_name DESC, media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                // MAUI_02954256
                                //Forget to revise for phone storage only condition for COSMOS PINYIN sort!
                                //Modify for find the same pname, find the same is_char, find the diff
                                //W1112MP also exist this issue!!
                                sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE ischar = ? AND p_name = ? AND media_id > ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ");
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND media_id > ? AND \
media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) UNION ");
                                strcat(db->sql_cmd," SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND media_id > ? AND media_id not in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                sprintf(db->sql_cmd,"SELECT media_id, name FROM main.audio WHERE name = ? AND media_id > ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1 ");
                            }
                        }
                    }
                #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id FROM main.audio WHERE media_id > ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1) UNION ");
                            strcat(db->sql_cmd," SELECT * FROM (SELECT media_id FROM db2.audio WHERE media_id > ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1)) ORDER BY media_id limit 1");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE media_id > ? AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY media_id limit 1 ");
                        }    
                    }
                #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                }
                else if((list_view->current_index == 2 && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || 
                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE ))|| /* add to playlist */
                    (list_view->current_index == 3 && list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                    (list_view->view_type[2] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_GENRE) &&
                    list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)) /* add from sort type */
                {
                    const S8* ptr;
                    srv_plst_view_type_enum view_type_temp;

                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;
                    }
                    else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else
                    {
                        ptr = Sqlgenreid;
                    }

                    if(list_view->view_type[0] != SRV_PLST_VIEW_PLST)
                    {
                        view_type_temp = list_view->view_type[0];
                    }
                    else
                    {
                        view_type_temp = list_view->view_type[2];
                    }
                    switch(view_type_temp)
                    {
                        case SRV_PLST_VIEW_ARTIST:
                        case SRV_PLST_VIEW_ALBUM:
                        case SRV_PLST_VIEW_GENRE:
                            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                            {
                                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                                {
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? \
AND p_name = ? AND media_id > ? and %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name = ? AND media_id > ? AND %s AND media_id not in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                                    }
                                    else
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name = ? AND media_id > ? AND %s AND \
media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ", ptr);
                                    }
                                }
                                else
                                {
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND \
media_id > ? and %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name = ? AND media_id > ? AND %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) \
ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1", ptr, ptr);
                                    }
                                    else
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name = ? AND media_id > ? AND %s AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1 ", ptr);
                                    }
                                }
                            }
                        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                            else
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id FROM main.audio WHERE media_id > ? and %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1) \
UNION SELECT * FROM (SELECT media_id from db2.audio WHERE media_id > ? AND %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1)) ORDER BY media_id limit 1", ptr, ptr);
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE media_id > ? AND %s AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY media_id limit 1 ", ptr);
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                            break;                     
                        default :
                            break;                            
                    }

                }
                else if((list_view->view_type[1] == SRV_PLST_VIEW_PLST_ADDTO&&
                (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                list_view->view_type[0] == SRV_PLST_VIEW_GENRE)) ||
                list_view->view_type[2] == SRV_PLST_VIEW_PLST_ADDTO && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST &&
                list_view->view_type[1] == SRV_PLST_VIEW_ALBUM) /* mark several artist */
                {
                    ret = pls_sql_add_mark_sort_type_to_plst(db, input_id, idx, id);
                    break;
                }
                else if((list_view->current_index == 3 && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA &&
                    list_view->view_type[1] == SRV_PLST_VIEW_ALBUM && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST) ||
                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM &&
                list_view->view_type[3] == SRV_PLST_VIEW_PLST_ADDTO))
                {
                    if(list_view->current_index == 2)
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name = ? AND media_id > ? AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc ,media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name = ? AND \
media_id > ? AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name = ? AND media_id > ? AND artist_id = ? AND album_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                            }
                            else
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND media_id > ? \
AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name = ? AND media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name = ? AND media_id > ? AND \
artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name = ? AND media_id > ? AND artist_id = ? AND album_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1");
                                }
                            }
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id FROM main.audio WHERE media_id > ? AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1) ");
                                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id from db2.audio WHERE media_id > ? AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1)) ORDER BY media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE media_id > ? AND artist_id = ? AND album_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY media_id limit 1");
                            }
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                    else
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name = ? AND media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name = ? \
AND media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name = ? AND media_id > ? AND artist_id = ? AND album_id = ? \
AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                            }
                            else
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND media_id > ? AND \
artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name = ? AND media_id > ? AND artist_id = ? AND \
album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name = ? AND media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1");
                                }
                            }
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id FROM main.audio WHERE media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1) ");
                                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY media_id limit 1)) ORDER BY media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE media_id > ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY media_id limit 1");
                            }
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                }
            }
            else /* two case: unmark all and not mark/unmark all*/
            {
                if((list_view->view_type[1] == SRV_PLST_VIEW_PLST_ADDTO &&
                (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                list_view->view_type[0] == SRV_PLST_VIEW_GENRE)) ||
                (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM &&
                list_view->view_type[2] == SRV_PLST_VIEW_PLST_ADDTO)) /* mark several artist */
                {
                    ret = pls_sql_add_mark_sort_type_to_plst(db, input_id, idx, id);
                    break;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar from main.audio WHERE media_id in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) order by ischar desc, p_name desc, media_id desc limit 5) UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio \
WHERE media_id in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by ischar desc, p_name desc, media_id desc limit 5)) order by ischar desc, p_name desc, media_id desc limit 5");
                        }
                        else
                        {
                            sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name from main.audio WHERE media_id in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) order by name desc, media_id desc limit 5) UNION SELECT * FROM (SELECT media_id, name from db2.audio \
WHERE media_id in (SELECT id FROM db2.mark WHERE mark_flag = 1) order by name desc, media_id desc limit 5)) order by name desc, media_id desc limit 5");
                        }
                    }
                #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                    else
                    {
                        sprintf(db->sql_cmd,"SELECT id FROM db2.mark WHERE mark_flag = 1");
                    }
                #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE media_id in (SELECT id FROM main.mark WHERE mark_flag = 1) order by ischar desc, name desc, media_id desc limit 5");
                        }
                        else
                        {
                            sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE media_id in (SELECT id FROM main.mark WHERE mark_flag = 1) order by name desc, media_id desc limit 5");
                        }
                    }
                #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                    else
                    {
                        sprintf(db->sql_cmd,"SELECT id FROM main.mark WHERE mark_flag = 1");
                    }
                #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if (list_view->is_mark_all && list_view->current_index >= 1)
            {
                U32 parent_id1, parent_id2 = 0;

                if(list_view->view_type[0] != SRV_PLST_VIEW_PLST) /* add to playlist */
                {
                    list_cache = &(list_view->list_cache[1]);
                    parent_id1 = list_cache->parent_id;
                    if(list_view->current_index == 3)
                    {
                        list_cache = &(list_view->list_cache[2]);
                        parent_id2 = list_cache->parent_id;
                    }
                    else
                    {
                        parent_id2 = 0;
                    }
                }
                else /* add from sort type */
                {                    
                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        parent_id1 = list_view->list_cache[list_view->current_index - 1].parent_id;    
                    }
                    else
                    {
                        parent_id1 = list_view->list_cache[list_view->current_index].parent_id;
                    }
                }
                
                if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                    (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                    (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                            sqlite3_bind_kal_wstr(stmt, 2, name);
                            sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_uint16(stmt, 4, ischar);
                                sqlite3_bind_kal_wstr(stmt, 5, name);
                                sqlite3_bind_kal_uint32(stmt, 6, list_view->added_id);
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                        else
                        {
                            sqlite3_bind_kal_wstr(stmt, 1, name);
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_wstr(stmt, 3, name);
                                sqlite3_bind_kal_uint32(stmt, 4, list_view->added_id);
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */ 
                        }
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
                else if((list_view->current_index == 2 && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO )||
                    (list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO))
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                            sqlite3_bind_kal_wstr(stmt, 2, name);
                            sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 4, parent_id1);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_uint16(stmt, 5, ischar);
                                sqlite3_bind_kal_wstr(stmt, 6, name);
                                sqlite3_bind_kal_uint32(stmt, 7, list_view->added_id);
                                sqlite3_bind_kal_uint32(stmt, 8, parent_id1);
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                        else
                        {
                            sqlite3_bind_kal_wstr(stmt, 1, name);
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 3, parent_id1);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_wstr(stmt, 4, name);
                                sqlite3_bind_kal_uint32(stmt, 5, list_view->added_id);
                                sqlite3_bind_kal_uint32(stmt, 6, parent_id1);
                            }
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 4, parent_id1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
                else 
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                            sqlite3_bind_kal_wstr(stmt, 2, name);
                            sqlite3_bind_kal_uint32(stmt, 3, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 4, parent_id1);
                            sqlite3_bind_kal_uint32(stmt, 5, parent_id2);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_uint16(stmt, 6, ischar);
                                sqlite3_bind_kal_wstr(stmt, 7, name);
                                sqlite3_bind_kal_uint32(stmt, 8, list_view->added_id);
                                sqlite3_bind_kal_uint32(stmt, 9, parent_id1);
                                sqlite3_bind_kal_uint32(stmt, 10, parent_id2);
                            }    
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                        else
                        {
                            sqlite3_bind_kal_wstr(stmt, 1, name);
                            sqlite3_bind_kal_uint32(stmt, 2, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 3, parent_id1);
                            sqlite3_bind_kal_uint32(stmt, 4, parent_id2);
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sqlite3_bind_kal_wstr(stmt, 5, name);
                                sqlite3_bind_kal_uint32(stmt, 6, list_view->added_id);
                                sqlite3_bind_kal_uint32(stmt, 7, parent_id1);
                                sqlite3_bind_kal_uint32(stmt, 8, parent_id2);
                            }  
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        }
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, list_view->added_id);
                        sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                        sqlite3_bind_kal_uint32(stmt, 3, parent_id2);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, list_view->added_id);
                            sqlite3_bind_kal_uint32(stmt, 5, parent_id1);
                            sqlite3_bind_kal_uint32(stmt, 6, parent_id2);
                        }    
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }
                }
            }
            ret = pls_sql_step_ex(db, stmt);        
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                list_view->added_id = media_id;
                if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] == SRV_PLST_VIEW_PLST)
                {
                    plstitem_id = sqlite3_column_kal_uint32(stmt, 1);
                }  
                pls_sql_finalize(stmt);
            }
            else 
            {
                pls_sql_finalize(stmt);

                /* add new part for plst sort by modify time */
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME && list_view->is_mark_all && !list_view->is_unmark_all) /* check name and ischar part */
                {                    
                    if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                        (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                        (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                    {                           
                        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name < ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1) UNION ");
                                strcat(db->sql_cmd," SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name < ? AND \
media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar DESC, p_name DESC, media_id limit 1)) ORDER BY ischar desc, p_name DESC, media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                //MAUI_02954256
                                //Forget to revise for phone storage only condition for COSMOS PINYIN sort!
                                //Modify for find the same pname, find the same is_char, find the diff
                                //W1112MP also exist this issue!!
                                sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE ischar = ? AND p_name < ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ");
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND \
media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) UNION ");
                                strcat(db->sql_cmd," SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name < ? AND media_id not in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                sprintf(db->sql_cmd,"SELECT media_id, name FROM main.audio WHERE name < ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1 ");
                            }
                        }
                    }
                    else if((list_view->current_index == 2 && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                        (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || 
                        list_view->view_type[0] == SRV_PLST_VIEW_GENRE ))|| /* add to playlist */
                        (list_view->current_index == 3 && list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                        (list_view->view_type[2] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_GENRE) &&
                        list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)) /* add from sort type */
                    {
                        const S8* ptr;
                        srv_plst_view_type_enum view_type_temp;

                        if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ARTIST)
                        {
                            ptr = Sqlartistid;
                        }
                        else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM)
                        {
                            ptr = Sqlalbumid;
                        }
                        else
                        {
                            ptr = Sqlgenreid;
                        }

                        if(list_view->view_type[0] != SRV_PLST_VIEW_PLST)
                        {
                            view_type_temp = list_view->view_type[0];
                        }
                        else
                        {
                            view_type_temp = list_view->view_type[2];
                        }
                        switch(view_type_temp)
                        {
                            case SRV_PLST_VIEW_ARTIST:
                            case SRV_PLST_VIEW_ALBUM:
                            case SRV_PLST_VIEW_GENRE:                                    
                                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                                {
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? \
AND p_name < ? and %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name < ? AND %s AND media_id not in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                                    }
                                    else
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name < ? AND %s AND \
media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ", ptr);
                                    }
                                }
                                else
                                {
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND \
%s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name < ? AND %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) \
ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1", ptr, ptr);
                                    }
                                    else
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                    {
                                        kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name < ? AND %s AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1 ", ptr);
                                    }
                                }                                 
                                
                                break;                     
                            default :
                                break;                            
                        }

                    }                        
                    else if((list_view->current_index == 3 && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA &&
                        list_view->view_type[1] == SRV_PLST_VIEW_ALBUM && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST) ||
                        (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM &&
                    list_view->view_type[3] == SRV_PLST_VIEW_PLST_ADDTO))
                    {
                        if(list_view->current_index == 2)
                        {                               
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name < ? AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc ,media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name < ? AND \
artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name < ? AND artist_id = ? AND album_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                            }
                            else
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? \
AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name < ? AND \
artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name < ? AND artist_id = ? AND album_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1");
                                }
                            }
                        }
                        else
                        {
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND \
p_name < ? AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar = ? AND p_name < ? \
AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar = ? AND p_name < ? AND artist_id = ? AND album_id = ? \
AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                }
                            }
                            else
                            {
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name < ? AND \
artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1) ");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name from db2.audio WHERE name < ? AND artist_id = ? AND \
album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1)) ORDER BY name desc, media_id limit 1");
                                }
                                else
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                {
                                    sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE name < ? AND artist_id = ? AND album_id = ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY name desc, media_id limit 1");
                                }
                            }
                        }
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    if (list_view->is_mark_all && list_view->current_index >= 1)
                    { 
                        U32 parent_id1, parent_id2 = 0;

                        if(list_view->view_type[0] != SRV_PLST_VIEW_PLST) /* add to playlist */
                        {
                            list_cache = &(list_view->list_cache[1]);
                            parent_id1 = list_cache->parent_id;
                            if(list_view->current_index == 3)
                            {
                                list_cache = &(list_view->list_cache[2]);
                                parent_id2 = list_cache->parent_id;
                            }
                            else
                            {
                                parent_id2 = 0;
                            }
                        }
                        else /* add from sort type */
                        {                    
                            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                            {
                                parent_id1 = list_view->list_cache[list_view->current_index - 1].parent_id;    
                            }
                            else
                            {
                                parent_id1 = list_view->list_cache[list_view->current_index].parent_id;
                            }
                        }
                        if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                            (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                            (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                            list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                        {                            
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                sqlite3_bind_kal_uint16(stmt, 1, ischar);
                                sqlite3_bind_kal_wstr(stmt, 2, name);                                
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_uint16(stmt, 3, ischar);
                                    sqlite3_bind_kal_wstr(stmt, 4, name);
                                }
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }
                            else
                            {
                                sqlite3_bind_kal_wstr(stmt, 1, name);
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_wstr(stmt, 2, name);
                                }
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }
                        }
                        else if((list_view->current_index == 2 && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO )||
                            (list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO))
                        {                            
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                sqlite3_bind_kal_uint16(stmt, 1, ischar);
                                sqlite3_bind_kal_wstr(stmt, 2, name);                                
                                sqlite3_bind_kal_uint32(stmt, 3, parent_id1);
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_uint16(stmt, 4, ischar);
                                    sqlite3_bind_kal_wstr(stmt, 5, name);                                    
                                    sqlite3_bind_kal_uint32(stmt, 6, parent_id1);
                                }
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }
                            else
                            {
                                sqlite3_bind_kal_wstr(stmt, 1, name);
                                sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_wstr(stmt, 3, name);
                                    sqlite3_bind_kal_uint32(stmt, 4, parent_id1);
                                }
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }                                                      
                        }
                        else 
                        {                            
                            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                            {
                                sqlite3_bind_kal_uint16(stmt, 1, ischar);
                                sqlite3_bind_kal_wstr(stmt, 2, name);
                                sqlite3_bind_kal_uint32(stmt, 3, parent_id1);
                                sqlite3_bind_kal_uint32(stmt, 4, parent_id2);
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_uint16(stmt, 5, ischar);
                                    sqlite3_bind_kal_wstr(stmt, 6, name);
                                    sqlite3_bind_kal_uint32(stmt, 7, parent_id1);
                                    sqlite3_bind_kal_uint32(stmt, 8, parent_id2);
                                }
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }
                            else
                            {
                                sqlite3_bind_kal_wstr(stmt, 1, name);
                                sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                                sqlite3_bind_kal_uint32(stmt, 3, parent_id2);
                            #if defined(__PLST_DUAL_DB_SUPPORT__)
                                if(IS_CARD_EXIST)
                                {
                                    sqlite3_bind_kal_wstr(stmt, 4, name);
                                    sqlite3_bind_kal_uint32(stmt, 5, parent_id1);
                                    sqlite3_bind_kal_uint32(stmt, 6, parent_id2);
                                }  
                            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            }                            
                        }
                    }
                    ret = pls_sql_step_ex(db, stmt);        
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        media_id = sqlite3_column_kal_uint32(stmt, 0);
                        list_view->added_id = media_id;
                        if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] == SRV_PLST_VIEW_PLST)
                        {
                            plstitem_id = sqlite3_column_kal_uint32(stmt, 1);
                        }  
                        pls_sql_finalize(stmt);
                    }
                    else
                    {
                        pls_sql_finalize(stmt);

                        /* add new part for plst sort by modify time */
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME &&
                            base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN &&
                            list_view->is_mark_all && !list_view->is_unmark_all) /* check name and ischar part */
                        {
                            if (list_view->is_mark_all && !list_view->is_unmark_all)
                            {
                                if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                                    (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                                    (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                                {
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar < ? \
AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1) UNION ");
                                        strcat(db->sql_cmd," SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar < ? AND \
media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar DESC, p_name DESC, media_id limit 1)) ORDER BY ischar desc, p_name DESC, media_id limit 1");
                                    }
                                    else
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                    {
                                        //MAUI_02954256
                                        //Forget to revise for phone storage only condition for COSMOS PINYIN sort!
                                        //Modify for find the same pname, find the same is_char, find the diff
                                        //W1112MP also exist this issue!!
                                        sprintf(db->sql_cmd,"SELECT media_id FROM main.audio WHERE ischar < ? AND media_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ");
                                    }
                                }
                                else if((list_view->current_index == 2 && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || 
                                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE ))|| /* add to playlist */
                                    (list_view->current_index == 3 && list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
                                    (list_view->view_type[2] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_GENRE) &&
                                    list_view->view_type[3] == SRV_PLST_VIEW_MEDIA)) /* add from sort type */
                                {
                                    const S8* ptr;
                                    srv_plst_view_type_enum view_type_temp;

                                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[2] == SRV_PLST_VIEW_ARTIST)
                                    {
                                        ptr = Sqlartistid;
                                    }
                                    else if(list_view->view_type[0] == SRV_PLST_VIEW_ALBUM || list_view->view_type[2] == SRV_PLST_VIEW_ALBUM)
                                    {
                                        ptr = Sqlalbumid;
                                    }
                                    else
                                    {
                                        ptr = Sqlgenreid;
                                    }

                                    if(list_view->view_type[0] != SRV_PLST_VIEW_PLST)
                                    {
                                        view_type_temp = list_view->view_type[0];
                                    }
                                    else
                                    {
                                        view_type_temp = list_view->view_type[2];
                                    }
                                    switch(view_type_temp)
                                    {
                                        case SRV_PLST_VIEW_ARTIST:
                                        case SRV_PLST_VIEW_ALBUM:
                                        case SRV_PLST_VIEW_GENRE: 

                                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                                            if(IS_CARD_EXIST)
                                            {
                                                kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar < ? \
and %s AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar < ? AND %s AND media_id not in \
(SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1", ptr, ptr);
                                            }
                                            else
                                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                            {
                                                kal_sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar < ? AND %s AND \
media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1 ", ptr);
                                            }
                                            break;                     
                                        default :
                                            break;                            
                                    }

                                }                        
                                else if((list_view->current_index == 3 && list_view->view_type[2] == SRV_PLST_VIEW_MEDIA &&
                                    list_view->view_type[1] == SRV_PLST_VIEW_ALBUM && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST) ||
                                    (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM &&
                                list_view->view_type[3] == SRV_PLST_VIEW_PLST_ADDTO))
                                {
                                    if(list_view->current_index == 2)
                                    {                               
                                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                                        if(IS_CARD_EXIST)
                                        {
                                            sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar < ? \
AND artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc ,media_id limit 1) ");
                                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar < ? AND \
artist_id = ? AND album_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc,media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                        }
                                        else
                                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                        {
                                            sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar < ? AND artist_id = ? AND album_id not in \
(SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                        }
                                    }
                                    else
                                    {                                        
                                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                                        if(IS_CARD_EXIST)
                                        {
                                            sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar < ? \
AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1) ");
                                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, p_name, ischar from db2.audio WHERE ischar < ? \
AND artist_id = ? AND album_id = ? AND media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1)) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                        }
                                        else
                                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                        {
                                            sprintf(db->sql_cmd, "SELECT media_id FROM audio WHERE ischar < ? AND artist_id = ? AND album_id = ? \
AND media_id not in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY ischar desc, p_name desc, media_id limit 1");
                                        }                                        
                                    }
                                }
                            }
                            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                            if(ret != SRV_PLST_OK)
                            {
                                return ret;
                            }
                            if (list_view->is_mark_all && list_view->current_index >= 1)
                            { 
                                U32 parent_id1, parent_id2 = 0;

                                if(list_view->view_type[0] != SRV_PLST_VIEW_PLST) /* add to playlist */
                                {
                                    list_cache = &(list_view->list_cache[1]);
                                    parent_id1 = list_cache->parent_id;
                                    if(list_view->current_index == 3)
                                    {
                                        list_cache = &(list_view->list_cache[2]);
                                        parent_id2 = list_cache->parent_id;
                                    }
                                    else
                                    {
                                        parent_id2 = 0;
                                    }
                                }
                                else /* add from sort type */
                                {                    
                                    if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST && list_view->view_type[1] == SRV_PLST_VIEW_ALBUM)
                                    {
                                        parent_id1 = list_view->list_cache[list_view->current_index - 1].parent_id;    
                                    }
                                    else
                                    {
                                        parent_id1 = list_view->list_cache[list_view->current_index].parent_id;
                                    }
                                }
                                if(((list_view->current_index == 1 && list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) || 
                                    (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_AUDIO)) ||
                                    (list_view->current_index == 1 && (list_view->view_type[0] == SRV_PLST_VIEW_ARTIST || list_view->view_type[0] == SRV_PLST_VIEW_ALBUM ||
                                    list_view->view_type[0] == SRV_PLST_VIEW_GENRE) && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA))
                                {                            
                                    sqlite3_bind_kal_uint16(stmt, 1, ischar);                          
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        sqlite3_bind_kal_uint16(stmt, 2, ischar);
                                    }
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                }
                                else if((list_view->current_index == 2 && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO )||
                                    (list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] != SRV_PLST_VIEW_AUDIO))
                                {                            
                                    sqlite3_bind_kal_uint16(stmt, 1, ischar);                          
                                    sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        sqlite3_bind_kal_uint16(stmt, 3, ischar);                              
                                        sqlite3_bind_kal_uint32(stmt, 4, parent_id1);
                                    }                                               
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                }
                                else 
                                { 
                                    sqlite3_bind_kal_uint16(stmt, 1, ischar);
                                    sqlite3_bind_kal_uint32(stmt, 2, parent_id1);
                                    sqlite3_bind_kal_uint32(stmt, 3, parent_id2);
                                #if defined(__PLST_DUAL_DB_SUPPORT__)
                                    if(IS_CARD_EXIST)
                                    {
                                        sqlite3_bind_kal_uint16(stmt, 4, ischar);
                                        sqlite3_bind_kal_uint32(stmt, 5, parent_id1);
                                        sqlite3_bind_kal_uint32(stmt, 6, parent_id2);
                                    }                                  
                                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                                }
                            }
                            ret = pls_sql_step_ex(db, stmt);        
                            if(ret == SRV_PLST_RET_ITEM_EXIST)
                            {
                                media_id = sqlite3_column_kal_uint32(stmt, 0);
                                list_view->added_id = media_id;
                                if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] == SRV_PLST_VIEW_PLST)
                                {
                                    plstitem_id = sqlite3_column_kal_uint32(stmt, 1);
                                }  
                                pls_sql_finalize(stmt);
                            }
                            else
                            {
                                pls_sql_finalize(stmt);
                                break;
                            }
                        }
                        else
                        {                            
                            break;
                        }
                    }
                }
                else
                {
                    break;
                }
            }
            ret = pls_sql_util_check_item_if_exist_in_plst(db, list_view->is_media_in_plst_unique, media_id, id);
            if(ret == SRV_PLST_RET_ITEM_EXIST || ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, " INSERT INTO main.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " INSERT INTO db2.plst_item(media_id, plst_id, idx) VALUES (?,?,?) ");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, media_id);
            sqlite3_bind_kal_uint32(stmt, 2, id);
            sqlite3_bind_kal_uint32(stmt, 3, idx);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                count++;
                idx++;
            }
            else
            {                
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_ADD_MEDIA_TO_PLST, ret,  media_id, id, idx, __LINE__);
                break;
            }
            (base->plstitem_count)++;
            if(base->plstitem_count >= SRV_PLST_MAX_PLST_ITEM)
            {             
                ret = SRV_PLST_RET_PLST_FULL;
                break;                    
            }
            if (list_view->is_add_cancel)
            {             
                ret = SRV_PLST_OK;
                break;
            }            

            if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[2] == SRV_PLST_VIEW_PLST)
            {
                media_id = plstitem_id;
            }

            if(list_view->is_mark_all)
            {
              /* do nothing */
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {   
                    sprintf(db->sql_cmd, " DELETE FROM db2.mark WHERE id = ? ");                   
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, " DELETE FROM main.mark WHERE id = ? ");   
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, media_id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }
            }
            if (count == SRV_PLST_MAX_SLIDE_NUM/SRV_PLST_MAX_SLIDE_NUM)
            {            
                ret = SRV_PLST_RET_CONTINUE;
                break;
            }
        }while(1); /* end while */

        if(ret == SRV_PLST_OK || ret == SRV_PLST_RET_PLST_FULL || list_view->is_add_cancel) /* finished, delete table */
        {
            PS8 error_msg = NULL;
            S32 ret_t;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret_t = sqlite3_exec(db->db, " DROP TABLE db2.mark ", NULL, 0, &error_msg);       
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                ret_t = sqlite3_exec(db->db, " DROP TABLE main.mark ", NULL, 0, &error_msg);
            }               
            if(ret_t > SQLITE_OK && ret_t < SQLITE_ROW)
            {
                ret = SRV_PLST_RET_ERR_SQLITE_ERR;
            }  
        }
        return ret; 
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_remove_item_from_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_remove_item_from_list(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 plst_id, U32 plstitem_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_playing_context_struct *playing_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    if(!list_view->is_mark)
    {
		//bql: MAUI_02938231
		//Error to compare plstitem_id only 
		//But should check the plst_id also
		//Because the plstitem_id maybe duplicate (not unique) for phone set list and memory card list
        if(playing_info->is_load &&
            (playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST ) && 
			(playing_info->current_picked_id == plstitem_id && playing_info->plst_id == plst_id)&& 
			playing_info->current_picked_id != playing_info->last_active_id)
        {
            playing_info->last_active_id = playing_info->current_picked_id;
            return SRV_PLST_RET_DELETE_ACTIVE;
        }
        if(plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "DELETE FROM main.plst_item WHERE plstitem_id = ? AND plst_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "DELETE FROM db2.plst_item WHERE plstitem_id = ? AND plst_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plstitem_id);
        sqlite3_bind_kal_uint32(stmt, 2, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if (ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        
        if(plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "UPDATE main.plst SET count = count - 1");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "UPDATE db2.plst SET count = count - 1");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        return ret;
    }
    else
    {
        U32 count = 0;
        if(list_view->is_mark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(plst_id > 0X8000)
                {               
                    sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id FROM plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM mark WHERE mark_flag = 1)");
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(plst_id > 0X8000)
                {               
                    sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT id FROM mark WHERE mark_flag = 1");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(list_view->is_mark_all)
        {
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;
            S32 ret_t = SRV_PLST_OK;
            sqlite3_stmt *stmt_t;

            count ++;
            
            if(list_view->is_cancel)
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_OK;
            }   
            if(count > SRV_PLST_SQL_OP_TIME)
            {
                pls_sql_finalize(stmt);
                list_view->prog_count += SRV_PLST_SQL_OP_TIME;
                ret = SRV_PLST_RET_CONTINUE;
                return ret;
            }            
            temp_id = sqlite3_column_kal_uint32(stmt, 0);
		//MAUI_02938231
		//Error to compare plstitem_id only 
		//But should check the plst_id also
		//Because the plstitem_id maybe duplicate (not unique) for phone set list and memory card list
            if(playing_info->is_load &&
                playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST && 
                (playing_info->current_picked_id == temp_id && playing_info->plst_id == plst_id)&& 
				playing_info->current_picked_id != playing_info->last_active_id)
            {
                playing_info->last_active_id = playing_info->current_picked_id;
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_DELETE_ACTIVE;
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(plst_id > 0X8000)
                {               
                    sprintf(db->sql_cmd, "DELETE FROM main.plst_item WHERE plstitem_id = ? ");
                }
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.plst_item WHERE plstitem_id = ?");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "DELETE FROM plst_item WHERE plstitem_id = ?");
            }
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
               pls_sql_finalize(stmt);
               return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, temp_id);
            ret_t = pls_sql_step_ex(db, stmt_t);            
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret_t;
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {              
                sprintf(db->sql_cmd, "DELETE FROM db2.mark WHERE id = ? ");   
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "DELETE FROM main.mark WHERE id = ?");
            }
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, temp_id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);               
            if(ret_t != SRV_PLST_OK)
            {
                pls_sql_finalize(stmt);
                return ret_t;
            }
            ret = pls_sql_step_ex(db, stmt);
        }
        pls_sql_finalize(stmt);
    }
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_clear_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_clear_plst(srv_plst_db_context_struct *db,U32 plst_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 count = 0;
    U32 min_id; 
    U32 max_id;
    U32 i;
    srv_plst_list_view_history_struct *list_view;
    const S8* ptr;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    if(plst_id > 0X8000)
    {
        ptr = Sqlmainplstitem;
    }
    else
    {
        ptr = Sqldbplstitem;
    }
    kal_sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM %s WHERE plst_id = ?", ptr);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        count = sqlite3_column_kal_uint32(stmt, 0);        
    }
    else
    {
        count = 0;
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    else
    {
        ret = SRV_PLST_OK;
    }
    
    for(i = 0; i <= (count/SRV_PLST_SQL_OP_TIME); i++)
    {

        U32 offset;

        if(i < count/ SRV_PLST_SQL_OP_TIME)
        {
            offset = SRV_PLST_SQL_OP_TIME;
        }
        else
        {
            offset = count - (i*SRV_PLST_SQL_OP_TIME);
        }

        if(list_view->is_delete_cancel)
        {
            return SRV_PLST_OK;
        }     
        kal_sprintf(db->sql_cmd, "SELECT MIN(plstitem_id) FROM %s WHERE plst_id = ?", ptr);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            min_id = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
        }
        else
        {
            min_id = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            break;
        }

        if(min_id == 0)
        {
            break;
        }

        kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM %s WHERE plst_id = ? ORDER BY plstitem_id limit 1 OFFSET ?", ptr);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, offset);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            max_id = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            max_id = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            break;
        }
        kal_sprintf(db->sql_cmd, "DELETE FROM %s WHERE plst_id = ? AND plstitem_id BETWEEN ? AND ?", ptr);
        ret = pls_sql_prepare_ex(db,  db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, min_id);
        sqlite3_bind_kal_uint32(stmt, 3, max_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

        kal_sprintf(db->sql_cmd, "SELECT media_id FROM %s WHERE plst_id = ?", ptr);
        ret = pls_sql_prepare_ex(db,  db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            return SRV_PLST_RET_CONTINUE;
        }
        if(list_view->is_cancel)
        {
            return ret;
        }
    }
    return ret;
}



/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_plst
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_delete_plst(srv_plst_db_context_struct *db,U32 *id)
{
   /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 count = 0;
    U32 min_id;
    U32 max_id;
    U32 i;
    U32 temp_OPTIME;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_playing_context_struct *playing_info;
    const S8* ptr;
    U32 plst_id = *id; // The play list id may change for multiple delete case, reutrn multiselect id
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);

    if(list_view->is_mark) /* mark several plst to delete */
    {
        if(list_view->is_mark_all && !list_view->is_unmark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT plst_id, plst_name FROM (SELECT * FROM (SELECT plst_id, plst_name FROM main.plst WHERE plst_name != \"\" AND plst_id NOT in (SELECT id from db2.mark WHERE mark_flag = 1)\
ORDER BY plst_name asc, plst_id asc limit 1) UNION SELECT * FROM (SELECT plst_id, plst_name FROM db2.plst WHERE plst_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1) \
ORDER BY plst_name asc, plst_id asc limit 1))ORDER BY plst_name asc, plst_id asc limit 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT Plst_id, plst_name FROM main.plst WHERE plst_name != \"\" AND plst_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1) ORDER BY plst_name asc, plst_id asc limit 1");
            }
        }
        else 
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1 order by id limit 1");
            }
            else 
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE mark_flag = 1 order by id limit 1");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            plst_id = sqlite3_column_kal_uint32(stmt, 0);
            *id = plst_id;
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else if(ret == SRV_PLST_OK)
        {
            PS8 error_msg;
            pls_sql_finalize(stmt);        
        
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret = sqlite3_exec(db->db, " DROP TABLE db2.mark ", NULL, 0, &error_msg);       
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                ret = sqlite3_exec(db->db, " DROP TABLE main.mark ", NULL, 0, &error_msg);
            }
            if(ret > SQLITE_OK && ret < SQLITE_ROW)
            {
                db->err_code = ret;
                return SRV_PLST_RET_ERR_SQLITE_ERR;
            }
            return SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    
    if(plst_id > 0X8000)
    {
        ptr = Sqlmainplstitem;
    }
    else
    {
        ptr = Sqldbplstitem;
    }
    kal_sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM %s WHERE plst_id = ?", ptr);
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, plst_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        count = sqlite3_column_kal_uint32(stmt, 0);        
    }
    else
    {
        count = 0;
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    else
    {
        ret = SRV_PLST_OK;
    }

    // MAUI_03079780, when total count is smaller than OP_TIME, delete 1 songs at a time
    if(count <= SRV_PLST_SQL_OP_TIME)
    {
        temp_OPTIME = 1;
    }
    else
    {
        temp_OPTIME = SRV_PLST_SQL_OP_TIME;
    }
    
    for(i = 0; (i <= (count/temp_OPTIME)) && count; i++)
    {

        U32 offset;

        if(i < count/ temp_OPTIME)
        {
            offset = temp_OPTIME;
        }
        else
        {
            offset = count - (i*temp_OPTIME);
        }
        
        if(list_view->is_delete_cancel)
        {
            return SRV_PLST_OK;
        }     

        kal_sprintf(db->sql_cmd, "SELECT MIN(plstitem_id) FROM %s WHERE plst_id = ?", ptr);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            min_id = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
        }
        else
        {
            min_id = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            break;
        }

        if(min_id == 0)
        {
            break;
        }

        kal_sprintf(db->sql_cmd, "SELECT plstitem_id FROM %s WHERE plst_id = ? ORDER BY plstitem_id limit 1 OFFSET ?", ptr);
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, offset - 1);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            max_id = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            max_id = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            break;
        }
//bql: MAUI_02930685
//should check if current playing list is deleting or not
//if not we will allowed to delete the list
		if( (playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST && playing_info->plst_id == plst_id) &&
            playing_info->current_picked_id >= min_id && 
            playing_info->current_picked_id <= max_id &&  
          playing_info->last_active_id != playing_info->current_picked_id)
        {
             playing_info->last_active_id = playing_info->current_picked_id;
            return SRV_PLST_RET_DELETE_ACTIVE;
        }

        kal_sprintf(db->sql_cmd, "DELETE FROM %s WHERE plst_id = ? AND plstitem_id BETWEEN ? AND ?", ptr);
        ret = pls_sql_prepare_ex(db,  db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, min_id);
        sqlite3_bind_kal_uint32(stmt, 3, max_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        kal_sprintf(db->sql_cmd, "SELECT media_id FROM %s WHERE plst_id = ?", ptr);
        ret = pls_sql_prepare_ex(db,  db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            list_view->prog_count += offset;
            return SRV_PLST_RET_CONTINUE;
        }
        if(list_view->is_delete_cancel)
        {
            return SRV_PLST_OK;
        }
    }
    if(ret != SRV_PLST_OK)
    {
        return SRV_PLST_OK;
    }
    
    if(plst_id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst WHERE plst_id = ?", &stmt);
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        ret = pls_sql_prepare_ex(db, "DELETE FROM db2.plst WHERE plst_id = ?", &stmt);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, plst_id);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_OK && list_view->is_mark)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM db2.mark WHERE id = ?", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM main.mark WHERE id = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_CONTINUE;
        }
    }
    return ret;
}

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_video_by_video_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_delete_video_by_video_id(srv_plst_db_context_struct *db, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt_p;
    S32 ret = SRV_PLST_OK; 
    UI_character_type path[(SRV_FMGR_PATH_MAX_LEN+1) + 1];
    FS_HANDLE fs_hdr;
    srv_plst_playing_context_struct *playing_info;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    if(playing_info->is_load && 
        playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO&&
        playing_info->current_picked_id == id && playing_info->current_picked_id != playing_info->last_active_id)
    {
        playing_info->last_active_id = playing_info->current_picked_id;
        return SRV_PLST_RET_DELETE_ACTIVE;
    }
    path[0] = 0;
    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "SELECT path FROM main.video WHERE vdo_id = ?");
    }
    else
    {
        sprintf(db->sql_cmd, "SELECT path FROM db2.video WHERE vdo_id = ? ");
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt_p, 1, id);
    ret = pls_sql_step_ex(db, stmt_p);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt_p, 0)))
        {
            mmi_ucs2ncpy((S8*) path, (const S8*)sqlite3_column_kal_wstr(stmt_p, 0), SRV_FMGR_PATH_MAX_LEN);    
        }
        else
        {
            path[0] = 0;
        }
        ret = SRV_PLST_OK;
    }
    pls_sql_finalize(stmt_p);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }     
    
    if(base->is_refresh)
    {
        fs_hdr = FS_GetAttributes(path);

        if(fs_hdr >= FS_NO_ERROR)
        {       
            if(id > 0X8000)
            {
                ret = pls_sql_prepare_ex(db, " UPDATE main.video SET is_exist = ? WHERE vdo_id = ? ", &stmt_p);
            }
            else
            {
                ret = pls_sql_prepare_ex(db, " UPDATE db2.video SET is_exist = ? WHERE vdo_id = ? ", &stmt_p);
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_p, 1, db->Ucount);
            sqlite3_bind_kal_uint32(stmt_p, 2, id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);            
            return ret;
        }
    }  
    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "DELETE FROM main.video WHERE vdo_id = ?");
    }
    else
    {
        sprintf(db->sql_cmd, "DELETE FROM db2.video WHERE vdo_id = ?");
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt_p, 1, id);
    ret = pls_sql_step_ex(db, stmt_p);
    pls_sql_finalize(stmt_p);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    fs_hdr = FS_GetAttributes(path);

    if(fs_hdr >= FS_NO_ERROR)
    {    
        fs_hdr = FS_Delete((U16*)path);
        if(fs_hdr < FS_NO_ERROR)
        {
            ret = SRV_PLST_RET_ERR_FS_ERROR;
            base->error_code = ret;
            base->ture_err_code = fs_hdr;
        }
        else
        {
            ret = SRV_PLST_OK;
        }
    }
    return ret;
}
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_media_by_media_id
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
static S32 pls_sql_delete_media_by_media_id(srv_plst_db_context_struct *db, U32 media_id, U32 *count)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt_p;
    S32 ret = SRV_PLST_OK; 
    srv_plst_playing_context_struct *playing_info;
    UI_character_type path[SRV_FMGR_PATH_MAX_LEN + 1];
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    *count = 0;
    if( playing_info->is_load && (
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO || 
        #endif
        playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) &&
        playing_info->current_picked_id == media_id && playing_info->current_picked_id != playing_info->last_active_id)
    {
        playing_info->last_active_id = playing_info->current_picked_id;
        return SRV_PLST_RET_DELETE_ACTIVE;
    }
    else if (playing_info->is_load && (
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST || 
        #endif
        playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST) &&
        playing_info->current_picked_id != playing_info->last_active_id)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(playing_info->plst_id  <= 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT media_id from db2.plst_item WHERE plstitem_id = ?");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?");
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1 , playing_info->current_picked_id);
        ret = pls_sql_step_ex(db, stmt_p);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 temp_id;
            temp_id = sqlite3_column_kal_uint32(stmt_p, 0);
            ret = SRV_PLST_OK;
            if(temp_id == media_id)
            {
                pls_sql_finalize(stmt_p);
                playing_info->last_active_id = playing_info->current_picked_id;
                return SRV_PLST_RET_DELETE_ACTIVE;    
            }            
        }        
        pls_sql_finalize(stmt_p);
    }
    
    if(media_id > 0X8000)
    {
        sprintf(db->sql_cmd, "SELECT path FROM main.meta_slim WHERE media_id = ?");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, "SELECT path FROM db2.meta_slim WHERE media_id = ?");
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
    ret = pls_sql_step_ex(db, stmt_p);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*) sqlite3_column_kal_wstr(stmt_p, 0)))
        {
            mmi_ucs2ncpy((S8*)path, (const S8*) sqlite3_column_kal_wstr(stmt_p, 0), SRV_FMGR_PATH_MAX_LEN);
        }
        else
        {
            path[0] = 0;
        }
        ret = SRV_PLST_OK;
    }
    pls_sql_finalize(stmt_p);

    if(base->is_refresh) 
    {
    /*   MAUI_02444494
        FS_HANDLE fs_hdr;
        fs_hdr = FS_GetAttributes((U16*)path);
        if(fs_hdr >= FS_NO_ERROR)
        {
            if(media_id > 0X8000)
            {
                ret = pls_sql_prepare_ex(db, " UPDATE main.meta_slim SET is_exist = ? WHERE media_id = ? ", &stmt_p);
            }
            else
            {
                ret = pls_sql_prepare_ex(db, " UPDATE db2.meta_slim SET is_exist = ? WHERE media_id = ? ", &stmt_p);
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_p, 1, db->Ucount);
            sqlite3_bind_kal_uint32(stmt_p, 2, media_id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);
            return ret;       
        }
        */
    }
   
    ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE media_id = ? " , &stmt_p);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
    ret = pls_sql_step_ex(db, stmt_p);
    pls_sql_finalize(stmt_p);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst_item WHERE media_id = ? " , &stmt_p);
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        pls_sql_finalize(stmt_p);        
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        (*count)++;
    }
    else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }
    
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {        
        ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM db2.plst_item WHERE media_id = ? " , &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        pls_sql_finalize(stmt_p);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM db2.plst_item WHERE media_id = ?",&stmt_p);
            sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }  
            (*count)++;
        }
        else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        } 
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

   // if((*count) == 0)
    {
        FS_HANDLE fs_hdr;
        U32 artist_id = 0;
        U32 album_id = 0;
        U32 genre_id = 0;


        if(media_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT artist_id, album_id,genre_id FROM main.audio WHERE media_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT artist_id, album_id,genre_id FROM db2.audio WHERE media_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
           artist_id = sqlite3_column_kal_uint32(stmt_p, 0);
           album_id = sqlite3_column_kal_uint32(stmt_p, 1);
           genre_id = sqlite3_column_kal_uint32(stmt_p, 2);           
        }
        pls_sql_finalize(stmt_p);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(media_id > 0X8000)
        {
            sprintf(db->sql_cmd, "DELETE FROM main.audio WHERE media_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "DELETE FROM db2.audio WHERE media_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        pls_sql_finalize(stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = SRV_PLST_OK;
        /* check artist if need delete */       
        if(artist_id)
        {
            if(media_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? limit 1");             
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE artist_id = ? limit 1");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_p, 1, artist_id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            else if(ret == SRV_PLST_OK)
            {
                /*no other song delete artist */
                if(media_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, artist_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);                    
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && media_id <= 0X8000 )
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, artist_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }            
        }/* artist delete end */
        ret = SRV_PLST_OK;
        /* check album if need delete */
        if(album_id > 0)
        {
            if(media_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id = ? limit 1");            
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE album_id = ? limit 1");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_p, 1, album_id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            else if(ret == SRV_PLST_OK)
            {
                /*no other song delete album */
                if(media_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, album_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }

                    sprintf(db->sql_cmd, "DELETE FROM main.album_artwork WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, album_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
   
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && media_id <= 0X8000)
                {
                    sprintf(db->sql_cmd, " DELETE FROM db2.album WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, album_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }

                    sprintf(db->sql_cmd, " DELETE FROM db2.album_artwork WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, album_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }   
            ret = SRV_PLST_OK;
        }/*album delete end */
        
#ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
        /* check genre if need delete begin*/
        if(genre_id)
        {        
            if(media_id > 0X8000)
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE genre_id = ? limit 1");             
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM db2.audio WHERE genre_id = ? limit 1");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt_p, 1, genre_id);
            ret = pls_sql_step_ex(db, stmt_p);
            pls_sql_finalize(stmt_p);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            else if(ret == SRV_PLST_OK)
            {
                /*no other song delete genre */
                if(media_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.genre WHERE genre_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, genre_id);
                    ret = pls_sql_step_ex(db, stmt_p);
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
                
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && media_id <= 0X8000)
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.genre WHERE genre_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt_p, 1, genre_id);
                    ret = pls_sql_step_ex(db, stmt_p);                    
                    pls_sql_finalize(stmt_p);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            ret = SRV_PLST_OK;
        }/* genre delete end */
#endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

        if( media_id > 0X8000)
        {
            sprintf(db->sql_cmd, "DELETE FROM main.meta WHERE media_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "DELETE FROM db2.meta WHERE media_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        pls_sql_finalize(stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        if( media_id > 0X8000)
        {
            sprintf(db->sql_cmd, "DELETE FROM main.meta_slim WHERE media_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "DELETE FROM db2.meta_slim WHERE media_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt_p, 1, media_id);
        ret = pls_sql_step_ex(db, stmt_p);
        pls_sql_finalize(stmt_p);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->is_refresh == MMI_FALSE)
        {
        fs_hdr = FS_GetAttributes((U16*)path);
        if(fs_hdr >= FS_NO_ERROR)
        {
            fs_hdr = FS_Delete((U16*)path);
            if(fs_hdr < FS_NO_ERROR)
            {
                ret = SRV_PLST_RET_ERR_FS_ERROR;
                base->error_code = ret;
                base->ture_err_code = fs_hdr;
            }
            else
            {
                ret = SRV_PLST_OK;
            }
        } 
        }
    }/* end of count == 0 delete media_id item */  
    return ret; 
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_media_from_list_one_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_delete_media_from_list_one_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 id)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type; 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    view_type = list_view->view_type[list_view->current_index];

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(view_type == SRV_PLST_VIEW_VIDEO )
    {
        if(!list_view->is_mark)
        {
            ret = pls_sql_delete_video_by_video_id(db, id);
        }
        else if(list_view->is_mark_all && !list_view->is_unmark_all) /* get id when mark serval */
        {
            U32 count = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, " SELECT vdo_id FROM main.video WHERE vdo_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag  = 1)");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE vdo_id NOT in (SELECT id FROM db2.mark WHERE mark_flag  = 1)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT vdo_id FROM main.video WHERE vdo_id NOT IN (SELECT id FROM main.mark WHERE mark_flag  = 1)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_video_by_video_id(db, id);
                if(ret == SRV_PLST_OK)
                {
                    count++;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;            
        }
        else /* mark and unmark all*/
        {
            U32 count = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE id IN (SELECT vdo_id FROM main.video UNION SELECT vdo_id FROM db2.video) and mark_flag = 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE id IN (SELECT vdo_id FROM main.video) and mark_flag = 1");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_video_by_video_id(db, id);
                if(ret == SRV_PLST_OK)
                {
                    count++;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;
        }            
        return ret;
    }
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(view_type == SRV_PLST_VIEW_AUDIO)
    {
        U32 count = 0;

        if(!list_view->is_mark)
        {
            ret = pls_sql_delete_media_by_media_id(db, id, &count);
        }
        else if(list_view->is_mark_all && !list_view->is_unmark_all)
        {
            U32 count0 = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE media_id NOT in (SELECT id FROM db2.mark  WHERE mark_flag = 1)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE media_id NOT IN (SELECT id FROM main.mark  WHERE mark_flag = 1)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, id,&count0);
                if(ret == SRV_PLST_OK)
                {
                    count += 1;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;        
        }
        else
        {
           U32 count0 = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1 and id IN (SELECT media_id FROM main.audio UNION SELECT media_id FROM db2.audio)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE mark_flag = 1 and id IN (SELECT media_id FROM main.audio)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, id, &count0);
                if(ret == SRV_PLST_OK)
                {
                    count += 1;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }                
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        return ret;            
    }
    else if(view_type == SRV_PLST_VIEW_ARTIST || SRV_PLST_VIEW_ALBUM || SRV_PLST_VIEW_GENRE)
    {
        U32 media_id = 0;
        U32 count = 0;

        if(!list_view->is_mark)
        {
            if(view_type == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */

            }
            else if(view_type == SRV_PLST_VIEW_ALBUM)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd," UNION SELECT media_id FROM db2.audio WHERE album_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE genre_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE genre_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        }
        else if(list_view->is_mark_all && !list_view->is_unmark_all)
        {
            if(view_type == SRV_PLST_VIEW_ARTIST)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE artist_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
            else if(view_type == SRV_PLST_VIEW_ALBUM)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE genre_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE genre_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE genre_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        }
        else
        {
            if(view_type == SRV_PLST_VIEW_ARTIST)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE artist_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
            else if(view_type == SRV_PLST_VIEW_ALBUM)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM (SELECT media_id FROM main.audio WHERE genre_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE genre_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1))");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE genre_id in (SELECT id FROM main.mark WHERE mark_flag = 1)");
                }
            }
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(!list_view->is_mark)
        {
        sqlite3_bind_kal_uint32(stmt, 1, id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 count0; 
            media_id = sqlite3_column_kal_uint32(stmt, 0);
            ret = pls_sql_delete_media_by_media_id(db, media_id, &count0);
            if(list_view->is_delete_cancel || ret == SRV_PLST_RET_CONTINUE)
            {
                break;
            }
            else if(ret == SRV_PLST_OK)
            {
                count += 1;
                list_view->prog_count +=1;
                if(count >= SRV_PLST_SQL_OP_TIME)
                {
                    ret = SRV_PLST_RET_CONTINUE;
                    break;
                }
                if(list_view->is_delete_cancel)
                {
                    ret = SRV_PLST_OK;
                    break;
                }
                ret = pls_sql_step_ex(db, stmt);
            }
            else /* error return */
            {
                break;
            }
        }
        pls_sql_finalize(stmt);
        if(list_view->is_delete_cancel)
        {
            return SRV_PLST_OK;
        }  
        if(ret == SRV_PLST_RET_CONTINUE)
        {
            return ret ;
        }  
        else if(ret < SRV_PLST_OK) /* error return happend in pls_sql_delete_media_by_media_id */
        {
            return ret;
        }

        
       // if(!media_id || ret == SRV_PLST_OK) /* delete this sort type done and then delete the sort id */
       /*
        {
            if(view_type == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
            }
            else if(view_type == SRV_PLST_VIEW_ALBUM)
            {
                sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");
            }
            else
            {
                sprintf(db->sql_cmd, "DELETE FROM main.genre WHERE genre_id = ?");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            ret = pls_sql_step_ex(db, stmt);            
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(IS_CARD_EXIST)
            {
                if(view_type == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ?");
                }
                else if(view_type == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.album WHERE album_id = ?");
                }
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM db2.genre WHERE genre_id = ?");
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);                
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }                    
        */
    }/* end of view_type == sort type */
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_media_from_list_two_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_delete_media_from_list_two_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 id)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type,view_type1;
    srv_plst_list_context_struct *list_cache;
    U32 id1;
    U32 count = 0;
    U32 media_id = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    view_type = list_view->view_type[list_view->current_index];
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type1 = list_view->view_type[list_view->current_index - 1]; 
    id1 = list_cache->parent_id;

    if(view_type  == SRV_PLST_VIEW_MEDIA && 
      (view_type1 == SRV_PLST_VIEW_ALBUM ||
       view_type1 == SRV_PLST_VIEW_ARTIST||
       view_type1 == SRV_PLST_VIEW_GENRE))
    {
        if(!list_view->is_mark)
        {
            ret = pls_sql_delete_media_by_media_id(db, id, &count);
            return ret;
        }
        else if(list_view->is_mark_all)
        {
            const S8* ptr;
            if(view_type1 == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(view_type1 == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else
            {
                ptr = Sqlgenreid;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE %s AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1) \
UNION SELECT media_id FROM db2.audio WHERE %s AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", ptr, ptr);
            } 
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE %s AND media_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0;                    
				S32 ret1;

                media_id = sqlite3_column_kal_uint32(stmt, 0);
                if(list_view->is_delete_cancel)
                {
                    pls_sql_finalize(stmt);
                    return SRV_PLST_OK;
                }
                ret1 = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(ret1 == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count += 1;
                    pls_sql_finalize(stmt);
                    return ret1;
                }
                else if(ret1 == SRV_PLST_OK)
                {
                    count +=1;
                    list_view->prog_count +=1;
                    if(count > SRV_PLST_SQL_OP_TIME)
                    {
						pls_sql_finalize(stmt);
                        ret1 = SRV_PLST_RET_CONTINUE;
                        return ret1;
                    }
                }
                else /* delete error happened */
                {
                    pls_sql_finalize(stmt);
                    return ret1;
                }                    
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);  
            return ret;
        }
        else /* mark and unmark all case */
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1 AND id IN (SELECT media_id FROM main.audio UNION SELECT media_id FROM db2.audio)");
            } 
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE mark_flag = 1 AND id IN (SELECT media_id FROM main.audio)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0;                    
		        S32 ret1;
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                if(list_view->is_delete_cancel)
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
                ret1 = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(ret1 == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count += 1;
                    pls_sql_finalize(stmt);
                    return ret1;
                }
                else if(ret1 == SRV_PLST_OK)
                {
                    count +=1;
                    list_view->prog_count += 1;
                    if(count > SRV_PLST_SQL_OP_TIME)
                    {
                        ret1 = SRV_PLST_RET_CONTINUE;
						pls_sql_finalize(stmt);
                        return ret1;
                    }
		            ret = pls_sql_step_ex(db, stmt);
                }
                else /* delete error happened */
                {
                    pls_sql_finalize(stmt);
                    return ret1;
                }                    
            }
            pls_sql_finalize(stmt);  
            return ret;
        }
    }
    else if(view_type == SRV_PLST_VIEW_ALBUM && view_type1 == SRV_PLST_VIEW_ARTIST)
    {
        id1 = list_cache->parent_id;

        if(!list_view->is_mark)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ?");
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else if(list_view->is_mark_all && !list_view->is_unmark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)");
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id1);

        if(!list_view->is_mark)
        {
            sqlite3_bind_kal_uint32(stmt, 2, id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id1);
                sqlite3_bind_kal_uint32(stmt, 4, id);            
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        while(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 count0;
            S32 ret1;
            
            media_id = sqlite3_column_kal_uint32(stmt, 0);
            if(list_view->is_delete_cancel)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            ret1 = pls_sql_delete_media_by_media_id(db, media_id, &count0);
            if(ret1 == SRV_PLST_RET_CONTINUE)
            {
                list_view->prog_count += 1;
                pls_sql_finalize(stmt);
                return ret1;
            }
            else if(ret1 == SRV_PLST_OK)
            {
                count +=1;
                list_view->prog_count += 1;
                if(count > SRV_PLST_SQL_OP_TIME)
                {
                    ret1 = SRV_PLST_RET_CONTINUE;
					pls_sql_finalize(stmt);
                    return ret1;
                }
                ret = pls_sql_step_ex(db, stmt);
            }
            else /* delete error happened */
            {
                pls_sql_finalize(stmt);
                return ret1;
            }                    
        }
        pls_sql_finalize(stmt);

        if(ret == SRV_PLST_RET_CONTINUE)
        {
            return ret;
        }
        else if(ret < SRV_PLST_OK)
        {
            return ret;
        }
        
        if(!media_id || ret == SRV_PLST_OK) /* delete the album info */
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id = ? ");            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            else if(ret == SRV_PLST_OK)
            {
                sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }               
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ?");
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id1);
                ret = pls_sql_step_ex(db, stmt);                    
                pls_sql_finalize(stmt);

                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id);
                    ret = pls_sql_step_ex(db, stmt);
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    } 
                }/* end of delete artist */
            }
            ret = SRV_PLST_OK;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM db2.audio WHERE album_id = ?");
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);            
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {                    
                    sprintf(db->sql_cmd, "DELETE FROM db2.album WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id);
                    ret = pls_sql_step_ex(db, stmt);
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }           

                    sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE artist_id = ?");    
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id1);
                    ret = pls_sql_step_ex(db, stmt);                    
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ?");
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        pls_sql_finalize(stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }                       
                    }/* end of delete artist */
                }
                ret = SRV_PLST_OK; 
            }                                    
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            return ret;
        }/* delete album/artist info */
    }
    else if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        if(view_type1 == SRV_PLST_VIEW_AUDIO)
        {
            ret = pls_sql_delete_media_by_media_id(db, id, &count);
            return ret;       
        }
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(view_type1 == SRV_PLST_VIEW_VIDEO)
        {
            ret = pls_sql_delete_video_by_video_id(db, id);
        }
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        else if(view_type1 == SRV_PLST_VIEW_ARTIST || view_type1 == SRV_PLST_VIEW_ALBUM || view_type1 == SRV_PLST_VIEW_GENRE)
        {
            U32 media_id = 0;
            U32 count = 0;
            if(view_type1 == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else if(view_type1 == SRV_PLST_VIEW_ALBUM)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd," UNION SELECT media_id FROM db2.audio WHERE album_id = ? ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            else
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE genre_id = ?");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE album_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0; 
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(list_view->is_delete_cancel || ret == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count+=1;
                    break;
                }
                else if(ret == SRV_PLST_OK)
                {
                    count += 1;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        break;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        ret = SRV_PLST_OK;
                        break;
                    }
					ret = pls_sql_step_ex(db, stmt);
                }
                else /* error return */
                {
                    break;
                }
            }
            pls_sql_finalize(stmt);
            
            if(list_view->is_delete_cancel)
            {
                return SRV_PLST_OK ;
            }  
            if(ret == SRV_PLST_RET_CONTINUE)
            {
                return ret ;
            }  
            else if(ret < SRV_PLST_OK) /* error return happend in pls_sql_delete_media_by_media_id */
            {
                return ret;
            }            
            
            if(!media_id || ret == SRV_PLST_OK) /* delete this sort type done and then delete the sort id */
            {
                if(view_type == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
                }
                else if(view_type == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.genre WHERE genre_id = ?");
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }                

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(view_type1 == SRV_PLST_VIEW_ARTIST)
                    {
                        sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ?");
                    }
                    else if(view_type1 == SRV_PLST_VIEW_ALBUM)
                    {
                        sprintf(db->sql_cmd, "DELETE FROM db2.album WHERE album_id = ?");
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else
                    {
                        sprintf(db->sql_cmd, "DELETE FROM db2.genre WHERE genre_id = ?");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id);
                    ret = pls_sql_step_ex(db, stmt);
                    pls_sql_finalize(stmt);                
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }                     
        }/* end of view_type == sort type */
        else if(view_type1 == SRV_PLST_VIEW_PLST)
        { // to do:
            ret = pls_sql_delete_plst(db, &id);
            return ret;
        }
        else            
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_media_from_list_three_level
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_delete_media_from_list_three_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 id)    
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type,view_type1,view_type2;
    srv_plst_list_context_struct *list_cache;
    U32 id1,id2;
    U32 count = 0;
    U32 media_id = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    view_type = list_view->view_type[list_view->current_index];
    list_cache = &(list_view->list_cache[list_view->current_index]);
    view_type1 = list_view->view_type[list_view->current_index - 1];
    view_type2 = list_view->view_type[list_view->current_index - 2];
    id2 = list_cache->parent_id;
    id1 = list_view->list_cache[list_view->current_index- 1].parent_id;
    
    if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH)
    {
        if(view_type1 == SRV_PLST_VIEW_MEDIA &&
          (view_type2  == SRV_PLST_VIEW_ARTIST ||
           view_type2  == SRV_PLST_VIEW_ALBUM  ||
           view_type2  == SRV_PLST_VIEW_GENRE ))
        {
            ret = pls_sql_delete_media_by_media_id(db, id, &count);
            return ret;
        }
        else if(view_type1 == SRV_PLST_VIEW_ALBUM && view_type2 == SRV_PLST_VIEW_ARTIST)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ?");
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id1);
            sqlite3_bind_kal_uint32(stmt, 2, id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id1);
                sqlite3_bind_kal_uint32(stmt, 4, id);            
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0;
                
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(list_view->is_delete_cancel)
                {                   
                    pls_sql_finalize(stmt);
                    return SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count +=1;
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {
                    count +=1;
                    list_view->prog_count +=1;
                    if(count > SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        break;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        ret = SRV_PLST_OK;
                        break;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                }
                else /* delete error happened */
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }                    
            }
            pls_sql_finalize(stmt);

            if(list_view->is_delete_cancel)
            {
                return SRV_PLST_OK;
            }
            else if(ret == SRV_PLST_RET_CONTINUE)
            {
                return ret;
            }
            else if(ret < SRV_PLST_OK)
            {
                return ret;
            }           
            
            if(!media_id || ret == SRV_PLST_OK) /* delete the album info */
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE album_id = ? ");
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {
                    sprintf(db->sql_cmd, "DELETE FROM main.album WHERE album_id = ?");                   
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id);                    
                    ret = pls_sql_step_ex(db, stmt);                   
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }

                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id1);
                    ret = pls_sql_step_ex(db, stmt);                    
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        return ret;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        sprintf(db->sql_cmd, "DELETE FROM main.artist WHERE artist_id = ?");
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);                        
                        pls_sql_finalize(stmt);
                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {                            
                            return ret;
                        } 
                    }/* end of delete artist */
                }
                ret = SRV_PLST_OK;              
               
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, " SELECT media_id FROM db2.audio WHERE album_id = ?");
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id);
                    ret = pls_sql_step_ex(db, stmt);
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {                      
                        return ret;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        sprintf(db->sql_cmd, "DELETE FROM db2.album WHERE album_id = ?");
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        pls_sql_finalize(stmt);

                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }

                        sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE artist_id = ?");
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id1);
                        ret = pls_sql_step_ex(db, stmt);                    
                        pls_sql_finalize(stmt);

                        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                        {
                            return ret;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            sprintf(db->sql_cmd, "DELETE FROM db2.artist WHERE artist_id = ?");
                            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                            if(ret != SRV_PLST_OK)
                            {
                                return ret;
                            }
                            sqlite3_bind_kal_uint32(stmt, 1, id);
                            ret = pls_sql_step_ex(db, stmt);                           
                            pls_sql_finalize(stmt);

                            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                            {
                                return ret;
                            }
                        }/* end of delete artist */
                    }
                    ret = SRV_PLST_OK;
                }/* delete album/artist info */  
            #endif /* __PLST_DUAL_DB_SUPPORT__ */

                return ret;
            } 
            return ret;
        }            
    }
    else  if(!list_view->is_mark)
    {
        ret = pls_sql_delete_media_by_media_id(db, id, &count);
    }
    else if(list_view->is_mark_all && !list_view->is_unmark_all)
    {
        if(view_type1 == SRV_PLST_VIEW_ALBUM && view_type2 == SRV_PLST_VIEW_ARTIST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ?  AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
            } 
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id1);
            sqlite3_bind_kal_uint32(stmt, 2, id2);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id1);
                sqlite3_bind_kal_uint32(stmt, 4, id2);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0;                    
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(list_view->is_delete_cancel)
                {
                    pls_sql_finalize(stmt);
                    return SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count +=1;
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {
                    list_view->prog_count +=1;
                    count +=1;
                    if(count > SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        break;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        ret = SRV_PLST_OK;
                        break;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                }
                else /* delete error happened */
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }                                    
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        if(view_type1 == SRV_PLST_VIEW_ALBUM && view_type2 == SRV_PLST_VIEW_ARTIST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1 AND id IN (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ? )");
            } 
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE mark_flag = 1 AND id IN (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? )");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id1);
            sqlite3_bind_kal_uint32(stmt, 2, id2);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id1);
                sqlite3_bind_kal_uint32(stmt, 4, id2);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                U32 count0;                    
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, media_id, &count0);
                if(list_view->is_delete_cancel)
                {
                    pls_sql_finalize(stmt);
                    return SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_CONTINUE)
                {
                    list_view->prog_count +=1;
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else if(ret == SRV_PLST_OK)
                {
                    count +=1;
                    list_view->prog_count += 1;
                    if(count > SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        break;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        ret = SRV_PLST_OK;
                        break;
                    }
                }
                else /* delete error happened */
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }                                    
                ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    return ret;
}


S32 pls_sql_delete_media_from_active_list(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 count = 0;
    sqlite3_stmt *stmt;
    srv_plst_playing_context_struct *playing_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/   
    playing_info = (srv_plst_playing_context_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->playing_info);
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TYPE_AUDIO)
    {
        if(!list_view->is_mark)
        {
            ret = pls_sql_delete_media_by_media_id(db, id, &count);
        }
        else if(list_view->is_mark_all && !list_view->is_unmark_all)
        {
            U32 count0 = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)");
                strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE media_id NOT in (SELECT id FROM db2.mark  WHERE mark_flag = 1)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT media_id FROM main.audio WHERE media_id NOT IN (SELECT id FROM main.mark  WHERE mark_flag = 1)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, id,&count0);
                if(ret == SRV_PLST_OK)
                {
                    count += 1;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;        
        }
        else
        {
           U32 count0 = 0;

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT id FROM db2.mark WHERE mark_flag = 1 and id IN (SELECT media_id FROM main.audio UNION SELECT media_id FROM db2.audio)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT id FROM main.mark WHERE mark_flag = 1 and id IN (SELECT media_id FROM main.audio)");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            while(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                id = sqlite3_column_kal_uint32(stmt, 0);
                ret = pls_sql_delete_media_by_media_id(db, id, &count0);
                if(ret == SRV_PLST_OK)
                {
                    count += 1;
                    list_view->prog_count +=1;
                    if(count >= SRV_PLST_SQL_OP_TIME)
                    {
                        ret = SRV_PLST_RET_CONTINUE;
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    if(list_view->is_delete_cancel)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }                
		        ret = pls_sql_step_ex(db, stmt);
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        return ret;            
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_delete_media_from_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_delete_media_from_list(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type;
    srv_plst_list_context_struct *list_cache;
    U32 id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    view_type = list_view->view_type[list_view->current_index];
    list_cache = &(list_view->list_cache[list_view->current_index]);
    if(!list_view->is_mark)
    {
        ret = pls_db_util_get_id(list_cache, index, &id);
    }
    else
    {
        id = 0;
    }
    MMI_TRACE(TRACE_GROUP_1,MMI_PLS_SQL_DELETE_MEDIA_FROM_LIST, index, list_view->current_index,view_type);
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ACTIVE)
    {
        U32 count;
        if(!list_view->is_mark)
        {
            return pls_sql_delete_media_by_media_id(db, id, &count);
        }
        else
        {
            return pls_sql_delete_media_from_active_list(db, list_view, id);
        }
    }
    else if(!list_view->current_index)
    {
        ret = pls_sql_delete_media_from_list_one_level(db, list_view, id);
        return ret;
    }
    else if(list_view->current_index == 1)
    {
        ret = pls_sql_delete_media_from_list_two_level(db, list_view, id);
        return ret;
    }
    else if((view_type == SRV_PLST_VIEW_MEDIA || view_type == SRV_PLST_VIEW_PREFIX_SEARCH )&& list_view->current_index == 2) 
    {   /* list_view->current_index >= 2 mark /unmark  only artist'album case */
        ret = pls_sql_delete_media_from_list_three_level(db, list_view, id);
        return ret;
    }
    else if(view_type == SRV_PLST_VIEW_PREFIX_SEARCH && list_view->current_index > 2)
    {
        U32 count;
        ret = pls_sql_delete_media_by_media_id(db,id, &count);   
        return ret;
    }    
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_plst_item_reorder
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_plst_item_reorder(srv_plst_db_context_struct *db, U32 index_o, u32 index_d)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_list_view_history_struct *list_view;
    srv_plst_base_info_struct *base;
    U32 id;
    U32 plstitem_id;
    U32 ordinal_1 = 0;
    U32 ordinal_2 = 0;
    U32 max_idx;
    U32 min_idx;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    //kal_printf("\npls_sql_plst_item_reorder index_o = %d, index_d = %d\n", index_o, index_d);
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    if(list_view->current_index != 1 || list_view->is_reorder != MMI_TRUE)
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    if(index_o == index_d)
    {
        return SRV_PLST_OK;
    }
    id = list_view->list_cache[1].parent_id;

    {
        S32 index_o_temp, temp_index_d;
        S32 ret_value = 0;
        ret_value = pls_db_util_check_item_if_in_cache(list_view, (S32)index_d, &temp_index_d);
        list_view->query_index = index_d;
        if(ret_value)
        {            
            ret = pls_sql_get_item_to_fill_cache(db, index_d, ret_value,&index_o_temp); 
        }
    }

    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
    {
        if(id > 0X8000)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
    else
    {
        if(id > 0X8000)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx, media_id ASC limit 1 OFFSET ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx, media_id ASC limit 1 OFFSET ?");
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx, media_id ASC limit 1 OFFSET ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    sqlite3_bind_kal_uint32(stmt, 2, index_o );
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        plstitem_id = sqlite3_column_kal_uint32(stmt, 0);
        ordinal_1 = sqlite3_column_kal_uint32(stmt, 1);
        sqlite3_reset(stmt);
        sqlite3_bind_kal_uint32(stmt, 1, id);
        sqlite3_bind_kal_uint32(stmt, 2, index_d);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            ordinal_2 = sqlite3_column_kal_uint32(stmt, 1);
        }
    }
    else 
    {
        plstitem_id = 0;
    }
    pls_sql_finalize(stmt);
    if(ret != SRV_PLST_OK)
    {
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
        return ret;
    }

    /* update index in the db table */
    {
        U32 count;
        U32 offset;
        U32 i = 0;

        if(ordinal_1 > ordinal_2)
        {
            max_idx = ordinal_1;
            min_idx = ordinal_2;
        }
        else
        {
            max_idx = ordinal_2;
            min_idx = ordinal_1;
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(id <= 0X8000 && id > 0)
        {
            ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND idx >= ? AND idx <= ?", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND idx >= ? AND idx <= ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        sqlite3_bind_kal_uint32(stmt, 2, min_idx);
        sqlite3_bind_kal_uint32(stmt, 3, max_idx);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            count = 0;
        }
        pls_sql_finalize(stmt);

        if(!count)
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }        
        
        for(i = 0; i <= count/(SRV_PLST_SQL_OP_TIME * 6); i++)
        {
            if(i < count/(SRV_PLST_SQL_OP_TIME * 6))
            {
                offset = (SRV_PLST_SQL_OP_TIME * 6) - 1;
            }
            else
            {
                offset = count - (i*(SRV_PLST_SQL_OP_TIME * 6)) - 1;
            }   

            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(id <= 0X8000 && id > 0)
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plst_id = ? and idx >= ? ORDER BY idx asc, plstitem_id asc limit 1 OFFSET ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plst_id = ? and idx <= ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
                    }            
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plst_id = ? and idx >= ? ORDER BY idx asc, plstitem_id asc limit 1 OFFSET ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plst_id = ? and idx <= ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
                    }
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(id <= 0X8000 && id > 0)
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plst_id = ? and idx <= ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plst_id = ? and idx >= ? ORDER BY idx, plstitem_id limit 1 OFFSET ?");
                    }            
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plst_id = ? and idx <= ? ORDER BY idx desc, plstitem_id desc limit 1 OFFSET ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plst_id = ? and idx >= ? ORDER BY idx, plstitem_id limit 1 OFFSET ?");
                    }
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(index_o > index_d)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, min_idx);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 2, max_idx);
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(index_o > index_d)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, max_idx);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 2, min_idx);
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

            sqlite3_bind_kal_uint32(stmt, 3, offset);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(index_o > index_d)
                    {
                        max_idx = sqlite3_column_kal_uint32(stmt, 0);
                    }
                    else
                    {
                        min_idx = sqlite3_column_kal_uint32(stmt, 0);
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    if(index_o > index_d)
                    {
                        min_idx = sqlite3_column_kal_uint32(stmt, 0);
                    }
                    else
                    {
                        max_idx = sqlite3_column_kal_uint32(stmt, 0);
                    }
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                ret = SRV_PLST_OK;
            }
            pls_sql_finalize(stmt);

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(id <= 0X8000 && id > 0)
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "UPDATE db2.plst_item SET idx = idx - 1 WHERE plst_id = ? AND idx > ? AND idx <= ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "UPDATE db2.plst_item SET idx = idx + 1 WHERE plst_id = ? AND idx >= ? AND idx < ?");
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "UPDATE db2.plst_item SET idx = idx + 1 WHERE plst_id = ? AND idx >= ? AND idx < ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "UPDATE db2.plst_item SET idx = idx - 1 WHERE plst_id = ? AND idx > ? AND idx <= ?");
                    }    
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "UPDATE main.plst_item SET idx = idx - 1 WHERE plst_id = ? AND idx > ? AND idx <= ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "UPDATE main.plst_item SET idx = idx + 1 WHERE plst_id = ? AND idx >= ? AND idx < ?");
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    if(index_o > index_d)
                    {
                        sprintf(db->sql_cmd, "UPDATE main.plst_item SET idx = idx + 1 WHERE plst_id = ? AND idx >= ? AND idx < ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "UPDATE main.plst_item SET idx = idx - 1 WHERE plst_id = ? AND idx > ? AND idx <= ?");
                    }
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id);
            sqlite3_bind_kal_uint32(stmt, 2, min_idx);
            sqlite3_bind_kal_uint32(stmt, 3, max_idx);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            // MAUI_02928464
            //side effect of LIST_SORT_BY_MODIFY_TIME in reorder logic
            //need to set min index as max if modify time decend order
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(index_o > index_d)
                {
                    min_idx = max_idx;
                }
                else
                {
                    max_idx = min_idx;
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(index_o > index_d)
                {
                    max_idx = min_idx;
                }
                else
                {
                    min_idx = max_idx;
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

        }
    }
    
    if(id > 0X8000)
    {
        sprintf(db->sql_cmd, "UPDATE main.plst_item SET idx = ? WHERE plstitem_id = ?");
    }
#if defined(__PLST_DUAL_DB_SUPPORT__)
    else
    {
        sprintf(db->sql_cmd, "UPDATE db2.plst_item SET idx = ? WHERE plstitem_id = ?");
    }
#endif /**/
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(ordinal_1 > ordinal_2)
    {
        sqlite3_bind_kal_uint32(stmt, 1, ordinal_2);
    }
    else
    {
        sqlite3_bind_kal_uint32(stmt, 1, ordinal_2);
    }
    sqlite3_bind_kal_uint32(stmt, 2, plstitem_id);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    if(ret == SRV_PLST_OK)
    {
        U32 i;
        U32 temp_id1;        
        
        if(index_o == 0 && index_d == (list_view->total_count - 1))
        {
            memset(&(list_view->list_cache[1].cache), 0, SRV_PLST_VIEW_LIST_CACHE * sizeof(srv_plst_list_cache_struct));
            list_view->list_cache[1].last_index = 0;
            list_view->list_cache[1].first_index = 0;
            list_view->list_cache[1].head = 0;
            list_view->list_cache[1].tail = 0;
            list_view->list_cache[1].cache_num = 0;
            list_view->query_index = 0;
        }
        else if (index_o == (list_view->total_count - 1) && index_d == 0)
        {
            memset(&(list_view->list_cache[1].cache), 0, SRV_PLST_VIEW_LIST_CACHE * sizeof(srv_plst_list_cache_struct));
            list_view->list_cache[1].last_index = 0;
            list_view->list_cache[1].first_index = 0;
            list_view->list_cache[1].head = 0;
            list_view->list_cache[1].tail = 0;
            list_view->list_cache[1].cache_num = 0;
            list_view->query_index = 0;
        }
        else
        {
            S32 temp_index_o;
            S32 temp_index_d;
            S32 ret_value = 0;

            ret_value = pls_db_util_check_item_if_in_cache(list_view, (S32)index_o, &temp_index_o);
            if(!ret_value)
            {
                ret_value = pls_db_util_check_item_if_in_cache(list_view, (S32)index_d, &temp_index_d);
                if(!ret_value)
                {
                    if(index_o < index_d)
                    {
                        if(temp_index_o < temp_index_d)
                        {
                            temp_id1 = list_view->list_cache[1].cache[temp_index_o].id;
                            for(i = temp_index_o; i < temp_index_d; i++)
                            {
                                list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i+1].id;
                            }
                            list_view->list_cache[1].cache[temp_index_d].id = temp_id1;  
                        }
                        else
                        {
                             temp_id1 = list_view->list_cache[1].cache[temp_index_o].id;
                             for(i = temp_index_o; i < SRV_PLST_VIEW_LIST_CACHE; i++)
                             {
                                list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i+1].id;
                             }

                             list_view->list_cache[1].cache[SRV_PLST_VIEW_LIST_CACHE - 1].id = list_view->list_cache[1].cache[0].id;

                             for(i = 0; i < temp_index_d; i++)
                             {
                                list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i+1].id;
                             }
                             list_view->list_cache[1].cache[temp_index_d].id = temp_id1;
                        }  
                    }
                    else  /*  index_o > index_d */
                    {
                        if(temp_index_d > temp_index_o)
                        {
                            temp_id1 = list_view->list_cache[1].cache[temp_index_o].id;
                            for(i = temp_index_o; i > 0; i--)
                             {
                                list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i-1].id;
                             }

                             list_view->list_cache[1].cache[0].id = list_view->list_cache[1].cache[SRV_PLST_VIEW_LIST_CACHE - 1].id;

                             for(i = SRV_PLST_VIEW_LIST_CACHE; i > temp_index_d; i--)
                             {
                                list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i-1].id;
                             }
           
                            list_view->list_cache[1].cache[temp_index_d].id = temp_id1;  
                        }
                        else
                        {
                             temp_id1 = list_view->list_cache[1].cache[temp_index_o].id;
                             for(i = temp_index_o; i > temp_index_d; i--)
                             {
                                  list_view->list_cache[1].cache[i].id = list_view->list_cache[1].cache[i-1].id;
                             }
                             list_view->list_cache[1].cache[temp_index_d].id = temp_id1;
                        }                     
                    }
                }
            }
            if(ret_value != 0)
            {
                /* current do nothing */
            }
        }
    }
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_play_config_reset
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_play_config_reset(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /*
    CREATE TABLE playing_info(
        unque_id      INTEGER     PRIMARY KEY,
        plst_id       INTEGER,
        playing_type  INTEGER,
        idx           INTEGER,
        filtertype    BLOB)                           
    */
    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(play_ptr->current_picked_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "UPDATE main.audio SET play_count = play_count + 1 WHERE media_id = ?", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "UPDATE db2.audio SET play_count = play_count + 1 WHERE media_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TYPE_VIDEO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        if(play_ptr->current_picked_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "UPDATE main.video SET play_count = play_count + 1 WHERE vdo_id = ?", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "UPDATE db2.video SET play_count = play_count + 1 WHERE vdo_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(play_ptr->plst_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "UPDATE main.plst_item SET play_count = play_count + 1 WHERE plstitem_id = ? ", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "UPDATE db2.plst_item SET play_count = play_count + 1 WHERE plstitem_id = ? ", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else 
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, play_ptr->current_picked_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_OK)
    {
        play_ptr->play_id += 1;
        play_ptr->pick_count = 1;
        play_ptr->played_count = 1;
        ret = SRV_PLST_OK;
    }
    pls_sql_finalize(stmt);    
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_set_active
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_set_active(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *play_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_base_info_struct *base;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /*
    CREATE TABLE playing_info(
        unque_id      INTEGER     PRIMARY KEY,
        plst_id       INTEGER,
        idx           INTEGER,        
        playing_type  INTEGER,
        filtertype    BLOB)                           
    */
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    if(base->config_store_play_info == SRV_PLST_PLAY_INFO_STORE)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT unque_id FROM db2.playing_info", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db, "SELECT unque_id FROM main.playing_info", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            pls_sql_finalize(stmt);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "UPDATE db2.playing_info set plst_id = ?, playing_type = ?, idx = ?, filtertype = ? WHERE unque_id = 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "UPDATE main.playing_info set plst_id = ?, playing_type = ?, idx = ?, filtertype = ? WHERE unque_id = 1");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_ptr->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, play_ptr->active_type);
            sqlite3_bind_kal_int32(stmt, 3, play_ptr->current_picked_id);
            sqlite3_bind_blob(stmt, 4, (srv_plst_list_view_type_struct*)&(play_ptr->play_info), sizeof(srv_plst_list_view_type_struct), SQLITE_STATIC);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);    
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
        else
        {
            pls_sql_finalize(stmt);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "INSERT INTO db2.playing_info(plst_id, playing_type, idx, filtertype) VALUES (?,?,?,?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "INSERT INTO main.playing_info(plst_id, playing_type, idx, filtertype) VALUES (?,?,?,?)");
            }

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, play_ptr->plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, play_ptr->active_type);
            sqlite3_bind_kal_int32(stmt, 3, play_ptr->current_picked_id);
            sqlite3_bind_blob(stmt, 4, (srv_plst_list_view_type_struct*)&(play_ptr->play_info), sizeof(srv_plst_list_view_type_struct), SQLITE_STATIC);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);    
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }          
    }

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__    
    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.video");
    }  
    else
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.plst_item");
    }
    else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.audio");
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        play_ptr->play_id = sqlite3_column_kal_uint32(stmt, 0) + 1;
    }
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        U32 count;
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
            #endif
            )
        {
            sprintf(db->sql_cmd, " SELECT MAX(play_count) FROM db2.video");
        }  
        else
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
            sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM db2.plst_item");
        }
        else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
            sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM db2.audio");
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count = sqlite3_column_kal_uint32(stmt, 0) + 1;            
        }
        else 
        {
            count = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(count > play_ptr->play_id)
        {
            play_ptr->play_id = count;
        }
   }  
#endif /* __PLST_DUAL_DB_SUPPORT__ */

        /* udpate to set */
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
         if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
            #endif
            )
        {
            if(play_ptr->current_picked_id > 0X8000)
            {
                sprintf(db->sql_cmd, " Update main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " Update db2.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }  
        else
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
            if(play_ptr->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "Update main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "Update db2.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || play_ptr->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
            if(play_ptr->current_picked_id > 0X8000)
            {
                sprintf(db->sql_cmd, "Update main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "Update db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
            }       
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, play_ptr->play_id);
        sqlite3_bind_kal_uint32(stmt, 2, play_ptr->ordinal);
        sqlite3_bind_kal_uint32(stmt, 3, play_ptr->current_picked_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

    /* delete old */
    #if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
    #endif
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_load_active_info
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_load_active_info(srv_plst_db_context_struct *db, U32* data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_playing_context_struct* playing_info;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    playing_info = (srv_plst_playing_context_struct*)data;
    /*
        CREATE TABLE playing_info(
            unque_id      INTEGER     PRIMARY KEY,
            plst_id       INTEGER,
            idx           INTEGER,
            playing_type  INTEGER,
            filtertype    BLOB)
    */
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        sprintf(db->sql_cmd, "SELECT * FROM db2.playing_info WHERE unque_id = 1");
    }
    else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    {
        sprintf(db->sql_cmd, "SELECT * FROM main.playing_info WHERE unque_id = 1");
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        playing_info->plst_id = sqlite3_column_kal_uint32(stmt, 1);
        playing_info->current_picked_id = sqlite3_column_kal_uint32(stmt, 2);
        playing_info->active_type = (srv_plst_active_list_enum)sqlite3_column_kal_uint32(stmt, 3);

        if(sqlite3_column_blob(stmt, 4) != NULL)
        {
            memcpy((S8*)(&(playing_info->play_info)), (const S8*)sqlite3_column_blob(stmt, 4),sizeof(srv_plst_list_view_type_struct));        
        }        
        pls_sql_finalize(stmt); 

    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            ret = pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
            pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
            playing_info->play_info.total_count = playing_info->total;
            if(playing_info->total == 0)
            {
                playing_info->plst_id = 0;
            }
        }
        else
    #endif
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            ret = pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);
            pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
            playing_info->play_info.total_count = playing_info->total;
            if(playing_info->total == 0)
            {
                playing_info->plst_id = 0;
            }
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            ret = pls_sql_get_active_index_by_id(db, playing_info, playing_info->current_picked_id, &playing_info->pick_index);            
            pls_sql_get_default_list_count(db,playing_info, &playing_info->total);
            playing_info->play_info.total_count = playing_info->total;
            if(playing_info->total == 0)
            {
                playing_info->plst_id = 0;
            }
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
       
        if(playing_info->play_info.current_index == 0 && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
        {
            playing_info->plst_id = playing_info->current_picked_id;
        }
        /* udpate playing info */
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
            #endif
            )
        {
            sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.video");
        }  
        else
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
            sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.plst_item");
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
            sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM main.audio");
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->play_id = sqlite3_column_kal_uint32(stmt, 0) + 1;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            U32 count;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
                #endif
                )
            {
                sprintf(db->sql_cmd, " SELECT MAX(play_count) FROM db2.video");
            }  
            else
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
                #endif
                )
            {
                sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM db2.plst_item");
            }
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
                #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
                || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
                #endif
                )
            {
                sprintf(db->sql_cmd, "SELECT MAX(play_count) FROM db2.audio");
            }
            else
            {
                ret = SRV_PLST_RET_ERR_PARAM_ERR;
                return ret;
            }

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                count = sqlite3_column_kal_uint32(stmt, 0) + 1;            
            }
            else 
            {
                count = 0;
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
            if(count > playing_info->play_id)
            {
                playing_info->play_id = count;
            }
        }  
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        /* udpate to set */
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
            #endif
            )
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->current_picked_id <= 0X8000)
            {
                sprintf(db->sql_cmd, " Update db2.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " Update main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        }  
        else
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->plst_id <= 0X8000)
            {
                sprintf(db->sql_cmd, "Update db2.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "Update main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->current_picked_id <= 0X8000)
            {
                sprintf(db->sql_cmd, "Update db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "Update main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
            }       
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        playing_info->played_count = 1;
        playing_info->pick_count = 1;
    }
    else
    {
        pls_sql_finalize(stmt);
    }
   
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_active_play_count_by_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_active_play_count_by_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 id, U32 *play_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        ) /* video  list */
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM main.video WHERE play_count = ? UNION SELECT vdo_id FROM db2.video WHERE play_count = ?)", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db,  "SELECT COUNT(vdo_id) FROM main.video WHERE play_count = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt,2, playing_info->play_id);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->pick_count = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            playing_info->pick_count = 0;
        }
        pls_sql_finalize(stmt);

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM main.video WHERE play_count = ? AND ordinal <= ? UNION SELECT vdo_id FROM db2.video WHERE play_count = ? and ordinal <= ? )", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db,  "SELECT COUNT(vdo_id) FROM main.video WHERE play_count = ? AND ordinal <= ? ", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        //MAUI_02948052
        //should bind ordinal to select the count of aready played items
        //Very core code for get play count info
        //also effect W1112MP version at list
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->ordinal);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->played_count = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            playing_info->played_count = 0;
        }
        pls_sql_finalize(stmt);
        
    }
    else
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE play_count = ? UNION SELECT media_id FROM db2.audio WHERE play_count = ?)", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db,  "SELECT COUNT(media_id) FROM main.audio WHERE play_count = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt,2, playing_info->play_id);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->pick_count = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            playing_info->pick_count = 0;
        }
        pls_sql_finalize(stmt);

         /* played_count */
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE play_count = ? AND ordinal <= ? UNION SELECT media_id FROM db2.audio WHERE play_count = ? AND ordinal <= ?)", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db,  "SELECT COUNT(media_id) FROM main.audio WHERE play_count = ? AND ordinal <= ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        //MAUI_02948052
        //should bind ordinal to select the count of aready played items
        //Very core code for get play count info
        //also effect W1112MP version at list
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->ordinal);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->played_count = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            playing_info->played_count = 0;
        }
        pls_sql_finalize(stmt);
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(playing_info->plst_id < 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE play_count = ?", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE play_count = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->pick_count = sqlite3_column_kal_uint32(stmt,0);
        }
        else
        {
            playing_info->pick_count = 0;
        }
        pls_sql_finalize(stmt);

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(playing_info->plst_id < 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE play_count = ? AND ordinal <= ?", &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE play_count = ? AND ordinal <= ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        //MAUI_02948052
        //should bind ordinal to select the count of aready played items
        //Very core code for get play count info
        //also effect W1112MP version at list
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            playing_info->played_count = sqlite3_column_kal_uint32(stmt,0);
        }
        else
        {
            playing_info->played_count = 0;
        }
        pls_sql_finalize(stmt);
    }
    if(ret != SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        ret = SRV_PLST_OK;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_active_idx
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_active_idx(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 id, srv_plst_active_type_enum type, U32 *index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U32 media_id = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
    {
        ret =  SRV_PLST_RET_ERR_PARAM_ERR;
    }
    else
    {
        UI_character_type name[SRV_PLST_META_INFO_MAX_LEN + 1];
        U32 album_id = 0;
        U16 ischar = 0;
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->plst_id > 0X8000)
            {
                ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?", &stmt);
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                ret = pls_sql_prepare_ex(db, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?", &stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->current_picked_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                media_id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
                return ret;
            }
        }
        else
        {
            media_id = id;
        }

        name[0] = 0;
        if(media_id > 0X8000)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ret = pls_sql_prepare_ex(db, "SELECT album.album_id, album.p_name, album.ischar FROM main.audio, main.album WHERE media_id = ? AND audio.album_id = album.album_id", &stmt);
            }
            else
            {
                ret = pls_sql_prepare_ex(db, "SELECT album.album_id, album_name FROM main.audio, main.album WHERE media_id = ? AND audio.album_id = album.album_id", &stmt);
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ret = pls_sql_prepare_ex(db, "SELECT album.album_id, album.p_name, album.ischar FROM db2.audio, db2.album WHERE media_id = ? AND audio.album_id = album.album_id", &stmt);
            }
            else
            {
                ret = pls_sql_prepare_ex(db, "SELECT album.album_id, album_name FROM db2.audio, db2.album WHERE media_id = ? AND audio.album_id = album.album_id", &stmt);
            }
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, media_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            album_id = sqlite3_column_kal_uint32(stmt,0);
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt,1)))
            {
                mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 1), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ischar = sqlite3_column_kal_uint16(stmt,2);
            }
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            return ret;
        }
        //playing_info->active_id = album_id;
        /* count index */
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM (SELECT album_id, album_name from main.album WHERE ischar = ? AND p_name = ? AND album_id <= ? UNION \
SELECT album_id, album_name FROM db2.album WHERE ischar = ? AND p_name = ? AND album_id <= ?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM main.album WHERE ischar = ? AND p_name = ? AND album_id <= ?");
            }
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM (SELECT album_id, album_name from main.album WHERE album_name <= ? UNION \
SELECT album_id, album_name FROM db2.album WHERE album_name <= ?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM main.album WHERE album_name <= ?");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 1, ischar);
            sqlite3_bind_kal_wstr(stmt, 2, name);
            sqlite3_bind_kal_uint32(stmt, 3, album_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 4, ischar);
                sqlite3_bind_kal_wstr(stmt, 5, name);
                sqlite3_bind_kal_uint32(stmt, 6, album_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 2, name);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db,stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *index = sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            *index = 0;
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM (SELECT album_id, album_name from main.album WHERE ischar = ? AND p_name < ? UNION \
SELECT album_id, album_name FROM db2.album WHERE ischar = ? AND p_name < ?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM main.album WHERE ischar = ? AND p_name < ?");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint16(stmt, 1, ischar);
            sqlite3_bind_kal_wstr(stmt, 2, name);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 3, ischar);
                sqlite3_bind_kal_wstr(stmt, 4, name);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db,stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *index += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                *index = 0;
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
            
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM (SELECT album_id, album_name from main.album WHERE ischar < ? UNION \
SELECT album_id, album_name FROM db2.album WHERE ischar < ?)");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT count(album_id) FROM main.album WHERE ischar < ? ");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint16(stmt, 1, ischar);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint16(stmt, 2, ischar);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *index += sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
            }
        }
        //playing_info->active_idx = *index;
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_plst_index_by_name
 * DESCRIPTION
 *   
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_plst_index_by_name(srv_plst_db_context_struct *db, U16 *name, U32 *index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U32 count = 0;
    U32 create_time = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_PLST_INDEX_BY_NAME, 0);
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    if (base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME &&
        base->config_play_sequeue == SRV_PLST_PLST_DEFAULT_SHOW_FIRST)
    {
        /* select create time of input plst name */
#if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "SELECT create_time FROM db2.plst WHERE plst_name = ?");
        }
        else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT create_time FROM main.plst WHERE plst_name = ?");
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            create_time = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
        
        /* count the index of input plst name */
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, 
"SELECT COUNT(plst_id) FROM ( \
 SELECT * FROM ( \
  SELECT plst_id FROM main.plst WHERE plst_name != \"\" and create_time > ? \
  ORDER BY create_time DESC, plst_id DESC) \
 UNION ALL \
 SELECT * FROM ( \
  SELECT plst_id FROM db2.plst WHERE create_time > ? \
  ORDER BY create_time DESC, plst_id DESC) \
 )");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, 
"SELECT COUNT(plst_id) FROM ( \
 SELECT * FROM ( \
  SELECT plst_id, create_time FROM main.plst WHERE plst_name != \"\" and create_time > ? \
  ORDER BY create_time DESC, plst_id DESC) \
 )");
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, create_time);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 2, create_time);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }

        /* count default list */
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plst_id) FROM main.plst WHERE plst_name = \"\" ORDER BY plst_id DESC", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count += sqlite3_column_kal_uint32(stmt, 0);
        }                    
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        *index = count;
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_PLST_INDEX_BY_NAME, *index);
        return SRV_PLST_OK;
    }
    else
    {
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
        return SRV_PLST_OK;
    }
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_active_index_by_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_active_index_by_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 id, U32 *ordinal)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U16 ischar = 1;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO) /* video  list */
    {
        UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.video WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT p_name, ischar from db2.video WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT name from db2.video WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ischar = sqlite3_column_kal_uint8(stmt,1);
            }
            pls_sql_finalize(stmt);
        }
        else /* id not exist, find a new id */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_get_auto_active_id(db, playing_info, &playing_info->current_picked_id);
            playing_info->pick_no_played = MMI_TRUE;
            return ret;
        }
        
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM main.video WHERE p_name < ? AND ischar = ? ", &stmt);
        }
        else
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM main.video WHERE name < ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint8(stmt, 2, ischar);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *ordinal = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            *ordinal = 0;
        }
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM main.video WHERE ischar < ? ", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint8(stmt, 1, ischar);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal += sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *ordinal += 0;
            }
            pls_sql_finalize(stmt);
            if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret;
            }
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE p_name < ? AND ischar = ?");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE name < ?");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, name);  
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint8(stmt, 2, ischar);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal+= sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        /* count the same name */
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM main.video WHERE p_name = ? AND vdo_id < ? AND ischar = ? ");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE p_name = ? AND vdo_id < ? AND ischar = ? ) ");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM main.video WHERE name = ? AND vdo_id < ?");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name = ? AND vdo_id < ? ) ");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ret = pls_sql_prepare_ex(db, " SELECT COUNT(vdo_id) FROM main.video WHERE p_name = ? AND vdo_id < ? AND ischar = ? ", &stmt);
            }
            else
            {
                ret = pls_sql_prepare_ex(db, " SELECT COUNT(vdo_id) FROM main.video WHERE name = ? AND vdo_id < ? ", &stmt);
            }
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, id);
            sqlite3_bind_kal_uint8(stmt, 3, ischar);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
               sqlite3_bind_kal_wstr(stmt, 4, name);
               sqlite3_bind_kal_uint32(stmt, 5, id);
               sqlite3_bind_kal_uint8(stmt, 6, ischar);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 1, name);
            sqlite3_bind_kal_uint32(stmt, 2, id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, name);
                sqlite3_bind_kal_uint32(stmt, 4, id);                   
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *ordinal += sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);
    }
#ifdef __MARK_SEVERAL_PLAY_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO)
    {
        UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
        
        if(id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT name from db2.video WHERE vdo_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
        }
        else /* id not exist, find a new id */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_get_auto_active_id(db, playing_info, &playing_info->current_picked_id);
            playing_info->pick_no_played = MMI_TRUE;
            return ret;            
        }
        
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        // to do: should mofidy if support multi select to play for performance issue
        if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) ||
           (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM ( SELECT vdo_id FROM main.video WHERE name < ? AND vdo_id NOT IN (SELECT id FROM db2.play) ");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name < ?  AND vdo_id NOT IN (SELECT id FROM db2.play))");  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.video WHERE name < ? AND vdo_id NOT IN (SELECT id FROM main.play) ");
            }
        }
        else if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM db2.play, main.video WHERE play.id = video.vdo_id AND name < ?");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.play, db2.video WHERE play.id = video.vdo_id AND name < ?) ");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            else
            {
                sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.play, main.video WHERE play.id = video.video_id AND name < ? ");
            }
        }            
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 3, name);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);                
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *ordinal = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            *ordinal = 0;
        }
        pls_sql_finalize(stmt);

        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        /* count same name */
        if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) ||
           (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM ( SELECT vdo_id FROM main.video WHERE name = ? AND vdo_id < ? AND vdo_id NOT IN (SELECT id FROM db2.play) ");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.video WHERE name = ? AND vdo_id < ? AND vdo_id NOT IN (SELECT id FROM db2.play))");  
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.video WHERE name = ? AND vdo_id < ? AND vdo_id NOT IN (SELECT id FROM main.play) ");
            }
        }
        else if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM (SELECT vdo_id FROM db2.play, main.video WHERE play.id = video.vdo_id AND name = ? AND vdo_id < ? ");
                strcat(db->sql_cmd, " UNION SELECT vdo_id FROM db2.play, db2.video WHERE play.id = video.vdo_id AND name = ? AND vdo_id < ?) ");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, " SELECT COUNT(vdo_id) FROM main.play, main.video WHERE play.id = video.video_id AND name = ? AND vdo_id < ?");
            }
        }            
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, id);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 3, name);
            sqlite3_bind_kal_uint32(stmt, 4, id);                
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *ordinal += sqlite3_column_kal_uint32(stmt, 0);
        }
        pls_sql_finalize(stmt);
    }
#endif /*__MARK_SEVERAL_PLAY_SUPPORT__*/
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
        //bql: MAUI_02456110
        U16 track_num = 0;

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {        
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT p_name, ischar, track_num FROM main.audio WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT p_name, ischar, track_num from db2.audio WHERE media_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT name from db2.audio WHERE media_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*) name, (S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_PLST_META_INFO_MAX_LEN);
            }
            else
            {
                name[0] = 0;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                ischar = sqlite3_column_kal_uint8(stmt, 1);
                track_num = sqlite3_column_kal_uint16(stmt, 2);
            }
            pls_sql_finalize(stmt);
        }
        else /* id not exist, find a new id */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_get_auto_active_id(db, playing_info, &playing_info->current_picked_id);
            playing_info->pick_no_played = MMI_TRUE;
            return ret;            
        }
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
//bql: MAUI_02456110
        if(!playing_info->play_info.current_index ||
            (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA &&
            (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)))
        {
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name < ? AND ischar = ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name < ? AND artist_id = ? AND ischar = ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE (p_name < ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND album_id = ?) ");
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name < ? AND genre_id = ? AND ischar = ?");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
                else
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name < ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name < ? AND artist_id = ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name < ? AND album_id = ?");
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name < ? AND genre_id = ?");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                }
            }
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO)
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) ||
                       (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM ( SELECT media_id FROM db2.play, main.audio WHERE name < ? AND play.id = audio.media_id ");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.play, db2.audio WHERE name < ? AND play.id = audio.media_id ");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM play, audio WHERE name < ? AND play.id = audio.media_id");
                        }
                    }
                    else if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name < ? AND media_id NOT IN (SELECT id FROM db2.play) ");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name < ? AND media_id NOT IN (SELECT id FROM db2.play)) ");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE name < ? AND media_id NOT IN (SELECT id FROM play) ");
                        }
                    }
                    else
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }
                else if(playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA &&
                            (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE))
                {
                  // to do: update the performance issue when multi select play support
                #if 0  
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
                    #endif
                }
                else /* not audio and temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }                    
            #endif
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint16(stmt, 3, track_num);
                    sqlite3_bind_kal_uint16(stmt, 4, track_num);
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                }
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint8(stmt, 3, ischar);
                }
            }
            else if( playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint8(stmt, 2, ischar);
                }
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal = sqlite3_column_kal_uint32(stmt, 0);
            }
            else 
            {
                *ordinal = 0;
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            //bql: MAUI_02949969
			//Side effect of MAUI_02919472
			//revise "||" to "&&"
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN &&
            playing_info->play_info.view_type[0] != SRV_PLST_VIEW_ALBUM)
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                {                
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE ischar < ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE ischar < ? AND artist_id = ? ");
                    }
                    //else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    //{
                        //bql: skip
                        //sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE album_id = ? AND track_num = ?");
                    //}
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE ischar < ? AND genre_id = ? ");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    //if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    //{
                        //bql: skip
                        //sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
                        //sqlite3_bind_kal_uint16(stmt, 2, track_num);
                    //}
                    //else 
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                    }
                    else if( playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint16(stmt, 1, ischar);
                    }
                    else
                    {
                        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        ret = SRV_PLST_OK;
                        *ordinal += sqlite3_column_kal_uint32(stmt, 0);
                    }
                    else 
                    {
                        *ordinal += 0;
                    }
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            }
            /* count the card*/
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE p_name < ? AND ischar = ?");                       
                        }
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE p_name < ? AND artist_id = ? AND ischar = ?");                       
                        }
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE (p_name < ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND album_id = ?) ");
                        }
                    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE p_name < ? AND genre_id = ? AND ischar = ?");
                        }
                    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    }
                    else
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE name < ?");                       
                        }
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE name < ? AND artist_id = ?");                       
                        }
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE name < ? AND album_id = ?");
                        }
                    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE name < ? AND genre_id = ?");
                        }
                    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint16(stmt, 3, track_num);
                        sqlite3_bind_kal_uint16(stmt, 4, track_num);
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);  
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint8(stmt, 3, ischar);
                    }
                }
                else if( playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        sqlite3_bind_kal_uint8(stmt, 2, ischar);
                    }
                }
                else
                {
                    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *ordinal+= sqlite3_column_kal_uint32(stmt, 0);
                }  
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                //bql: MAUI_02919472
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN &&
                playing_info->play_info.view_type[0] != SRV_PLST_VIEW_ALBUM)
                {
                    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
                    {                
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE ischar < ?");
                        }
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE ischar < ? AND artist_id = ? ");
                        }
                        //else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        //{
                            //bql: skip
                            //sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE album_id = ? AND track_num = ?");
                        //}
                    #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM db2.audio WHERE ischar < ? AND genre_id = ? ");
                        }
                    #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }

                        //if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM )
                        //{
                            //bql: skip
                            //sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
                            //sqlite3_bind_kal_uint16(stmt, 2, track_num);
                        //}
                        //else 
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                        {
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                        }
                        else if( playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint16(stmt, 1, ischar);
                        }
                        else
                        {
                            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            ret = SRV_PLST_OK;
                            *ordinal += sqlite3_column_kal_uint32(stmt, 0);
                        }
                        else 
                        {
                            *ordinal += 0;
                        }
                        pls_sql_finalize(stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    }
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            /* count the same */
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE p_name = ? AND media_id < ? AND ischar = ?");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE p_name = ? AND media_id < ? AND ischar = ?)");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name = ?  AND media_id < ? AND ischar = ?");
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name = ? AND media_id < ?");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name = ? AND media_id < ?)");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name = ?  AND media_id < ?");
                        }
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                   const S8* ptr;
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else
                    {
                        ptr = Sqlgenreid;
                    }
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        //bql: MAUI_02919472
                        if (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                //bql: MAUI_02930556 (side effect of MAUI_02919472)
                                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id)FROM (SELECT media_id FROM main.audio WHERE p_name = ? AND media_id < ? AND %s AND track_num = ?\
                                UNION SELECT media_id FROM db2.audio WHERE p_name = ? AND media_id < ? AND %s AND track_num = ?)", ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name = ?  AND media_id < ? AND %s AND track_num = ?", ptr);
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id)FROM (SELECT media_id FROM main.audio WHERE p_name = ? AND media_id < ? AND %s AND ischar = ? \
                                UNION SELECT media_id FROM db2.audio WHERE p_name = ? AND media_id < ? AND %s AND ischar = ?)", ptr, ptr);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE p_name = ?  AND media_id < ? AND %s AND ischar = ? AND track_num = ?", ptr);
                            }
                        }

                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id)FROM (SELECT media_id FROM main.audio WHERE name = ? AND media_id < ? AND %s \
UNION SELECT media_id FROM db2.audio WHERE name = ? AND media_id < ? AND %s)", ptr, ptr);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM main.audio WHERE name = ?  AND media_id < ? AND %s", ptr);
                        }
                    }
                }
            }
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO)
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) ||
                       (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM ( SELECT media_id FROM db2.play, main.audio WHERE name = ? AND media_id < ? AND play.id = audio.media_id ");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.play, db2.audio WHERE name = ? AND media_id < ? AND play.id = audio.media_id ");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM play, audio WHERE name = ? AND media_id < ? AND play.id = audio.media_id");
                        }
                    }
                    else if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name = ? AND media_id < ? AND media_id NOT IN (SELECT id FROM db2.play) ");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name = ? AND media_id < ? AND media_id NOT IN (SELECT id FROM db2.play)) ");
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE name = ? AND media_id < ? AND media_id NOT IN (SELECT id FROM play) ");
                        }
                    }
                    else
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }
                else if(playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA &&
                            (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE))
                {
                    const S8* ptr;
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else
                    {
                        ptr = Sqlgenreid;
                    }
                    if((playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all) ||
                      (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM ( SELECT media_id FROM db2.play, main.audio WHERE name = ? AND media_id < ? AND %s \
AND play.id = audio.media_id UNION SELECT media_id FROM db2.play, db2.audio WHERE name = ? AND media_id < ? AND %s AND play.id = audio.media_id", ptr, ptr);
                            
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM play, audio WHERE name = ? AND media_id < ? AND %s AND play.id = audio.media_id", ptr);
                        }
                    }
                    else if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM (SELECT media_id FROM main.audio WHERE name = ? AND media_id < ? AND %s AND \
media_id NOT IN (SELECT id FROM db2.play) UNION SELECT media_id FROM db2.audio WHERE name = ? AND media_id < ? AND %s AND media_id NOT IN (SELECT id FROM db2.play))", ptr, ptr);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE name = ? AND media_id < ? AND %s AND media_id NOT IN (SELECT id FROM play)", ptr);                         
                        }
                    }
                    else
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }
                else /* not audio and temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }                    
            #endif
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    //bql: MAUI_02919472
                    if (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        sqlite3_bind_kal_uint16(stmt, 4, track_num);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint8(stmt, 4, ischar);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, id);
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                        if (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                            sqlite3_bind_kal_uint16(stmt, 8, track_num);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint8(stmt, 8, ischar);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 4, name);
                        sqlite3_bind_kal_uint32(stmt, 5, id);
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->plst_id);                
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }

            if( playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint8(stmt, 3, ischar);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 4, name);
                        sqlite3_bind_kal_uint32(stmt, 5, id);
                        sqlite3_bind_kal_uint32(stmt, 6, ischar);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 3, name);
                        sqlite3_bind_kal_uint32(stmt, 4, id);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal += sqlite3_column_kal_uint32(stmt, 0);
            }
            else 
            {
                *ordinal += 0;
            }
            pls_sql_finalize(stmt);
        }
//bql: MAUI_02660488
        else if(playing_info->play_info.current_index >= 1)
        {// bql: only support artist -> album -> media which is based on original code
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id, p_name FROM main.audio WHERE (p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?) ");
                        strcat(db->sql_cmd, " UNION SELECT media_id, p_name FROM db2.audio WHERE (p_name < ? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)  )");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE (p_name < ? AND artist_id = ? AND album_id = ? AND track_num = ?)  OR (track_num < ? AND artist_id = ? AND album_id = ?) ");
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id, name FROM main.audio WHERE name <? AND artist_id = ? AND album_id = ?");
                        strcat(db->sql_cmd, " UNION SELECT media_id, name FROM db2.audio WHERE name < ? AND artist_id = ? AND album_id = ? )");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE name < ? AND artist_id = ? AND album_id = ?");
                    }
                }
            }
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO)
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM &&
                    (playing_info->play_info.current_index == 1 || (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)))
                {
                    if(IS_CARD_EXIST)
                    {
                        if((playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all) ||
                            (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio, db2.play WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND play.id = audio.media_id");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio, db2.play WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND play.id = audio.media_id");
                        }
                        else if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND media_id NOT IN (SELECT id FROM db2.play)");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND media_id NOT IN (SELECT id FROM db2.play)");
                        }
                    }
                    else if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                    {
                        if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio, play WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND play.id = audio.media_id");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio WHERE ((p_name <? AND artist_id = ? AND album_id = ? AND track_num = ?) OR (track_num < ? AND artist_id = ? AND album_id = ?)) AND media_id NOT IN (SELECT id FROM db2.play)");
                        }
                    }
                    else
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }
                else 
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }               
            }
        #endif
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

            
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);   
                }
                sqlite3_bind_kal_uint16(stmt, 4, track_num);
                sqlite3_bind_kal_uint16(stmt, 5, track_num);
                sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[1]);   
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 8, name);
                    sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 10, playing_info->plst_id);
                    }
                    else 
                    {
                        sqlite3_bind_kal_uint32(stmt, 10, playing_info->play_info.id[1]);   
                    }
                    sqlite3_bind_kal_uint16(stmt, 11, track_num);
                    sqlite3_bind_kal_uint16(stmt, 12, track_num);
                    sqlite3_bind_kal_uint32(stmt, 13, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 14, playing_info->plst_id);
                    }
                    else 
                    {
                        sqlite3_bind_kal_uint32(stmt, 14, playing_info->play_info.id[1]);   
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);   
                }
                
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 4, name);
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->plst_id);
                    }
                    else 
                    {
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[1]);   
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *ordinal = 0;
            }
            pls_sql_finalize(stmt);

            /*  count the same  */
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {    
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id, p_name FROM main.audio WHERE p_name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ?");
                        strcat(db->sql_cmd, " UNION SELECT media_id, p_name FROM db2.audio WHERE p_name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ?)");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE p_name = ? AND media_id < ? AND artist_id = ?  AND album_id = ? AND track_num = ?");
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ?");
                        strcat(db->sql_cmd, " UNION SELECT media_id, name FROM db2.audio WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? )");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE name = ? AND media_id < ? AND artist_id = ?  AND album_id = ?");
                    }
                }
            }
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO)
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM &&
                    (playing_info->play_info.current_index == 1 || (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)))
                {
                    if(IS_CARD_EXIST)
                    {
                        if((playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all) ||
                            (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio, db2.play WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND play.id = audio.media_id AND track_num = ?");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio, db2.play WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND play.id = audio.media_id AND track_num = ?");
                        }
                        else if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ? AND media_id NOT IN (SELECT id FROM db2.play)");
                            strcat(db->sql_cmd, " UNION SELECT media_id FROM db2.audio WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ? AND media_id NOT IN (SELECT id FROM db2.play)");
                        }
                    }
                    else if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                    {
                        if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio, play WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ? AND play.id = audio.media_id");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT COUNT(media_id) FROM audio WHERE name = ? AND media_id < ? AND artist_id = ? AND album_id = ? AND track_num = ? AND media_id NOT IN (SELECT id FROM db2.play)");
                        }
                    }
                    else
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }
                else 
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }               
            }
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);   
                }
                sqlite3_bind_kal_uint16(stmt, 5, track_num);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 6, name);
                    sqlite3_bind_kal_uint32(stmt, 7, id);
                    sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                    }
                    else 
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[1]);   
                    }
                    sqlite3_bind_kal_uint16(stmt, 10, track_num);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);   
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 5, name);
                    sqlite3_bind_kal_uint32(stmt, 6, id);
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 8, playing_info->plst_id);
                    }
                    else 
                    {
                        sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[1]);   
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *ordinal += sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *ordinal = 0;
            }
            pls_sql_finalize(stmt);
        }
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        ||playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST 
        #endif
        )
    {// todo
        U32 index = 0;
        
        if(playing_info->plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT idx FROM main.plst_item WHERE plstitem_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT idx FROM db2.plst_item WHERE plstitem_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        { 
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            index = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else if(ret == SRV_PLST_OK)
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_get_auto_active_id(db, playing_info, &playing_info->current_picked_id);
            playing_info->pick_no_played = MMI_TRUE;
            return ret;   
        }
        else        
        {
            pls_sql_finalize(stmt);
            return ret;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM main.plst_item WHERE idx > ? AND plst_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE idx > ? AND plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM main.plst_item WHERE idx < ? AND plst_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE idx < ? AND plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST)
        {
            if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) ||
               (playing_info->play_info.is_mark && !playing_info->play_info.is_mark_all && !playing_info->play_info.is_unmark_all))
            {
                if(IS_CARD_EXIST)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE idx < ? AND plst_id = ? ");
                        strcat(db->sql_cmd, " AND plstitem_id NOT IN (SELECT id FROM db2.play) ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE idx < ? AND plst_id = ?  ");
                        strcat(db->sql_cmd, " AND plstitem_id NOT IN (SELECT id FROM db2.play) ");
                    }
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE idx < ? AND plst_id = ? ");
                    strcat(db->sql_cmd, " AND plstitem_id NOT IN (SELECT id FROM main.play) ");               
                }
            }
            else if(playing_info->play_info.is_mark && playing_info->play_info.is_unmark_all)
            {
                if(IS_CARD_EXIST)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM db2.play,main.plst_item WHERE idx < ? AND plst_id = ? AND play.id = plst_item.plstitem_id");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM db2.play,db2.plst_item WHERE idx < ? AND plst_id = ? AND play.id = plst_item.plstitem_id");
                    }
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.play, main.plst_item WHERE idx < ? AND plst_id = ? AND play.id = plst_item.plstitem_id");              
                }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            } 
        }
    #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, index);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *ordinal = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            *ordinal = 0;
        }
        pls_sql_finalize(stmt);
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
    }
    return ret;
}

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static S32 pls_sql_get_active_media_id_for_video_by_drv_by_offset(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, MMI_BOOL is_card, U32 rands_id, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO) /* video  list */
    {
        if(is_card)
        {
            sprintf(db->sql_cmd, "SELECT vdo_id, name FROM db2.video WHERE play_count != ? limit 1 offset ?");
        }
        else
        {            
            sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE play_count != ? limit 1 offset ?");
        } 
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 2, rands_id - 1);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            ret = SRV_PLST_OK;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);

            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info,*id, &playing_info->pick_index);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
            }

            if(*id > 0X8000)
            {
                ret_t = pls_sql_prepare_ex(db, "UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?", &stmt);
            }
            else
            {
                ret_t = pls_sql_prepare_ex(db, "UPDATE db2.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?", &stmt);
            }
            if(ret_t != SRV_PLST_OK)
            {
                return SRV_PLST_RET_ERR_SQLITE_ERR;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret_t == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                return ret_t;
            }
            return ret;
        }
        pls_sql_finalize(stmt);
        return ret;      
    }    
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

static S32 pls_sql_get_active_media_id_for_plst_by_drv_by_offset(srv_plst_db_context_struct * db, srv_plst_playing_context_struct * playing_info, MMI_BOOL is_card, U32 rands_id, U32 * id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U32 plstitem_id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
       if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->plst_id > 0X8000)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? limit 1 offset ?");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? AND media_id > 32768 limit 1 offset ?");
                }
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else 
            {
                sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM db2.plst_item WHERE play_count != ? AND plst_id = ? limit 1 offset ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
        sqlite3_bind_kal_uint32(stmt, 3, rands_id - 1);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            ret = SRV_PLST_OK;
            plstitem_id = sqlite3_column_kal_uint32(stmt, 0);
            *id = plstitem_id; 
            playing_info->current_picked_id = plstitem_id;
            pls_sql_finalize(stmt);
            /* udpate info */
            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "UPDATE db2.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt, 3, plstitem_id);
            ret_t = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);  
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }     
            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id , &playing_info->pick_index);

                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
            }
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}


static S32 pls_sql_get_active_media_id_for_audio_by_drv_by_offset(srv_plst_db_context_struct * db, srv_plst_playing_context_struct * playing_info, MMI_BOOL is_card, U32 rands_id, U32 * id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/      
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(!playing_info->play_info.current_index ||
            (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA &&
            (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)))
        { 

            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(is_card)
                    {
                        sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE play_count != ? limit 1 offset ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE play_count != ? limit 1 offset ?");
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    const S8* ptr;

                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else
                    {
                        ptr = Sqlgenreid;
                    }
                    if(is_card)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE play_count != ? AND %s limit 1 offset ?", ptr);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE play_count != ? AND %s limit 1 offset ?", ptr);
                    }
                }
                else 
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }                            
                      
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);  
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                sqlite3_bind_kal_uint32(stmt, 2, rands_id - 1);
            }

            if(!playing_info->play_info.current_index && 
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 3, rands_id - 1);
            }
            else if(playing_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                sqlite3_bind_kal_uint32(stmt, 3, rands_id - 1);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                ret = SRV_PLST_OK;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);

                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                }
                return ret;
            }
            pls_sql_finalize(stmt);
            return ret;
        }   
        else if(playing_info->play_info.current_index >= 1) /* entry list depth >= 1 */
        { 
          
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM &&
                    (playing_info->play_info.current_index == 1 || (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)))
                {
                     if(is_card)
                    {
                        sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE play_count != ? AND artist_id = ? AND album_id = ? limit 1 offset ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE play_count != ? AND artist_id = ? AND album_id = ? limit 1 offset ?");
                    }
                }
                else 
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }                
            else /* not audio and  not temp_audio */
            {
                ret = SRV_PLST_RET_ERR_PARAM_ERR;
                return ret;
            }            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
            if(playing_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
            }
            else 
            {
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);   
            }    
            sqlite3_bind_kal_uint32(stmt, 4, rands_id - 1);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);                
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }

                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                }
                return ret;
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
}

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
static S32 pls_sql_get_active_media_id_for_video_by_drv(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, MMI_BOOL is_card, MMI_BOOL find_local, U32 rands_id, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO) /* video  list */
    {
        if(find_local) /* found larger than rands_id */
        {
            if(is_card)
            {
                sprintf(db->sql_cmd, "SELECT vdo_id, name FROM db2.video WHERE vdo_id > ? AND play_count != ?");
            }
            else
            {            
                sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE vdo_id > ? AND play_count != ?");
            }

        }
        else /* find smaller than rands_id */
        {
            if(is_card)
            {
                sprintf(db->sql_cmd, "SELECT vdo_id, name FROM db2.video WHERE vdo_id <= ? AND play_count != ?");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE vdo_id <= ? AND play_count != ?");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, rands_id);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
        ret = pls_sql_step_ex(db, stmt);

        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            U32 ret_t;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info,*id, &playing_info->pick_index);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
            }
            if(*id > 0X8000)
            {
                ret_t = pls_sql_prepare_ex(db, "UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?", &stmt);
            }
            else
            {
                ret_t = pls_sql_prepare_ex(db, "UPDATE db2.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?", &stmt);
            }
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret_t != SRV_PLST_OK)
            {
                ret = ret_t;
            }
            return ret;
        }
        pls_sql_finalize(stmt);
        return ret;      
    }    
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

static S32 pls_sql_get_active_media_id_for_plst_by_drv(srv_plst_db_context_struct * db, srv_plst_playing_context_struct * playing_info, MMI_BOOL is_card, MMI_BOOL find_local, U32 rands_id, U32 * id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U32 plstitem_id;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(find_local)/* find larger */
        {
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                if(playing_info->plst_id > 0X8000)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE plstitem_id > ? AND play_count != ? AND plst_id = ?");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE plstitem_id > ? AND play_count != ? AND plst_id = ? AND media_id > 32768");
                    }
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM db2.plst_item WHERE plstitem_id > ? AND play_count != ? AND plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        else /* find smaller than rands_id */
        {
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                if(playing_info->plst_id > 0X8000)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE plstitem_id <= ? AND play_count != ? AND plst_id = ?");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM main.plst_item WHERE plstitem_id <= ? AND play_count != ? AND plst_id = ? AND media_id > 32768");
                    }
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else 
                {
                    sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM db2.plst_item WHERE plstitem_id <= ? AND play_count != ? AND plst_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, rands_id);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            plstitem_id = sqlite3_column_kal_uint32(stmt, 0);
            *id = plstitem_id; 
            playing_info->current_picked_id = plstitem_id;
            pls_sql_finalize(stmt);
            /* udpate info */
            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, "UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "UPDATE db2.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt, 3, plstitem_id);
            ret_t = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);  
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }  

            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id , &playing_info->pick_index);

                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
            }
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}



static S32 pls_sql_get_active_media_id_for_audio_by_drv(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, MMI_BOOL is_card, MMI_BOOL find_local, U32 rands_id, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    const S8* ptr = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/      
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
        {
            ptr = Sqlartistid;
        }
        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
        {
            ptr = Sqlalbumid;
        }
        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
        {
            ptr = Sqlgenreid;
        }
        
        if(!playing_info->play_info.current_index ||
            (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA &&
            (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)))
        { 
            if(find_local)/* find larger */            
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        if(is_card)
                        {
                            sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id > ? AND play_count != ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE media_id > ?  AND play_count != ?");
                        }
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        if(is_card)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id > ? AND play_count != ? AND %s", ptr);
                        }
                        else
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE media_id > ?  AND play_count != ? AND %s", ptr);
                        }
                    }
                    else 
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }                
                else /* active type is not audio/ temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }
            else /* find smaller than rands_id */
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        if(is_card)
                        {
                            sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id <= ? AND play_count != ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE media_id <=  ?  AND play_count != ?");
                        }
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        if(is_card)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id <=  ? AND play_count != ? AND %s", ptr);
                        }
                        else
                        {
                            kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE media_id <=  ?  AND play_count != ? AND %s", ptr);
                        }
                    }
                }
                else /* active type is not audio/ temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            } /* end of smaller */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, rands_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);            

            if(!playing_info->play_info.current_index && 
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
            }
            else if(playing_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                }
                return ret;
            }
            pls_sql_finalize(stmt);
            return ret;
        }   
        else if(playing_info->play_info.current_index >= 1) /* entry list depth >= 1 */
        { 
            if(find_local)/*find larger */
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM &&
                        (playing_info->play_info.current_index == 1 || (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)))
                    {
                         if(is_card)
                        {
                            sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id > ? AND play_count != ? AND artist_id = ? AND album_id = ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE media_id > ?  AND play_count != ? AND artist_id = ? AND album_id = ?");
                        }
                    }
                    else 
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }                
                else /* not audio and  not temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }
            else /* find smaller */
            {
                if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO) /* audio type */
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM &&
                        (playing_info->play_info.current_index == 1 || (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)))
                    {
                         if(is_card)
                        {
                            sprintf(db->sql_cmd, "SELECT media_id, name FROM db2.audio WHERE media_id <= ? AND play_count != ? AND artist_id = ? AND album_id = ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE media_id <= ?  AND play_count != ? AND artist_id = ? AND album_id = ?");
                        }
                    }
                    else 
                    {
                        ret = SRV_PLST_RET_ERR_PARAM_ERR;
                        return ret;
                    }
                }                                            
                else /* not audio and temp_audio */
                {
                    ret = SRV_PLST_RET_ERR_PARAM_ERR;
                    return ret;
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, rands_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
            if(playing_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
            }
            else 
            {
                sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);   
            }            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }

                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                }
                return ret;
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
}



/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_id_by_ordinal
 * DESCRIPTION
 *   get id by checking the previous selected order, used in shuffle on or most/recent list case
 * PARAMETERS
 *  db              [IN]
 *  playing_info    [IN]
 *  manul_pre       [IN] Is previous song
 *  find_flag       [IN]
 *  id              [OUT]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_id_by_ordinal(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info,MMI_BOOL manul_pre, MMI_BOOL find_flag, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    U32 temp_index = 0;
    srv_plst_base_info_struct *base;
    const S8 *ptr = NULL, *ptr2 = NULL, *ptr3 = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);   

    /* Check if item has already been selected and ordered */
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE play_count = ? AND ordinal = ?");
            strcat(db->sql_cmd, " UNION SELECT media_id, name FROM db2.audio WHERE play_count = ? AND ordinal = ?");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, " SELECT media_id, name FROM main.audio WHERE play_count = ? AND ordinal = ?");
        }
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(playing_info->plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE play_count = ? AND ordinal = ? and plst_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE play_count = ? AND ordinal = ? and plst_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, " SELECT vdo_id, name FROM main.video WHERE play_count = ? AND ordinal = ?");
            strcat(db->sql_cmd, " UNION SELECT vdo_id, name FROM db2.video WHERE play_count = ? AND ordinal = ?");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, " SELECT vdo_id, name FROM main.video WHERE play_count = ? AND ordinal = ?");
        }       
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    name[0] = 0;
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
    sqlite3_bind_kal_uint32(stmt, 2, playing_info->ordinal);
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
    }
    else 
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->ordinal);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        *id = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_finalize(stmt);

        if(playing_info->is_update_index)
        {
            ret = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
        }
        if(ret == SRV_PLST_OK)
        {
            ret = SRV_PLST_RET_ITEM_EXIST;
        }        
        return ret;
    }
    else
    {
        pls_sql_finalize(stmt);
    }
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    /* Assign query codition string pointer */
    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
    {
        ptr = Sqlartistid;
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
    {
        ptr = Sqlalbumid;
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
    {
        ptr = Sqlgenreid;
    }

    /* shuffle off, play from middle to end and then should be from the begin to play */
    if(base->shuffle == SRV_PLST_SHUFFLE_OFF &&
        (((playing_info->pick_index + 1) == playing_info->total) && !find_flag) ||
        (playing_info->pick_index == 0 && manul_pre))        
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {          
            if(manul_pre)
            {
                ptr2 = SqlOnaiddesc;
            }
            else
            {
                ptr2 = SqlOnaidasc;
            }  

            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {                    
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
play_count != ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE play_count != ? %s)) %s", ptr2, ptr2, ptr2);    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                       kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE play_count != ? %s", ptr2);
                    }
                    
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE \
play_count != ? AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE play_count != ? AND %s%s))%s", ptr, ptr2, ptr, ptr2, ptr2);                   
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE play_count != ?  AND %s%s", ptr, ptr2); 
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }     
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt, 4, 1);
                    sqlite3_bind_kal_uint32(stmt, 5, 1);
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_AUDIO)
                    {   
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                    }

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 6, 1);
                        sqlite3_bind_kal_uint32(stmt, 7, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE play_count != ? \
AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE play_count != ? AND artist_id = ? \
AND album_id = ? %s)) %s", ptr2, ptr2, ptr2);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE play_count != ? AND artist_id = ?  AND album_id = ? %s", ptr2);
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 4, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_id);    
                    sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 8, 1);
                    sqlite3_bind_kal_uint32(stmt, 9, 1);
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                    return ret;
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }            
        }       
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            if(manul_pre)
            {
                ptr2 = SqlOvideonaiddesc;
            }
            else
            {
                ptr2 = SqlOvideonaidasc;
            }
            
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE play_count != ? \
%s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE play_count != ? %s)) %s", ptr2, ptr2, ptr2);      
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE play_count != ? %s", ptr2);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                sqlite3_stmt *stmt_t;
                
                *id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->current_picked_id = *id;
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                }
                else 
                {
                    name[0] = 0;
                }
                pls_sql_finalize(stmt);
                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                    if(ret_t != SRV_PLST_OK )
                    {
                        return ret_t;     
                    }
                    else
                    {
                        return ret;
                    }
                }
            }
            else
            {
                pls_sql_finalize(stmt);  
            }
        }
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
                if(manul_pre)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? ORDER BY idx ASC limit 1");          
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE  play_count != ? AND plst_id = ? ORDER BY idx ASC limit 1 ");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? ORDER BY idx desc limit 1");          
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE  play_count != ? AND plst_id = ? ORDER idx desc limit 1 ");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
                if(manul_pre)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? ORDER BY idx DESC limit 1");          
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE  play_count != ? AND plst_id = ? ORDER BY idx DESC limit 1 ");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE play_count != ? AND plst_id = ? limit 1");          
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE  play_count != ? AND plst_id = ? limit 1 ");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t; 
                sqlite3_stmt *stmt_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.plst_item SET play_count = ?, ordinal = ? WHERE plstitem_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t); 
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                if(playing_info->is_update_index)
                {
                    ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    if(ret_t == SRV_PLST_OK)
                    {
                        return ret;
                    }
                    else
                    {
                        return ret_t;
                    }
                }
                return ret;
            }
            else
            {
            pls_sql_finalize(stmt);        
            }
            return ret;
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }    

    /* ordinal not exist, find the next */
    /* get current first */
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(playing_info->current_picked_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        if(playing_info->current_picked_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT name FROM db2.video WHERE vdo_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(playing_info->plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, " SELECT idx, ordinal FROM main.plst_item WHERE plstitem_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else 
        {
            sprintf(db->sql_cmd, "SELECT idx, ordinal FROM db2.plst_item WHERE plstitem_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, playing_info->current_picked_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
            temp_index = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
        }
        else
        {
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
            if(playing_info->is_update_index)
            {
                ret = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
            }
        }
    }
    else /* current not exist to do*/
    {
        pls_sql_finalize(stmt);   
        return ret;
    } 
    if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
    {
        return ret;
    }

    /* find the name same */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            if(find_flag)
            {
                ptr2 = Sqlvideolarg;
                ptr3 = SqlOvideonaidasc;
            }
            else
            {
                ptr2 = Sqlvideosmal;
                ptr3 = SqlOvideonaiddesc;
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name = ? \
AND play_count != ? and %s%s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ?  AND play_count != ? \
and %s%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);               
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE name = ? AND play_count != ? and %s%s", ptr2, ptr3);
            }
        }        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
        sqlite3_bind_kal_uint32(stmt, 4, 1);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 5, name);
            sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 7, playing_info->current_picked_id);
            sqlite3_bind_kal_uint32(stmt, 8, 1);
            sqlite3_bind_kal_uint32(stmt, 9, 1);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            sqlite3_stmt *stmt_t;

            *id = sqlite3_column_kal_uint32(stmt, 0);
            playing_info->current_picked_id = *id;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
            if(*id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                if(ret_t != SRV_PLST_OK )
                {
                    return ret_t;     
                }
                else
                {
                    return ret;
                }
            }
        }
        else
        {
            pls_sql_finalize(stmt);
        }
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
    }
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(find_flag)
        {
            ptr2 = Sqlmedialarger;
            ptr3 = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlmediasmaller;
            ptr3 = SqlOnaiddesc;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND play_count != ? and %s%s ) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND play_count != ? \
and %s%s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                                       
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE name = ? AND play_count != ? and %s%s", ptr2, ptr3);                    
                    }                    
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND play_count != ? AND %s AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND play_count != ? \
AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE name = ? AND play_count != ? AND %s AND %s%s", ptr2, ptr, ptr3);
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, 1);
                    sqlite3_bind_kal_wstr(stmt, 5, name);
                    sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->current_picked_id);
                    sqlite3_bind_kal_uint32(stmt, 8, 1);
                    sqlite3_bind_kal_uint32(stmt, 9, 1);
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {                    
                    if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_AUDIO)
                    {   
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 5, 1);                        
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                    }
                    
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 6, name);
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_id);
                        sqlite3_bind_kal_uint32(stmt, 8, playing_info->current_picked_id);
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 10, 1);
                        sqlite3_bind_kal_uint32(stmt, 11, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(find_flag)
                {
                    ptr2 = Sqlmedialarger;
                    ptr3 = SqlOmediaidasc;
                }
                else
                {
                    ptr2 = Sqlmediasmaller;
                    ptr3 = SqlOmediaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND play_count != ? \
AND %s AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND play_count != ? \
AND %s AND artist_id = ? AND album_id = ? %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE name = ? AND play_count != ? AND %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);                    
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
                sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 6, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 7, name);
                    sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_id);  
                    sqlite3_bind_kal_uint32(stmt, 9, playing_info->current_picked_id);
                    sqlite3_bind_kal_uint32(stmt, 10, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 11, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 11, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 12, 1);
                    sqlite3_bind_kal_uint32(stmt, 13, 1);
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t!= SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id,  &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }                
        }
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        /* do nothing */
    }


    /* find the name differrent */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        if(find_flag)
        {
            ptr2 = Sqlnamelarger;
            ptr3 = SqlOvideonaidasc;
        }
        else
        {
            ptr2 = Sqlnamesmaller;
            ptr3 = SqlOvideonaiddesc;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? %s) \
UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s AND play_count != ? %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);            
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? %s", ptr2, ptr3);                
            }
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else /* temp video */
        {
            if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? \
AND vdo_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s AND \
play_count != ? AND vdo_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? AND vdo_id NOT IN \
(SELECT id FROM play WHERE mark_flag = 0) %s", ptr2, ptr3);
                }
            }
            else
            {
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? \
AND vdo_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s AND \
play_count != ? AND vdo_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                }
                else
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s AND play_count != ? AND vdo_id IN \
(SELECT id FROM play WHERE mark_flag = 1) %s", ptr2, ptr3);
                }
            }
        }
    #endif /*__MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);    
        sqlite3_bind_kal_int32(stmt, 3, 1);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 4, name);
            sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 6, 1);
            sqlite3_bind_kal_uint32(stmt, 7, 1);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            sqlite3_stmt *stmt_t;

            *id = sqlite3_column_kal_uint32(stmt, 0);
            playing_info->current_picked_id = *id;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
            if(*id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                if(ret_t != SRV_PLST_OK )
                {
                    return ret_t;     
                }
                else
                {
                    return ret;
                }
            }
        }
        else
        {
            pls_sql_finalize(stmt);
        }        
        return ret;
    }
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(find_flag)
        {
            ptr2 = Sqlnamelarger;
            ptr3 = SqlOnaidasc;
        }
        else
        {
            ptr2 = Sqlnamesmaller;
            ptr3 = SqlOnaiddesc;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND \
play_count != ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND play_count != ? %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                     
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? %s", ptr2, ptr3);                        
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND %s%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND play_count != ? AND %s%s)) %s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                                          
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE %s AND play_count != ?  AND %s%s", ptr2, ptr, ptr3);
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, 1);
                    sqlite3_bind_kal_wstr(stmt, 4, name);
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt, 6, 1);
                    sqlite3_bind_kal_uint32(stmt, 7, 1);
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_AUDIO)
                    {   
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 4 ,1);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 8, 1);
                        sqlite3_bind_kal_uint32(stmt, 9, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(find_flag)
                {
                    ptr2 = Sqlnamelarger;
                    ptr3 = SqlOnaidasc;
                }
                else
                {
                    ptr2 = Sqlnamesmaller;
                    ptr3 = SqlOnaiddesc;
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND play_count != ? AND artist_id = ? \
AND album_id = ? %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);                 
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 6, name);
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_id);    
                    sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 10, 1);
                    sqlite3_bind_kal_uint32(stmt, 11, 1);
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    } 
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id,  &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                    return ret;
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }                
        }
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else /* temp audio */
        {
            if(find_flag)
            {
                ptr2 = Sqlnamelarger;
                ptr3 = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlnamesmaller;
                ptr3 = SqlOnaiddesc;
            }
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ?\
AND media_id NOT IN (SELECT id FROM db2.play  WHERE mark_flag = 0) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND \
play_count != ? AND media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                            
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND media_id NOT IN\
(SELECT id FROM main.play WHERE mark_flag = 0) %s", ptr2, ptr3);
                         
                        }
                    }
                    else /* mark serval */
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND media_id AND media_id IN (SELECT id FROM db2.play WHERE mark_flag = 1)%s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE \
%s AND play_count != ? AND media_id IN (SELECT id FROM db2.play  WHERE mark_flag = 1) %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                           
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        else
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND media_id IN \
(SELECT id FROM play WHERE mark_flag = 1) %s", ptr2, ptr3);                         
                        }
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND %s AND media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio \
WHERE %s AND play_count != ?  AND ordinal != ? AND %s AND media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                                               
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND %s AND media_id NOT IN \
(SELECT id FROM play WHERE mark_flag = 0) %s", ptr2, ptr, ptr3);                          
                        }
                    }
                    else /* mark serval */
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id,name FROM main.audio WHERE %s AND \
play_count != ? AND %s AND media_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s) UNION SELECT * FROM (SELECT media_id, name \
FROM db2.audio WHERE %s AND play_count != ? AND %s AND media_id IN (SELECT id FROM db2.play WHERE mark_flag = 1)%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND %s AND \
media_id IN (SELECT id FROM play WHERE mark_flag = 1) %s", ptr2, ptr, ptr3);
                        }
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }    

                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, 1);
                    sqlite3_bind_kal_wstr(stmt, 4, name);
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt, 6, 1);
                    sqlite3_bind_kal_uint32(stmt, 7, 1);
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_AUDIO)
                    {   
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 8, 1);
                        sqlite3_bind_kal_uint32(stmt, 9, 1);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(find_flag)
                {
                    ptr2 = Sqlnamelarger;
                    ptr3 = SqlOnaidasc;
                }
                else
                {
                    ptr2 = Sqlnamesmaller;
                    ptr3 = SqlOnaiddesc;
                }
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s) UNION SELECT * FROM (SELECT media_id, name \
FROM db2.audio WHERE %s AND play_count != ? AND artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) \
%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND artist_id = ?  AND album_id = ? \
AND media_id NOT IN (SELECT id FROM play WHERE mark_flag = 0) %s", ptr2, ptr3);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND play_count != ? \
AND artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s) UNION SELECT * FROM (SELECT media_id, name \
FROM db2.audio WHERE %s AND play_count != ? AND artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) \
%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND play_count != ? AND artist_id = ?  AND album_id = ? \
AND media_id IN (SELECT id FROM play WHERE mark_flag = 1) %s", ptr2, ptr3);
                    }
                }
                
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_wstr(stmt, 1, name);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_wstr(stmt, 6, name);
                    sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_id);    
                    sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 10, 1);
                    sqlite3_bind_kal_uint32(stmt, 11, 1);
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    if(playing_info->is_update_index)
                    {
                        ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index); 
                        if(ret_t != SRV_PLST_OK )
                        {
                            return ret_t;     
                        }
                        else
                        {
                            return ret;
                        }
                    }
                    return ret;
                }
                else
                {
                pls_sql_finalize(stmt);
            }
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
        {
            if(find_flag)
            {
                ptr2 = Sqlplstidxsmal;
                ptr3 = SqlOplstidxiddesc;
            }
            else
            {
                ptr2 = Sqlplstidxlarg;
                ptr3 = SqlOplstidxidasc;
            }
        }
    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
        else
        {
            if(find_flag)
            {
                ptr2 = Sqlplstidxlarg;
                ptr3 = SqlOplstidxidasc;
            }
            else
            {
                ptr2 = Sqlplstidxsmal;
                ptr3 = SqlOplstidxiddesc;
            }
        }
    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->plst_id > 0X8000)
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM  main.plst_item WHERE %s AND play_count != ? AND plst_id = ? %s", ptr2, ptr3);
                
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE %s AND play_count != ? AND plst_id = ? %s", ptr2, ptr3);                
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else /* temp list */
        {
            if(IS_CARD_EXIST)
            {
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s", ptr2, ptr3);                     
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0) %s", ptr2, ptr3);                     
                    }               
                }
                else /* mark serval */
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s", ptr2, ptr3);
                    }
                    else
                    {
                        kal_sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id IN (SELECT id FROM db2.play WHERE mark_flag = 1) %s", ptr2, ptr3);                     
                    } 
                }/* end mark serval */
            }/* end card exist */
            else
            {
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    kal_sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id NOT IN (SELECT id FROM play WHERE mark_flag = 0) %s", ptr2, ptr3);                    
                }
                else
                {
                    kal_sprintf(db->sql_cmd, " SELECT plstitem_id, idx FROM plst_item WHERE %s AND play_count != ? AND plst_id = ? \
AND plstitem_id IN (SELECT id FROM play WHERE mark_flag = 1) %s", ptr2, ptr3);
                }
            }/* end of card not exist */
        }/* end of temp plst  */
    #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, temp_index);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
        sqlite3_bind_kal_uint32(stmt, 4, 1);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t; 
            sqlite3_stmt *stmt_t;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.plst_item SET play_count = ?, ordinal = ? WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            if(playing_info->is_update_index)
            {
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                if(ret_t == SRV_PLST_OK)
                {
                    return ret;
                }
                else
                {
                    return ret_t;
                }
            }
        }
        else
        {
        pls_sql_finalize(stmt);        
    }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_id_by_sequeue
 * DESCRIPTION
 *   get id by list sorting order
 * PARAMETERS
 *  db              [IN]
 *  playing_info    [IN]
 *  next_flag       [IN] go to next or previous
 *  id              [OUT]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_id_by_sequeue(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 next_flag, U32 *id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    UI_character_type name[META_TAG_FRAME_MAX_LEN + 1];
    U32 temp_index = 0;
    U16 track_num = 0;
    const S8* ptr, *ptr2, *ptr3;
    MMI_BOOL is_most_recent = MMI_FALSE;
    srv_plst_default_playlist_enum type = SRV_PLST_DEF_LIST_ENUM_END;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/     
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);    
    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
    {
        ptr = Sqlartistid;
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
    {
        ptr = Sqlalbumid;
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
    {
        ptr = Sqlgenreid;
    }
    else
    {
        ptr = NULL;
    }

    /* shuffle off, play from middle to end and then should be from the begin to play */
    if((((playing_info->pick_index + 1) == playing_info->total) && next_flag) ||
        (playing_info->pick_index == 0 && !next_flag ))        
    {
        MMI_BOOL manul_pre = MMI_TRUE;

        if(((playing_info->pick_index + 1) == playing_info->total) && next_flag)
        {
            manul_pre = MMI_FALSE;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(manul_pre)
            {
                ptr2 = SqlOpnaiddesc;
            }
            else
            {
                ptr2 = SqlOpnaidasc;
            }
        }
        else
        {
            if(manul_pre)
            {
                ptr2 = SqlOnaiddesc;
            }
            else
            {
                ptr2 = SqlOnaidasc;
            }
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {            
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio %s) UNION SELECT * FROM \
(SELECT media_id, p_name, ischar FROM db2.audio %s)) %s", ptr2, ptr2, ptr2);                    
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, p_name, ischar FROM audio %s", ptr2);
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio %s) UNION SELECT * FROM \
(SELECT media_id, name FROM db2.audio %s)) %s", ptr2, ptr2, ptr2);                    
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio %s", ptr2);
                        }
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM   ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                            if(manul_pre)
                            {
                                ptr2 = SqlOtracknaiddesc;
                            }
                            else
                            {
                                ptr2 = SqlOtracknaidasc;
                            }
                        }
                        else
                        {
                            if(manul_pre > 0)
                            {
                                ptr2 = SqlOpnaiddesc;
                            }
                            else
                            {
                                ptr2 = SqlOpnaidasc;
                            }
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE %s%s)) %s", ptr, ptr2, ptr, ptr2, ptr2);                   

                            }
                            else
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s%s)) %s", ptr, ptr2, ptr, ptr2, ptr2);                   
                            }
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, track_num FROM audio WHERE %s%s", ptr, ptr2); 
                        } 
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s)) %s", ptr, ptr2, ptr, ptr2, ptr2);                   
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE %s%s", ptr, ptr2); 
                        }    
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }     
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, 1);
                }
                else
                {   
                    if(!playing_info->play_info.current_index)
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                    }
                    else
                    {
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint32(stmt, 5, 1);
                    }
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    ret = SRV_PLST_OK;
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);                                
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    else
                    {
                        return SRV_PLST_OK;
                    }
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                return ret;            
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(manul_pre)
                    {
                        ptr2 = SqlOtracknaiddesc;
                    }
                    else
                    {
                        ptr2 = SqlOtracknaidasc;
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name,track_num FROM main.audio WHERE artist_id = ? AND album_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE  artist_id = ? AND album_id = ? %s))%s", ptr2, ptr2, ptr2);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, p_name,track_num FROM audio WHERE artist_id = ?  AND album_id = ? %s", ptr2);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? %s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE  artist_id = ? AND album_id = ? %s))%s", ptr2, ptr2, ptr2);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE artist_id = ?  AND album_id = ? %s", ptr2);
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);   
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[1]);
                }
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 6, 1);
                    sqlite3_bind_kal_uint32(stmt, 7, 1);
                }                
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);            
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    else
                    {
                        return SRV_PLST_OK;
                    }
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                return ret;
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }            
        }       
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {// todo
            if(manul_pre)
            {
                ptr2 = SqlOvideonaiddesc;
            }
            else
            {
                ptr2 = SqlOvideonaidasc;
            }
    
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video %s) \
UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video %s))%s", ptr2, ptr2, ptr2);      
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video %s", ptr2);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                sqlite3_stmt *stmt_t;
                
                *id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->current_picked_id = *id;
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                }
                else 
                {
                    name[0] = 0;
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
                if(*id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);            
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                else
                {
                    return SRV_PLST_OK;
                }
            }
            else
            {
                pls_sql_finalize(stmt);
            }
            return ret;
        }
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {// todo
            pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
            if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
            {
                is_most_recent = MMI_TRUE;
            }            
        #endif /*__PLST_SRV_FEATURE_MOST_RECENT_LIST__*/
                
            if(manul_pre)
            {
                if(playing_info->plst_id > 0X8000)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx asc limit 1");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx DESC limit 1");          
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id asc limit 1)");
                                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id asc limit 1)) order by played asc, plstitem_id limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id asc limit 1)");
                                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id asc limit 1)) order by played_count asc, plstitem_id limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx asc limit 1");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx DESC limit 1");          
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id asc limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id asc limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx ASC limit 1 ");
                    }
                #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx DESC limit 1 ");
                    }
                #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(playing_info->plst_id > 0X8000)
                {                    
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {   
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx DESC limit 1");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx ASC limit 1");          
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)");
                                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)) order by played DESC, plstitem_id DESC limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) order by played_count DESC, plstitem_id DESC limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx DESC limit 1");          
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx ASC limit 1");          
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx DESC limit 1 ");
                    }
                #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx ASC limit 1 ");
                    }
                #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
            if(is_most_recent)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t; 
                sqlite3_stmt *stmt_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.plst_item SET play_count = ?, ordinal = ? WHERE plstitem_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);            
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                else
                {
                    return SRV_PLST_OK;
                }

            }
            else
            {
                pls_sql_finalize(stmt);        
            }
            return ret;
        }
        else
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }    
    
    /* get current first */
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
            {
                if(playing_info->current_picked_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT p_name, track_num FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT p_name, track_num FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                if(playing_info->current_picked_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT p_name, ischar FROM main.audio WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "SELECT p_name, ischar FROM db2.audio WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
        }
        else
        {
            if(playing_info->current_picked_id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT name FROM main.audio WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT name FROM db2.audio WHERE media_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
        if(playing_info->current_picked_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT name FROM main.video WHERE vdo_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT name FROM db2.video WHERE vdo_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {// todo
        pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
        {
            is_most_recent = MMI_TRUE;
        } 
    #endif /*__PLST_SRV_FEATURE_MOST_RECENT_LIST__*/
        if(playing_info->plst_id > 0X8000)
        {            
            if(!is_most_recent)
            {
                sprintf(db->sql_cmd, " SELECT idx, ordinal FROM main.plst_item WHERE plstitem_id = ?");
            }
        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
            else 
            {
                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    sprintf(db->sql_cmd, " SELECT played, ordinal FROM main.plst_item, main.meta WHERE plstitem_id = ? AND plst_item.media_id = meta.media_id ");
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {                        
                        strcat(db->sql_cmd, " UNION SELECT played, ordinal FROM main.plst_item, db2.meta WHERE plstitem_id = ? AND plst_item.media_id = meta.media_id");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sprintf(db->sql_cmd, " SELECT played_count, ordinal FROM main.plst_item, main.meta WHERE plstitem_id = ? AND plst_item.media_id = meta.media_id ");
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {                        
                        strcat(db->sql_cmd, " UNION SELECT played_count, ordinal FROM main.plst_item, db2.meta WHERE plstitem_id = ? AND plst_item.media_id = meta.media_id");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            }
        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else 
        {
            sprintf(db->sql_cmd, "SELECT idx, ordinal FROM db2.plst_item WHERE plstitem_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, playing_info->current_picked_id);
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(is_most_recent && IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
            #endif
            )
        {
            temp_index = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 0), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                track_num = sqlite3_column_kal_uint16(stmt, 1);
            }
            pls_sql_finalize(stmt);
        }
        ret = SRV_PLST_OK;
    }
    else
    {
        pls_sql_finalize(stmt);
    }     
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }

   
    /* find the name same */
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {//todo
        if(next_flag)
        {
            ptr2 = Sqlvideolarg;
            ptr3 = SqlOvideoidasc;
        }
        else
        {
            ptr2 = Sqlvideosmal;
            ptr3 = SqlOvideoiddesc;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name = ? and %s%s) \
UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name = ?  and %s%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE name = ? and %s%s", ptr2, ptr3);
            }
        }        
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
        sqlite3_bind_kal_uint32(stmt, 3, 1);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 4, name);
            sqlite3_bind_kal_uint32(stmt, 5, playing_info->current_picked_id);
            sqlite3_bind_kal_uint32(stmt, 6, 1);
            sqlite3_bind_kal_uint32(stmt, 7, 1);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            sqlite3_stmt *stmt_t;

            ret = SRV_PLST_OK;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            playing_info->current_picked_id = *id;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
            if(*id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);             
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);
        }       
    }
    else 
#endif __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(next_flag)
            {
                ptr2 = Sqlmedialarger;
                ptr3 = SqlOpnaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr3 = SqlOpnaiddesc;
            }
        }
        else
        {
            if(next_flag)
            {
                ptr2 = Sqlmedialarger;
                ptr3 = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlmediasmaller;
                ptr3 = SqlOnaiddesc;
            }
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? and %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? and %s%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, p_name,ischar FROM audio WHERE ischar = ? AND p_name = ? and %s%s", ptr2, ptr3);                     
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? and %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? and %s%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE name = ? and %s%s", ptr2, ptr3);                     
                        }
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_ALBUM)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND p_name = ? AND %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND p_name = ? AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                        
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, ischar FROM audio WHERE ischar = ? AND p_name = ? AND %s AND %s%s", ptr2, ptr, ptr3);
                            }
                        }
                        else
                        {
                            if(next_flag)
                            {
                                ptr3 = SqlOtracknaidasc;
                            }
                            else
                            {
                                ptr3 = SqlOtracknaiddesc;
                            }
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND p_name = ? AND %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE track_num = ? AND p_name = ? AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                        
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, ischar FROM audio WHERE track_num = ? AND p_name = ? AND %s AND %s%s", ptr2, ptr, ptr3);
                            }

                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? AND %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE name = ? AND %s AND %s%s", ptr2, ptr, ptr3);
                        }
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint8(stmt, 1, track_num);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint8(stmt,5, track_num);
                        sqlite3_bind_kal_wstr(stmt, 6, name);
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->current_picked_id);
                        sqlite3_bind_kal_uint32(stmt, 8, 1);
                        sqlite3_bind_kal_uint32(stmt, 9, 1);
                    }
                    else 
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {                    
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, 1);
                        }
                        else
                        {   
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 5, 1);
                        }                    
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint8(stmt, 6, track_num);
                            sqlite3_bind_kal_wstr(stmt, 7, name);
                            sqlite3_bind_kal_uint32(stmt, 8, playing_info->current_picked_id);
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 10, 1);
                            sqlite3_bind_kal_uint32(stmt, 11, 1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }    

                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                        sqlite3_bind_kal_wstr(stmt, 4, name);
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->current_picked_id);
                        sqlite3_bind_kal_uint32(stmt, 6, 1);
                        sqlite3_bind_kal_uint32(stmt, 7, 1);
                    }
                    else 
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {                    
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                        }
                        else
                        {   
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 4, 1);
                        }                    
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 5, name);
                            sqlite3_bind_kal_uint32(stmt, 6, playing_info->current_picked_id);
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt,7, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 8, 1);
                            sqlite3_bind_kal_uint32(stmt, 9, 1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }    
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    ret = SRV_PLST_OK;
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);            
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }                          
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    if(next_flag)
                    {
                        ptr3 = SqlOtracknaidasc;
                    }
                    else
                    {
                        ptr3 = SqlOtracknaiddesc;
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND p_name = ? \
AND %s AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE track_num = ? AND p_name = ? AND %s AND \
artist_id = ? AND album_id = ? %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, p_name, track_num FROM audio WHERE track_num = ? AND p_name = ? AND %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name = ? \
AND %s AND artist_id = ? AND album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name = ? AND %s AND \
artist_id = ? AND album_id = ? %s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE name = ? AND %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, track_num);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->current_picked_id);
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 6, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 7, track_num);
                        sqlite3_bind_kal_wstr(stmt, 8, name);
                        sqlite3_bind_kal_uint32(stmt, 9, playing_info->current_picked_id);
                        sqlite3_bind_kal_uint32(stmt, 10, playing_info->play_info.id[0]); 
                        if(playing_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 11, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 11, playing_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 12, 1);
                        sqlite3_bind_kal_uint32(stmt, 13, 1);
                    }  
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 5, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 6, name);
                        sqlite3_bind_kal_uint32(stmt, 7, playing_info->current_picked_id);
                        sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[0]); 
                        if(playing_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 10, 1);
                        sqlite3_bind_kal_uint32(stmt, 11, 1);
                    }  
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    return ret;
                }
                pls_sql_finalize(stmt);
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }                
        }
    }
#ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {// todo
        pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
        if(type == SRV_PLST_DEF_MOST_PLST)
        {
            is_most_recent = MMI_TRUE;
        } 
        if(is_most_recent && type == SRV_PLST_DEF_MOST_PLST)                        
        {            
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(next_flag)
                {                
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)");
                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)) ORDER BY played_count ASC , plstitem_id ASC limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) ORDER BY played_count DESC , plstitem_id DESC limit 1");
                }
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                if(next_flag)
                {
                
                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1");                               
                }
                else
                {     
                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");                               
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, temp_index);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 5, temp_index);
                sqlite3_bind_kal_uint32(stmt, 6, playing_info->current_picked_id);
                sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t; 
                sqlite3_stmt *stmt_t;
                *id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);

                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                }
                else
                {
                    return SRV_PLST_RET_PLST_FULL;
                }
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    return ret_t;
                }
                return ret;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
            
        }        
    }
#endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */

#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    /* find the name differrent */
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {// todo
        if(next_flag)
        {
            ptr2 = Sqlnamelarger;
            ptr3 = SqlOvideonaidasc;
        }
        else
        {
            ptr2 = Sqlnamesmaller;
            ptr3 = SqlOvideonaiddesc;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s%s) UNION \
SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s%s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s%s", ptr2, ptr3);
            }
        }
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        else /* temp video */
        {
            if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s AND vdo_id NOT IN \
(SELECT id FROM db2.play WHERE mark_flag = 0) %s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s AND vdo_id NOT IN (SELECT id \
FROM db2.play WHERE mark_flag = 0) %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s AND vdo_id NOT IN (SELECT id FROM play \
WHERE mark_flag = 0) %s", ptr2, ptr3);                 
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE %s AND vdo_id IN \
(SELECT id FROM db2.play WHERE mark_flag = 1) %s) UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE %s AND vdo_id IN \
(SELECT id FROM db2.play WHERE mark_flag = 1) %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                     kal_sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE %s AND vdo_id IN (SELECT id FROM play WHERE mark_flag = 1)%s", ptr2, ptr3);
                }
            }
        }
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        sqlite3_bind_kal_uint32(stmt, 2, 1);
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 3, name);
            sqlite3_bind_kal_uint32(stmt, 4, 1);
            sqlite3_bind_kal_uint32(stmt, 5, 1);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t;
            sqlite3_stmt *stmt_t;

            ret = SRV_PLST_OK;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            playing_info->current_picked_id = *id;
            if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
            }
            else 
            {
                name[0] = 0;
            }
            pls_sql_finalize(stmt);
            if(*id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);
        }        
       // return ret;
    }
    else 
#endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(next_flag)
            {
                ptr2 = Sqlpnamelarger;
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                {
                    ptr3 = SqlOtracknaidasc;
                }
                else
                {
                    ptr3 = SqlOpnaidasc;
                }                
            }
            else
            {
                ptr2 = Sqlpnamesmaller;
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                    (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                {
                    ptr3 = SqlOtracknaiddesc;
                }
                else
                {
                    ptr3 = SqlOpnaiddesc;
                }                
            }
        }
        else
        {
            if(next_flag)
            {
                ptr2 = Sqlnamelarger;
                ptr3 = SqlOnaidasc;
            }
            else
            {
                ptr2 = Sqlnamesmaller;
                ptr3 = SqlOnaiddesc;
            }
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(!playing_info->play_info.current_index ||
               (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
            {
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE ischar = ? AND %s%s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, p_name,ischar FROM audio WHERE ischar = ? AND %s%s", ptr2, ptr3);
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s%s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s%s", ptr2, ptr3);
                        }
                    }
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE track_num = ? AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, track_num FROM audio WHERE track_num = ? AND %s AND %s%s", ptr2, ptr, ptr3);
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE ischar = ? AND %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, ischar FROM audio WHERE ischar = ? AND %s AND %s%s", ptr2, ptr, ptr3);
                            }
                        }
                    }
                    else
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id,name FROM audio WHERE %s AND %s%s", ptr2, ptr, ptr3);
                        }
                    }
                }
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, track_num);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, 1);
                        sqlite3_bind_kal_uint32(stmt, 4, track_num);
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, 1);
                        sqlite3_bind_kal_uint32(stmt, 7, 1);
                        
                    }
                    else 
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                        }
                        else
                        {   
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 4, 1);
                        }

                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, track_num);
                            sqlite3_bind_kal_wstr(stmt, 6, name);
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 8, 1);
                            sqlite3_bind_kal_uint32(stmt, 9, 1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }    
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                        sqlite3_bind_kal_wstr(stmt, 3, name);
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint32(stmt, 5, 1);
                        
                    }
                    else 
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, 1);
                        }
                        else
                        {   
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                        }

                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_wstr(stmt, 4, name);
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 6, 1);
                            sqlite3_bind_kal_uint32(stmt, 7, 1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }    
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t;
                    sqlite3_stmt *stmt_t;
                    
                    ret = SRV_PLST_OK;
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                //return ret;
            }
            else if((playing_info->play_info.current_index == 1 || 
                     (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                      playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                      playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE track_num = ? AND %s AND artist_id = ? AND \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE track_num = ? AND %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, p_name, track_num FROM audio WHERE track_num= ? AND %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s AND artist_id = ? AND \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, name FROM audio WHERE %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);   
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, track_num);
                    sqlite3_bind_kal_wstr(stmt, 2, name);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 5, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 6, track_num);
                        sqlite3_bind_kal_wstr(stmt, 7, name);
                        sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_info.id[0]); 
                        if(playing_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 9, playing_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 10, 1);
                        sqlite3_bind_kal_uint32(stmt, 11, 1);
                    }    
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    sqlite3_bind_kal_wstr(stmt, 1, name);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 4, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_wstr(stmt, 5, name);
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[0]); 
                        if(playing_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 8, 1);
                        sqlite3_bind_kal_uint32(stmt, 9, 1);
                    }    
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    sqlite3_stmt *stmt_t;
                    S32 ret_t;
                    
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    playing_info->current_picked_id = *id;
                    ret = SRV_PLST_OK;
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                    {
                        mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                    }
                    else 
                    {
                        name[0] = 0;
                    } 
                    pls_sql_finalize(stmt);
                    if(*id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                //return ret;
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }                
        }       
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {//todo
        pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
        {
            is_most_recent = MMI_TRUE;
        }  
    #endif /*__PLST_SRV_FEATURE_MOST_RECENT_LIST__*/

        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->plst_id > 0X8000)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(next_flag)
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM  main.plst_item WHERE idx < ? AND plst_id = ? ORDER BY idx DESC limit 1 ");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM  main.plst_item WHERE idx > ? AND plst_id = ? ORDER BY idx limit 1 ");
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)) ORDER BY played DESC , plstitem_id desc limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) ORDER BY played_count DESC , plstitem_id desc limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                    else
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE idx > ?  AND plst_id = ? ORDER BY idx asc limit 1");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE idx < ?  AND plst_id = ? ORDER BY idx DESC limit 1");
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1)");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1)) ORDER BY played ASC, plstitem_id ASC limit 1");
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)");
                                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)) ORDER BY played_count ASC , plstitem_id ASC limit 1");
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(next_flag)
                    {
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM  main.plst_item WHERE idx < ? AND plst_id = ? AND media_id > 32768 ORDER BY idx DESC limit 1 ");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM  main.plst_item WHERE idx > ? AND plst_id = ? AND media_id > 32768 ORDER BY idx limit 1 ");
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1");                                
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");                               
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                    else
                    {  
                        if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE idx > ? AND plst_id = ? AND media_id > 32768 ORDER BY idx asc limit 1");
                        }
                    #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                        else
                        {
                            if(!is_most_recent)
                            {
                                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE idx < ? AND plst_id = ? AND media_id > 32768 ORDER BY idx DESC limit 1");
                            }
                        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                            else
                            {
                                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1");                                
                                }
                                else
                                {
                                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1");                               
                                }
                            }
                        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
                        }
                    #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
                    }
                }
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
                {
                    if(next_flag)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE idx < ?  AND plst_id = ? ORDER BY idx DESC limit 1 ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE idx > ? AND plst_id = ? ORDER BY idx ASC limit 1");
                    }
                }
            #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
                else
                {
                    if(next_flag)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE idx > ?  AND plst_id = ? ORDER BY idx limit 1 ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE idx < ? AND plst_id = ? ORDER BY idx DESC limit 1");
                    }
                }
            #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }    
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, temp_index);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
        if(is_most_recent)
        {
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt ,4, temp_index);
                sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            S32 ret_t; 
            sqlite3_stmt *stmt_t;
            *id = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
            pls_sql_finalize(stmt);

            if(playing_info->plst_id > 0X8000)
            {
                sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, " UPDATE db2.plst_item SET play_count = ?, ordinal = ? WHERE plstitem_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
            ret_t = pls_sql_step_ex(db, stmt_t);
            pls_sql_finalize(stmt_t);
            if(ret_t != SRV_PLST_OK)
            {
                return ret_t;
            }
            return ret;
        }
        else 
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
            if(is_most_recent && type == SRV_PLST_DEF_MOST_PLST)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {                                 
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id order by played_count DESC limit 1)");
                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT played_count FROM main.plst_item, db2.meta WHERE plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id order by played_count desc limit 1)) ORDER BY played_count DESC limit 1");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                   sprintf(db->sql_cmd, "SELECT  max(played_count) FROM main.plst_item, main.meta WHERE plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id");                               
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    U32 played_count;

                    played_count = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                    if(played_count == temp_index)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            if(next_flag)
                            {                
                                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) ORDER BY played_count DESC , plstitem_id desc limit 1");
                            }
                            else
                            {
                                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)");
                                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)) ORDER BY played_count ASC , plstitem_id ASC limit 1");
                            }
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            if(next_flag)
                            {
                            
                                sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");                               
                            }
                            else
                            {     
                                sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count = ? AND plstitem_id > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1");                               
                            }
                        }
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, temp_index);
                        sqlite3_bind_kal_uint32(stmt, 2, playing_info->current_picked_id);
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                        sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint32(stmt, 5, temp_index);
                            sqlite3_bind_kal_uint32(stmt, 6, playing_info->current_picked_id);
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                            sqlite3_bind_kal_uint32(stmt, 8, playing_info->play_id);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            S32 ret_t; 
                            sqlite3_stmt *stmt_t;
                            *id = sqlite3_column_kal_uint32(stmt, 0);
                            ret = SRV_PLST_OK;
                            pls_sql_finalize(stmt);

                            if(playing_info->plst_id > 0X8000)
                            {
                                sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                            }
                            else
                            {
                                return SRV_PLST_RET_PLST_FULL;
                            }
                            ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                            if(ret_t != SRV_PLST_OK)
                            {
                                return ret_t;
                            }
                            sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                            sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                            sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                            ret_t = pls_sql_step_ex(db, stmt_t);
                            pls_sql_finalize(stmt_t);
                            if(ret_t != SRV_PLST_OK)
                            {
                                return ret_t;
                            }
                            return ret;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                            if(ret != SRV_PLST_OK)
                            {
                                return ret;
                            }
                        }                        
                    }
                }               
                else
                {
                    pls_sql_finalize(stmt);
                }
            }

            if(is_most_recent)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(next_flag)
                    {                        
                        if(type == SRV_PLST_DEF_RECENTLY_PLST)
                        {
                            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1)");
                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1)) ORDER BY played ASC , plstitem_id ASC limit 1");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)");
                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1)) ORDER BY played_count ASC , plstitem_id ASC limit 1");
                        }
                    }
                    else
                    {                       
                        if(type == SRV_PLST_DEF_RECENTLY_PLST)
                        {
                            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)");
                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)) ORDER BY played DESC, plstitem_id DESC limit 1");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) ORDER BY played_count DESC , plstitem_id DESC limit 1");
                        }                       
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(next_flag)
                    {
                        if(type == SRV_PLST_DEF_RECENTLY_PLST)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played > ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played ASC, plstitem_id ASC limit 1");                                
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count >? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count ASC, plstitem_id ASC limit 1");                               
                        }
                    }
                    else
                    {                       
                        if(type == SRV_PLST_DEF_RECENTLY_PLST)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE played < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1");                                
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE played_count < ? AND plst_id = ? AND play_count != ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");                               
                        }
                    
                    }
                }       
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, temp_index);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, temp_index);
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                    sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_id);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    S32 ret_t; 
                    sqlite3_stmt *stmt_t;
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                    pls_sql_finalize(stmt);

                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                    }
                    else
                    {
                        return SRV_PLST_RET_PLST_FULL;
                    }
                    ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                    sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                    sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                    ret_t = pls_sql_step_ex(db, stmt_t);
                    pls_sql_finalize(stmt_t);
                    if(ret_t != SRV_PLST_OK)
                    {
                        return ret_t;
                    }
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            }
        #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
        }
        //return ret;                
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    //find more

    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && playing_info->play_info.view_type[0] != SRV_PLST_VIEW_PLST)
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
            #endif
            )
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(next_flag)
                {                    
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                    {
                        ptr3 = SqlOtracknaidasc;
                        ptr2 = Sqltracklarger;
                    }
                    else
                    {
                        ptr2 = Sqlischarlarger;
                        ptr3 = SqlOpnaidasc;
                    }
                }
                else
                {                    
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                        (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM))
                    {
                        ptr2 = Sqltracksmaller;
                        ptr3 = SqlOtracknaiddesc;
                    }
                    else
                    {
                        ptr2 = Sqlischarsmaller;
                        ptr3 = SqlOpnaiddesc;
                    }
                }
            }
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(!playing_info->play_info.current_index ||
                   (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA))
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {                        
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            kal_sprintf(db->sql_cmd, "SELECT * FROM ( SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE %s%s)) %s", ptr2, ptr3, ptr2, ptr3, ptr3);                        
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            kal_sprintf(db->sql_cmd, " SELECT media_id, p_name,ischar FROM audio WHERE %s%s", ptr2, ptr3);
                        }
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {                        
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, track_num FROM audio WHERE %s AND %s%s", ptr2, ptr, ptr3);
                            }
                        }
                        else
                        {
                        #if defined(__PLST_DUAL_DB_SUPPORT__)
                            if(IS_CARD_EXIST)
                            {
                                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE  %s AND %s%s) \
UNION SELECT * FROM (SELECT media_id, p_name,ischar FROM db2.audio WHERE %s AND %s%s))%s", ptr2, ptr, ptr3, ptr2, ptr, ptr3, ptr3);
                            }
                            else
                        #endif /* __PLST_DUAL_DB_SUPPORT__ */
                            {
                                kal_sprintf(db->sql_cmd, " SELECT media_id,p_name, ischar FROM audio WHERE  %s AND %s%s", ptr2, ptr, ptr3);
                            }
                        } 
                    }
                    else 
                    {
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                    }                
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }                   
                    
                    sqlite3_bind_kal_uint16(stmt, 1, track_num);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sqlite3_bind_kal_uint32(stmt, 2, 1);
                        sqlite3_bind_kal_uint16(stmt, 3, track_num);
                        sqlite3_bind_kal_uint32(stmt, 4, 1);
                        sqlite3_bind_kal_uint32(stmt, 5, 1);
                        
                    }
                    else 
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, 1);
                        }
                        else
                        {   
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 3, 1);
                        }

                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            sqlite3_bind_kal_uint16(stmt, 4, track_num);
                            if(!playing_info->play_info.current_index)
                            {
                                sqlite3_bind_kal_uint32(stmt, 5, playing_info->plst_id);
                            }
                            else
                            {
                                sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[0]);
                            }
                            sqlite3_bind_kal_uint32(stmt, 6, 1);
                            sqlite3_bind_kal_uint32(stmt, 7, 1);
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    }    
                    
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        S32 ret_t;
                        sqlite3_stmt *stmt_t;
                        
                        ret = SRV_PLST_OK;
                        *id = sqlite3_column_kal_uint32(stmt, 0);
                        playing_info->current_picked_id = *id;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                            mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else 
                        {
                            name[0] = 0;
                        }
                        pls_sql_finalize(stmt);
                        if(*id > 0X8000)
                        {
                            sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        else
                        {
                            sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                        if(ret_t != SRV_PLST_OK)
                        {
                            return ret_t;
                        }
                        sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                        sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                        sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                        ret_t = pls_sql_step_ex(db, stmt_t);
                        pls_sql_finalize(stmt_t);
                        if(ret_t != SRV_PLST_OK)
                        {
                            return ret_t;
                        }
                        return ret;
                    }
                    else
                    {
                        pls_sql_finalize(stmt);
                    }
                    //return ret;
                }
                else if((playing_info->play_info.current_index == 1 || 
                         (playing_info->play_info.current_index == 2 && playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
                          playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST &&
                          playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, " SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, track_num FROM main.audio WHERE %s AND artist_id = ? AND \
album_id = ? %s) UNION SELECT * FROM (SELECT media_id, p_name,track_num FROM db2.audio WHERE %s AND artist_id = ? AND album_id = ? %s))%s", ptr2, ptr3, ptr2, ptr3, ptr3);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, " SELECT media_id, p_name, track_num FROM audio WHERE %s AND artist_id = ?  AND album_id = ? %s", ptr2, ptr3);
                    }
                    
                    
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);   
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }                   
                    
                    sqlite3_bind_kal_uint16(stmt, 1, track_num);
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                    }
                    sqlite3_bind_kal_uint32(stmt, 4, 1);
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint16(stmt, 5, track_num);
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[0]); 
                        if(playing_info->play_info.current_index == 1)
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 7, playing_info->play_info.id[1]);
                        }
                        sqlite3_bind_kal_uint32(stmt, 8, 1);
                        sqlite3_bind_kal_uint32(stmt, 9, 1);
                    }    
                #endif /* __PLST_DUAL_DB_SUPPORT__ */

                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        sqlite3_stmt *stmt_t;
                        S32 ret_t;
                        
                        *id = sqlite3_column_kal_uint32(stmt, 0);
                        playing_info->current_picked_id = *id;
                        ret = SRV_PLST_OK;
                        if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                        {
                            mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1), META_TAG_FRAME_MAX_LEN);
                        }
                        else 
                        {
                            name[0] = 0;
                        } 
                        pls_sql_finalize(stmt);
                        if(*id > 0X8000)
                        {
                            sprintf(db->sql_cmd, " UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        else
                        {
                            sprintf(db->sql_cmd, " UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                        if(ret_t != SRV_PLST_OK)
                        {
                            return ret_t;
                        }
                        sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                        sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                        sqlite3_bind_kal_uint32(stmt_t, 3, *id);
                        ret_t = pls_sql_step_ex(db, stmt_t);
                        pls_sql_finalize(stmt_t);
                        if(ret_t != SRV_PLST_OK)
                        {
                            return ret_t;
                        }
                        return ret;
                    }
                    else
                    {
                        pls_sql_finalize(stmt);
                    }
                    //return ret;
                }
                else
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                
            }       
        }                    
    }
    return ret; 
}



/* current only support find the first */
S32 pls_sql_get_active_id_by_index(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 index, U32 *id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);    
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
    {

        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
        {//bql: MAUI_02660492
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                const S8* ptr = SqlOpnaidasc;
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio %s ) \
    UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio %s)) %s", ptr, ptr,ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                     kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio %s", ptr);
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, 1);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, 1);
                    sqlite3_bind_kal_uint32(stmt, 3, 1);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret = pls_sql_step_ex(db, stmt);
                if (ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    *id = 0;
                    if(ret == SRV_PLST_OK)
                    {
                        ret = SRV_PLST_RET_EMPTY;
                    }
                }                    
                pls_sql_finalize(stmt);
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio ORDER BY name, media_id limit 1)");
                    strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name FROM db2.audio ORDER BY name, media_id ASC limit 1)) ORDER BY name, media_id limit 1");
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio ORDER BY name, media_id ASC limit 1");
                }           
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *id = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    *id = 0;
                    if(ret == SRV_PLST_OK)
                    {
                        ret = SRV_PLST_RET_EMPTY;
                    }
                }                    
                pls_sql_finalize(stmt);
            }
        }
//bql: MAUI_02456110
//for the case artist (album/genre) (-> media
        else if((playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST || 
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_IMAGE_FLOW ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE) && 
                (!playing_info->play_info.current_index ||
                (playing_info->play_info.current_index == 1 && 
                playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA)))
        {

            const S8* ptr_p;
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr_p = Sqlartistid;
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM || 
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_IMAGE_FLOW)
            {
                ptr_p = Sqlalbumid; /* order by tack num first */
            }
            else
            {
                ptr_p = Sqlgenreid;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {  
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM || 
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_IMAGE_FLOW)
                {
                    const S8* ptr = SqlOtracknaidasc;

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {                    
                        kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, track_num FROM main.audio WHERE %s %s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio WHERE %s %s))%s",ptr_p, ptr, ptr_p, ptr, ptr);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM audio WHERE %s %s", ptr_p, ptr);
                    }
                }
                else
                {
                    const S8* ptr = SqlOpnaidasc;
                    
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {                    
                        kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio WHERE %s %s) \
UNION ALL SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE %s %s))%s",ptr_p, ptr, ptr_p, ptr, ptr);                    
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio WHERE %s %s", ptr_p, ptr);
                    }

                }
            }
            else
            {
                const S8* ptr = SqlOnaidasc;
                
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id , name FROM main.audio WHERE %s %s) \
UNION ALL SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s %s))%s",ptr_p, ptr, ptr_p, ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM audio WHERE %s %s", ptr_p, ptr);
                }    
            }
            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(!playing_info->play_info.current_index)
            {
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
            }
            sqlite3_bind_kal_uint32(stmt, 2, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                if(!playing_info->play_info.current_index)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                }
                sqlite3_bind_kal_uint32(stmt, 4, 1);
                sqlite3_bind_kal_uint32(stmt, 5, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
            }
            else
            {
                *id = 0;
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
            }                    
            pls_sql_finalize(stmt);
        }
        // MAUI_02660488
        // for the case artist -> album (-> media) only
        else if((playing_info->play_info.current_index == 1 || 
                (playing_info->play_info.current_index == 2 && 
                playing_info->play_info.view_type[2] == SRV_PLST_VIEW_MEDIA)) &&
               playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && 
               playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT * FROM \
(SELECT * FROM \
(SELECT media_id, p_name , track_num FROM main.audio \
WHERE artist_id = ? AND album_id = ?  \
ORDER BY track_num, p_name, media_id limit 1)     \
UNION ALL \
SELECT * FROM \
(SELECT media_id, p_name, track_num FROM db2.audio \
WHERE artist_id = ? AND album_id = ?  \
ORDER BY track_num, p_name, media_id limit 1) \
) \
ORDER BY track_num, p_name, media_id limit 1");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id, p_name, track_num FROM audio WHERE artist_id = ? AND album_id = ?  ORDER BY track_num, p_name, media_id limit 1");
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    { 
                        sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ?  ORDER BY name, media_id ASC limit 1 )");
                        strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? ORDER BY name, media_id ASC limit 1)) ORDER BY name , media_id ASC limit 1");
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ?  ORDER BY name, media_id ASC limit 1");
                    }
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
            if(playing_info->play_info.current_index == 1)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[1]);
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *id = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
            }
            else
            {
                *id = 0;
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
            }                    
            pls_sql_finalize(stmt);
        }
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video ORDER BY name, vdo_id limit 1)");
            strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT vdo_id, name FROM db2.video ORDER BY name, vdo_id ASC limit 1)) ORDER BY name, vdo_id limit 1");
        }
        else 
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
           sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video ORDER BY name , vdo_id ASC limit 1"); 
        }           
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *id = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
        }
        else
        {
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            *id = 0;
        }
        pls_sql_finalize(stmt);
    }
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        srv_plst_default_playlist_enum type;
        ret = pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);

    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        if(ret == SRV_PLST_OK && (type == SRV_PLST_DEF_RECENTLY_PLST || type == SRV_PLST_DEF_MOST_PLST))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {                
                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)");
                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1)) order by played DESC, plstitem_id DESC limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ?  AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)");
                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1)) order by played_count DESC, plstitem_id DESC limit 1");
                }               
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {               
                if(type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id DESC limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id DESC limit 1");
                }
            }
        }
        else
    #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
        {
            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx desc, plstitem_id desc limit 1");
                    }
                    else
                    {
                        sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx desc, plstitem_id desc limit 1 ");                       
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx desc, plstitem_id desc limit 1 ");
                }  
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM main.plst_item WHERE plst_id = ? ORDER BY idx, plstitem_id ASC limit 1");
                    }
                    else
                    {
                        sprintf(db->sql_cmd,"SELECT plstitem_id, idx FROM db2.plst_item WHERE plst_id = ? ORDER BY idx, plstitem_id ASC limit 1 ");                       
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx, plstitem_id ASC limit 1 ");
                }  
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
    #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
        if((type == SRV_PLST_DEF_RECENTLY_PLST || type == SRV_PLST_DEF_MOST_PLST) && IS_CARD_EXIST)
        {
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
        }
    #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *id = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
        }
        else
        {
            if(ret == SRV_PLST_OK)
            {
                ret = SRV_PLST_RET_EMPTY;
            }
            *id = 0;
        }
        pls_sql_finalize(stmt);
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_rand_range
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_rand_range(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32 *min_value, U32* max_value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        switch(playing_info->active_type)
        {
            case SRV_PLST_ACTIVE_LIST_AUDIO:
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio UNION SELECT media_id from db2.audio)");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ?)");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? UNION SELECT media_id FROM db2.audio WHERE artist_id = ?)");            
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE album_id = ? UNION SELECT media_id FROM db2.audio WHERE album_id = ?)");
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE genre_id = ?  UNION SELECT media_id FROM db2.audio WHERE genre_id = ? )");
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                    
                break;
                
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__    
            case SRV_PLST_ACTIVE_LIST_TEMP_AUDIO:
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        sprintf(db->sql_cmd, "SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio UNION SELECT media_id from db2.audio) WHERE media_id NOT IN (SELECT id FROM db2.play WHERER mark_flag = 0) ");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? AND album_id = ? UNION SELECT media_id FROM db2.audio WHERE artist_id = ? AND album_id = ?) WHERE media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE artist_id = ? UNION SELECT media_id FROM db2.audio WHERE artist_id = ?) WHERE media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");             
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE album_id = ? UNION SELECT media_id FROM db2.audio WHERE album_id = ?) WHERE media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio WHERE genre_id = ?  UNION SELECT media_id FROM db2.audio WHERE genre_id = ? ) WHERE media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else 
                    {
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                    } 
                    sprintf(db->sql_cmd, "SELECT MIN(media_id), MAX(media_id) FROM (SELECT media_id FROM main.audio UNION SELECT media_id from db2.audio) WHERE media_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM db2.play WHERE mark_flag = 1");
                }
                break;
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_VIDEO:
                sprintf(db->sql_cmd, "SELECT MIN(vdo_id), MAX(vdo_id) FROM (SELECT vdo_id FROM main.video UNION SELECT vdo_id from db2.video)");
                break;
                
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_TEMP_VIDEO:
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(vdo_id), MAX(vdo_id) FROM (SELECT vdo_id FROM main.video UNION SELECT vdo_id from db2.video) WHERE vdo_id NOT IN (SELECT id FROM db2.play WHERE mark_flag = 0)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM db2.play WHERE mark_play = 1");
                }
                break;
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            case SRV_PLST_ACTIVE_LIST_PLST:
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(plstitem_id), MAX(plstitem_id) FROM main.plst_item WHERE plst_id = ?");
                }
                else
                {
                    sprintf(db->sql_cmd,"SELECT MIN(plstitem_id), MAX(plstitem_id) FROM db2.plst_item WHERE plst_id = ?");
                }
                break;
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_TEMP_PLST:
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    if(playing_info->plst_id > 0X8000)
                    {
                        sprintf(db->sql_cmd, "SELECT MIN(plstitem_id), MAX(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id from db2.play WHERE mark_flag = 0) ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd,"SELECT MIN(plstitem_id), MAX(plstitem_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id from db2.play WHERE mark_flag = 0) ");
                    }
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM db2.play WHERE mark_flag = 1");   
                }
                break;
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            default:
                break;
        }
    }
    else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    {
        switch(playing_info->active_type)
        {
            case SRV_PLST_ACTIVE_LIST_AUDIO:
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(media_id), MAX(media_id) FROM main.audio");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? ");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id)  FROM main.audio WHERE artist_id = ?");            
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM main.audio WHERE album_id = ?");
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    sprintf(db->sql_cmd,"SELECT MIN(media_id), MAX(media_id) FROM main.audio WHERE genre_id = ? ");
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                break;

            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_TEMP_AUDIO:
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(media_id), MAX(media_id) FROM audio ");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM mark");    
                }
                break;
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_VIDEO:
                sprintf(db->sql_cmd, "SELECT MIN(vdo_id), MAX(vdo_id) FROM video ");
                break;
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_TEMP_VIDEO: 
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(vdo_id), MAX(vdo_id) FROM video WHERE vdo_id NOT IN (SELECT id FROM play WHERE mark_flag = 0)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM play WHERE mark_flag = 1");    
                }
                break;
        #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
        #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            case SRV_PLST_ACTIVE_LIST_PLST:
                sprintf(db->sql_cmd, "SELECT MIN(plstitem_id), MAX(plstitem_id) FROM plst_item WHERE plst_id = ? ");
                break;
            #ifdef __MARK_SEVERAL_PLAY_SUPPORT__    
            case SRV_PLST_ACTIVE_LIST_TEMP_PLST:
                if(playing_info->play_info.is_mark && playing_info->play_info.is_mark_all)
                {
                    sprintf(db->sql_cmd, "SELECT MIN(plstitem_id), MAX(plstitem_id) FROM plst_item  WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM play WHERE mark_flag = 0)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(id), MAX(id) FROM play WHERE mark_flag = 1");
                }
                break;
            #endif /* __MARK_SEVERAL_PLAY_SUPPORT__ */
            default:
                break;
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);  
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
    {
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[1]);
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
    {
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[0]);
            sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[1]);
        }
        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
        {
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
        }
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */

    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if((playing_info->play_info.is_mark && playing_info->play_info.is_mark_all) || !playing_info->play_info.is_mark )
        {
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_info.id[0]);
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        *min_value = sqlite3_column_kal_uint32(stmt, 0);
        *max_value = sqlite3_column_kal_uint32(stmt, 1);
        ret = SRV_PLST_OK;
    }
    else
    {
        *min_value = 0;
        *max_value = 0;
    }
    pls_sql_finalize(stmt);
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_max_unselect_by_drv
 * DESCRIPTION
 *   Get max media id, min media id and count for <<shuffle on>> case
 *   Here comes some performance enhance chage and seperate to "phone + card" and "card only" situation
 *
 *   For "Phone + card" case, It will get count in phone disk, and caculate by playing info.
 *   For "Card only" case, it does not get count and use the playing info directly.
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
#if defined(__PLST_DUAL_DB_SUPPORT__)
S32 pls_sql_get_max_unselect_by_drv(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* ph_max, U32* ph_min, U32* ph_count, U32* ca_max, U32* ca_min, U32* ca_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U16 i;    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    switch(playing_info->active_type)
    {
        case SRV_PLST_ACTIVE_LIST_AUDIO:
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                sprintf(db->sql_cmd, "SELECT MAX(media_id), MIN(media_id), COUNT(media_id) FROM main.audio WHERE play_count != ?");
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                sprintf(db->sql_cmd," SELECT MAX(media_id), MIN(media_id), COUNT(media_id) FROM  main.audio WHERE play_count != ? AND artist_id = ? AND album_id = ?");
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd,"SELECT MAX(media_id), MIN(media_id), COUNT(media_id) FROM main.audio WHERE play_count != ? AND artist_id = ?");            
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                sprintf(db->sql_cmd,"SELECT MAX(media_id),MIN(media_id), COUNT(media_id) FROM main.audio WHERE play_count != ? AND album_id = ?");
            }
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sprintf(db->sql_cmd,"SELECT MAX(media_id), MIN(media_id), COUNT(media_id) FROM main.audio WHERE play_count != ? AND genre_id = ?");
            }
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
            else 
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }                    
            break;

    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        case SRV_PLST_ACTIVE_LIST_VIDEO:
            sprintf(db->sql_cmd, "SELECT MAX(vdo_id),MIN(vdo_id), COUNT(vdo_id) FROM main.video WHERE play_count != ?");
            break;
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */        
        case SRV_PLST_ACTIVE_LIST_PLST:
            if(playing_info->plst_id > 0X8000)
            {
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT MAX(plstitem_id),MIN(plstitem_id), COUNT(plstitem_id) FROM main.plst_item WHERE play_count != ? AND plst_id = ?");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MAX(plstitem_id),MIN(plstitem_id), COUNT(plstitem_id) FROM main.plst_item WHERE play_count != ? AND plst_id = ? AND media_id > 32768");
                }
            }
            else
            {
                /* No need to select "ca_count", it takes much time. It can count by (playing_info->total - playing_info->pick_count - ph_count) */
                //sprintf(db->sql_cmd,"SELECT MAX(plstitem_id), MIN(plstitem_id), COUNT(plstitem_id) FROM db2.plst_item WHERE play_count != ? AND plst_id = ?");
                sprintf(db->sql_cmd,"SELECT MAX(plstitem_id), MIN(plstitem_id) FROM db2.plst_item WHERE play_count != ? AND plst_id = ?");
            }
            break;           
        default:
            return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
    {
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
        sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
    }
    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
        playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
    {
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
    }
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)               
    {
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->plst_id > 0X8000)
            {
                *ph_max = sqlite3_column_kal_uint32(stmt, 0);
                *ph_min = sqlite3_column_kal_uint32(stmt, 1);
                *ph_count = sqlite3_column_kal_uint32(stmt, 2);
            }
            else
            {
                *ca_max = sqlite3_column_kal_uint32(stmt, 0);
                *ca_min = sqlite3_column_kal_uint32(stmt, 1);
                //*ca_count = sqlite3_column_kal_uint32(stmt, 2);
            }                    
        }
        else
        {
            *ph_max = sqlite3_column_kal_uint32(stmt, 0);
            *ph_min = sqlite3_column_kal_uint32(stmt, 1);
            *ph_count = sqlite3_column_kal_uint32(stmt, 2);
        }
        pls_sql_finalize(stmt);
        ret = SRV_PLST_OK;
    }
    else
    {
        pls_sql_finalize(stmt);
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }   
    
    /* No need to select "ca_count", it takes much time. It can count by (playing_info->total - playing_info->pick_count - ph_count) */
    if(IS_CARD_EXIST)
    {
        /* If select MAX and MIN in a query, it will take a very long time, so seperate into two steps */
        for(i = 0 ; i < 2 ; i++)
        {
            switch(playing_info->active_type)
            {
                case SRV_PLST_ACTIVE_LIST_AUDIO:
                    if(i == 0)
                    {
                        sprintf(db->sql_cmd, "SELECT MAX(media_id)");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT MIN(media_id)");
                    }
                    strcat(db->sql_cmd, " FROM db2.audio WHERE play_count != ?");

                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        //sprintf(db->sql_cmd, "SELECT MAX(media_id), MIN(media_id),COUNT(media_id) FROM db2.audio WHERE play_count != ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                    {
                        //sprintf(db->sql_cmd, "SELECT MAX(media_id), MIN(media_id),COUNT(media_id) FROM db2.audio WHERE play_count != ? and artist_id = ? AND album_id = ?");
                        strcat(db->sql_cmd, " AND artist_id = ? AND album_id = ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        //sprintf(db->sql_cmd,"SELECT MAX(media_id), MIN(media_id),COUNT(media_id) FROM db2.audio WHERE play_count != ? and artist_id = ?");            
                        strcat(db->sql_cmd, " AND artist_id = ?");
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        //sprintf(db->sql_cmd,"SELECT MAX(media_id), MIN(media_id),COUNT(media_id) FROM db2.audio WHERE play_count != ? AND album_id = ?");
                        strcat(db->sql_cmd, " AND album_id = ?");
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        //sprintf(db->sql_cmd,"SELECT MAX(media_id), MIN(media_id), COUNT(media_id) FROM db2.audio WHERE play_count != ? AND genre_id = ?");
                        strcat(db->sql_cmd, " AND genre_id = ?");
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else 
                    {
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                    }                    
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_ACTIVE_LIST_VIDEO:
                    if(i == 0)
                    {
                        sprintf(db->sql_cmd, "SELECT MAX(vdo_id) FROM db2.video WHERE play_count != ?");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT MIN(vdo_id) FROM db2.video WHERE play_count != ?");
                    }

                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
                case SRV_PLST_ACTIVE_LIST_PLST:
                    return SRV_PLST_OK;
                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
            }        
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(i == 0)
                {
                    *ca_max = sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *ca_min = sqlite3_column_kal_uint32(stmt, 0);
                }
                //*ca_count = sqlite3_column_kal_uint32(stmt, 2);         
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
            }
        }
    }    
    return ret;
}

#else /* __PLST_DUAL_DB_SUPPORT__ */

S32 pls_sql_get_max_unselect_by_drv(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* ph_max, U32* ph_min, U32* ph_count, U32* ca_max, U32* ca_min, U32* ca_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    S32 ret = SRV_PLST_OK;
    U16 i;    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /* No need to select "ph_count", it takes much time. It can count by (playing_info->total - playing_info->pick_count) */
    /* If select MAX and MIN in a query, it will take a very long time, so seperate into two steps */
    for(i = 0 ; i < 2 ; i++)
    {
        switch(playing_info->active_type)
        {
            case SRV_PLST_ACTIVE_LIST_AUDIO:
                if(i == 0)
                {
                    sprintf(db->sql_cmd, "SELECT MAX(media_id)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(media_id)");
                }
                strcat(db->sql_cmd, " FROM main.audio WHERE play_count != ?");

                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    strcat(db->sql_cmd, " AND artist_id = ? AND album_id = ?");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    strcat(db->sql_cmd, " AND artist_id = ?");
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    strcat(db->sql_cmd, " AND album_id = ?");
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    strcat(db->sql_cmd, " AND genre_id = ?");
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                else 
                {
                    return SRV_PLST_RET_ERR_PARAM_ERR;
                }                    
                break;

        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_ACTIVE_LIST_VIDEO:
                if(i == 0)
                {
                    sprintf(db->sql_cmd, "SELECT MAX(vdo_id)");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT MIN(vdo_id)");
                }
                strcat(db->sql_cmd, " FROM main.video WHERE play_count != ?");

                break;
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
            case SRV_PLST_ACTIVE_LIST_PLST:
                if(i == 0)
                {
                    sprintf(db->sql_cmd,"SELECT MAX(plstitem_id)");
                }
                else
                {
                    sprintf(db->sql_cmd,"SELECT MIN(plstitem_id)");
                }
                strcat(db->sql_cmd, " FROM main.plst_item WHERE play_count != ? AND plst_id = ?");
                
                break;  
            default:
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }

        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
        {
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
        }
        else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
            playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE ||
            playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(i == 0)
            {
                *ph_max = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *ph_min = sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
        }
    }

    /* No need to select count here, it can be counted for signe db case */
    *ph_count = playing_info->total - playing_info->pick_count;

    return ret;
}
#endif /* __PLST_DUAL_DB_SUPPORT__ */

// to do check return error code
S32 pls_sql_check_current_active_id_exist(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;   
    U32 id;
    sqlite3_stmt *stmt;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        #endif
        )
    {
        if(playing_info->plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ? and plst_id = ?");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ? and plst_id = ?");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt,1, playing_info->current_picked_id);
        sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            id = sqlite3_column_kal_uint32(stmt,0);
        }
        else
        {
            id = 0;
        }
        pls_sql_finalize(stmt);
    }
    else
    {
        id = playing_info->current_picked_id;
    }

    if(!id)
    {
        playing_info->current_picked_id = 0;        
    }

    if( playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_PLST
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_AUDIO
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(id <= 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE media_id = ?");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE media_id = ?");
        }
    }
#ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
    else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO 
        #ifdef __MARK_SEVERAL_PLAY_SUPPORT__
        || playing_info->active_type == SRV_PLST_ACTIVE_LIST_TEMP_VIDEO
        #endif
        )
    {
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(id <= 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT vdo_id FROM db2.video WHERE vdo_id = ?");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "SELECT vdo_id FROM main.video WHERE vdo_id = ?");
        }   
    }
#endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
    else
    {
        return MMI_FALSE;
    }
    
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        /* check if the exist id is in the playing list, add for edit can change the playing list but id exist still */
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            return MMI_TRUE;
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                return MMI_TRUE;
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && 
                playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(id <= 0X8000)
                {
                    sprintf(db->sql_cmd, "SELECT media_id from db2.audio WHERE media_id = ?  AND artist_id = ? AND album_id = ?");
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id from main.audio WHERE media_id = ? AND artist_id = ? AND album_id = ?");
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                ret = pls_sql_step_ex(db, stmt);                
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    return MMI_TRUE;
                }
                else
                {
                    return MMI_FALSE;
                }                
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                const S8* ptr;
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    ptr = Sqlartistid;
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    ptr = Sqlalbumid;
                }
                else
                {
                    ptr = Sqlgenreid;
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(id < 0X8000)
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM db2.audio WHERE media_id = ? and %s", ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE media_id = ? and %s", ptr);
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                ret = pls_sql_step_ex(db, stmt);                
                pls_sql_finalize(stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    return MMI_TRUE;
                }
                else
                {
                    return MMI_FALSE;
                }                
            }
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            return MMI_TRUE;
        }            
        return MMI_FALSE;
    }
    else 
    {
        return MMI_FALSE;
    }
}


/* if current id not exist, get the next by order */
S32 pls_sql_get_next_if_current_not_exist(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* active_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    sqlite3_stmt *stmt;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    if(base->shuffle == SRV_PLST_SHUFFLE_ON)
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT media_id FROM main.audio WHERE play_count != ? limit 1) UNION SELECT * FROM (SELECT media_id FROM db2.audio WHERE play_count != ? limit 1)");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE play_count != ? limit 1");
                }
            }
            else if((playing_info->play_info.current_index == 0 || 
                (playing_info->play_info.current_index == 1 && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_MEDIA) && 
                (playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)))
            {               
                const S8* ptr;

                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    ptr = Sqlartistid;
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    ptr = Sqlalbumid;
                }
                else
                {
                    ptr = Sqlgenreid;
                }

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT media_id FROM main.audio WHERE play_count != ? AND %s limit 1) \
UNION SELECT * FROM ( SELECT media_id FROM db2.audio WHERE play_count != ? AND %s limit 1)", ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE play_count != ? AND %s limit 1", ptr);
                }
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT media_id FROM main.audio WHERE play_count != ? AND artist_id = ? AND album_id = ? limit 1)");
                    strcat(db->sql_cmd, " UNION SELECT * FROM ( SELECT media_id FROM db2.audio WHERE play_count != ? AND artist_id = ? AND album_id = ? limit 1)");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id FROM main.audio WHERE play_count != ? AND artist_id = ? and album_id = ? limit 1 ");
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                if(playing_info->play_info.current_index == 1)
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);
                }
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);    
                    sqlite3_bind_kal_uint32(stmt, 5, playing_info->play_info.id[0]); 
                    if(playing_info->play_info.current_index == 1)
                    {
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->plst_id);
                    }
                    else
                    {
                        sqlite3_bind_kal_uint32(stmt, 6, playing_info->play_info.id[1]);
                    }
                } 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }
            else
            {
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
                }
                else 
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(playing_info->play_info.view_type[0] != SRV_PLST_VIEW_AUDIO)
                    {   
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                        }
                    }

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_id);
                        if(!playing_info->play_info.current_index)
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, playing_info->plst_id);
                        }
                        else
                        {
                            sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_info.id[0]);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                } 
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                sqlite3_stmt *stmt_t;

                ret = SRV_PLST_OK;
                *active_id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->current_picked_id = *active_id;
                if(*active_id > 0X8000)
                {
                    sprintf(db->sql_cmd, "UPDATE main.audio SET play_count = ? , ordinal = ? WHERE media_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, "UPDATE db2.audio SET play_count = ?, ordinal = ? WHERE media_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *active_id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t); 
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *active_id, &playing_info->pick_index); 
                if(ret_t != SRV_PLST_OK )
                {
                    pls_sql_finalize(stmt);
                    return ret_t;     
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
            }
            else /* not exist, reset to the first */
            {
                U32 min_value; 
                pls_sql_finalize(stmt);
                       
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret;
            }            
        }
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT vdo_id FROM main.video WHERE play_count != ? limit 1 UNION SELECT vdo_id FROM db2.video WHERE play_count != ? limi 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT vdo_id FROM main.video WHERE play_count != ? limit 1");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_id);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t;
                sqlite3_stmt *stmt_t;
                
                *active_id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->current_picked_id = *active_id;
                if(*active_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.video SET play_count = ? , ordinal = ? WHERE vdo_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.video SET play_count = ?, ordinal = ? WHERE vdo_id = ?");
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *active_id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *active_id, &playing_info->pick_index); 
                if(ret_t != SRV_PLST_OK )
                {
                    pls_sql_finalize(stmt);
                    return ret_t;     
                }
                else
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
            }
            else
            {
                U32 min_value; 
                pls_sql_finalize(stmt);
                       
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret;
            }
        }
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->plst_id <= 0X8000 && playing_info->plst_id > 0)
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM db2.plst_item WHERE play_count != ? AND plst_id = ? limit 1");          
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE  play_count != ? AND plst_id = ? limit 1 ");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT plstitem_id, idx FROM main.plst_item WHERE media_id > 32768 AND play_count != ? AND plst_id = ? limit 1 ");
                }
            }
            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                S32 ret_t; 
                sqlite3_stmt *stmt_t;
                *active_id = sqlite3_column_kal_uint32(stmt, 0);
                if(playing_info->plst_id > 0X8000)
                {
                    sprintf(db->sql_cmd, " UPDATE main.plst_item SET play_count = ? , ordinal = ? WHERE plstitem_id = ?");
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    sprintf(db->sql_cmd, " UPDATE db2.plst_item SET play_count = ?, ordinal = ? WHERE plstitem_id = ?");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                ret_t = pls_sql_prepare_ex(db, db->sql_cmd, &stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                sqlite3_bind_kal_uint32(stmt_t, 1, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt_t, 2, playing_info->ordinal);
                sqlite3_bind_kal_uint32(stmt_t, 3, *active_id);
                ret_t = pls_sql_step_ex(db, stmt_t);
                pls_sql_finalize(stmt_t);
                if(ret_t != SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    return ret_t;
                }
                pls_sql_finalize(stmt);
                ret_t = pls_sql_get_active_index_by_id(db, playing_info, *active_id, &playing_info->pick_index);
                if(ret_t == SRV_PLST_OK)
                {
                    return ret;
                }
                else
                {
                    return ret_t;
                }
            }
            else
            {
                U32 min_value; 
                pls_sql_finalize(stmt);
                       
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret;      
            }
        } 
        else 
        {
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
    }   
    else /* shuffle off */
    {
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            U32 ordinal;
            U32 ordinal2 = 0;
            UI_character_type name[SRV_PLST_META_INFO_MAX_LEN + 1];

            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
            {
                ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM main.audio WHERE play_count = ?", &stmt);
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && 
                playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM main.audio WHERE play_count = ? AND artist_id = ? AND album_id = ? ", &stmt);
            }
            else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                const S8* ptr;

                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    ptr = Sqlartistid;                    
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                    ptr = Sqlalbumid;
                }
                else 
                {
                    ptr = Sqlgenreid;
                }
                kal_sprintf(db->sql_cmd, "SELECT MAX(ordinal) FROM main.audio WHERE play_count = ? AND %s", ptr);
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            }
                
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);

            if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
            }
            else 
            {
                sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);                
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ordinal = sqlite3_column_kal_uint32(stmt, 0);   
                ret = SRV_PLST_OK;
            }
            else
            {
                ordinal = 0;
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {               
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_AUDIO)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM db2.audio WHERE play_count = ?", &stmt);
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && 
                    playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM db2.audio WHERE play_count = ? AND artist_id = ? AND album_id = ? ", &stmt);
                }
                else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM  ||
                    playing_info->play_info.view_type[0] == SRV_PLST_VIEW_GENRE)
                {
                    const S8* ptr;

                    if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ptr = Sqlartistid;                    
                    }
                    else if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ALBUM)
                    {
                        ptr = Sqlalbumid;
                    }
                    else 
                    {
                        ptr = Sqlgenreid;
                    }
                    kal_sprintf(db->sql_cmd, "SELECT MAX(ordinal) FROM db2.audio WHERE play_count = ? AND %s", ptr);
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                if(playing_info->play_info.view_type[0] == SRV_PLST_VIEW_ARTIST && playing_info->play_info.view_type[1] == SRV_PLST_VIEW_ALBUM)
                {                    
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->play_info.id[0]);
                    sqlite3_bind_kal_uint32(stmt, 3, playing_info->play_info.id[1]);
                }
                else 
                {
                    sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);                    
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ordinal2 = sqlite3_column_kal_uint32(stmt, 0);                
                    ret = SRV_PLST_OK;
                }
                else
                {
                    ordinal2 = 0;
                }
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            if (ordinal2 == ordinal && ordinal == 0) /* not exist, use the fist id */
            {
                U32 min_value;
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret;    
            }

            if(ordinal >= ordinal2)
            {
                ret = pls_sql_prepare_ex(db, "SELECT media_id, name FROM main.audio WHERE play_count = ? and ordinal = ? ", &stmt);
            }
            else 
            {
                ret = pls_sql_prepare_ex(db, "SELECT media_id, name FROM db2.audio WHERE play_count = ? and ordinal = ? ", &stmt);
                ordinal = ordinal2;
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, ordinal);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                playing_info->current_picked_id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->ordinal = ordinal;
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_wstr(stmt, 1),SRV_PLST_META_INFO_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
            }
            else 
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_ERR_UNKOWN_ERR;
            }
            pls_sql_finalize(stmt);
            /* find next */  
            playing_info->pick_index --;
            ret = pls_sql_get_next_active_id(db, playing_info, active_id);
            return ret;
            
        }
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {           
            U32 ordinal;
            U32 ordinal2 = 0;
            UI_character_type name[SRV_PLST_META_INFO_MAX_LEN + 1];

            ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM main.video WHERE play_count = ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                ordinal = sqlite3_column_kal_uint32(stmt, 0);                
            }
            else
            {
                ordinal = 0;
            }
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {               
                ret = pls_sql_prepare_ex(db, "SELECT MAX(ordinal) FROM db2.video WHERE play_count = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    ordinal2 = sqlite3_column_kal_uint32(stmt, 0);                
                }
                else
                {
                    ordinal2 = 0;
                }
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */

            if (ordinal == ordinal2 && ordinal == 0) /* not exist, use the fist id */
            {
                U32 min_value;
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret;    
            }

            if(ordinal >= ordinal2)
            {
                ret = pls_sql_prepare_ex(db, "SELECT vdo_id, name FROM main.video WHERE play_count = ? and ordinal = ? ", &stmt);
            }
            else 
            {
                ret = pls_sql_prepare_ex(db, "SELECT vdo_id, name FROM db2.video WHERE play_count = ? and ordinal = ? ", &stmt);
                ordinal = ordinal2;
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, ordinal);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                playing_info->current_picked_id = sqlite3_column_kal_uint32(stmt, 0);
                playing_info->ordinal = ordinal;
                if(mmi_ucs2strlen((S8*)sqlite3_column_kal_str(stmt, 1)))
                {
                    mmi_ucs2ncpy((S8*)name, (S8*)sqlite3_column_kal_str(stmt, 1),SRV_PLST_META_INFO_MAX_LEN);
                }
                else
                {
                    name[0] = 0;
                }
                ret = SRV_PLST_OK;
            }
            else 
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_ERR_UNKOWN_ERR;
            }
            pls_sql_finalize(stmt);
            /* find next */  
            playing_info->pick_index --;
            ret = pls_sql_get_next_active_id(db, playing_info, active_id);
            return ret;
        }            
    #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            U32 ordinal = 0;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->plst_id <= 0X8000 && playing_info->plst_id > 0)
            {
                sprintf(db->sql_cmd, "SELECT max(ordinal) FROM db2.plst_item WHERE play_count = ? and plst_id = ?");          
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd, "SELECT max(ordinal) FROM main.plst_item WHERE  play_count = ? and plst_id = ?");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT max(ordinal) FROM main.plst_item WHERE media_id > 32768 AND play_count = ? and plst_id = ?");
                }
            }            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, playing_info->plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                ordinal = sqlite3_column_kal_uint32(stmt, 0);
            }
            else 
            {
                ordinal = 0;
            }
            pls_sql_finalize(stmt);
            if(!ordinal)
            {
                U32 min_value;
                playing_info->ordinal = playing_info->total;
                playing_info->pick_index = 0;
                ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
                playing_info->current_picked_id = min_value;
                ret = pls_sql_set_active(db, playing_info);
                playing_info->played_count = 1;
                playing_info->pick_count = 1;
                return ret; 
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(playing_info->plst_id <= 0X8000 && playing_info->plst_id > 0)
            {
                sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item, main.meta WHERE play_count = ? and ordinal = ? and plst_id = ? AND meta.media_id = plst_item.media_id");
                strcat(db->sql_cmd, " UNION SELECT plstitem_id FROM db2.plst_item, db2.meta WHERE play_count = ? and ordinal = ? and plst_id = ? AND meta.media_id = plst_item.media_id ");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {                
                sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item, main.meta WHERE  play_count = ? and ordinal = ? and plst_id = ? AND meta.media_id = plst_item.media_id ");
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    strcat(db->sql_cmd, " UNION SELECT plstitem_id FROM main.plst_item, db2.meta WHERE  play_count = ? and ordinal = ? and plst_id = ? AND meta.media_id = plst_item.media_id  ");
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
            }            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, playing_info->play_id);
            sqlite3_bind_kal_uint32(stmt, 2, ordinal);
            sqlite3_bind_kal_uint32(stmt, 3, playing_info->plst_id);

            if(playing_info->plst_id <= 0X8000 ||
                (playing_info->plst_id > 0X8000 && IS_CARD_EXIST))
            {
                sqlite3_bind_kal_uint32(stmt, 4, playing_info->play_id);
                sqlite3_bind_kal_uint32(stmt, 5, ordinal);
                sqlite3_bind_kal_uint32(stmt, 6, playing_info->plst_id);
            }
            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;                
                playing_info->current_picked_id = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                playing_info->ordinal = ordinal;
                playing_info->pick_index --;
                ret = pls_sql_get_next_active_id(db, playing_info, active_id);
                return ret;                
            } 
            else
            {
                pls_sql_finalize(stmt);
                return SRV_PLST_RET_ERR_UNKOWN_ERR;
            }            
        }  
        else 
        {
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
    } 
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_udpate_active_info_after_change_index
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_udpate_active_info_after_change_index(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt* stmt;
    U32 idx = 0;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    /*
    CREATE TABLE playing_info(
        unque_id      INTEGER     PRIMARY KEY,
        plst_id       INTEGER,
        playing_type  INTEGER,
        idx           INTEGER,
        filtertype    BLOB)                           
    */
    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_UPDATE_ACTIVE_INFO_AFTER_CHANGE_INDEX, 0, __LINE__);

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        ret = pls_sql_prepare_ex(db, "SELECT * FROM db2.playing_info WHERE unque_id = 1", &stmt);
    }
    else
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    {
        ret = pls_sql_prepare_ex(db, "SELECT * FROM main.playing_info WHERE unque_id = 1", &stmt);
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        ret = SRV_PLST_OK;                

        if (playing_info->plst_id == sqlite3_column_kal_uint32(stmt, 1) &&
            playing_info->current_picked_id == sqlite3_column_kal_uint32(stmt, 2) &&
            playing_info->active_type == (srv_plst_active_list_enum)sqlite3_column_kal_uint32(stmt, 3) &&
            sqlite3_column_blob(stmt, 4) != NULL &&
            memcmp((S8*)(&(playing_info->play_info)), (const S8*)sqlite3_column_blob(stmt, 4),sizeof(srv_plst_list_view_type_struct)) == 0)
        {
            pls_sql_finalize(stmt);
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_UPDATE_ACTIVE_INFO_AFTER_CHANGE_INDEX, 0, __LINE__);
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "UPDATE db2.playing_info set plst_id = ?, playing_type = ?, idx = ?, filtertype = ? WHERE unque_id = 1");
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "UPDATE main.playing_info set plst_id = ?, playing_type = ?, idx = ?, filtertype = ? WHERE unque_id = 1");
            }
        }
    } 
    else
    {
        pls_sql_finalize(stmt);
        //return SRV_PLST_RET_ERR_UNKOWN_ERR;

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "INSERT INTO db2.playing_info(plst_id, playing_type, idx, filtertype) VALUES (?,?,?,?)");
        }
        else
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        {
            sprintf(db->sql_cmd, "INSERT INTO main.playing_info(plst_id, playing_type, idx, filtertype) VALUES (?,?,?,?)");
        }
    }

    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, playing_info->plst_id);
    sqlite3_bind_kal_uint32(stmt, 2, playing_info->active_type);
    sqlite3_bind_kal_int32(stmt, 3, playing_info->current_picked_id);
    sqlite3_bind_blob(stmt, 4, (srv_plst_list_view_type_struct*)&(playing_info->play_info), sizeof(srv_plst_list_view_type_struct), SQLITE_STATIC);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_UPDATE_ACTIVE_INFO_AFTER_CHANGE_INDEX, ret, __LINE__);
    return ret;
}


S32 pls_sql_get_current_active_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* active_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = pls_sql_check_current_active_id_exist(db, playing_info);
    if(ret < SRV_PLST_OK)
    {
        return ret;
    }

    if(ret)
    {
        return SRV_PLST_OK;
    }
    else
    {
        return pls_sql_get_next_if_current_not_exist(db, playing_info, active_id);
    }
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_shuffle_next
 * DESCRIPTION
 *  get next song for shuffle on for next and auto next
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_shuffle_next(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* id, MMI_BOOL is_auto)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 rands_id;
    MMI_BOOL find_location = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* play ordinal */
    if(playing_info->pick_count >= playing_info->total) /* playing one finished*/
    {
        U32 min_value;

        playing_info->ordinal = playing_info->total;
        playing_info->pick_index = 0;
        ret = pls_sql_get_active_id_by_index(db, playing_info,0, &min_value);
        playing_info->current_picked_id = min_value;
        ret = pls_sql_set_active(db, playing_info);
        playing_info->played_count = 1;
        playing_info->pick_count = 1;
        return ret;
    }
    else if(playing_info->played_count < playing_info->pick_count) /* playing in the shuffle rarry */
    {
        playing_info->played_count ++;
        playing_info->ordinal ++;
        ret = pls_sql_get_id_by_ordinal(db, playing_info, MMI_FALSE, MMI_FALSE, id);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
// MAUI_02948311
//Should update playing_info->pick_index every since shuffle pick, too
//Because if not, playing_info->pick_index value will be error while toggling shuffle on -> shuffle off 
//and the last song cannot be skipped when pick next from the last song of the loop 
            pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
            ret = SRV_PLST_OK;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
        playing_info->current_picked_id = *id;
        return ret;
    }
    else/* random a id */ 
    {
        U32 ph_max = 0;
        U32 ph_min = 0;
        U32 ph_count = 0;
        U32 ca_max = 0;
        U32 ca_min = 0;
        U32 ca_count = 0;
        MMI_BOOL is_card = MMI_FALSE;

        /* No need to select "ca_count" in this function it takes much time when many entry. It can be counted */
        ret = pls_sql_get_max_unselect_by_drv(db, playing_info, &ph_max, &ph_min, &ph_count, &ca_max, &ca_min, &ca_count);
        //ASSERT((ph_count + ca_count) == (playing_info->total - playing_info->pick_count));
        ca_count = playing_info->total - playing_info->pick_count - ph_count;

        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
            {
                if(playing_info->plst_id < 0X8000 && ca_count)
                {
                    rands_id = pls_sql_util_rand(1, ca_count);
                    is_card = MMI_TRUE;
                }
                else if(playing_info->plst_id > 0X8000 && ph_count)
                {                       
                    rands_id = pls_sql_util_rand(1, ph_count);
                }
                else
                {
                    return SRV_PLST_RET_ERR_FATAL_ERROR;
                }
            }
            else
            {
            if(playing_info->plst_id > 0X8000)
            {
                is_card = MMI_FALSE;
                rands_id = pls_sql_util_rand(ph_min, ph_max);
            }
            else
            {
                is_card = MMI_TRUE;
                rands_id = pls_sql_util_rand(ca_min, ca_max);
            }
            }
        }
        else
        {
            if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
            {
                if(ca_count > ph_count )
                {
                    rands_id = pls_sql_util_rand(1, ca_count);
                    is_card = MMI_TRUE;
                }
                else
                {
                    if(ph_count < 1)
                    {
                        return SRV_PLST_RET_ERR_FATAL_ERROR;
                    }
                    rands_id = pls_sql_util_rand(1, ph_count);
                }
            }
            else
            {
                if(ca_count > ph_count )
                {
                    if(ca_min > ca_max)
                    {
                        return SRV_PLST_RET_ERR_FATAL_ERROR;
                    }
                    rands_id = pls_sql_util_rand(ca_min, ca_max);
                    is_card = MMI_TRUE;
                }
                else
                {
                    if(ph_min > ph_max)
                    {
                        return SRV_PLST_RET_ERR_FATAL_ERROR;
                    }
                    rands_id = pls_sql_util_rand(ph_min, ph_max);
                }
            }
        }
        playing_info->ordinal ++;
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
            {
                ret = pls_sql_get_active_media_id_for_video_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                if(ret == SRV_PLST_OK)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;                       
                    pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                }
                return ret;
            }
            else
            {
                ret = pls_sql_get_active_media_id_for_video_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;                        
                    pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    find_location = MMI_FALSE;
                    ret = pls_sql_get_active_media_id_for_video_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count ++;
                        playing_info->current_picked_id = *id;
                        pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                        ret = SRV_PLST_OK;                            
                    }
                    else if(ret == SRV_PLST_OK) 
                    {
                        ret = SRV_PLST_RET_ERR_UNKOWN_ERR;
                    }
                }  
                return ret;
            }
        }
        else
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
        if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
            {
                ret = pls_sql_get_active_media_id_for_audio_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                if(ret == SRV_PLST_OK)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;                       
                    pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                }
                return ret;
            }
            else
            {
                ret = pls_sql_get_active_media_id_for_audio_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;
                    // For next mode, do not count index here, it will update later by application
                    // TODO: it should no need to update for auto next mode either, need to check with app
                    if(is_auto)
                    {
                        pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    }
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    find_location = MMI_FALSE;
                    ret = pls_sql_get_active_media_id_for_audio_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count ++;
                        playing_info->current_picked_id = *id;
                        // For next mode, do not count index here, it will update later by application
                        // TODO: it should no need to update for auto next mode either, need to check with app
                        if(is_auto)
                        {
                            pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                        }
                        ret = SRV_PLST_OK;                           
                    }
                }
                return ret;
            }
        }
        else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
            {
                ret = pls_sql_get_active_media_id_for_plst_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                if(ret == SRV_PLST_OK)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;                       
                    pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                }
                return ret;
            }
            else
            {
                ret = pls_sql_get_active_media_id_for_plst_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    playing_info->pick_count ++;
                    playing_info->played_count ++;
                    playing_info->current_picked_id = *id;                        
                    pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    find_location = MMI_FALSE;
                    ret = pls_sql_get_active_media_id_for_plst_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count ++;
                        playing_info->current_picked_id = *id;                            
                        pls_sql_get_active_index_by_id(db, playing_info, *id, &playing_info->pick_index);
                        ret = SRV_PLST_OK;
                    }
                }
                return ret;
            }
        }
        else 
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }        
    } /* rand id finished */
}

// MAUI_02990331
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_auto_active_id_int
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_auto_active_id_int(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    ret = pls_sql_check_current_active_id_exist(db, playing_info);
    if(ret < SRV_PLST_OK)
    {
        return ret;
    }
    if(!ret)
    {
        return pls_sql_get_next_if_current_not_exist(db, playing_info, id);
    }
    ret = SRV_PLST_OK;
    if(base->shuffle == SRV_PLST_SHUFFLE_OFF)
    {    
        /* play ordinal */
        if(playing_info->pick_count >= playing_info->total) /* playing one finished*/
        {        
            playing_info->ordinal = playing_info->total;
            playing_info->play_id ++;
            ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, id);
            playing_info->current_picked_id = *id;
            if(playing_info->pick_index < (playing_info->total - 1))
            {
                playing_info->pick_index++;
            }
            else
            {
                playing_info->pick_index = 0;
            }
            playing_info->played_count = 1;
            playing_info->pick_count = 1;
            return ret;
        }
        else if(playing_info->played_count < playing_info->pick_count)
        {
            playing_info->played_count ++;
            playing_info->ordinal ++;
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                srv_plst_default_playlist_enum type;
                pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
                if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    ret = pls_sql_get_id_by_ordinal(db, playing_info, MMI_FALSE, MMI_FALSE, &playing_info->current_picked_id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        ret = SRV_PLST_OK;
                    }
                }
                else
                {
                    ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, &playing_info->current_picked_id);
                }
            }
            else
            {
                ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, &playing_info->current_picked_id);
            }
            if(playing_info->pick_index < (playing_info->total - 1))
            {
                playing_info->pick_index++;
            }
            else
            {
                playing_info->pick_index = 0;
            }           
            playing_info->current_picked_id = *id; 
        }
        else
        {
            playing_info->played_count ++;               
            playing_info->ordinal ++;
            ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, id);
            if(playing_info->pick_index < (playing_info->total - 1))
            {
                playing_info->pick_index++;
            }
            else
            {
                playing_info->pick_index = 0;
            } 
            playing_info->pick_count ++;
            playing_info->current_picked_id = *id;  
            
            return ret;
        }       
    }
    else if(base->shuffle == SRV_PLST_SHUFFLE_ON)
    {
        ret = pls_sql_get_shuffle_next(db, playing_info, id, MMI_TRUE);
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    return ret;
}


//MAUI_02990331
//wrongly logic to apply the same behavior beteen get auto and get next
//seperate the functions and revise for pick file counter 
/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_auto_active_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_auto_active_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    ret = pls_sql_check_current_active_id_exist(db, playing_info);
    if(ret < SRV_PLST_OK)
    {
        return ret;
    }
    if(!ret)
    {
        return pls_sql_get_next_if_current_not_exist(db, playing_info, id);
    }
    ret = SRV_PLST_OK;

    if(base->repeat == SRV_PLST_REPEAT_ONE)
    {
        *id = playing_info->current_picked_id;
    }
    /* SRV_PLST_REPEAT_OFF or SRV_PLST_REPEAT_ALL */
    else 
    {
        S32 ret_t;

        /* For reapeat off or repeat all but app have play cycle information, return empty */

        if(base->shuffle == SRV_PLST_SHUFFLE_OFF)
        {
            /* For shuffle off mode, stop songs when play to the end of list */
            if(playing_info->pick_index == (playing_info->total - 1)  &&
               (base->repeat == SRV_PLST_REPEAT_OFF || base->config_play_cycle_info == SRV_PLST_HAVE_PLAY_CYCLE_INFO))
            {
                ret = SRV_PLST_RET_EMPTY;
            }

        }
        else
        {
            /* For shuffle on mode, stop songs when play a full cycle */
            if(playing_info->pick_count >= playing_info->total &&
               (base->repeat == SRV_PLST_REPEAT_OFF || base->config_play_cycle_info == SRV_PLST_HAVE_PLAY_CYCLE_INFO))
            {
                ret = SRV_PLST_RET_EMPTY;
            }
        }

        if(playing_info->pick_no_played)
        {
            *id = playing_info->current_picked_id;
            playing_info->pick_no_played = MMI_FALSE;
        }
        else
        {
            ret_t = pls_sql_get_auto_active_id_int(db, playing_info, id);
            if(ret_t != SRV_PLST_OK)
            {
                ret = ret_t;
            }
         }
     }
    return ret;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_next_active_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_next_active_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    ret = pls_sql_check_current_active_id_exist(db, playing_info);
    if(ret < SRV_PLST_OK)
    {
        return ret;
    }
    if(!ret)
    {
        return pls_sql_get_next_if_current_not_exist(db, playing_info, id);
    }
    ret = SRV_PLST_OK;
    if(base->shuffle == SRV_PLST_SHUFFLE_OFF)
    {    
        /* play ordinal */
        if(playing_info->pick_count >= playing_info->total) /* playing one finished*/
        {        
            playing_info->ordinal = playing_info->total;
            playing_info->play_id ++;
            ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, id);
            playing_info->current_picked_id = *id;
            if(playing_info->pick_index < (playing_info->total - 1))
            {
                playing_info->pick_index++;
            }
            else
            {
                playing_info->pick_index = 0;
            }
            playing_info->played_count = 1;
            playing_info->pick_count = 1;
            return ret;
        }
        else
        {
            playing_info->ordinal ++;
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                srv_plst_default_playlist_enum type;
                pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
                if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    ret = pls_sql_get_id_by_ordinal(db, playing_info, MMI_FALSE, MMI_FALSE, &playing_info->current_picked_id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        ret = SRV_PLST_OK;
                    }
                }
                else
                {
                    ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, &playing_info->current_picked_id);
                }
            }
            else
            {
                ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_TRUE, &playing_info->current_picked_id);
            }
            if(playing_info->pick_index < (playing_info->total - 1))
            {
                playing_info->pick_index++;
            }
            else
            {
                playing_info->pick_index = 0;
            }           
            playing_info->current_picked_id = *id; 
            if(playing_info->played_count <= 1)
            {
                playing_info->played_count = 1;
            }
            else
            {
                playing_info->played_count --;                
            }             
            if(base->config_store_play_info != SRV_PLST_PLAY_INFO_STORE)
            {
                pls_sql_set_active(db, playing_info);
            }
            return ret;
        }
    }
    else if(base->shuffle == SRV_PLST_SHUFFLE_ON)
    {
        ret = pls_sql_get_shuffle_next(db, playing_info, id, MMI_FALSE);
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_prev_active_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_prev_active_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct *playing_info, U32* id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    U32 rands_id;
    MMI_BOOL find_location = MMI_TRUE;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    ret = pls_sql_check_current_active_id_exist(db, playing_info);
    if(ret < SRV_PLST_OK)
    {
        return ret;
    }
    if(!ret)
    {
        return pls_sql_get_next_if_current_not_exist(db, playing_info, id);
    }
    ret = SRV_PLST_OK;

    if(base->shuffle == SRV_PLST_SHUFFLE_OFF)
    {    
        /* play ordinal */
        if(playing_info->pick_count >= playing_info->total) /* playing one finished*/
        {
            playing_info->ordinal = playing_info->total;
            playing_info->play_id ++;
            ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_FALSE, id);
            playing_info->current_picked_id = *id;
            if(playing_info->pick_index == 0)
            {
                playing_info->pick_index = playing_info->pick_count - 1;
            }
            else
            {
                playing_info->pick_index--;
            }
            playing_info->played_count = 1;
            playing_info->pick_count = 1;
            return ret;
        }
        else 
        {
            playing_info->ordinal --;
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST &&  playing_info->played_count > 1)
            {
                srv_plst_default_playlist_enum type;
                pls_sql_util_get_default_list_info(db, playing_info->plst_id, &type);
                if(type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST)
                {
                    ret = pls_sql_get_id_by_ordinal(db, playing_info, MMI_TRUE, MMI_TRUE, &playing_info->current_picked_id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        ret = SRV_PLST_OK;
                    }
                }
                else
                {
                    ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_FALSE, id);
                }
            }
            else
            {
                ret = pls_sql_get_id_by_sequeue(db, playing_info, MMI_FALSE, id);
            }
            playing_info->current_picked_id = *id;      

            if(playing_info->played_count <= 1)
            {
                playing_info->played_count = 1;
            }
            else
            {
                playing_info->played_count --;                
            }             
            if(playing_info->pick_index > 0 )
            {
                playing_info->pick_index--;
            }
            else
            {
                playing_info->pick_index = playing_info->total - 1;
            }    
            if(base->config_store_play_info != SRV_PLST_PLAY_INFO_STORE)
            {
                pls_sql_set_active(db, playing_info);
            }
            return ret;
        }        
    }
    else if(base->shuffle == SRV_PLST_SHUFFLE_ON)
    {
        /* play ordinal */
        if(playing_info->pick_count >= playing_info->total) /* playing one finished*/
        {        
            U32 min_value;
            
            playing_info->ordinal = playing_info->total;
            playing_info->pick_index = 0;
            ret = pls_sql_get_active_id_by_index(db, playing_info, 0, &min_value);
            playing_info->current_picked_id = min_value;
            ret = pls_sql_set_active(db, playing_info);
            playing_info->played_count = 1;
            playing_info->pick_count = 1;
            return ret;
        }
        else if(playing_info->played_count > 1) /* playing in the shuffle rarry */
        {
            playing_info->played_count-- ;
            playing_info->ordinal--;
            ret = pls_sql_get_id_by_ordinal(db, playing_info,MMI_TRUE, MMI_TRUE, id);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
            }
            else
            {
                ret = SRV_PLST_RET_ERR_UNKOWN_ERR;
            }
            playing_info->current_picked_id = *id;
            return ret;
        }
        else/* random a id */ 
        {
            U32 ph_max = 0;
            U32 ph_min = 0;
            U32 ph_count = 0;
            U32 ca_max = 0;
            U32 ca_min = 0;
            U32 ca_count = 0;
            MMI_BOOL is_card = MMI_FALSE;

            /* No need to select "ca_count" in this function it takes much time when many entry. It can be counted */
            ret = pls_sql_get_max_unselect_by_drv(db, playing_info, &ph_max, &ph_min, &ph_count, &ca_max, &ca_min, &ca_count);
            //ASSERT((ph_count + ca_count) == (playing_info->total - playing_info->pick_count));
            ca_count = playing_info->total - playing_info->pick_count - ph_count;

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }   
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
                {
                    if(playing_info->plst_id < 0X8000 && ca_count)
                    {
                        rands_id = pls_sql_util_rand(1, ca_count);
                        is_card = MMI_TRUE;
                    }
                    else if(playing_info->plst_id > 0X8000 && ph_count)
                    {                       
                        rands_id = pls_sql_util_rand(1, ph_count);
                    }
                    else
                    {
                        return SRV_PLST_RET_ERR_FATAL_ERROR;
                    }
                }
                else
                {
                if(playing_info->plst_id > 0X8000)
                {
                    is_card = MMI_FALSE;
                    rands_id = pls_sql_util_rand(ph_min, ph_max);
                }
                else
                {
                    is_card = MMI_TRUE;
                    rands_id = pls_sql_util_rand(ca_min, ca_max);
                }
            }
            }
            else
            {            
                if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
                {
                    if(ca_count > ph_count )
                    {
                        rands_id = pls_sql_util_rand(1, ca_count);
                        is_card = MMI_TRUE;
                    }
                    else
                    {
                        if(ph_count < 1)
                        {
                            return SRV_PLST_RET_ERR_FATAL_ERROR;
                        }
                        rands_id = pls_sql_util_rand(1, ph_count);
                    }
                }
                else
                {
                    if(ca_count > ph_count )
                    {
                        if(ca_min > ca_max)
                        {
                            return SRV_PLST_RET_ERR_FATAL_ERROR;
                        }
                        rands_id = pls_sql_util_rand(ca_min, ca_max);
                        is_card = MMI_TRUE;
                    }
                    else
                    {
                        if(ph_min > ph_max)
                        {
                            return SRV_PLST_RET_ERR_FATAL_ERROR;
                        }
                        rands_id = pls_sql_util_rand(ph_min, ph_max);
                    }
                }
            }
            playing_info->ordinal --;
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
            {
                if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
                {
                    ret = pls_sql_get_active_media_id_for_video_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                    if(ret == SRV_PLST_OK)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;                       
                    }
                    return ret;
                }
                else
                {
                    ret = pls_sql_get_active_media_id_for_video_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;
                        ret = SRV_PLST_OK;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        find_location = MMI_FALSE;
                        ret = pls_sql_get_active_media_id_for_video_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            playing_info->pick_count ++;
                            playing_info->played_count = 1;
                            playing_info->current_picked_id = *id;
                            ret = SRV_PLST_OK;
                        }
                    }
                    return ret;
                }
            }
            else
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
            {
                if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
                {
                    ret = pls_sql_get_active_media_id_for_audio_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                    if(ret == SRV_PLST_OK)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;
                    }
                    return ret;
                }
                else
                {
                    ret = pls_sql_get_active_media_id_for_audio_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;
                        ret = SRV_PLST_OK;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        find_location = MMI_FALSE;
                        ret = pls_sql_get_active_media_id_for_audio_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            playing_info->pick_count ++;
                            playing_info->played_count = 1;
                            playing_info->current_picked_id = *id;
                            ret = SRV_PLST_OK;
                        }
                    }
                    return ret;
                }
            }
            else if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
            {
                if(playing_info->total < SRV_PLST_SQL_SHUFFLE_LIMIT)
                {
                    ret = pls_sql_get_active_media_id_for_plst_by_drv_by_offset(db, playing_info, is_card, rands_id, id);
                    if(ret == SRV_PLST_OK)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;
                    }
                    return ret;
                }
                else
                {
                    ret = pls_sql_get_active_media_id_for_plst_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        playing_info->pick_count ++;
                        playing_info->played_count = 1;
                        playing_info->current_picked_id = *id;
                        ret = SRV_PLST_OK;
                    }
                    else if(ret == SRV_PLST_OK)
                    {
                        find_location = MMI_FALSE;
                        ret = pls_sql_get_active_media_id_for_plst_by_drv(db, playing_info, is_card, find_location, rands_id, id);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            playing_info->pick_count ++;
                            playing_info->played_count = 1;
                            playing_info->current_picked_id = *id;
                            ret = SRV_PLST_OK;
                        }
                    }
                    return ret;
                }
            }
            else 
            {
                ret = SRV_PLST_RET_ERR_PARAM_ERR;
                return ret;
            }        
        } /* rand id finished */         
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_active_media_path_by_id
 * DESCRIPTION
 *   active list only 
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_get_active_media_path_by_id(srv_plst_db_context_struct *db, srv_plst_playing_context_struct  *play_info, srv_plst_active_list_enum active_type, U32 id, UI_string_type path,  U32 *id_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(play_info->plst_id > 0X8000)
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ? ");
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            sprintf(db->sql_cmd, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ? ");
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        ret = pls_sql_prepare_ex(db, db->sql_cmd,&stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            *id_o = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            *id_o = 0;
        }
        pls_sql_finalize(stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
    }
    else
    {
        *id_o = id;
    }
    

    if(path != NULL)
    {
    
        if(active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT path FROM main.meta_slim WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT path FROM db2.meta_slim WHERE media_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
        else if(active_type == SRV_PLST_ACTIVE_LIST_VIDEO)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT path FROM main.video WHERE vdo_id = ?");            
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT path FROM db2.video WHERE vdo_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    #endif /* __PLST_SRV_FEATURE_VIDEO_SUPPORT__ */
        else if(active_type == SRV_PLST_ACTIVE_LIST_STREAM_LINK)
        {
            if(id > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT URL FROM main.stream WHERE stream_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT URL FROM db2.stream WHERE stream_id = ? ");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else if(active_type == SRV_PLST_ACTIVE_LIST_PLST)
        {
            if(*id_o > 0X8000)
            {
                sprintf(db->sql_cmd, "SELECT path FROM main.meta_slim WHERE media_id = ?");
            }
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            else
            {
                sprintf(db->sql_cmd, "SELECT path FROM db2.meta_slim WHERE media_id = ?");
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
        else 
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
            return ret;
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, *id_o);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            ret = SRV_PLST_OK;
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
            {
                if(active_type == SRV_PLST_ACTIVE_LIST_STREAM_LINK)
                {// to do : change as stream link length
                    if(mmi_ucs2strlen((S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)path, (const S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_FMGR_PATH_MAX_LEN);
                    }
                    else
                    {
                        path[0] = 0;
                    }
                }
                else
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)path, (const S8*)sqlite3_column_kal_wstr(stmt, 0), SRV_FMGR_PATH_MAX_LEN);
                    }
                    else
                    {
                        path[0] = 0;
                    }
                }
            }
        }
        pls_sql_finalize(stmt);
    }
    return ret;    
}

S32 pls_sql_get_cntx_by_id(srv_plst_db_context_struct *db, srv_plst_get_cntx_param_struct *in_param, srv_plst_get_context_struct *out_param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 id = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(in_param->id_enum == SRV_PLST_TYPE_ID_NONE || in_param->id_enum > SRV_PLST_TYPE_ID_PLST)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(in_param->get_type >= SRV_PLST_CNTX_TYPE_END)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }

    if(in_param->id_enum == SRV_PLST_TYPE_ID_ALBUM)
    {
        switch(in_param->get_type)
        {
            case SRV_PLST_CNTX_TYPE_ARTISTNAME:
                ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM main.audio WHERE album_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM db2.audio WHERE album_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            //bql: MAUI_02661984 statement finalize leak
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }

                if(ret != SRV_PLST_OK)
                {
                    break;
                }
               
                ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM db2.artist WHERE artist_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
                
            case SRV_PLST_CNTX_TYPE_ALBUMNAME:
                ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE album_id = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;                    
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_name FROM db2.album WHERE album_id = ?", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;                    
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }                    
                break;
                
        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_CNTX_TYPE_GENRENAME:
                ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM main.audio WHERE album_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM db2.audio WHERE album_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }               
                ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM main.genre WHERE genre_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM db2.genre WHERE genre_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                
            case SRV_PLST_CNTX_TYPE_TITLE:
            case SRV_PLST_CNTX_TYPE_FILENAME:
                ret = SRV_PLST_RET_ERR_SERVICE_MAX_SUPPORT;
                break;
            default:
                break;               
        }
    }
    else if(in_param->id_enum == SRV_PLST_TYPE_ID_ARTIST)
    {
        switch(in_param->get_type)
        {
            case SRV_PLST_CNTX_TYPE_ARTISTNAME:
                ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM db2.artist WHERE artist_id = ?", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
            case SRV_PLST_CNTX_TYPE_ALBUMNAME:
                ret = pls_sql_prepare_ex(db, "SELECT album_id FROM main.audio WHERE artist_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_id FROM db2.audio WHERE artist_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }               
                ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE album_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_name FROM db2.album WHERE album_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
            case SRV_PLST_CNTX_TYPE_GENRENAME:
                ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM main.audio WHERE artist_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_id FROM db2.audio WHERE artist_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }               
                ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM main.genre WHERE genre_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM db2.genre WHERE genre_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
        
            case SRV_PLST_CNTX_TYPE_TITLE:
            case SRV_PLST_CNTX_TYPE_FILENAME:
                ret = SRV_PLST_RET_ERR_SERVICE_MAX_SUPPORT;
                break;

                default:
                    break;
        }
    }
#ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
    else if(in_param->id_enum == SRV_PLST_TYPE_ID_GENRE)
    {
        switch(in_param->get_type)
        {
            case SRV_PLST_CNTX_TYPE_ARTISTNAME:
                ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM main.audio WHERE genre_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_id FROM db2.audio WHERE genre_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }               
                ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM db2.artist WHERE artist_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
            case SRV_PLST_CNTX_TYPE_ALBUMNAME:
                ret = pls_sql_prepare_ex(db, "SELECT album_id FROM main.audio WHERE genre_id = ? limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    id = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_id FROM db2.audio WHERE genre_id = ? limit 1", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            id = sqlite3_column_kal_uint32(stmt, 0);
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }                
                else
                {
                    pls_sql_finalize(stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    break;
                }               
                ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE genre_id = ? ", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_name FROM db2.album WHERE album_id = ? ", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)  
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
            case SRV_PLST_CNTX_TYPE_GENRENAME:
                ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM main.genre WHERE genre_id = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM db2.genre WHERE genre_id = ?", &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                            {
                                mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                            }
                            else
                            {
                                out_param->name[0] = 0;
                            }
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_OK;
                        }
                        else if(ret == SRV_PLST_OK)
                        {
                            pls_sql_finalize(stmt);
                            ret = SRV_PLST_RET_EMPTY;
                        }
                        else
                        {
                            pls_sql_finalize(stmt);
                        }
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
                
            case SRV_PLST_CNTX_TYPE_TITLE:
            case SRV_PLST_CNTX_TYPE_FILENAME:
                break;
               
                default:
                    break;
        }
    }
#endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
    else if(in_param->id_enum == SRV_PLST_TYPE_ID_MEDIA ||
        in_param->id_enum == SRV_PLST_TYPE_ID_AUDIO)
    {  
        U32 artist_id = 0;
        U32 album_id = 0;
        U32 genre_id = 0;
        switch(in_param->get_type)
        {
            case SRV_PLST_CNTX_TYPE_ARTISTNAME:
            case SRV_PLST_CNTX_TYPE_ALBUMNAME:
            case SRV_PLST_CNTX_TYPE_GENRENAME:
                if(in_param->id > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, genre_id FROM main.audio WHERE media_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT artist_id, album_id, genre_id FROM db2.audio WHERE media_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    artist_id = sqlite3_column_kal_uint32(stmt, 0);
                    album_id = sqlite3_column_kal_uint32(stmt, 1);
                    genre_id = sqlite3_column_kal_uint32(stmt, 2);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_OK)
                    {
                        ret = SRV_PLST_RET_EMPTY;
                    }
                    return ret;
                }

                if(in_param->get_type == SRV_PLST_CNTX_TYPE_ARTISTNAME)
                {
                    if(in_param->id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM main.artist WHERE artist_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT artist_name FROM db2.artist WHERE artist_id = ?", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else if(in_param->get_type == SRV_PLST_CNTX_TYPE_ALBUMNAME)
                {
                    if(in_param->id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_name FROM main.album WHERE album_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT album_name FROM db2.album WHERE album_id = ?", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else
                {
                    if(in_param->id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM main.genre WHERE genre_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT genre_name FROM db2.genre WHERE genre_id = ?", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                if(in_param->get_type == SRV_PLST_CNTX_TYPE_ARTISTNAME)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, artist_id);
                }
                else if(in_param->get_type == SRV_PLST_CNTX_TYPE_ALBUMNAME)
                {
                    sqlite3_bind_kal_uint32(stmt, 1, album_id);
                }
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                else
                {
                    sqlite3_bind_kal_uint32(stmt, 1, genre_id);
                }
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_OK)
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_RET_EMPTY;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
                break;
            case SRV_PLST_CNTX_TYPE_TITLE: /* yaling check more after order by title */
            case SRV_PLST_CNTX_TYPE_FILENAME:
                if(in_param->get_type == SRV_PLST_CNTX_TYPE_TITLE)
                {
                    if(in_param->id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT title FROM main.meta WHERE media_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT title FROM db2.meta WHERE media_id = ?", &stmt);
                    }  
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                else
                {
                    if(in_param->id > 0X8000)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT name FROM main.audio WHERE media_id = ?", &stmt);
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT name FROM db2.audio WHERE media_id = ?", &stmt);
                    }  
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, in_param->id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 0)))
                    {
                        mmi_ucs2ncpy((S8*)out_param->name, (const S8*)sqlite3_column_kal_wstr(stmt, 0), (SRV_PLST_META_INFO_MAX_LEN));   
                    }
                    else
                    {
                        out_param->name[0] = 0;
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else 
                {
                    pls_sql_finalize(stmt);
                    if(ret == SRV_PLST_OK)
                    {
                        ret = SRV_PLST_RET_EMPTY;
                    }
                }
                break;

                default:
                    break;
        }
    }
    else 
    {
        ret = SRV_PLST_RET_ERR_SERVICE_MAX_SUPPORT;
        //current unsurpport
    }
    return ret;
}

#ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
S32 pls_sql_update_most_plst_info(srv_plst_db_context_struct *db, U32 media_id, U32 plst_id, U32 list_count, U32 play_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 max_count = SRV_PLST_MOST_PLAYED_COUNT;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */ 
    /*----------------------------------------------------------------*/ 
    if(!max_count || max_count > list_count)
    {
    /* check if exist in the list */
        ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK) /* not exist */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_prepare_ex(db, "INSERT INTO main.plst_item(plst_id, media_id, idx) VALUES(?,?,?) ", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, media_id);
            sqlite3_bind_kal_uint32(stmt, 3, list_count);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }    
        }
        else if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    else
    {
        U32 replace_id = 0;
        U32 play = 0;

        /* check if exist in the list */
        ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK) /* not exist */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_prepare_ex(db, "SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, main.meta WHERE plst_item.media_id = meta.media_id AND played_count != 0 AND played_count < ? \
ORDER BY played_count ASC, plstitem_id asc limit 1", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, play_count);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                replace_id = sqlite3_column_kal_uint32(stmt, 0);
                play = sqlite3_column_kal_uint32(stmt, 1);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            else
            {
                pls_sql_finalize(stmt);
            }

            
            if(IS_CARD_EXIST)
            {  
                ret = pls_sql_prepare_ex(db, "SELECT plstitem_id, played_count FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, db2.meta WHERE plst_item.media_id = meta.media_id AND played_count != 0 AND played_count < ? \
ORDER BY played_count ASC, plstitem_id asc limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, plst_id);
                sqlite3_bind_kal_uint32(stmt, 2, play_count);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    U32 temp_play_count = sqlite3_column_kal_uint32(stmt, 1);

                    if(temp_play_count < play || !play || !replace_id)
                    {
                        replace_id = sqlite3_column_kal_uint32(stmt, 0);
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
            }            

            if(!replace_id) /* found count same but play firstly*/
            {
                ret = pls_sql_prepare_ex(db, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, main.meta WHERE plst_item.media_id = meta.media_id AND played_count = ? \
ORDER BY played ASC, plstitem_id asc limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, plst_id);
                sqlite3_bind_kal_uint32(stmt, 2, play_count);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    replace_id = sqlite3_column_kal_uint32(stmt, 0);
                    play = sqlite3_column_kal_uint32(stmt, 1);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }

                
                if(IS_CARD_EXIST)
                {  
                    ret = pls_sql_prepare_ex(db, "SELECT plstitem_id, played FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, db2.meta WHERE plst_item.media_id = meta.media_id AND played_count = ? \
ORDER BY played ASC, plstitem_id asc limit 1", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, plst_id);
                    sqlite3_bind_kal_uint32(stmt, 2, play_count);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        U32 temp_play_count = sqlite3_column_kal_uint32(stmt, 1);

                        if(temp_play_count < play || !play || !replace_id)
                        {
                            replace_id = sqlite3_column_kal_uint32(stmt, 0);
                        }
                        pls_sql_finalize(stmt);
                        ret = SRV_PLST_OK;
                    }
                    else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                    {
                        pls_sql_finalize(stmt);
                        return ret;
                    }
                    else
                    {
                        pls_sql_finalize(stmt);
                    }
                }                            
            }
            
            if(replace_id)
            {
                ret = pls_sql_prepare_ex(db, "UPDATE main.plst_item SET media_id = ? WHERE plstitem_id = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, media_id);
                sqlite3_bind_kal_uint32(stmt, 2, replace_id);
                ret = pls_sql_step_ex(db, stmt);
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }            
        }
        else if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }  
        else
        {
            pls_sql_finalize(stmt);
        }
    }                 
    return SRV_PLST_OK;
}


S32 pls_sql_update_recent_plst_info(srv_plst_db_context_struct *db, U32 media_id, U32 plst_id, U32 list_count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;      
    U32 max_count = SRV_PLST_RECENT_LIST_MAX_COUNT;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!max_count || max_count > list_count)
    {
         ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK) /* not exist */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_prepare_ex(db, "INSERT INTO main.plst_item(plst_id, media_id, idx) VALUES(?,?,?)", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, media_id);
            sqlite3_bind_kal_uint32(stmt, 3, list_count);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }    
        }
        else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
    }
    else
    {
        U32 replace_id = 0;
        U32 played = 0 ;
        /* check if exist in the list */
        ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK) /* not exist */
        {
            pls_sql_finalize(stmt);
            ret = pls_sql_prepare_ex(db, "SELECT played, plstitem_id FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, main.meta WHERE plst_item.media_id = meta.media_id AND played != 0 order by played asc, plstitem_id asc limit 1", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                replace_id = sqlite3_column_kal_uint32(stmt, 1);
                played = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
            {
                pls_sql_finalize(stmt);
                return ret;
            }
            else
            {
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT played, plstitem_id FROM main.plst INNER JOIN main.plst_item ON main.plst.plst_id = \
main.plst_item.plst_id AND plst.plst_id = ?, db2.meta WHERE plst_item.media_id = meta.media_id AND played != 0 order by played asc, plstitem_id asc limit 1", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, plst_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    U32 temp_played = sqlite3_column_kal_uint32(stmt, 0);
                    if(played > temp_played || !played || !replace_id)
                    {
                        replace_id = sqlite3_column_kal_uint32(stmt, 1);
                    }                        
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
                {
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }   
            }
            
            ret = pls_sql_prepare_ex(db, "UPDATE main.plst_item SET media_id = ? WHERE plstitem_id = ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, media_id);
            sqlite3_bind_kal_uint32(stmt, 2, replace_id);
            ret = pls_sql_step_ex(db, stmt);
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }            
        }
        else if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            pls_sql_finalize(stmt);
            return SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
        }       
    }  
    return SRV_PLST_OK;
}

/*****************************************************************************
 * FUNCTION
 *  pls_sql_update_media_playing_info
 * DESCRIPTION
 *   update current playing media's playing info
 * PARAMETERS
 *  db           [IN]
 * playing_info  [IN]
 * id            [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_update_media_playing_info(srv_plst_db_context_struct *db, srv_plst_playing_context_struct* playing_info, U32 id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 real_id;
    U32 played_count;
    U32 time_new;
    U32 recent_list_id = 0;
    U32 most_list_id = 0;
    U32 recent_list_count;
    U32 most_list_count;
    U32 i;
    U32 id_start = 1;
    applib_time_struct time;
    srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    for(i = 1; i < SRV_PLST_DEF_LIST_ENUM_END ; i = i<<1)
    {
        if (i & base->default_plst_config)
        {
            U32 temp_id;
            switch(i)
            {
                case SRV_PLST_DEF_MY_FAVOURITE:
                case SRV_PLST_DEF_MOST_PLST:
                case SRV_PLST_DEF_RECENTLY_PLST:
                case SRV_PLST_DEF_ON_THE_FLY:
                    temp_id = id_start|0X8000;  
                    if(i == SRV_PLST_DEF_MOST_PLST)
                    {
                        most_list_id = temp_id;
                        break;
                    }
                    else if(i == SRV_PLST_DEF_RECENTLY_PLST)
                    {
                        recent_list_id = temp_id;
                    }
                    id_start++;
                    break;
                    
                default :
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
    }

    /* count most list and recently list*/
    {
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, most_list_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            most_list_count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        }
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, recent_list_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            recent_list_count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return SRV_PLST_RET_ERR_UNKOWN_ERR;
        } 
    }

    /* Get media id from play list */
    if(playing_info->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(playing_info->plst_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plstitem_id = ?", &stmt);
        }
        else 
        {
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM db2.plst_item WHERE plstitem_id = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            real_id = sqlite3_column_kal_uint32(stmt, 0);
        }
        else
        {
            real_id = 0;
        }        
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ERR_SQLITE_ERR)
        {
            return ret;
        }
        ret = SRV_PLST_OK;
    }
    else
    {
        real_id = id;
    }
    if(!real_id)
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }
    
    if(real_id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "SELECT played_count FROM main.meta WHERE media_id = ?", &stmt);
    }
    else
    {
        ret = pls_sql_prepare_ex(db, "SELECT played_count FROM db2.meta WHERE media_id = ?", &stmt);
    }
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, real_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        played_count = sqlite3_column_kal_uint32(stmt, 0);
        pls_sql_finalize(stmt);
    }
    else if(ret == SRV_PLST_OK)
    {
        pls_sql_finalize(stmt);
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    else
    {
        pls_sql_finalize(stmt);
        return SRV_PLST_RET_ERR_SQLITE_ERR;
    }
    applib_dt_get_rtc_time(&time);
    //applib_dt_get_date_time(&time);
    time_new = applib_dt_mytime_2_utc_sec(&time, MMI_FALSE);
    if(real_id > 0X8000)
    {
        ret = pls_sql_prepare_ex(db, "UPDATE main.meta SET played_count= ?, played = ? WHERE media_id = ?", &stmt);
    }
    else
    {
        ret = pls_sql_prepare_ex(db, "UPDATE db2.meta SET played_count= ?, played = ?  WHERE media_id = ?", &stmt);
    }   
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, played_count + 1);
    sqlite3_bind_kal_uint32(stmt, 2, time_new);
    sqlite3_bind_kal_uint32(stmt, 3, real_id);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret != SRV_PLST_OK)
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    ret = SRV_PLST_OK;
    
    /* update most played list info */
    ret = pls_sql_update_most_plst_info(db, real_id, most_list_id, most_list_count, played_count + 1);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    /* update recently list */
    ret = pls_sql_update_recent_plst_info(db, real_id, recent_list_id, recent_list_count);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    return ret;
}
#endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */

#ifdef __PLST_SRV_FEATURE_GROUP_LIST__
static S32 pls_sql_list_jump_one_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, srv_plst_view_type_enum *type, U32 *id, U32* index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 id_temp;
    U32 count = 0;
    U16 ischar = (U16)pls_sql_util_ischar(list_view->search);
    MMI_BOOL found = MMI_TRUE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    *index = 0;

    if(IS_CARD_EXIST)
    {
        switch(type[0])
        {           
            case SRV_PLST_VIEW_AUDIO:
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE p_name >= ? AND ischar = ? order by ischar, p_name, media_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE p_name >= ? AND ischar = ? order by ischar, p_name, media_id limit 1)) order by ischar, p_name, media_id limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE name >= ? order by name, media_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE name >= ? order by name, media_id limit 1)) order by name, media_id limit 1");
                }
                break;
                
        #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
            case SRV_PLST_VIEW_VIDEO:
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, p_name, ischar FROM main.video WHERE p_name >= ? and ischar = ? order by ischar, p_name, vdo_id limit 1) UNION  ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT vdo_id, p_name, ischar FROM db2.video WHERE p_name >= ? AND ischar = ? order by ischar, p_name, vdo_id limit 1)) order by ischar, p_name, vdo_id limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT vdo_id, name FROM main.video WHERE name >= ? order by name, vdo_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT vdo_id, name FROM db2.video WHERE name >= ? order by name, vdo_id limit 1)) order by name, vdo_id limit 1");
                }
                break;
        #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            case SRV_PLST_VIEW_ARTIST:
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, p_name, ischar FROM main.artist WHERE p_name >= ? AND ischar = ? order by ischar, p_name, artist_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT artist_id, p_name, ischar FROM db2.artist WHERE p_name >= ? AND ischar=? order by ischar, p_name, artist_id limit 1)) order by ischar, p_name, artist_id limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name >= ? order by artist_name, artist_id limit 1) UNION");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT artist_id, artist_name FROM db2.artist WHERE artist_name >= ? order by artist_name, artist_id limit 1)) order by artist_name, artist_id limit 1");
                }
                break;

            case SRV_PLST_VIEW_ALBUM:
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, p_name, ischar FROM main.album WHERE p_name >= ? AND ischar = ? order by ischar, p_name, album_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT album_id, p_name, ischar FROM db2.album WHERE p_name >= ? AND ischar = ? order by ischar, p_name, album_id limit 1)) order by ischar, p_name, album_id limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album_id, album_name FROM main.album WHERE album_name >= ? order by album_name, album_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT album_id, album_name FROM db2.album WHERE album_name >= ? order by album_name, album_id limit 1)) order by album_name, album_id limit 1");
                }
                break;

        #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
             case SRV_PLST_VIEW_GENRE:
                if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, p_name, ischar FROM main.genre WHERE p_name >= ? AND ischar = ? order by ischar, p_name, genre_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT genre_id, p_name, ischar FROM db2.genre WHERE p_name >= ? order by ischar, p_name, genre_id limit 1)) order by ischar, p_name, genre_id limit 1");
                }
                else
                {
                    sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name >= ? order by genre_name, genre_id limit 1) UNION ");
                    strcat(db->sql_cmd, "SELECT * FROM (SELECT genre_id, genre_name FROM db2.genre WHERE genre_name >= ? order by genre_name, genre_id limit 1)) order by genre_name, genre_id limit 1");
                }
                break;
        #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
             default:
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }            
    }
    else
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT media_id, p_name FROM main.audio WHERE p_name >= ? AND ischar = ? order by ischar, p_name, media_id limit 1");
                    break;
            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT vdo_id, p_name FROM main.video WHERE p_name >= ? AND ischar=? order by ischar, p_name, vdo_id limit 1");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT artist_id, p_name FROM main.artist WHERE p_name >= ? AND ischar = ? order by ischar, p_name, artist_id limit 1");
                    break;
                
                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT album_id, p_name FROM main.album WHERE p_name >= ? AND ischar = ? order by ischar, p_name, album_id limit 1");
                    break;
                
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                 case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT genre_id, p_name FROM main.genre WHERE p_name >= ? AND ischar = ? order by ischar, p_name, genre_id limit 1");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                 default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }

        }
        else
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE name >= ? order by name, media_id limit 1");
                    break;
            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT vdo_id, name FROM main.video WHERE name >= ? order by name, vdo_id limit 1");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT artist_id, artist_name FROM main.artist WHERE name >= ? order by artist_name, artist_id limit 1");
                    break;
                
                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT album_id, album_name FROM main.album WHERE album_name >= ? order by album_name, album_id limit 1");
                    break;
                
            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                 case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT genre_id, genre_name FROM main.genre WHERE genre_name >= ? order by genre_name, genre_id limit 1");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                 default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
    if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
    {
        sqlite3_bind_kal_uint16(stmt, 2, ischar);
    }
    if(IS_CARD_EXIST)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
            sqlite3_bind_kal_uint16(stmt, 4, ischar);
        }
        else
        {
            sqlite3_bind_kal_wstr(stmt, 2, list_view->search);
        }
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {        
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
        {
            mmi_ucs2ncpy((S8*)list_view->string, (const S8*)sqlite3_column_kal_wstr(stmt, 1), (SRV_PLST_MAX_FILE_LEN));
        }
        else
        {
            list_view->string[0] = 0;
        }
        id_temp = sqlite3_column_kal_uint32(stmt,0);
        pls_sql_finalize(stmt);

        /* count index */
        /* phone first */
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE p_name = ? AND media_id < ? AND ischar = ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video WHERE p_name = ? AND vdo_id < ? AND ischar = ?");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE p_name = ? AND artist_id < ? AND ischar = ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE p_name = ? AND album_id < ? AND ischar = ? ");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre WHERE p_name = ? AND genre_id < ? AND ischar = ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }

        }
        else
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE name = ? AND media_id < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video WHERE name = ? AND vdo_id < ?");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
            
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE artist_name = ? AND artist_id < ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE album_name = ? AND album_id < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre WHERE genre_name = ? AND genre_id < ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
        sqlite3_bind_kal_uint32(stmt, 2, id_temp);
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 3, ischar);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE p_name < ? AND ischar = ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video WHERE p_name < ? AND ischar = ?");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE p_name < ? AND ischar = ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE p_name < ? AND ischar = ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre WHERE p_name < ? AND ischar = ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
        else
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE name < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video WHERE name < ?");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE artist_name < ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE album_name < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre WHERE genre_name < ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint16(stmt, 2, ischar);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            count += sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }


        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            switch(type[0])
            {
                case SRV_PLST_VIEW_AUDIO:
                    sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE ischar < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                case SRV_PLST_VIEW_VIDEO:
                    sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM main.video WHERE ischar < ?");
                    break;
            #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE ischar < ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE ischar < ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM main.genre WHERE ischar < ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }            
            sqlite3_bind_kal_uint16(stmt, 1, ischar);            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count += sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }
        /* card */
        if(IS_CARD_EXIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                switch(type[0])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE p_name = ? AND media_id < ? AND ischar = ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    case SRV_PLST_VIEW_VIDEO:
                        sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE p_name = ? AND vdo_id < ? AND ischar = ?");
                        break;
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                    case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE p_name = ? AND artist_id < ? AND ischar = ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE p_name = ? AND artist_id < ? AND ischar = ?)");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE p_name = ? AND album_id < ? AND ischar = ? UNION \
SELECT album_id, album_name FROM db2.album WHERE p_name = ? AND album_id < ? AND ischar = ? )");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM (SELECT genre_id, genre_name FROM main.genre WHERE p_name = ? AND genre_id < ? AND ischar = ? UNION \
SELECT genre_id, genre_name FROM db2.genre WHERE p_name = ? AND genre_id < ? AND ischar = ?)");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
            }
            else
            {
                switch(type[0])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE name = ? AND media_id < ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    case SRV_PLST_VIEW_VIDEO:
                        sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE name = ? AND vdo_id < ?");
                        break;
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/

                    case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name = ? AND artist_id < ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE artist_name = ? AND artist_id < ?)");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE album_name = ? AND album_id < ? UNION \
SELECT album_id, album_name FROM db2.album WHERE album_name = ? AND album_id < ?)");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name = ? AND genre_id < ? UNION \
SELECT genre_id, genre_name FROM db2.genre WHERE genre_name = ? AND genre_id < ?)");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 2, id_temp);
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint16(stmt, 3, ischar);
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
                    sqlite3_bind_kal_uint32(stmt, 5, id_temp);
                    sqlite3_bind_kal_uint16(stmt, 6, ischar);
                }
            }
            else
            {
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
                    sqlite3_bind_kal_uint32(stmt, 4, id_temp);
                }
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    count = sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    count += sqlite3_column_kal_uint32(stmt, 0);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                switch(type[0])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE p_name < ? AND ischar = ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    case SRV_PLST_VIEW_VIDEO:
                        sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE p_name < ? AND ischar = ?");
                        break;
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                     case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE p_name <= ? AND ischar = ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE p_name <= ? AND ischar = ? )");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE p_name <= ? AND ischar = ? UNION \
SELECT album_id, album_name FROM db2.album WHERE p_name <= ? AND ischar = ? )");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM (SELECT genre_id, genre_name FROM main.genre WHERE p_name <= ? AND ischar = ? UNION \
SELECT genre_id, genre_name FROM db2.genre WHERE p_name <= ? AND ischar = ?)");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
            }
            else
            {
                switch(type[0])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE name < ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    case SRV_PLST_VIEW_VIDEO:
                        sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE name < ?");
                        break;
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                    case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name <= ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE artist_name <= ? )");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE album_name <= ? UNION \
SELECT album_id, album_name FROM db2.album WHERE album_name <= ? )");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM (SELECT genre_id, genre_name FROM main.genre WHERE genre_name <= ? UNION \
SELECT genre_id, genre_name FROM db2.genre WHERE genre_name <= ?)");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint16(stmt, 2, ischar);
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
                    sqlite3_bind_kal_uint16(stmt, 4, ischar);
                }
            }
            else
            {
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
                }
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {
                    count = sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    count += sqlite3_column_kal_uint32(stmt, 0);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                switch(type[0])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE ischar < ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    case SRV_PLST_VIEW_VIDEO:
                        sprintf(db->sql_cmd, "SELECT COUNT(vdo_id) FROM db2.video WHERE ischar < ?");
                        break;
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                     case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE ischar < ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE ischar < ? )");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE ischar < ? UNION \
SELECT album_id, album_name FROM db2.album WHERE ischar < ? )");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd, "SELECT COUNT(genre_id) FROM (SELECT genre_id, genre_name FROM main.genre WHERE ischar < ? UNION \
SELECT genre_id, genre_name FROM db2.genre WHERE ischar < ?)");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint16(stmt, 1, ischar);
                if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                {                   
                    sqlite3_bind_kal_uint16(stmt, 2, ischar);
                }
               
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(type[0] != SRV_PLST_VIEW_AUDIO && type[0] != SRV_PLST_VIEW_VIDEO)
                    {
                        count += sqlite3_column_kal_uint32(stmt, 0);
                    }
                    else
                    {
                        count += sqlite3_column_kal_uint32(stmt, 0);
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            }
        }
    }
    else
    {
        pls_sql_finalize(stmt);
        found = MMI_FALSE;
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }        
    }
    if(!found)
    {
        ret = SRV_PLST_RET_EMPTY;
    }
    else
    {
        list_view->list_cache[list_view->current_index].cache_num = 1;
        list_view->list_cache[list_view->current_index].cache[0].idx_in_list = count;
        list_view->list_cache[list_view->current_index].cache[0].id = id_temp;
        list_view->list_cache[list_view->current_index].tail++;
        ret = SRV_PLST_OK;
    }
    *index = count;
    return ret;
}


static S32 pls_sql_list_jump_two_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, srv_plst_view_type_enum *type, U32 *id, U32* index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    srv_plst_base_info_struct *base;
    S32 ret = SRV_PLST_OK;
    U32 id_temp;
    U32 count = 0;
    U16 ischar = (U16)pls_sql_util_ischar(list_view->search);
    MMI_BOOL found = MMI_TRUE;
    const S8* ptr;    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    *index = count;   
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);

    if(type[1] == SRV_PLST_VIEW_MEDIA)
    {
        if(type[0] == SRV_PLST_VIEW_ARTIST)
        {
            ptr = Sqlartistid;
        }
        else if(type[0] == SRV_PLST_VIEW_ALBUM)
        {
            ptr = Sqlalbumid;
        }
        else
        {
            ptr = Sqlgenreid;
        }
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, p_name, ischar FROM main.audio WHERE ischar = ? AND %s and p_name >= ? order by ischar, p_name, media_id limit 1) UNION \
SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio WHERE ischar = ? AND %s AND p_name >= ? order by ischar, p_name, media_id limit 1)) order by ischar, name, media_id limit 1", ptr, ptr);           
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM main.audio WHERE %d and p_name >= ? order by ischar, p_name, media_id limit 1", ptr);
            }
        }
        else
        {
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE %s and name >= ? order by name, media_id limit 1) UNION \
SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE %s AND name >= ? order by name, media_id limit 1)) order by name, media_id limit 1", ptr, ptr);           
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE %d and name >= ? order by name, media_id limit 1", ptr);
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            sqlite3_bind_kal_uint32(stmt, 1, ischar);
            sqlite3_bind_kal_uint32(stmt, 2, id[0]);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 4, ischar);
                sqlite3_bind_kal_uint32(stmt, 5, id[0]);
                sqlite3_bind_kal_wstr(stmt, 6, list_view->string);
            }

        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, id[0]);
                sqlite3_bind_kal_wstr(stmt, 4, list_view->string);
            }
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)list_view->string, (const S8*)sqlite3_column_kal_wstr(stmt, 1), (SRV_PLST_MAX_FILE_LEN));
            }
            else
            {
                list_view->string[0] = 0;
            }
            id_temp = sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;

            /* count index */
            /* phone first */
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from main.audio WHERE %s AND p_name = ? AND id < ? and ischar = ? ", ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from main.audio WHERE %s AND name = ? AND id < ?", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, id_temp); 
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint32(stmt, 4, ischar);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count = sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from main.audio WHERE %s AND p_name < ? AND ischar = ?", ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from main.audio WHERE %s AND name < ?", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, id_temp);
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint32(stmt, 4, ischar);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from main.audio WHERE %s AND ischar < ?", ptr);
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                sqlite3_bind_kal_uint32(stmt, 2, ischar);                
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    count += sqlite3_column_kal_uint32(stmt,0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            }

            /* card*/
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from db2.audio WHERE %s AND p_name = ? AND id < ? and ischar = ?", ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from db2.audio WHERE %s AND name = ? AND id < ?", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, id_temp);           
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint32(stmt, 4, ischar);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }

            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from db2.audio WHERE %s AND p_name < ? AND ischar = ?", ptr);
            }
            else
            {
                kal_sprintf(db->sql_cmd, "SELECT COUNT(media_id) from db2.audio WHERE %s AND name < ?", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_wstr(stmt, 2, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 3, id_temp);
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                sqlite3_bind_kal_uint32(stmt, 4, ischar);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }
        else
        {
            pls_sql_finalize(stmt);
            found = MMI_FALSE;
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
    }
    else if(type[0] == SRV_PLST_VIEW_ARTIST && type[1] == SRV_PLST_VIEW_ALBUM)
    {
        if(IS_CARD_EXIST)
        {
            sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT album.album_id AS ID, album_name FROM main.album, main.artist, main.audio WHERE album_name >= ? ");
            strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id order by album_name, ID limit 1) UNION");
            strcat(db->sql_cmd, "SELECT * FROM (SELECT album.album_id AS ID, album_name from db2.album, db2.artist, db2.audio WHERE album_name >= ? AND artist_id = ?)");
            strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id order by album_name, ID limit 1)) ORDER BY album_name, ID limit 1");
        }
        else
        {
            sprintf(db->sql_cmd, "SELECT album.album_id AS ID, album_name FROM main.album, main.artist, main.audio WHERE album_name >= ? ");
            strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id order by album_name, ID limit 1");
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, list_view->search);
        sqlite3_bind_kal_uint32(stmt, 2, id[0]);
        if(IS_CARD_EXIST)
        {
            sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
            sqlite3_bind_kal_uint32(stmt, 4, id[0]);
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
            {
                mmi_ucs2ncpy((S8*)list_view->string, (const S8*)sqlite3_column_kal_wstr(stmt, 1), (SRV_PLST_MAX_FILE_LEN));
            }
            else
            {
                list_view->string[0] = 0;
            }
            id_temp = sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;  

            /* count index */

            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(ID) FROM (SELECT * FROM (SELECT album.album_id AS ID, album_name FROM main.album, main.artist, main.audio WHERE album_name <= ? ");
                strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id ) UNION");
                strcat(db->sql_cmd, "SELECT * FROM (SELECT album.album_id AS ID, album_name from db2.album, db2.artist, db2.audio WHERE album_name <= ? AND artist_id = ?)");
                strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(album.album_id) FROM SELECT album.album_id AS ID, album_name FROM main.album, main.artist, main.audio WHERE album_name <= ? ");
                strcat(db->sql_cmd, "AND artist_id = ? and album.album_id = audio.album_id and audio.artist_id = artist.artist_id group by album_name");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 2, id[0]);
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
                sqlite3_bind_kal_uint32(stmt, 4, id[0]);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                count = sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }
        else
        {
            pls_sql_finalize(stmt);
            found = MMI_FALSE;
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }
    }
    else
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
    if(!found)
    {
        ret = SRV_PLST_RET_EMPTY;
    }
    else
    {
        list_view->list_cache[list_view->current_index].cache_num = 1;
        list_view->list_cache[list_view->current_index].cache[0].idx_in_list = count;
        list_view->list_cache[list_view->current_index].cache[0].id = id_temp;
        list_view->list_cache[list_view->current_index].tail++;
        ret = SRV_PLST_OK;
    }
    *index = count;
    return ret;
}

static S32 pls_sql_list_jump_three_level(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, srv_plst_view_type_enum *type, U32 *id, U32* index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 id_temp;
    U32 count = 0;
    MMI_BOOL found = MMI_TRUE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    *index = count;
    /* artist->album->song list*/
    if(IS_CARD_EXIST)
    {
        sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? AND name >= ? order by name, media_id limit 1) UNION)");
        strcat(db->sql_cmd, "SELECT * FROM (SELECT media_id, name FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name >=? order by name, media_id limit 1)) order by name, limit 1");
    }
    else
    {
        sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? AND name >= ? order by name, media_id limit 1");
    }
    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
    sqlite3_bind_kal_uint32(stmt, 2, id[1]);
    sqlite3_bind_kal_wstr(stmt, 3, list_view->search);
    if(IS_CARD_EXIST)
    {
        sqlite3_bind_kal_uint32(stmt, 4, id[0]);
        sqlite3_bind_kal_uint32(stmt, 5, id[1]);
        sqlite3_bind_kal_wstr(stmt, 6, list_view->search);
    }
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        if(mmi_ucs2strlen((const S8*)sqlite3_column_kal_wstr(stmt, 1)))
        {
            mmi_ucs2ncpy((S8*)list_view->string, (const S8*)sqlite3_column_kal_wstr(stmt, 1), (SRV_PLST_MAX_FILE_LEN));
        }
        else
        {
            list_view->string[0] = 0;
        }
        id_temp = sqlite3_column_kal_uint32(stmt,0);
        pls_sql_finalize(stmt);
        ret = SRV_PLST_OK;

        /* count index */
        /* phone first */
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND name = ? AND media_id < ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id[0]);
        sqlite3_bind_kal_uint32(stmt, 2, id[1]);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
        sqlite3_bind_kal_uint32(stmt, 4, id_temp);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK)
        {
            count = sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND name < ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, id[0]);
        sqlite3_bind_kal_uint32(stmt, 2, id[1]);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_OK)
        {
            count += sqlite3_column_kal_uint32(stmt,0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }       
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name = ? AND media_id < ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_uint32(stmt, 2, id[1]);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_uint32(stmt, 4, id_temp);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_OK)
            {
                count += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
            
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ? AND name < ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id[0]);
            sqlite3_bind_kal_uint32(stmt, 2, id[1]);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_OK)
            {
                count += sqlite3_column_kal_uint32(stmt,0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
        }
    }
    else
    {
        pls_sql_finalize(stmt);
        found = MMI_FALSE;
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
    }
    if(!found)
    {
        ret = SRV_PLST_RET_EMPTY;
    }
    else
    {
        list_view->list_cache[list_view->current_index].cache_num = 1;
        list_view->list_cache[list_view->current_index].cache[0].idx_in_list = count;
        list_view->list_cache[list_view->current_index].cache[0].id = id_temp;
        list_view->list_cache[list_view->current_index].tail++;
        ret = SRV_PLST_OK;
    }
    *index = count;
    return ret;
}

S32 pls_sql_get_group_count_by_character(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, UI_string_type string, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    UI_character_type temp_string[2];
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    temp_string[0] = string[0] + 1;
    *count = 0;

    if(!list_view->current_index ||
        (list_view->current_index> 1 && (list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_PLST_ADDTO)))
    {
        switch(list_view->view_type[list_view->current_index])
        {
            case SRV_PLST_VIEW_AUDIO:
                ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.audio WHERE p_name >= ? AND p_name < ?", &stmt);
                break;

            case SRV_PLST_VIEW_ARTIST:
                ret = pls_sql_prepare_ex(db, "SELECT count(artist_id) FROM main.artist WHERE p_name >= ? AND p_name < ?", &stmt);
                break;

             case SRV_PLST_VIEW_ALBUM:
                ret = pls_sql_prepare_ex(db, "SELECT count(album_id) FROM main.album WHERE p_name >= ? AND p_name < ?", &stmt);
                break;

             default:
                return SRV_PLST_RET_ERR_PARAM_ERR;
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }

        sqlite3_bind_kal_wstr(stmt, 0, string);
        sqlite3_bind_kal_wstr(stmt, 1, temp_string);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

        if(IS_CARD_EXIST)
        {
            switch(list_view->view_type[list_view->current_index])
            {
                case SRV_PLST_VIEW_AUDIO:
                    ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.audio WHERE p_name >= ? AND p_name < ?", &stmt);
                    break;
    
                case SRV_PLST_VIEW_ARTIST:
                    ret = pls_sql_prepare_ex(db, "SELECT count(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE p_name >= ? AND p_name < ? UNION \
SELECT artist_id, artist_name from db2.artist WHERE p_name >= ? AND p_name < ? ) group by artist_name", &stmt);
                    break;
    
                case SRV_PLST_VIEW_ALBUM:
                   ret = pls_sql_prepare_ex(db, "SELECT count(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE p_name >= ? AND p_name < ? UNION \
SELECT album_id, album_name FROM db2.album WHERE p_name >= ?  AND p_name < ?) group by album_name", &stmt);
                   break;
    
                default:
                   return SRV_PLST_RET_ERR_PARAM_ERR;
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
    
            sqlite3_bind_kal_wstr(stmt, 0, string);
            sqlite3_bind_kal_wstr(stmt, 1, temp_string);
            if(list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_AUDIO)
            {
                sqlite3_bind_kal_wstr(stmt, 2, string);
                sqlite3_bind_kal_wstr(stmt, 3, temp_string);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                if(list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_AUDIO)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
         }
         return ret;
    }
    else if(list_view->current_index == 1 ||
        (list_view->current_index > 2 && (list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_PLST_ADDTO)))
    {
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
            list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.audio WHERE artist_id = ? AND p_name >= ? AND p_name < ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[list_view->current_index].parent_id);
            sqlite3_bind_kal_wstr(stmt, 2, string);
            sqlite3_bind_kal_wstr(stmt, 3, temp_string);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *count = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.audio WHERE artist_id = ? AND p_name >= ? AND p_name < ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[list_view->current_index].parent_id);
                sqlite3_bind_kal_wstr(stmt, 2, string);
                sqlite3_bind_kal_wstr(stmt, 3, temp_string);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
            }            
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
        return ret;
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}

S32 pls_sql_get_group_count(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, srv_plst_list_group_item_info_struct *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 count = 0;    
#if defined(__MMI_CSTAR__) || defined(__MMI_T9__)
    //U32 temp_count = 0;
#endif
    UI_character_type string[2];
    U8 i = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
#if defined(__MMI_CSTAR__) || defined(__MMI_T9__) 
    data->group_count = 27; 
    string[0] = 'A';
    //ret = pls_sql_get_view_count(db, 0, &temp_count);

    if(ret == SRV_PLST_OK)
    {
        for(i = 0; i < 26; i++)
        {
            ret = pls_sql_get_group_count_by_character(db, list_view, string + i, &count);
            if(ret == SRV_PLST_OK)
            {
                data->group[i] = count;
                list_view->group[list_view->current_index].group[i] = count;
                list_view->total_count +=count;
               // temp_count -= count;
            }
            else
            {
                break;
            }            
        }
    }
    if(ret == SRV_PLST_OK)
    {
       // data->group[i] = temp_count;

       if(!list_view->current_index ||
        (list_view->current_index > 1 && (list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA &&
        list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_PLST_ADDTO)))
        {
            switch(list_view->view_type[list_view->current_index])
            {
                case SRV_PLST_VIEW_AUDIO:
                    ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.audio WHERE ischar = ?", &stmt);
                    break;

                case SRV_PLST_VIEW_ARTIST:
                    ret = pls_sql_prepare_ex(db, "SELECT count(artist_id) FROM main.artist WHERE ischar = ?", &stmt);
                    break;

                 case SRV_PLST_VIEW_ALBUM:
                    ret = pls_sql_prepare_ex(db, "SELECT count(album_id) FROM main.album WHERE ischar = ?", &stmt);
                    break;

                 default:
                    return SRV_PLST_RET_ERR_PARAM_ERR;
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

            sqlite3_bind_kal_uint16(stmt, 0, 1);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                data->group[i] = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }

            if(IS_CARD_EXIST)
            {
                switch(list_view->view_type[list_view->current_index])
                {
                    case SRV_PLST_VIEW_AUDIO:
                        ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.audio WHERE ischar = ? ", &stmt);
                        break;
        
                    case SRV_PLST_VIEW_ARTIST:
                        ret = pls_sql_prepare_ex(db, "SELECT count(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE ischar = ?  UNION \
    SELECT artist_id, artist_name from db2.artist WHERE ischar = ? ) group by artist_name", &stmt);
                        break;
        
                    case SRV_PLST_VIEW_ALBUM:
                       ret = pls_sql_prepare_ex(db, "SELECT count(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE ischar = ? UNION \
    SELECT album_id, album_name FROM db2.album WHERE ischar = ?) group by artist_name", &stmt);
                       break;
        
                    default:
                       return SRV_PLST_RET_ERR_PARAM_ERR;
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
        
                sqlite3_bind_kal_uint16(stmt, 0, 1);
                if(list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_AUDIO)
                {
                    sqlite3_bind_kal_uint16(stmt, 1, 1);
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    if(list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_AUDIO)
                    {
                        data->group[i] = sqlite3_column_kal_uint32(stmt, 0);
                    }
                    else
                    {
                        (data->group[i]) += sqlite3_column_kal_uint32(stmt, 0);
                    }
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
             }
             list_view->group[list_view->current_index].group[i]= data->group[i];
             list_view->total_count += data->group[i];
             list_view->list_cache[list_view->current_index].total = list_view->total_count;
             return ret;
        }
        else if(list_view->current_index == 1 ||
            (list_view->current_index > 2 && (list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_MEDIA &&
            list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_PLST_ADDTO)))
        {
            if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA &&
                list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.audio WHERE artist_id = ? and ischar = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[list_view->current_index].parent_id);
                sqlite3_bind_kal_uint16(stmt, 2, 1);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    data->group[i] = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                }
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.audio WHERE artist_id = ? and ischar = ?", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, list_view->list_cache[list_view->current_index].parent_id);
                    sqlite3_bind_kal_uint16(stmt, 2, 1);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        (data->group[i]) += sqlite3_column_kal_uint32(stmt, 0);
                        pls_sql_finalize(stmt);
                        ret = SRV_PLST_OK;
                    }
                    else
                    {
                        pls_sql_finalize(stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                    }
                }            
            }
            else
            {
                ret = SRV_PLST_RET_ERR_PARAM_ERR;
            }
            return ret;
        }
    }
#else
    data->group_count = 1;
    ret = pls_sql_get_view_count(db, 0, &count);
    data->group[0] = count;
#endif

    return ret;
}


S32 pls_sql_list_jump(srv_plst_db_context_struct *db, U32 jump_info, U32* index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_list_view_history_struct *list_view;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id_parent[SRV_PLST_VIEW_LIST_DEPTH];
    U8 stack = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);     
    mmi_ucs2ncpy((S8*)&list_view->search, (S8*)jump_info, SRV_PLST_MAX_FILE_LEN - 1); 

    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST)
    {
        view_type[0] = SRV_PLST_VIEW_PLST;        
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_AUDIO ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_VIDEO ||
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO && 
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_AUDIO))
    {
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            view_type[0] = list_view->view_type[list_view->current_index - 1];           
        }
        else
        {
            view_type[0] = list_view->view_type[list_view->current_index];
        }
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA ||
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO &&
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA))
    {
        if((list_view->current_index > 2 && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM &&
            list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_PLST_ADDTO) ||
           (list_view->current_index > 3 && list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ALBUM &&
            list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO) )
        {
            view_type[0] = SRV_PLST_VIEW_ARTIST;
            view_type[1] = SRV_PLST_VIEW_ALBUM;
            view_type[2] = SRV_PLST_VIEW_MEDIA;
            if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
            {
                id_parent[0] = list_view->list_cache[1].parent_id;
                id_parent[1] = list_view->list_cache[2].parent_id;
            }
            else
            {
                id_parent[0] = list_view->list_cache[list_view->current_index - 1].parent_id;
                id_parent[1] = list_view->list_cache[list_view->current_index].parent_id;
            }
            stack = 2;
        }
        else
        {
            if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
            {
                view_type[0] = list_view->view_type[0];
                view_type[1] = SRV_PLST_VIEW_MEDIA;
                id_parent[0] = list_view->list_cache[1].parent_id;
            }
            else
            {
            view_type[0] = list_view->view_type[list_view->current_index - 1];
            view_type[1] = SRV_PLST_VIEW_MEDIA;
            id_parent[0] = list_view->list_cache[list_view->current_index].parent_id;
            }
            stack = 1;
        }
    }
    else if((list_view->current_index > 0 && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM && 
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST) ||
        list_view->current_index > 1&& list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM && 
        list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
    {
        view_type[0] = SRV_PLST_VIEW_ARTIST;
        view_type[1] = SRV_PLST_VIEW_ALBUM;
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            id_parent[0] = list_view->list_cache[list_view->current_index - 1].parent_id;
        }
        else
        {
            id_parent[0] = list_view->list_cache[1].parent_id;
        }
        stack = 1;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ARTIST ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_GENRE ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_IMAGE_FLOW ||
       ((list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST ||
       list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM ||
       list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_GENRE) &&
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO))
    {
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            view_type[0] = list_view->view_type[list_view->current_index];
        }
        else
        {
            view_type[0] = list_view->view_type[list_view->current_index - 1];
        }
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ACTIVE ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_DEFAULT)
    {
     /* current no need */
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }    
    
    if(!stack)
    {
        ret = pls_sql_list_jump_one_level(db, list_view, view_type, id_parent, index);
    }
    else if(stack == 1)
    {
        ret = pls_sql_list_jump_two_level(db, list_view, view_type, id_parent, index);
    }
    else if(stack == 2)
    {
        ret = pls_sql_list_jump_three_level(db, list_view, view_type, id_parent, index);
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}
#endif /* __PLST_SRV_FEATURE_GROUP_LIST__ */

MMI_BOOL pls_sql_check_plst_is_exist(srv_plst_db_context_struct *db, UI_string_type name)    
{
   /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM main.plst WHERE plst_name = ?", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return MMI_FALSE;
    }
    sqlite3_bind_kal_wstr(stmt, 1, name);
    ret = pls_sql_step_ex(db, stmt);
    pls_sql_finalize(stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {
        return MMI_TRUE;
    }

#if defined(__PLST_DUAL_DB_SUPPORT__)
    if(IS_CARD_EXIST)
    {
        ret = pls_sql_prepare_ex(db, "SELECT plst_id FROM db2.plst WHERE plst_name = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return MMI_FALSE;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            return MMI_TRUE;
        }    
    }
#endif /* __PLST_DUAL_DB_SUPPORT__ */
    return MMI_FALSE;
}


MMI_BOOL pls_sql_active_media_check_if_in_defplst(srv_plst_db_context_struct *db, 
        srv_plst_playing_context_struct *play_ptr, srv_plst_default_playlist_enum type)
{
   /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 plst_id = 0;
    U32 media_id = 0;
    //srv_plst_list_view_history_struct *list_view;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    //list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
    ret = pls_sql_util_get_default_list_id(db, type, &plst_id);
    if(ret != SRV_PLST_OK)
    {
        return MMI_FALSE;
    }
    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(play_ptr->plst_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plst_id = ? AND plstitem_id = ?", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret =  pls_sql_prepare_ex(db, "SELECT media_id FROM db2.plst_item WHERE plst_id = ? AND plstitem_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        if(ret != SRV_PLST_OK)
        {
            return MMI_FALSE;
        }
        sqlite3_bind_kal_uint32(stmt, 1, play_ptr->plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, play_ptr->current_picked_id);
         ret = pls_sql_step_ex(db, stmt);
         if(ret == SRV_PLST_RET_ITEM_EXIST)
         {
            srv_plst_default_playlist_enum temp_type;
            
            media_id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
            ret = pls_sql_util_get_default_list_info(db, play_ptr->plst_id, &temp_type);
            if(ret == SRV_PLST_OK && temp_type == type)
            {
                return MMI_TRUE;
            }
         }
         else
         {
            pls_sql_finalize(stmt);
            return MMI_FALSE;
         }    
    }
    else
    {
        media_id = play_ptr->current_picked_id;
    }
    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST ||
        play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
    {
        ret = pls_sql_prepare_ex(db, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return MMI_FALSE;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            return MMI_TRUE;
        }
        else 
        {
            return MMI_FALSE;
        }
    }
    else 
    {
        return MMI_FALSE;
    }
}

S32 pls_sql_active_media_add_or_remove_from_defplst(srv_plst_db_context_struct *db, 
        srv_plst_playing_context_struct *play_ptr, MMI_BOOL is_add, srv_plst_default_playlist_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK; 
    U32 plst_id = 0;
	srv_plst_default_playlist_enum  playing_plst_type = SRV_PLST_DEF_LIST_ENUM_END;
    U32 media_id = 0;
    U32 index = 0;
    srv_plst_list_view_history_struct *list_view;
	srv_plst_base_info_struct *base;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    list_view = (srv_plst_list_view_history_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->list_view_history);
	base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);   
    ret = pls_sql_util_get_default_list_id(db, type, &plst_id);
    if(ret != SRV_PLST_OK)
    {
        return MMI_FALSE;
    }
	//MAUI_02913814
	pls_sql_util_get_default_list_info(db, play_ptr->plst_id, &playing_plst_type);
    ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id), MAX(idx) FROM main.plst_item WHERE plst_id = ?", &stmt);
    if(ret != SRV_PLST_OK)
    {
        return ret;
    }
    sqlite3_bind_kal_uint32(stmt, 1, plst_id);
    ret = pls_sql_step_ex(db, stmt);
    if(ret == SRV_PLST_RET_ITEM_EXIST)
    {  
        U32 count;
        count = sqlite3_column_kal_uint32(stmt, 0);
        index = sqlite3_column_kal_uint32(stmt, 1);
        pls_sql_finalize(stmt);

        if(is_add && count >= SRV_PLST_MAX_PLST_ITEM)
        {
            return SRV_PLST_RET_PLST_FULL;
        }
        else if(!is_add && !count)
        {
            return SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        pls_sql_finalize(stmt);
        return ret;
    }

    if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_AUDIO)
    {
        media_id = play_ptr->current_picked_id;
    }
    else if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST)
    {
        if(play_ptr->plst_id > 0X8000)
        {
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM main.plst_item WHERE plst_id = ? AND plstitem_id = ?", &stmt);
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "SELECT media_id FROM db2.plst_item WHERE plst_id = ? AND plstitem_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, play_ptr->plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, play_ptr->current_picked_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            media_id = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
        }
        else
        {
            pls_sql_finalize(stmt);
            return ret;
        }
    }
    else 
    {
        return SRV_PLST_RET_ERR_PARAM_ERR;
    }
  
    if(is_add)
    {
        ret = pls_sql_prepare_ex(db, "INSERT INTO main.plst_item(plst_id, media_id, idx) VALUES(?,?,?)", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        sqlite3_bind_kal_uint32(stmt, 2, media_id);
        sqlite3_bind_kal_uint32(stmt, 3, index + 1);
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);

        //if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST && type == SRV_PLST_DEF_MY_FAVOURITE)
        //MAUI_02913814
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST && playing_plst_type == SRV_PLST_DEF_MY_FAVOURITE)
        {
            pls_sql_get_active_index_by_id(db, play_ptr, play_ptr->current_picked_id, &play_ptr->pick_index);
            pls_sql_get_active_play_count_by_id(db, play_ptr, play_ptr->current_picked_id, &play_ptr->pick_count);
            pls_sql_get_default_list_count(db,play_ptr, &play_ptr->total);
            play_ptr->play_info.total_count = play_ptr->total;
            if(play_ptr->total == 0)
            {
                play_ptr->plst_id = 0;            
            } 
        }
        if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            srv_plst_default_playlist_enum temp_type;
            ret = pls_sql_util_get_default_list_info(db, list_view->list_cache[1].parent_id, &temp_type);
            if(ret == SRV_PLST_OK && temp_type == type)
            {                
                memset(&(list_view->list_cache[1].cache), 0, SRV_PLST_VIEW_LIST_CACHE * sizeof(srv_plst_list_cache_struct));
                list_view->list_cache[1].last_index = 0;
                list_view->list_cache[1].first_index = 0;
                list_view->list_cache[1].head = 0;
                list_view->list_cache[1].tail = 0;
                list_view->list_cache[1].cache_num = 0;
                list_view->list_cache[1].total = 0;
                list_view->query_index = 0;
                list_view->total_count = 0;
            }
        }
        return ret;
    }
    else
    {
        U32 next_to_play = 0;
        //MAUI_02923480
        //need to pick next song before current playing deleted
        //and in our pls_sql_get_next_active_id()... there is some defect cannot fixed
        //event we pass the para of &id to get the next, PLS will always over write play_ptr->current_picked_id
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST && 
            playing_plst_type == SRV_PLST_DEF_MY_FAVOURITE)
        {//MAUI_02930593
            U32 temp_id = 0;
            srv_plst_shuffle_enum temp_shuffle = SRV_PLST_SHUFFLE_OFF;
            //keep current playing id
            temp_id = play_ptr->current_picked_id;
            temp_shuffle = (srv_plst_shuffle_enum)base->shuffle;
            //get next to played to current_picked_id
            base->shuffle = SRV_PLST_SHUFFLE_OFF;
            if (play_ptr->pick_index + 1 < play_ptr->total)
            {
                pls_sql_get_next_active_id(db, play_ptr,&play_ptr->current_picked_id);
            }
            else
            {
                pls_sql_get_prev_active_id(db, play_ptr,&play_ptr->current_picked_id);
            }
            base->shuffle = temp_shuffle;
            //store next to play
            next_to_play = play_ptr->current_picked_id;
            //restore current id used to delete
            play_ptr->current_picked_id = temp_id;
		}

        if(SRV_PLST_DEF_MY_FAVOURITE == playing_plst_type)
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst_item WHERE plst_id = ? AND plstitem_id = ?", &stmt);
        }
        else
        {
            ret = pls_sql_prepare_ex(db, "DELETE FROM main.plst_item WHERE plst_id = ? AND media_id = ?", &stmt);
        }
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        if(SRV_PLST_DEF_MY_FAVOURITE == playing_plst_type)
        {
            sqlite3_bind_kal_uint32(stmt, 2,  play_ptr->current_picked_id);
        }
        else
        {
            sqlite3_bind_kal_uint32(stmt, 2, media_id);
        }
        ret = pls_sql_step_ex(db, stmt);
        pls_sql_finalize(stmt);
        //if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST && type == SRV_PLST_DEF_MY_FAVOURITE)
        //MAUI_02913814
        if(play_ptr->active_type == SRV_PLST_ACTIVE_LIST_PLST && playing_plst_type == SRV_PLST_DEF_MY_FAVOURITE)
        {
            play_ptr->current_picked_id = next_to_play;
            pls_sql_get_active_index_by_id(db, play_ptr, play_ptr->current_picked_id, &play_ptr->pick_index);
            //pls_sql_get_active_play_count_by_id(db, play_ptr, play_ptr->current_picked_id, &play_ptr->pick_count);
            pls_sql_get_default_list_count(db,play_ptr, &play_ptr->total);
            play_ptr->play_info.total_count = play_ptr->total;
            if(play_ptr->total == 0)
            {
                play_ptr->plst_id = 0;
                play_ptr->is_load = MMI_FALSE;
            } 
            else
            {
                //MAUI_02932692, set as next one as active
                play_ptr->pick_count = 0;
                play_ptr->ordinal = play_ptr->total; 
                pls_sql_enter_instance(db);
                pls_sql_begin_transaction(db);
                ret = pls_sql_set_active(db, play_ptr);
                if(ret == SRV_PLST_OK )
                {
                    play_ptr->pick_count = 1;
                    play_ptr->played_count = 1;
                    ret = pls_sql_commit_transaction(db);
                    if(ret > SQLITE_OK && ret < SQLITE_ROW)
                    {
                        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_ACTIVE_INDEX_BY_ID, __LINE__);
                    }
                }
                else
                {
                    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_GET_ACTIVE_INDEX_BY_ID, __LINE__);
                    pls_sql_rollback_transaction(db);
                }
                pls_sql_exit_instance(db);   
            }
        }

        if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            srv_plst_default_playlist_enum temp_type;
            ret = pls_sql_util_get_default_list_info(db, list_view->list_cache[1].parent_id, &temp_type);

            // If current active play list is my favorite or view stack has my favorite list
            if((playing_plst_type == SRV_PLST_DEF_MY_FAVOURITE) || ((ret == SRV_PLST_OK) && (temp_type == SRV_PLST_DEF_MY_FAVOURITE)))
            {                
                memset(&(list_view->list_cache[1].cache), 0, SRV_PLST_VIEW_LIST_CACHE * sizeof(srv_plst_list_cache_struct));
                list_view->list_cache[1].last_index = 0;
                list_view->list_cache[1].first_index = 0;
                list_view->list_cache[1].head = 0;
                list_view->list_cache[1].tail = 0;
                list_view->list_cache[1].cache_num = 0;
                list_view->list_cache[1].total = 0;
                list_view->query_index = 0;
                list_view->total_count = 0;
            }
        }
        return ret;        
    }
}


S32 pls_sql_get_media_count(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32* id, srv_plst_view_type_enum *type, U8 stack,  U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    *count = 0;
    if(!stack)
    {
        if(type[0] == SRV_PLST_VIEW_AUDIO ||
            type[0] == SRV_PLST_VIEW_VIDEO)
        {
            if(!list_view->is_mark)
            {
                *count = 1;
                return SRV_PLST_OK;
            }
            else if(list_view->is_mark_all && !list_view->is_unmark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM main.video WHERE vdo_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE media_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM main.video WHERE vdo_id NOT in (SELECT id FROM main.db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST && ret == SRV_PLST_OK)
                {
                    if(type[0] == SRV_PLST_VIEW_AUDIO)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE media_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_VIDEO_SUPPORT__
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(vdo_id) FROM db2.video WHERE vdo_id not in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /*__PLST_SRV_FEATURE_VIDEO_SUPPORT__*/
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(id) FROM db2.mark WHERE mark_flag = 1", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(id) FROM main.mark WHERE mark_flag = 1", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);
                return ret;
            }
        }
        else if(type[0] == SRV_PLST_VIEW_ARTIST ||
            type[0] == SRV_PLST_VIEW_ALBUM ||
            type[0] == SRV_PLST_VIEW_GENRE ||
            type[0] == SRV_PLST_VIEW_IMAGE_FLOW)
        {
            const S8* ptr;

            if(type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(type[0] == SRV_PLST_VIEW_GENRE)
            {
                ptr = Sqlgenreid;
            }
            else
            {
                ptr = Sqlalbumid;
            }
            if(!list_view->is_mark)
            {
                kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM main.audio WHERE %s ", ptr);              
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM db2.audio WHERE %s ", ptr);              
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else if(list_view->is_mark_all && !list_view->is_unmark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE album_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE album_id NOT in (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE genre_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE album_id NOT in (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE genre_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE album_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                    }
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(type[0] == SRV_PLST_VIEW_ARTIST)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    else if(type[0] == SRV_PLST_VIEW_GENRE)
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE genre_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
        }
        else if(type[0] == SRV_PLST_VIEW_PLST)
        {
            if(!list_view->is_mark)
            {
                if(id[0] > 0X8000)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ?", &stmt);
                }
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                else
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ?", &stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);
                return ret;
            }
            else if(list_view->is_mark_all && !list_view->is_unmark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id NOT in (SELECT id from db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt , 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM db2.plst_item WHERE plst_id NOT IN (select id from db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);                    
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id in (SELECT id from db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM main.plst_item WHERE plst_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt , 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT count(plstitem_id) FROM db2.plst_item WHERE plst_id IN (select id from db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);                    
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }            
        }/* type end */
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }        
    }
    else if(stack == 1)
    {
        if(type[0] == SRV_PLST_VIEW_ARTIST && type[1] == SRV_PLST_VIEW_ALBUM)
        {
            if(!list_view->is_mark)
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ?", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ?", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else if(list_view->is_mark_all && !list_view->is_unmark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }   
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }   
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
        }
        else if(type[1] == SRV_PLST_VIEW_MEDIA)
        {
            if(type[0] == SRV_PLST_VIEW_ARTIST ||
                type[0] == SRV_PLST_VIEW_ALBUM ||
                type[0] == SRV_PLST_VIEW_GENRE ||
                type[0] == SRV_PLST_VIEW_IMAGE_FLOW)
            {
                const S8* ptr;
                if(type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    ptr = Sqlartistid;
                }
                else if(type[0] == SRV_PLST_VIEW_GENRE)
                {
                    ptr = Sqlgenreid;
                }
                else
                {
                    ptr = Sqlalbumid;
                }
                    
                if(!list_view->is_mark)
                {
                    *count = 1;
                    return SRV_PLST_OK;                    
                }
                else if(list_view->is_mark_all && ! list_view->is_unmark_all)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM main.audio WHERE %s AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", ptr);                        
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM main.audio WHERE %s AND media_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", ptr);
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count = sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM db2.audio WHERE %s AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", ptr);
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            *count += sqlite3_column_kal_uint32(stmt, 0);
                            ret = SRV_PLST_OK;
                        }
                        pls_sql_finalize(stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    return ret;
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM main.audio WHERE %s AND media_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", ptr);                        
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM main.audio WHERE %s AND media_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", ptr);
                    }
                    ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count = sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);

                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd, "SELECT count(media_id) FROM db2.audio WHERE %s AND media_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", ptr);
                        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                        if(ret != SRV_PLST_OK)
                        {
                            return ret;
                        }
                        sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                        ret = pls_sql_step_ex(db, stmt);
                        if(ret == SRV_PLST_RET_ITEM_EXIST)
                        {
                            *count += sqlite3_column_kal_uint32(stmt, 0);
                            ret = SRV_PLST_OK;
                        }
                        pls_sql_finalize(stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    return ret;
                }
            }
            else if(type[0] == SRV_PLST_VIEW_PLST)
            {
                if(!list_view->is_mark)
                {
                    *count = 1;
                    return SRV_PLST_OK;
                }
                else if(list_view->is_mark_all && ! list_view->is_unmark_all)
                {
                    if(id[0] > 0X8000)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                        }
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif //
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count = sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                    return ret;
                }
                else
                {
                    if(id[0] > 0X8000)
                    {
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        if(IS_CARD_EXIST)
                        {
                            ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                        }
                        else
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        {
                            ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM main.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                        }
                    }
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    else
                    {
                        ret = pls_sql_prepare_ex(db, "SELECT count(media_id) FROM db2.plst_item WHERE plst_id = ? AND plstitem_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    }
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count = sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                    return ret;
                }
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else if(stack == 2)
    {
        if(type[0] == SRV_PLST_VIEW_ARTIST && type[1] == SRV_PLST_VIEW_ALBUM && type[2] == SRV_PLST_VIEW_MEDIA)
        {
            if(!list_view->is_mark)
            {
                *count = 1;
                return ret;
            }
            else if(list_view->is_mark_all && !list_view->is_unmark_all)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ? AND media_id NOT IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }   
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio WHERE artist_id = ? AND album_id = ? AND media_id IN (SELECT id FROM main.mark WHERE mark_flag = 1)", &stmt);
                }
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    ret = SRV_PLST_OK;
                }
                pls_sql_finalize(stmt);

            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id IN (SELECT id FROM db2.mark WHERE mark_flag = 1)", &stmt);
                    if(ret != SRV_PLST_OK)
                    {
                        return ret;
                    }
                    sqlite3_bind_kal_uint32(stmt, 1, id[0]);
                    sqlite3_bind_kal_uint32(stmt, 2, id[1]);
                    ret = pls_sql_step_ex(db, stmt);
                    if(ret == SRV_PLST_RET_ITEM_EXIST)
                    {
                        *count += sqlite3_column_kal_uint32(stmt, 0);
                        ret = SRV_PLST_OK;
                    }
                    pls_sql_finalize(stmt);
                }   
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                return ret;
            }
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }        
    }
    return ret;
}


S32 pls_sql_get_mark_count(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, S32 index, U32 *count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id_parent[SRV_PLST_VIEW_LIST_DEPTH];
    U8 stack = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST)
    {
        view_type[0] = SRV_PLST_VIEW_PLST;
        pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &(id_parent[0]));
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_AUDIO ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_VIDEO ||
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO && 
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_AUDIO))
    {
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            view_type[0] = list_view->view_type[list_view->current_index - 1];
            pls_db_util_get_id(&(list_view->list_cache[list_view->current_index - 1]), index, &(id_parent[0]));
        }
        else
        {
            view_type[0] = list_view->view_type[list_view->current_index];
            pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &(id_parent[0]));
        }
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_MEDIA ||
        (list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO &&
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_MEDIA))
    {
        if((list_view->current_index > 2 && list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM &&
            list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_PLST_ADDTO) ||
           (list_view->current_index > 3 && list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ALBUM &&
            list_view->view_type[list_view->current_index - 3] == SRV_PLST_VIEW_ARTIST &&
            list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO) )
        {
            view_type[0] = SRV_PLST_VIEW_ARTIST;
            view_type[1] = SRV_PLST_VIEW_ALBUM;
            view_type[2] = SRV_PLST_VIEW_MEDIA;
            if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
            {
                id_parent[0] = list_view->list_cache[1].parent_id;
                id_parent[1] = list_view->list_cache[2].parent_id;
            }
            else
            {
                id_parent[0] = list_view->list_cache[list_view->current_index - 1].parent_id;
                id_parent[1] = list_view->list_cache[list_view->current_index].parent_id;
            }
            stack = 2;
        }
        else
        {
            if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
            {
                view_type[0] = list_view->view_type[0];
                view_type[1] = SRV_PLST_VIEW_MEDIA;
                id_parent[0] = list_view->list_cache[1].parent_id;
            }
            else
            {
                view_type[0] = list_view->view_type[list_view->current_index - 1];
                view_type[1] = SRV_PLST_VIEW_MEDIA;
                id_parent[0] = list_view->list_cache[list_view->current_index].parent_id;
            }
            stack = 1;
        }
    }
    else if((list_view->current_index > 0 && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM && 
        list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST) ||
        list_view->current_index > 1&& list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM && 
        list_view->view_type[list_view->current_index - 2] == SRV_PLST_VIEW_ARTIST &&
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
    {
        view_type[0] = SRV_PLST_VIEW_ARTIST;
        view_type[1] = SRV_PLST_VIEW_ALBUM;
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
        {
            id_parent[0] = list_view->list_cache[list_view->current_index - 1].parent_id;
            pls_db_util_get_id(&(list_view->list_cache[list_view->current_index - 1]), index, &(id_parent[1]));
        }
        else
        {
            id_parent[0] = list_view->list_cache[1].parent_id;
            pls_db_util_get_id(&(list_view->list_cache[1]), index, &(id_parent[1]));
        }
        stack = 1;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ARTIST ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ALBUM ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_GENRE ||
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_IMAGE_FLOW ||
       ((list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST ||
       list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ALBUM ||
       list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_GENRE) &&
       list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO))
    {
        if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
    {
        view_type[0] = list_view->view_type[list_view->current_index - 1];
        pls_db_util_get_id(&(list_view->list_cache[list_view->current_index - 1]), index, &(id_parent[0]));
        }
        else
        {
            view_type[0] = list_view->view_type[list_view->current_index];
            pls_db_util_get_id(&(list_view->list_cache[list_view->current_index ]), index, &(id_parent[0]));
        }
        stack = 0;
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ACTIVE ||
        list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_DEFAULT)
    {
     /* current no need */
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
        return ret;
    }    
    ret = pls_sql_get_media_count(db, list_view, id_parent, view_type, stack, count);
    return ret;
}



S32 pls_sql_search_count(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32* count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;    
    UI_character_type name_s[SRV_PLST_META_INFO_MAX_LEN + 1];
    UI_character_type name_t[2];
    MMI_BOOL is_chinese = MMI_FALSE;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);     
    if((list_view->search[0] >= 0x4E00) && (list_view->search[0] <= 0x9FA5))
    {
        is_chinese = MMI_TRUE;
    }
    name_t[0] = 92;
    name_t[1] = 0;
    memset(name_s, 0, sizeof(name_s));
    pls_sql_util_parser_search_string(list_view->search,  name_s, SRV_PLST_META_INFO_MAX_LEN);
    //kal_wsprintf(name_s, "%w%c", list_view->search, '%');
    if(base->config_search == SRV_PLST_SEARCH_BY_WORD_FIX)
    {
        if(is_chinese)
        {
            kal_wsprintf(list_view->string, "%c%w", '%',name_s);
        }
        else
        {
            kal_wsprintf(list_view->string, "%c%c%w", '%',' ',name_s);
        }
    }
    else
    {
        list_view->string[0] = 0;
    }
    if(!mmi_ucs2strlen((S8*)list_view->search))
    {
        MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
        *count = 0;
    }
    if(list_view->view_type[0] == SRV_PLST_VIEW_AUDIO)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE p_name like ? escape  ? or p_name like ? escape ? ");
        }
        else
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM main.audio WHERE name like ? escape ? or name like ? escape ? ");
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name_s);
        sqlite3_bind_kal_wstr(stmt, 2, name_t);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
        sqlite3_bind_kal_wstr(stmt, 4, name_t);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *count = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
            pls_sql_finalize(stmt);
        }
        else
        {
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE p_name like ? escape ? or p_name like ? escape ? ");
            }
            else
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE name like ?  escape ? or name like ? escape ? ");
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, name_s);
            sqlite3_bind_kal_wstr(stmt, 2, name_t);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_wstr(stmt, 4, name_t);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *count += sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }  
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST ||
        list_view->view_type[0] == SRV_PLST_VIEW_ALBUM)
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
        {
            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE p_name like ? escape ? or p_name like ? escape ?");
            }
            else
            {
                 sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE p_name like ? escape ? or p_name like ? escape ?");
            }
        }
        else
        {
            if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM main.artist WHERE artist_name like ? escape ? or artist_name like ? escape ?");
            }
            else
            {
                 sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM main.album WHERE album_name like ? escape ? or album_name like ? escape ?");
            }
        }
        ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_wstr(stmt, 1, name_s);
        sqlite3_bind_kal_wstr(stmt, 2, name_t);
        sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
        sqlite3_bind_kal_wstr(stmt, 4, name_t);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *count = sqlite3_column_kal_uint32(stmt, 0);
            ret = SRV_PLST_OK;
            pls_sql_finalize(stmt);
        }
        else
        {
            MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN && !is_chinese)
            {
                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE p_name like ? escape ? or p_name like ? escape ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE p_name like ? escape ? or p_name like ? escape ?)");
                }
                else
                {
                     sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE p_name like ? escape ? or p_name like ? escape ? UNION \
SELECT album_id, album_name FROM db2.album WHERE p_name like ? escape ? or p_name like ? escape ?)");
                }
            }
            else
            {
                if(list_view->view_type[0] == SRV_PLST_VIEW_ARTIST)
                {
                    sprintf(db->sql_cmd, "SELECT COUNT(artist_id) FROM (SELECT artist_id, artist_name FROM main.artist WHERE artist_name like ? escape ? or artist_name like ? escape ? UNION \
SELECT artist_id, artist_name FROM db2.artist WHERE artist_name like ? escape ? or artist_name like ? escape ?)");
                }
                else
                {
                     sprintf(db->sql_cmd, "SELECT COUNT(album_id) FROM (SELECT album_id, album_name FROM main.album WHERE album_name like ? escape ? or album_name like ? escape ? UNION \
SELECT album_id, album_name FROM db2.album WHERE album_name like ? escape ? or album_name like ? escape ?)");
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_wstr(stmt, 1, name_s);
            sqlite3_bind_kal_wstr(stmt, 2, name_t);
            sqlite3_bind_kal_wstr(stmt, 3, list_view->string);
            sqlite3_bind_kal_wstr(stmt, 4, name_t);
            sqlite3_bind_kal_wstr(stmt, 5, name_s);
            sqlite3_bind_kal_wstr(stmt, 6, name_t);
            sqlite3_bind_kal_wstr(stmt, 7, list_view->string);
            sqlite3_bind_kal_wstr(stmt, 8, name_t);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *count = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
                pls_sql_finalize(stmt);
            }
            else
            {
                MMI_TRACE(TRACE_GROUP_2, MMI_PLS_PLS_ERROR_HAPPEN, __LINE__);
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }  
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}

S32 pls_sql_util_get_hint_count_as_hint_type(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32* count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    U32 id_parent[SRV_PLST_VIEW_LIST_DEPTH];
    U8 i;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    for (i = 0; i < list_view->current_index; i++)
    {
        id_parent[i] = list_view->list_cache[i + 1].parent_id;
    }  
    *count = 0;
    pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &(id_parent[list_view->current_index]));

    if(list_view->hint_type == SRV_PLST_VIEW_AUDIO)
    {
        ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM main.audio", &stmt);
        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *count = sqlite3_column_kal_uint32(stmt, 0);
            pls_sql_finalize(stmt);
            ret = SRV_PLST_OK;
        }
        else
        {
            pls_sql_finalize(stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
        }

    #if defined(__PLST_DUAL_DB_SUPPORT__)
        if(IS_CARD_EXIST)
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(media_id) FROM db2.audio", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count += sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
            }
            else
            {
                pls_sql_finalize(stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
            }           
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */
        return ret;
    }
    else if(list_view->hint_type == SRV_PLST_VIEW_ALBUM)
    {
        if(!list_view->current_index && list_view->view_type[0] == SRV_PLST_VIEW_ARTIST ||
            (list_view->current_index && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_ARTIST)  ||
            (list_view->current_index && list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PREFIX_SEARCH &&
            list_view->view_type[list_view->current_index - 1] == SRV_PLST_VIEW_ARTIST))
        {
            ret = pls_sql_prepare_ex(db, "SELECT count(distinct album_id) FROM main.audio WHERE artist_id = ?", &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id_parent[list_view->current_index]);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *count = sqlite3_column_kal_uint32(stmt, 0);
                pls_sql_finalize(stmt);
                ret = SRV_PLST_OK;
            }
            else
            {
                *count = 0;
                pls_sql_finalize(stmt);
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT count(distinct album_id) FROM (select album_id from main.audio where artist_id = ? union select album_id from db2.audio WHERE artist_id = ?)", &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1,id_parent[list_view->current_index]);
                sqlite3_bind_kal_uint32(stmt, 2, id_parent[list_view->current_index]);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    *count = sqlite3_column_kal_uint32(stmt, 0);
                    pls_sql_finalize(stmt);
                    ret = SRV_PLST_OK;
                }
                else
                {
                    pls_sql_finalize(stmt);
                }
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            return ret;
        }
        else if((list_view->current_index && list_view->view_type[list_view->current_index - 1] != SRV_PLST_VIEW_ALBUM) ||
            (!list_view->current_index && list_view->view_type[0] == SRV_PLST_VIEW_DUMMY))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(distinct album_id) FROM (SELECT album_id FROM main.album UNION SELECT album_id FROM db2.album) ", &stmt);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(album_id) FROM main.album", &stmt);
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else if(list_view->hint_type == SRV_PLST_VIEW_ARTIST)
    {
        if((list_view->current_index && list_view->view_type[list_view->current_index] != SRV_PLST_VIEW_ARTIST) ||
            (!list_view->current_index && list_view->view_type[0] == SRV_PLST_VIEW_DUMMY))
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(distinct artist_id) FROM (SELECT artist_id FROM main.artist UNION SELECT artist_id FROM db2.artist) ", &stmt);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(artist_id) FROM main.artist", &stmt);
            }
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            pls_sql_finalize(stmt);
            return ret;
        }
        else
        {
            ret = SRV_PLST_RET_ERR_PARAM_ERR;
        }
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;    
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_get_active_media_path_by_id
 * DESCRIPTION
 *   current only support sort/plst two type, not plst_addto
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_util_get_hint_count(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32* count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id_parent[SRV_PLST_VIEW_LIST_DEPTH];
    U8 i;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    view_type[list_view->current_index] = list_view->view_type[list_view->current_index];
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id_parent[i] = list_view->list_cache[i + 1].parent_id;
    }   
    if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_IMAGE_FLOW)
    {
       U32 temp_id = 0;
        
        ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);

        if(ret == SRV_PLST_OK)
        {          
            sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM audio WHERE album_id = ?");            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, temp_id);            
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM db2.audio WHERE album_id = ?"); 
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, temp_id);            
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }  
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }        
    }
    else if((!list_view->current_index && (view_type[0] == SRV_PLST_VIEW_ARTIST ||
        view_type[0] == SRV_PLST_VIEW_ALBUM || view_type[0] == SRV_PLST_VIEW_GENRE || view_type[0] == SRV_PLST_VIEW_PLST)) ||
        (view_type[0] == SRV_PLST_VIEW_PLST && view_type[1] == SRV_PLST_VIEW_MEDIA &&(view_type[2] == SRV_PLST_VIEW_ARTIST ||
        view_type[2] == SRV_PLST_VIEW_ALBUM || view_type[2] == SRV_PLST_VIEW_GENRE))||
        (list_view->current_index == 1 &&(view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH && (view_type[0] == SRV_PLST_VIEW_PLST ||
        view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM || view_type[0] == SRV_PLST_VIEW_GENRE))))
    {
        U32 temp_id = 0;
        srv_plst_view_type_enum view_temp;

        if(list_view->current_index == 2 && view_type[0] == SRV_PLST_VIEW_PLST)
        {
            view_temp = list_view->view_type[list_view->current_index];
        }
        else
        {
            view_temp = view_type[0];
        }
        ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);

        if(ret == SRV_PLST_OK)
        {            
            switch(view_temp)
            {
                case SRV_PLST_VIEW_ARTIST:
                    sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM audio WHERE artist_id = ?");
                    break;

                case SRV_PLST_VIEW_ALBUM:
                    sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM audio WHERE album_id = ?");
                    break;

            #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                case SRV_PLST_VIEW_GENRE:
                    sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM audio WHERE genre_id = ?");
                    break;
            #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                case SRV_PLST_VIEW_PLST:
                   sprintf(db->sql_cmd, " SELECT COUNT(plstitem_id) FROM plst_item WHERE plst_id = ? AND media_id > 32768");
                    break;

                default:
                    return SRV_PLST_RET_ERR_PARAM_ERR; 
            }
            
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, temp_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);               
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                switch(view_temp)
                {
                    case SRV_PLST_VIEW_ARTIST:
                        sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ?");
                        break;

                    case SRV_PLST_VIEW_ALBUM:
                        sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM db2.audio WHERE album_id = ?");
                        break;

                #ifdef __PLST_SRV_FEATURE_GENRE_SUPPORT__
                    case SRV_PLST_VIEW_GENRE:
                        sprintf(db->sql_cmd,"SELECT COUNT(media_id) FROM db2.audio WHERE genre_id = ?");
                        break;
                #endif /* __PLST_SRV_FEATURE_GENRE_SUPPORT__ */

                    case SRV_PLST_VIEW_PLST: // to do : revise for mark several
                        if(temp_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND media_id <= 32768");
                        }
                    #if defined(__PLST_DUAL_DB_SUPPORT__)
                        else
                        {
                            sprintf(db->sql_cmd,"SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ?");
                        }
                    #endif /* __PLST_DUAL_DB_SUPPORT__ */
                        break;

                    default:
                        return SRV_PLST_RET_ERR_PARAM_ERR;                       
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, temp_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM &&
        (list_view->current_index == 1 ||(list_view->current_index == 2 && view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH)))
    {
        U32 temp_id = 0;
        
        ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);

        if(ret == SRV_PLST_OK) 
        {
            sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM audio WHERE artist_id = ? AND album_id = ? ");           
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id_parent[0]);
            sqlite3_bind_kal_uint32(stmt, 2, temp_id);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *count = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *count = 0;
            }
            pls_sql_finalize(stmt);

            if(ret != SRV_PLST_OK)
            {
                return ret;
            }

        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT COUNT(media_id) FROM db2.audio WHERE artist_id = ? AND album_id = ?");
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, id_parent[0]);
                sqlite3_bind_kal_uint32(stmt, 2, temp_id);
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *count += sqlite3_column_kal_uint32(stmt, 0);
                }
                else
                {
                    *count = 0;
                }
                pls_sql_finalize(stmt);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
        }
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_PLST_ADDTO)
    {
        U32 plst_id;

        pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &plst_id);

        if(plst_id > 0X8000)
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? ", &stmt);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM main.plst_item WHERE plst_id = ? AND media_id > 32768", &stmt);
            }
        }
    #if defined(__PLST_DUAL_DB_SUPPORT__)
        else
        {
            ret = pls_sql_prepare_ex(db, "SELECT COUNT(plstitem_id) FROM db2.plst_item WHERE plst_id = ?", &stmt);
        }
    #endif /* __PLST_DUAL_DB_SUPPORT__ */

        if(ret != SRV_PLST_OK)
        {
            return ret;
        }
        sqlite3_bind_kal_uint32(stmt, 1, plst_id);
        ret = pls_sql_step_ex(db, stmt);
        if(ret == SRV_PLST_RET_ITEM_EXIST)
        {
            *count = sqlite3_column_kal_uint32(stmt,0);
            ret = SRV_PLST_OK;
        }
        else
        {
            if(ret == SRV_PLST_OK)
            {
                *count = 0;
            }
        }
        pls_sql_finalize(stmt);
        return ret;
    }
    else
    {
        ret = SRV_PLST_RET_ERR_PARAM_ERR;
    }
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  pls_sql_util_get_media_id_by_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  db  [IN]
 * RETURNS
 *  return error code  S32
 *****************************************************************************/
S32 pls_sql_util_get_media_id_by_index(srv_plst_db_context_struct *db, srv_plst_list_view_history_struct *list_view, U32 index, U32 sub_index, U32* id_o)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    srv_plst_base_info_struct *base;
    sqlite3_stmt *stmt;
    S32 ret = SRV_PLST_OK;
    srv_plst_view_type_enum view_type[SRV_PLST_VIEW_LIST_DEPTH];
    U32 id_parent[SRV_PLST_VIEW_LIST_DEPTH];
    U8 i;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    base = (srv_plst_base_info_struct*)&(((srv_plst_main_context_struct*)(db->srv_hdr))->base_info);
    view_type[list_view->current_index] = list_view->view_type[list_view->current_index];
    for (i = 0; i < list_view->current_index; i++)
    {
        view_type[i] = list_view->view_type[i];
        id_parent[i] = list_view->list_cache[i + 1].parent_id;
    } 

    /* MAUI_02456300, all song, scrlling down and press play all
       cannot get the first index in the case of all audio play, so patch for this special case */
    if((list_view->current_index == 0) && (list_view->view_type[0] == SRV_PLST_VIEW_AUDIO) && (index == 0))
    {
        if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
        {
            const S8* ptr = SqlOpnaidasc;
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                kal_sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM (SELECT media_id , p_name, ischar FROM main.audio %s ) \
UNION SELECT * FROM (SELECT media_id, p_name, ischar FROM db2.audio %s)) %s", ptr, ptr,ptr);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                 kal_sprintf(db->sql_cmd, "SELECT media_id, p_name, ischar FROM audio %s", ptr);
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, 1);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, 1);
                sqlite3_bind_kal_uint32(stmt, 3, 1);
            }
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            ret = pls_sql_step_ex(db, stmt);
            if (ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
            }
            else
            {
                *id_o = 0;
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
            }                    
            pls_sql_finalize(stmt);
        }
        else
        {
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM (SELECT media_id, name FROM main.audio ORDER BY name, media_id limit 1)");
                strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT media_id, name FROM db2.audio ORDER BY name, media_id ASC limit 1)) ORDER BY name, media_id limit 1");
            }
            else 
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio ORDER BY name, media_id ASC limit 1");
            }           
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
            }
            else
            {
                *id_o = 0;
                if(ret == SRV_PLST_OK)
                {
                    ret = SRV_PLST_RET_EMPTY;
                }
            }                    
            pls_sql_finalize(stmt);
        }
    }
    else if(list_view->view_type[list_view->current_index] == SRV_PLST_VIEW_IMAGE_FLOW)
    {
        U32 temp_id = 0;        
        ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);
        if(ret == SRV_PLST_OK)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd,"SELECT * FROM (SELECT * FROM ( SELECT media_id, p_name, track_num FROM main.audio WHERE album_id = ? ORDER BY track_num, p_name, media_id limit ? ) ");
                    strcat(db->sql_cmd, "UNION SELECT * FROM (SELECT media_id, p_name, track_num FROM db2.audio  WHERE album_id = ? ORDER BY track_num, p_name, track_num limit ? )) ORDER BY track_num, p_name, media_id limit 1 offset ? ");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd,"SELECT media_id FROM audio WHERE album_id = ? ORDER BY track_num, p_name, media_id limit 1 OFFSET ?");  
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, name FROM main.audio WHERE album_id = ? ORDER BY name limit ? ) ");
                    strcat(db->sql_cmd, "UNION SELECT * FROM ( SELECT media_id, name FROM db2.audio  WHERE album_id = ? ORDER BY name limit ? )) ORDER BY name limit 1 offset ? ");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd,"SELECT media_id FROM audio WHERE album_id = ? ORDER BY name limit 1 OFFSET ?");  
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, temp_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 3, temp_id);
                sqlite3_bind_kal_uint32(stmt, 4, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 5, sub_index);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sqlite3_bind_kal_uint32(stmt, 2, sub_index);
            }          
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *id_o = 0;
            }
            pls_sql_finalize(stmt);
        }
    }
    /* Long press a artst, album, genre to play all or select play all in the artst, album, genre song list*/
    else if((list_view->current_index == 0 && (view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM || view_type[0] == SRV_PLST_VIEW_GENRE )) ||
            (list_view->current_index == 1 && ((view_type[1] == SRV_PLST_VIEW_MEDIA || view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH) && 
             (view_type[0] == SRV_PLST_VIEW_ARTIST || view_type[0] == SRV_PLST_VIEW_ALBUM || view_type[0] == SRV_PLST_VIEW_GENRE))))
    {
        U32 temp_id = 0;

        /* select play all in the artst, album, genre song list */
        if(list_view->current_index == 1 && view_type[1] == SRV_PLST_VIEW_MEDIA)
        {
            temp_id = list_view->list_cache[list_view->current_index].parent_id;
            ret = SRV_PLST_OK;
        }
        /* Long press a artst, album, genre to play all */
        else
        {
            ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);
        }

        if(ret == SRV_PLST_OK)
        {
            const S8* ptr;
            if(view_type[0] == SRV_PLST_VIEW_ARTIST)
            {
                ptr = Sqlartistid;
            }
            else if(view_type[0] == SRV_PLST_VIEW_ALBUM)
            {
                ptr = Sqlalbumid;
            }
            else if(view_type[0] == SRV_PLST_VIEW_GENRE)
            {
                ptr = Sqlgenreid;
            }
            else
            {
                return SRV_PLST_RET_ERR_PARAM_ERR;
            }
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
                if(view_type[0] == SRV_PLST_VIEW_ALBUM)
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, p_name, track_num FROM main.audio WHERE %s ORDER BY track_num, p_name, media_id limit ?) \
UNION SELECT * FROM ( SELECT media_id, p_name, track_num FROM db2.audio  WHERE %s ORDER BY track_num, p_name, media_id limit ? )) ORDER BY track_num, p_name, media_id limit 1 offset ?", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id FROM audio WHERE %s ORDER BY track_num, p_name, media_id limit 1 OFFSET ?", ptr);               
                    }
                }
                else
                {
                #if defined(__PLST_DUAL_DB_SUPPORT__)
                    if(IS_CARD_EXIST)
                    {
                        kal_sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, p_name, ischar FROM main.audio WHERE %s ORDER BY ischar, p_name, media_id limit ?) \
UNION SELECT * FROM ( SELECT media_id, p_name, ischar FROM db2.audio  WHERE %s ORDER BY ischar, p_name, media_id limit ? ) ) ORDER BY ischar, p_name, media_id limit 1 offset ?", ptr, ptr);
                    }
                    else
                #endif /* __PLST_DUAL_DB_SUPPORT__ */
                    {
                        kal_sprintf(db->sql_cmd,"SELECT media_id FROM audio WHERE %s ORDER BY ischar, p_name, media_id limit 1 OFFSET ?", ptr);               
                    }
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    kal_sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, name FROM main.audio WHERE %s ORDER BY name limit ?) \
UNION SELECT * FROM ( SELECT media_id, name FROM db2.audio  WHERE %s ORDER BY name limit ? ) ) ORDER BY name limit 1 offset ?", ptr, ptr);
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    kal_sprintf(db->sql_cmd,"SELECT media_id FROM audio WHERE %s ORDER BY name limit 1 OFFSET ?", ptr);               
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, temp_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 2, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 3, temp_id);
                sqlite3_bind_kal_uint32(stmt, 4, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 5, sub_index);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sqlite3_bind_kal_uint32(stmt, 2, sub_index);
            }          
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
            }
            else
            {
                *id_o = 0;
            }
            pls_sql_finalize(stmt);
        }
    }
    /* Long press artist->album to play all or  select play all in the artst->album song list*/
    else if(view_type[0] == SRV_PLST_VIEW_ARTIST && view_type[1] == SRV_PLST_VIEW_ALBUM &&
        (list_view->current_index == 1 ||( list_view->current_index == 2 && (view_type[2] == SRV_PLST_VIEW_MEDIA || view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH))))
    {
        U32 temp_id = 0;

        /* select play all in the artst->album song list */
        if(list_view->current_index == 2 && view_type[2] == SRV_PLST_VIEW_MEDIA)
        {
            temp_id = list_view->list_cache[list_view->current_index].parent_id;
            ret = SRV_PLST_OK;
        }
        /* long press artist->album to play all */
        else
        {
            ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &temp_id);
        }

        if(ret == SRV_PLST_OK)
        {
            if(base->config_sort_list_view == SRV_PLST_LIST_SORT_BY_PINYIN)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, p_name, track_num FROM main.audio WHERE artist_id = ? AND album_id = ? ORDER BY track_num, p_name, media_id limit ? ) ");
                    strcat(db->sql_cmd, "UNION SELECT * FROM ( SELECT media_id, p_name, track_num FROM db2.audio  WHERE artist_id = ? AND album_id = ? ORDER BY track_num, p_name, media_id limit ?)) ORDER BY track_num, p_name, media_id limit 1 offset ? ");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id, p_name, track_num FROM main.audio WHERE artist_id = ? AND album_id = ? ORDER BY track_num, p_name, media_id limit 1 OFFSET ?");
                }
            }
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    sprintf(db->sql_cmd,"SELECT * FROM ( SELECT * FROM ( SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? ORDER BY name limit ? ) ");
                    strcat(db->sql_cmd, "UNION SELECT * FROM ( SELECT media_id, name FROM db2.audio  WHERE artist_id = ? AND album_id = ? ORDER BY name limit ?)) ORDER BY name limit 1 offset ? ");
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    sprintf(db->sql_cmd, "SELECT media_id, name FROM main.audio WHERE artist_id = ? AND album_id = ? ORDER BY name limit 1 OFFSET ?");
                }
            }
            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, id_parent[0]);
            sqlite3_bind_kal_uint32(stmt, 2, temp_id);
        #if defined(__PLST_DUAL_DB_SUPPORT__)
            if(IS_CARD_EXIST)
            {
                sqlite3_bind_kal_uint32(stmt, 3, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 4, id_parent[0]);
                sqlite3_bind_kal_uint32(stmt, 5, temp_id);
                sqlite3_bind_kal_uint32(stmt, 6, sub_index + 1);
                sqlite3_bind_kal_uint32(stmt, 7, sub_index);
            }
            else
        #endif /* __PLST_DUAL_DB_SUPPORT__ */
            {
                sqlite3_bind_kal_uint32(stmt, 3, sub_index);
            }
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
                ret = SRV_PLST_OK;
            }
            else
            {
                *id_o = 0;
            }
            pls_sql_finalize(stmt);
        }
    }
    else if ((list_view->view_type[0] == SRV_PLST_VIEW_PLST && 
      (!list_view->current_index || (list_view->current_index && list_view->view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH))) ||
      (list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
      (list_view->current_index || (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH))))
    {// todo
        U32 plst_id = 0;
        if(list_view->view_type[0] == SRV_PLST_VIEW_PLST && 
            (!list_view->current_index || (list_view->current_index && list_view->view_type[1] == SRV_PLST_VIEW_PREFIX_SEARCH)))
        {
            ret = pls_db_util_get_id(&(list_view->list_cache[list_view->current_index]), index, &plst_id);        
        }
        else if  (list_view->view_type[0] == SRV_PLST_VIEW_PLST && list_view->view_type[1] == SRV_PLST_VIEW_MEDIA &&
            (list_view->current_index || (list_view->current_index == 2 && list_view->view_type[2] == SRV_PLST_VIEW_PREFIX_SEARCH)))
        {
            plst_id = list_view->list_cache[1].parent_id; 
        }
        else 
        {
            ret =  SRV_PLST_RET_ERR_PARAM_ERR;
        }
        if(ret == SRV_PLST_OK)
        {       
            srv_plst_default_playlist_enum type;

            ret = pls_sql_util_get_default_list_info(db, plst_id, &type);

            if(ret == SRV_PLST_OK && (type == SRV_PLST_DEF_MOST_PLST || type == SRV_PLST_DEF_RECENTLY_PLST))
            {
            #ifdef __PLST_SRV_FEATURE_MOST_RECENT_LIST__
                if(IS_CARD_EXIST)
                {
                    if(type == SRV_PLST_DEF_MOST_PLST)
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played_count desc ,plstitem_id desc limit 1 )");
                        strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played_count FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played_count DESC, plstitem_id desc limit 1)) ORDER BY played_count DESC, plstitem_id desc limit 1");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT * FROM (SELECT * FROM(SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played desc, plstitem_id desc limit 1 )");
                        strcat(db->sql_cmd, " UNION SELECT * FROM (SELECT plstitem_id, played FROM main.plst_item, db2.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played DESC, plstitem_id desc limit 1)) ORDER BY played DESC, plstitem_id desc limit 1");
                    }
                }
                else 
                {
                    if(type == SRV_PLST_DEF_MOST_PLST)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, played_count FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played_count desc, plstitem_id desc limit 1 ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id, played FROM main.plst_item, main.meta WHERE plst_id = ? AND plst_item.media_id = meta.media_id ORDER BY played desc, plstitem_id desc limit 1");                      
                    }
                }
                ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
                if(ret != SRV_PLST_OK)
                {
                    return ret;
                }
                sqlite3_bind_kal_uint32(stmt, 1, plst_id);
                if(IS_CARD_EXIST)
                {
                    sqlite3_bind_kal_uint32(stmt, 2, plst_id);
                }
                ret = pls_sql_step_ex(db, stmt);
                if(ret == SRV_PLST_RET_ITEM_EXIST)
                {
                    ret = SRV_PLST_OK;
                    *id_o = sqlite3_column_kal_uint32(stmt, 0);
                }
                else 
                {
                    *id_o = 0;
                }
                pls_sql_finalize(stmt);
                return ret;
            #else
                return SRV_PLST_RET_ERR_PARAM_ERR;
            #endif /* __PLST_SRV_FEATURE_MOST_RECENT_LIST__ */
            }

            if(base->config_plst_view == SRV_PLST_LIST_SORT_BY_MODIFY_TIME)
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(!list_view->is_mark)
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? ORDER BY idx desc limit 1 OFFSET ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? ORDER BY idx desc limit 1 OFFSET ?");
                        }
                    }
                    else if(list_view->is_mark && list_view->is_mark_all)
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark ) ORDER BY idx desc limit 1 OFFSET ? ");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark ) ORDER BY idx desc limit 1 OFFSET ?");
                        }                
                    }
                    else
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT id FROM db2.mark, main.plst_item WHERE plst_id = ? AND id = plstitem_id ORDER BY idx desc limit 1 OFFSET ? ) ");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT id FROM db2.mark, db2.plst_item WHERE plst_id = ? AND id = plstitem_id ORDER BY idx desc limit 1 OFFSET ? ) ");
                        }
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(!list_view->is_mark)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id FROM plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx desc limit 1 OFFSET ?");  
                    }
                    else if(list_view->is_mark && list_view->is_mark_all)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id FROM plst_item WHERE plst_id = ? AND media_id > 32768 AND plstitem_id NOT IN (SELECT id FROM mark ) ORDER BY idx desc limit 1 OFFSET ? ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT id FROM mark, plst_item WHERE plst_id = ? AND media_id > 32768 AND id = plstitem_id ORDER BY idx desc limit 1 OFFSET ? ) ");
                    }
                }
            }
        #ifdef __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__
            else
            {
            #if defined(__PLST_DUAL_DB_SUPPORT__)
                if(IS_CARD_EXIST)
                {
                    if(!list_view->is_mark)
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? ORDER BY idx limit 1 OFFSET ?");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? ORDER BY idx  limit 1 OFFSET ?");
                        }
                    }
                    else if(list_view->is_mark && list_view->is_mark_all)
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM main.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark ) ORDER BY idx limit 1 OFFSET ? ");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT plstitem_id FROM db2.plst_item WHERE plst_id = ? AND plstitem_id NOT IN (SELECT id FROM db2.mark ) ORDER BY idx limit 1 OFFSET ?");
                        }                
                    }
                    else
                    {
                        if(plst_id > 0X8000)
                        {
                            sprintf(db->sql_cmd, "SELECT id FROM db2.mark, main.plst_item WHERE plst_id = ? AND id = plstitem_id ORDER BY idx limit 1 OFFSET ? ) ");
                        }
                        else
                        {
                            sprintf(db->sql_cmd, "SELECT id FROM db2.mark, db2.plst_item WHERE plst_id = ? AND id = plstitem_id ORDER BY idx limit 1 OFFSET ? ) ");
                        }
                    }
                }
                else
            #endif /* __PLST_DUAL_DB_SUPPORT__ */
                {
                    if(!list_view->is_mark)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id FROM plst_item WHERE plst_id = ? AND media_id > 32768 ORDER BY idx limit 1 OFFSET ?");  
                    }
                    else if(list_view->is_mark && list_view->is_mark_all)
                    {
                        sprintf(db->sql_cmd, "SELECT plstitem_id FROM plst_item WHERE plst_id = ? AND media_id > 32768 AND plstitem_id NOT IN (SELECT id FROM mark ) ORDER BY idx limit 1 OFFSET ? ");
                    }
                    else
                    {
                        sprintf(db->sql_cmd, "SELECT id FROM mark, plst_item WHERE plst_id = ? AND media_id > 32768 AND id = plstitem_id ORDER BY idx limit 1 OFFSET ? ) ");
                    }
                }
            }
        #endif /* __PLST_SRV_FEATURE_LIST_SORT_BY_NAME__ */

            ret = pls_sql_prepare_ex(db, db->sql_cmd, &stmt);
            if(ret != SRV_PLST_OK)
            {
                return ret;
            }
            sqlite3_bind_kal_uint32(stmt, 1, plst_id);
            sqlite3_bind_kal_uint32(stmt, 2, sub_index);
            ret = pls_sql_step_ex(db, stmt);
            if(ret == SRV_PLST_RET_ITEM_EXIST)
            {
                ret = SRV_PLST_OK;
                *id_o = sqlite3_column_kal_uint32(stmt, 0);
            }
            else 
            {
                *id_o = 0;
            }
            pls_sql_finalize(stmt);
        }
    }
    else 
    {
        /* current do nothing */
    }
    return ret;
}


S32 pls_sql_util_get_fs_err(srv_plst_db_context_struct *db)
{
    S32 ret = 0;
    ret = sqlite3_instance_get_last_io_error(&(db->sqlite_instance));

    MMI_TRACE(TRACE_GROUP_2, MMI_PLS_SQL_UTIL_GET_FS_ERR, ret);
    return ret;
}
#endif

 
